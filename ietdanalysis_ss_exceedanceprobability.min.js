class ExceedanceProbabilityPlot extends ChartCommons{constructor(containerId,IETDhour,IETDData){super(containerId);this.containerId=containerId;this.IETDhour=IETDhour;this.IETDData=IETDData;this.margin={top:20,right:20,bottom:50,left:60};this.title="Exceedance Probability Plot";this.resize=this.resize.bind(this);this.processData=this.processData.bind(this);this.processData();this.initialize()}processData(){if(!Array.isArray(this.IETDData)||this.IETDData.length===0){console.error("Invalid or empty IETDData");return}try{const volumes=this.IETDData.map(data=>data[2]).sort((a,b)=>b-a);const n=volumes.length;this.formattedData=volumes.map((volume,index)=>{const exceedanceProb=(index+1)/(n+1)*100;return{volume:volume,probability:exceedanceProb}})}catch(error){console.error("Error processing data:",error);return null}}initialize(){const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.height=parseInt(container.style("height"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.innerHeight=this.height-this.margin.top-this.margin.bottom;this.createSvg();this.createScales();this.createAxes();this.createVisualization();window.addEventListener("resize",this.resize)}createSvg(){d3.select(`#${this.containerId}`).select("svg").remove();this.svg=d3.select(`#${this.containerId}`).append("svg").attr("width",this.width).attr("height",this.height);this.tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").attr("font-family","Arial").style("font-size","11px").style("color","black")}createScales(){this.xScale=d3.scaleLinear().domain([0,100]).range([0,this.innerWidth]);const maxVolume=d3.max(this.formattedData,d=>d.volume);this.yScale=d3.scaleSymlog().domain([d3.min(this.formattedData,d=>d.volume)*.9,maxVolume*1.1]).range([this.innerHeight,0])}createAxes(){const xAxis=d3.axisBottom(this.xScale).tickFormat(d=>d+"%");this.xAxis=this.svg.append("g").attr("class","x axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top+this.innerHeight})`).call(xAxis);this.yAxis=this.svg.append("g").attr("class","y axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`).call(d3.axisLeft(this.yScale).tickFormat(d=>d.toFixed(2)));this.dedupeYAxisLabels(this.svg.select(".y.axis").selectAll(".tick text"))}dedupeYAxisLabels(labels){const labelData=[];labels.each(function(d,i){const bbox=this.getBoundingClientRect();labelData.push({index:i,top:bbox.top,bottom:bbox.bottom,height:bbox.height,element:this,value:d})});labelData.sort((a,b)=>a.top-b.top);const buffer=2;let lastVisibleLabel=labelData[0];d3.select(lastVisibleLabel.element).style("opacity",1);for(let i=1;i<labelData.length;i++){const currentLabel=labelData[i];if(lastVisibleLabel.bottom+buffer>currentLabel.top){d3.select(currentLabel.element).style("opacity",0)}else{d3.select(currentLabel.element).style("opacity",1);lastVisibleLabel=currentLabel}}}createVisualization(){const line=d3.line().x(d=>this.margin.left+this.xScale(d.probability)).y(d=>this.margin.top+this.yScale(d.volume));this.svg.append("path").datum(this.formattedData).attr("class","exceedance-line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",1).attr("d",line);this.points=this.svg.selectAll(".exceedance-point").data(this.formattedData).enter().append("circle").attr("class","exceedance-point").attr("cx",d=>this.margin.left+this.xScale(d.probability)).attr("cy",d=>this.margin.top+this.yScale(d.volume)).attr("r",2).attr("fill","steelblue").attr("stroke","steelblue").attr("stroke-width",1).on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));this.createTitles()}createTitles(){this.chartTitle=this.svg.append("text").attr("class","title").attr("x",this.margin.left+this.innerWidth/2).attr("y",15).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","12px").attr("font-weight","bold").text(`${this.title}`);this.svg.append("text").attr("class","x-axis-label").attr("text-anchor","middle").attr("x",this.margin.left+this.innerWidth/2).attr("y",this.height-10).attr("font-size","12px").attr("font-family","Arial").text("Exceedance Probability (%)");this.svg.append("g").attr("transform",`translate(${this.margin.left*1/5}, ${this.innerHeight/2})`).append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("font-size","12px").text("HPCP (inch)").attr("font-family","Arial")}handleMouseOver(event,d){this.tooltip.html(this.createTooltipFormat(d,`
                    Probability: ${d.probability.toFixed(2)}%<br/>
                HPCP: ${d.volume.toFixed(2)} inches
            `)).style("visibility","visible").style("top",event.pageY-10+"px").style("left",event.pageX+10+"px");d3.select(event.target).raise().attr("fill","#e41a1c").attr("r",4).attr("stroke-width",1)}handleMouseOut(event,d){this.tooltip.style("visibility","hidden");d3.select(event.target).attr("fill","steelblue").attr("r",2).attr("stroke-width",1)}resize(){if(!this.isVisible())return;const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.svg.attr("width",this.width);this.xScale.range([0,this.innerWidth]);this.svg.select(".x.axis").transition().duration(500).call(d3.axisBottom(this.xScale).tickFormat(d=>d+"%"));const line=d3.line().x(d=>this.margin.left+this.xScale(d.probability)).y(d=>this.margin.top+this.yScale(d.volume));this.svg.select(".exceedance-line").transition().duration(500).attr("d",line(this.formattedData));this.svg.selectAll(".exceedance-point").transition().duration(500).attr("cx",d=>this.margin.left+this.xScale(d.probability)).attr("cy",d=>this.margin.top+this.yScale(d.volume));this.chartTitle.attr("x",this.margin.left+this.innerWidth/2);this.svg.select(".x-axis-label").attr("x",this.margin.left+this.innerWidth/2)}async updateData(newIETDData,newIETDHour){this.IETDData=newIETDData;this.IETDhour=newIETDHour;this.processData();this.createScales();this.svg.select(".x.axis").transition().duration(750).call(d3.axisBottom(this.xScale).tickFormat(d=>d+"%"));this.svg.select(".y.axis").transition().duration(750).call(d3.axisLeft(this.yScale).tickFormat(d=>d.toFixed(2))).on("end",()=>{requestAnimationFrame(()=>{this.dedupeYAxisLabels(this.svg.select(".y.axis").selectAll(".tick text"))})});const line=d3.line().x(d=>this.margin.left+this.xScale(d.probability)).y(d=>this.margin.top+this.yScale(d.volume));this.svg.select(".exceedance-line").datum(this.formattedData).transition().duration(750).attr("d",line);const points=this.svg.selectAll(".exceedance-point").data(this.formattedData);points.exit().remove();points.transition().duration(750).attr("cx",d=>this.margin.left+this.xScale(d.probability)).attr("cy",d=>this.margin.top+this.yScale(d.volume));points.enter().append("circle").attr("class","exceedance-point").attr("r",2).attr("fill","steelblue").attr("stroke","steelblue").attr("stroke-width",1).attr("cx",d=>this.margin.left+this.xScale(d.probability)).attr("cy",d=>this.margin.top+this.yScale(d.volume)).on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));this.chartTitle.text(`${this.title}`)}destroy(){try{window.removeEventListener("resize",this.resize);const container=d3.select(`#${this.containerId}`);container.select("svg").remove();if(this.tooltip){this.tooltip.remove();this.tooltip=null}container.selectAll(".exceedance-line").remove();container.selectAll(".exceedance-point").remove();container.selectAll(".x.axis").remove();container.selectAll(".y.axis").remove();container.selectAll(".title").remove();container.selectAll(".x-axis-label").remove();container.selectAll(".y-axis-label").remove();container.selectAll(".exceedance-point").on("mouseover",null).on("mouseout",null);this.formattedData=null;this.IETDData=null;this.IETDhour=null;this.svg=null;this.tooltip=null;this.xScale=null;this.yScale=null;this.xAxis=null;this.yAxis=null;this.points=null;this.chartTitle=null;this.width=null;this.height=null;this.innerWidth=null;this.innerHeight=null;this.margin=null;super.destroy()}catch(error){console.error("Error in destroy:",error)}}}