class AnomalyPlot{constructor(containerId,IETDhour,IETDData,zScoreThreshold=2){this.containerId=containerId;this.IETDhour=IETDhour;this.IETDData=IETDData;this.zScoreThreshold=zScoreThreshold;this.margin={top:20,right:20,bottom:50,left:60};this.title="Significant Precipitation Anomalies";this.positiveColor="#ff7f7f";this.negativeColor="#7f7fff";this.meanLineColor="#666666";this.resize=this.resize.bind(this);this.processData=this.processData.bind(this);this.timeFormat=this.timeFormat.bind(this);this.processData();this.initialize()}timeFormat(date){if(!date)return"";try{const d=new Date(date);const month=(d.getMonth()+1).toString().padStart(2,"0");const day=d.getDate().toString().padStart(2,"0");const year=d.getFullYear();const hour=d.getHours().toString().padStart(2,"0");return`${month}/${day}/${year} ${hour}h`}catch(e){return""}}processData(){if(!Array.isArray(this.IETDData)||this.IETDData.length===0){console.error("Invalid or empty IETDData");return}try{const baseData=this.IETDData.map(data=>{const[datefrom,dateto,volume]=data;return{date:new Date(datefrom),volume:volume,from:datefrom,to:dateto,period:`${this.timeFormat(datefrom)} ~ ${this.timeFormat(dateto)}`}}).sort((a,b)=>a.date-b.date);const volumes=baseData.map(d=>d.volume);this.meanValue=d3.mean(volumes);this.stdDev=d3.deviation(volumes);this.formattedData=baseData.map(d=>{const anomaly=d.volume-this.meanValue;const zScore=(d.volume-this.meanValue)/this.stdDev;return{...d,anomaly:anomaly,zScore:zScore,isSignificant:Math.abs(zScore)>=this.zScoreThreshold}});this.significantAnomalies=this.formattedData.filter(d=>d.isSignificant);this.anomalyPercentage=(this.significantAnomalies.length/this.formattedData.length*100).toFixed(1)}catch(error){console.error("Error processing anomaly data:",error);return null}}initialize(){const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.height=parseInt(container.style("height"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.innerHeight=this.height-this.margin.top-this.margin.bottom;this.createSvg();this.createScales();this.createAxes();this.createVisualization();window.addEventListener("resize",this.resize)}createSvg(){d3.select(`#${this.containerId}`).select("svg").remove();this.svg=d3.select(`#${this.containerId}`).append("svg").attr("width",this.width).attr("height",this.height);this.tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").attr("font-family","Arial").style("font-size","11px").style("color","black")}createScales(){this.xScale=d3.scaleTime().domain(d3.extent(this.formattedData,d=>d.date)).range([0,this.innerWidth]);const maxAbsAnomaly=d3.max(this.significantAnomalies,d=>Math.abs(d.anomaly));this.yScale=d3.scaleLinear().domain([-maxAbsAnomaly,maxAbsAnomaly]).range([this.innerHeight,0]).nice()}dedupeLabels(labels){const rects=[];labels.each(function(d,i){const bbox=this.getBoundingClientRect();rects.push({index:i,x:bbox.x,y:bbox.y,width:bbox.width,height:bbox.height,element:this,visible:true})});rects.sort((a,b)=>a.x-b.x);let lastVisibleIndex=0;for(let i=1;i<rects.length;i++){const curr=rects[i];const lastVisible=rects[lastVisibleIndex];if(lastVisible.x+lastVisible.width+5>curr.x){d3.select(curr.element).style("opacity",0);curr.visible=false}else{d3.select(curr.element).style("opacity",1);curr.visible=true;lastVisibleIndex=i}}}createAxes(){const xAxis=d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"));this.xAxis=this.svg.append("g").attr("class","x axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top+this.innerHeight})`).call(xAxis);this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"));this.yAxis=this.svg.append("g").attr("class","y axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`).call(d3.axisLeft(this.yScale).ticks(5).tickFormat(d=>d3.format("+.1f")(d)));this.svg.append("line").attr("class","zero-line").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(0)).attr("y2",this.margin.top+this.yScale(0)).attr("stroke",this.meanLineColor).attr("stroke-width",1).attr("stroke-dasharray","4,4")}createVisualization(){const upperThreshold=this.meanValue+this.stdDev*this.zScoreThreshold;const lowerThreshold=this.meanValue-this.stdDev*this.zScoreThreshold;this.svg.append("line").attr("class","threshold-line upper").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(this.stdDev*this.zScoreThreshold)).attr("y2",this.margin.top+this.yScale(this.stdDev*this.zScoreThreshold)).attr("stroke",this.positiveColor).attr("stroke-width",1).attr("stroke-dasharray","4,4");this.svg.append("line").attr("class","threshold-line lower").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(-this.stdDev*this.zScoreThreshold)).attr("y2",this.margin.top+this.yScale(-this.stdDev*this.zScoreThreshold)).attr("stroke",this.negativeColor).attr("stroke-width",1).attr("stroke-dasharray","4,4");this.svg.append("line").attr("class","zero-line").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(0)).attr("y2",this.margin.top+this.yScale(0)).attr("stroke",this.meanLineColor).attr("stroke-width",1).attr("stroke-dasharray","4,4");this.points=this.svg.selectAll(".anomaly-point").data(this.significantAnomalies).enter().append("circle").attr("class","anomaly-point").attr("data-indicator",d=>d.period).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly)).attr("r",5).attr("fill",d=>d.anomaly>=0?this.positiveColor:this.negativeColor).attr("stroke","white").attr("stroke-width",1).on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.append("path").datum(this.significantAnomalies).attr("class","anomaly-line").attr("fill","none").attr("stroke","#999999").attr("stroke-width",1).attr("stroke-dasharray","4,4").attr("d",lineGenerator);this.createTitles()}createTitles(){const IETDHour_text="IETD="+this.IETDhour+" "+(this.IETDhour>1?"hours":"hour");this.chartTitle=this.svg.append("text").attr("class","title anomaly").attr("x",this.innerWidth/2).attr("y",15).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","12px").attr("font-weight","bold").text(`${this.title} (${IETDHour_text}, |z| ≥ ${this.zScoreThreshold}σ)`);this.svg.append("text").attr("class","anomaly-percentage").attr("x",this.innerWidth/2).attr("y",35).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","10px").text(`${this.anomalyPercentage}% of events (${this.significantAnomalies.length} of ${this.formattedData.length})`);this.svg.append("g").attr("transform",`translate(${this.margin.left*1/5}, ${this.innerHeight/2})`).append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("font-size","12px").text("HPCP (inch)").attr("font-family","Arial")}handleMouseOver(event,d){if(typeof addHighlights_in_Highcharts==="function"){addHighlights_in_Highcharts(d.from,d.to)}if(typeof addHighlightD3Glyphs==="function"){addHighlightD3Glyphs(d.period,"brown")}const zScoreText=d.zScore>=0?`+${d.zScore.toFixed(2)}σ`:`${d.zScore.toFixed(2)}σ`;this.tooltip.html(`
            <div style="padding: 3px; border-radius: 8px; box-shadow:0 10px 16px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19) !important;">
                <span style="color:blue">${d.period}</span><br/>
                Value: ${d.volume.toFixed(2)} inches<br/>
                Mean: ${this.meanValue.toFixed(2)} inches<br/>
                Anomaly: ${d.anomaly>=0?"+":""}${d.anomaly.toFixed(2)} inches<br/>
                Z-Score: ${zScoreText}
            </div>`).style("visibility","visible").style("top",event.pageY-10+"px").style("left",event.pageX+10+"px");d3.select(event.target).attr("r",7).attr("stroke-width",2).attr("fill","brown")}handleMouseOut(event,d){if(typeof removeHighlights_in_allHighcharts==="function"){removeHighlights_in_allHighcharts()}if(typeof removeHighlightD3Glyphs==="function"){removeHighlightD3Glyphs(d.period)}this.tooltip.style("visibility","hidden");d3.select(event.target).attr("r",5).attr("stroke-width",1).attr("fill",d=>d.anomaly>=0?this.positiveColor:this.negativeColor)}resize(){if(!this.isVisible())return;const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.svg.attr("width",this.width);this.xScale.range([0,this.innerWidth]);this.svg.select(".x.axis").transition().duration(500).call(d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"))).on("end",()=>{this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"))});this.svg.selectAll(".threshold-line, .zero-line").transition().duration(500).attr("x2",this.margin.left+this.innerWidth);this.points.transition().duration(500).attr("cx",d=>this.margin.left+this.xScale(d.date));const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.select(".anomaly-line").transition().duration(500).attr("d",lineGenerator);this.chartTitle.attr("x",this.innerWidth/2);this.svg.select(".anomaly-percentage").attr("x",this.innerWidth/2)}updateData(newIETDData,newIETDHour,newZScoreThreshold=null){this.IETDData=newIETDData;this.IETDhour=newIETDHour;if(newZScoreThreshold!==null){this.zScoreThreshold=newZScoreThreshold}this.processData();this.createScales();this.svg.select(".x.axis").transition().duration(750).call(d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"))).on("end",()=>{this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"))});this.svg.select(".y.axis").transition().duration(750).call(d3.axisLeft(this.yScale).ticks(5).tickFormat(d=>d3.format("+.1f")(d)));this.svg.selectAll(".threshold-line").transition().duration(750).attr("y1",(d,i)=>this.margin.top+this.yScale((i===0?1:-1)*this.stdDev*this.zScoreThreshold)).attr("y2",(d,i)=>this.margin.top+this.yScale((i===0?1:-1)*this.stdDev*this.zScoreThreshold));this.svg.select(".zero-line").transition().duration(750).attr("y1",this.margin.top+this.yScale(0)).attr("y2",this.margin.top+this.yScale(0));const points=this.svg.selectAll(".anomaly-point").data(this.significantAnomalies);points.exit().remove();points.transition().duration(750).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly)).attr("fill",d=>d.anomaly>=0?this.positiveColor:this.negativeColor);points.enter().append("circle").attr("class","anomaly-point").attr("r",5).attr("fill",d=>d.anomaly>=0?this.positiveColor:this.negativeColor).attr("stroke","white").attr("stroke-width",1).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly)).on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.select(".anomaly-line").datum(this.significantAnomalies).transition().duration(750).attr("d",lineGenerator);const IETDHour_text="IETD="+this.IETDhour+" "+(this.IETDhour>1?"hours":"hour");this.chartTitle.text(`${this.title} (${IETDHour_text}, |z| ≥ ${this.zScoreThreshold}σ)`);this.svg.select(".anomaly-percentage").text(`${this.anomalyPercentage}% of events (${this.significantAnomalies.length} of ${this.formattedData.length})`)}highlightPoints(indicator){console.log(indicator);this.points.filter(d=>d.period===indicator).attr("r",8).attr("stroke-width",2).attr("stroke","#FFD700").raise()}resetHighlights(){this.points.attr("r",5).attr("stroke","white").attr("stroke-width",1)}addHighlights(indicator){this.highlightPoints(indicator)}removeHighlights(indicator){this.resetHighlights()}destroy(){window.removeEventListener("resize",this.resize);d3.select(`#${this.containerId}`).select("svg").remove();if(this.tooltip)this.tooltip.remove()}}