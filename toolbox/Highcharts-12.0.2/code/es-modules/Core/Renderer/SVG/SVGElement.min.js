"use strict";import A from"../../Animation/AnimationUtilities.js";const{animate,animObject,stop}=A;import Color from"../../Color/Color.js";import H from"../../Globals.js";const{deg2rad,doc,svg,SVG_NS,win,isFirefox}=H;import U from"../../Utilities.js";const{addEvent,attr,createElement,crisp,css,defined,erase,extend,fireEvent,getAlignFactor,isArray,isFunction,isNumber,isObject,isString,merge,objectEach,pick,pInt,pushUnique,replaceNested,syncTimeout,uniqueKey}=U;class SVGElement{_defaultGetter(key){let ret=pick(this[key+"Value"],this[key],this.element?this.element.getAttribute(key):null,0);if(/^-?[\d\.]+$/.test(ret)){ret=parseFloat(ret)}return ret}_defaultSetter(value,key,element){element.setAttribute(key,value)}add(parent){const renderer=this.renderer,element=this.element;let inserted;if(parent){this.parentGroup=parent}if(typeof this.textStr!=="undefined"&&this.element.nodeName==="text"){renderer.buildText(this)}this.added=true;if(!parent||parent.handleZ||this.zIndex){inserted=this.zIndexSetter()}if(!inserted){(parent?parent.element:renderer.box).appendChild(element)}if(this.onAdd){this.onAdd()}return this}addClass(className,replace){const currentClassName=replace?"":this.attr("class")||"";className=(className||"").split(/ /g).reduce(function(newClassName,name){if(currentClassName.indexOf(name)===-1){newClassName.push(name)}return newClassName},currentClassName?[currentClassName]:[]).join(" ");if(className!==currentClassName){this.attr("class",className)}return this}afterSetters(){if(this.doTransform){this.updateTransform();this.doTransform=false}}align(alignOptions,alignByTranslate,alignTo,redraw=true){const attribs={},renderer=this.renderer,alignedObjects=renderer.alignedObjects,initialAlignment=Boolean(alignOptions);if(alignOptions){this.alignOptions=alignOptions;this.alignByTranslate=alignByTranslate;this.alignTo=alignTo}else{alignOptions=this.alignOptions||{};alignByTranslate=this.alignByTranslate;alignTo=this.alignTo}const alignToKey=!alignTo||isString(alignTo)?alignTo||"renderer":void 0;if(alignToKey){if(initialAlignment){pushUnique(alignedObjects,this)}alignTo=void 0}const alignToBox=pick(alignTo,renderer[alignToKey],renderer),x=(alignToBox.x||0)+(alignOptions.x||0)+((alignToBox.width||0)-(alignOptions.width||0))*getAlignFactor(alignOptions.align),y=(alignToBox.y||0)+(alignOptions.y||0)+((alignToBox.height||0)-(alignOptions.height||0))*getAlignFactor(alignOptions.verticalAlign);attribs[alignByTranslate?"translateX":"x"]=Math.round(x);attribs[alignByTranslate?"translateY":"y"]=Math.round(y);if(redraw){this[this.placed?"animate":"attr"](attribs);this.placed=true}this.alignAttr=attribs;return this}alignSetter(value){const convert={left:"start",center:"middle",right:"end"};if(convert[value]){this.alignValue=value;this.element.setAttribute("text-anchor",convert[value])}}animate(params,options,complete){const animOptions=animObject(pick(options,this.renderer.globalAnimation,true)),deferTime=animOptions.defer;if(doc.hidden){animOptions.duration=0}if(animOptions.duration!==0){if(complete){animOptions.complete=complete}syncTimeout(()=>{if(this.element){animate(this,params,animOptions)}},deferTime)}else{this.attr(params,void 0,complete||animOptions.complete);objectEach(params,function(val,prop){if(animOptions.step){animOptions.step.call(this,val,{prop:prop,pos:1,elem:this})}},this)}return this}applyTextOutline(textOutline){const elem=this.element,hasContrast=textOutline.indexOf("contrast")!==-1,styles={};if(hasContrast){styles.textOutline=textOutline=textOutline.replace(/contrast/g,this.renderer.getContrast(elem.style.fill))}const parts=textOutline.split(" ");const color=parts[parts.length-1];let strokeWidth=parts[0];if(strokeWidth&&strokeWidth!=="none"&&H.svg){this.fakeTS=true;strokeWidth=strokeWidth.replace(/(^[\d\.]+)(.*?)$/g,function(match,digit,unit){return 2*Number(digit)+unit});this.removeTextOutline();const outline=doc.createElementNS(SVG_NS,"tspan");attr(outline,{class:"highcharts-text-outline",fill:color,stroke:color,"stroke-width":strokeWidth,"stroke-linejoin":"round"});const parentElem=elem.querySelector("textPath")||elem;[].forEach.call(parentElem.childNodes,childNode=>{const clone=childNode.cloneNode(true);if(clone.removeAttribute){["fill","stroke","stroke-width","stroke"].forEach(prop=>clone.removeAttribute(prop))}outline.appendChild(clone)});let totalHeight=0;[].forEach.call(parentElem.querySelectorAll("text tspan"),element=>{totalHeight+=Number(element.getAttribute("dy"))});const br=doc.createElementNS(SVG_NS,"tspan");br.textContent="â€‹";attr(br,{x:Number(elem.getAttribute("x")),dy:-totalHeight});outline.appendChild(br);parentElem.insertBefore(outline,parentElem.firstChild)}}attr(hash,val,complete,continueAnimation){const{element}=this,symbolCustomAttribs=SVGElement.symbolCustomAttribs;let key,hasSetSymbolSize,ret=this,skipAttr,setter;if(typeof hash==="string"&&typeof val!=="undefined"){key=hash;hash={};hash[key]=val}if(typeof hash==="string"){ret=(this[hash+"Getter"]||this._defaultGetter).call(this,hash,element)}else{objectEach(hash,function eachAttribute(val,key){skipAttr=false;if(!continueAnimation){stop(this,key)}if(this.symbolName&&symbolCustomAttribs.indexOf(key)!==-1){if(!hasSetSymbolSize){this.symbolAttr(hash);hasSetSymbolSize=true}skipAttr=true}if(this.rotation&&(key==="x"||key==="y")){this.doTransform=true}if(!skipAttr){setter=this[key+"Setter"]||this._defaultSetter;setter.call(this,val,key,element)}},this);this.afterSetters()}if(complete){complete.call(this)}return ret}clip(clipElem){if(clipElem&&!clipElem.clipPath){const id=uniqueKey()+"-",clipPath=this.renderer.createElement("clipPath").attr({id:id}).add(this.renderer.defs);extend(clipElem,{clipPath:clipPath,id:id,count:0});clipElem.add(clipPath)}return this.attr("clip-path",clipElem?`url(${this.renderer.url}#${clipElem.id})`:"none")}crisp(rect,strokeWidth){strokeWidth=Math.round(strokeWidth||rect.strokeWidth||0);const x1=rect.x||this.x||0,y1=rect.y||this.y||0,x2=(rect.width||this.width||0)+x1,y2=(rect.height||this.height||0)+y1,x=crisp(x1,strokeWidth),y=crisp(y1,strokeWidth),x2Crisp=crisp(x2,strokeWidth),y2Crisp=crisp(y2,strokeWidth);extend(rect,{x:x,y:y,width:x2Crisp-x,height:y2Crisp-y});if(defined(rect.strokeWidth)){rect.strokeWidth=strokeWidth}return rect}complexColor(colorOptions,prop,elem){const renderer=this.renderer;let colorObject,gradName,gradAttr,radAttr,gradients,stops,stopColor,stopOpacity,radialReference,id,key=[],value;fireEvent(this.renderer,"complexColor",{args:arguments},function(){if(colorOptions.radialGradient){gradName="radialGradient"}else if(colorOptions.linearGradient){gradName="linearGradient"}if(gradName){gradAttr=colorOptions[gradName];gradients=renderer.gradients;stops=colorOptions.stops;radialReference=elem.radialReference;if(isArray(gradAttr)){colorOptions[gradName]=gradAttr={x1:gradAttr[0],y1:gradAttr[1],x2:gradAttr[2],y2:gradAttr[3],gradientUnits:"userSpaceOnUse"}}if(gradName==="radialGradient"&&radialReference&&!defined(gradAttr.gradientUnits)){radAttr=gradAttr;gradAttr=merge(gradAttr,renderer.getRadialAttr(radialReference,radAttr),{gradientUnits:"userSpaceOnUse"})}objectEach(gradAttr,function(value,n){if(n!=="id"){key.push(n,value)}});objectEach(stops,function(val){key.push(val)});key=key.join(",");if(gradients[key]){id=gradients[key].attr("id")}else{gradAttr.id=id=uniqueKey();const gradientObject=gradients[key]=renderer.createElement(gradName).attr(gradAttr).add(renderer.defs);gradientObject.radAttr=radAttr;gradientObject.stops=[];stops.forEach(function(stop){if(stop[1].indexOf("rgba")===0){colorObject=Color.parse(stop[1]);stopColor=colorObject.get("rgb");stopOpacity=colorObject.get("a")}else{stopColor=stop[1];stopOpacity=1}const stopObject=renderer.createElement("stop").attr({offset:stop[0],"stop-color":stopColor,"stop-opacity":stopOpacity}).add(gradientObject);gradientObject.stops.push(stopObject)})}value="url("+renderer.url+"#"+id+")";elem.setAttribute(prop,value);elem.gradient=key;colorOptions.toString=function(){return value}}})}css(styles){const oldStyles=this.styles,newStyles={},elem=this.element;let textWidth,hasNew=!oldStyles;if(oldStyles){objectEach(styles,function(value,n){if(oldStyles&&oldStyles[n]!==value){newStyles[n]=value;hasNew=true}})}if(hasNew){if(oldStyles){styles=extend(oldStyles,newStyles)}if(styles.width===null||styles.width==="auto"){delete this.textWidth}else if(elem.nodeName.toLowerCase()==="text"&&styles.width){textWidth=this.textWidth=pInt(styles.width)}extend(this.styles,styles);if(textWidth&&(!svg&&this.renderer.forExport)){delete styles.width}const fontSize=isFirefox&&styles.fontSize||null;if(fontSize&&(isNumber(fontSize)||/^\d+$/.test(fontSize))){styles.fontSize+="px"}const stylesToApply=merge(styles);if(elem.namespaceURI===this.SVG_NS){["textOutline","textOverflow","whiteSpace","width"].forEach(key=>stylesToApply&&delete stylesToApply[key]);if(stylesToApply.color){stylesToApply.fill=stylesToApply.color}}css(elem,stylesToApply)}if(this.added){if(this.element.nodeName==="text"){this.renderer.buildText(this)}if(styles.textOutline){this.applyTextOutline(styles.textOutline)}}return this}dashstyleSetter(value){let i,strokeWidth=this["stroke-width"];if(strokeWidth==="inherit"){strokeWidth=1}value=value&&value.toLowerCase();if(value){const v=value.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");i=v.length;while(i--){v[i]=""+pInt(v[i])*pick(strokeWidth,NaN)}value=v.join(",").replace(/NaN/g,"none");this.element.setAttribute("stroke-dasharray",value)}}destroy(){const wrapper=this,element=wrapper.element||{},renderer=wrapper.renderer,ownerSVGElement=element.ownerSVGElement;let parentToClean=element.nodeName==="SPAN"&&wrapper.parentGroup||void 0,grandParent,i;element.onclick=element.onmouseout=element.onmouseover=element.onmousemove=element.point=null;stop(wrapper);if(wrapper.clipPath&&ownerSVGElement){const clipPath=wrapper.clipPath;[].forEach.call(ownerSVGElement.querySelectorAll("[clip-path],[CLIP-PATH]"),function(el){if(el.getAttribute("clip-path").indexOf(clipPath.element.id)>-1){el.removeAttribute("clip-path")}});wrapper.clipPath=clipPath.destroy()}wrapper.connector=wrapper.connector?.destroy();if(wrapper.stops){for(i=0;i<wrapper.stops.length;i++){wrapper.stops[i].destroy()}wrapper.stops.length=0;wrapper.stops=void 0}wrapper.safeRemoveChild(element);while(parentToClean&&parentToClean.div&&parentToClean.div.childNodes.length===0){grandParent=parentToClean.parentGroup;wrapper.safeRemoveChild(parentToClean.div);delete parentToClean.div;parentToClean=grandParent}if(wrapper.alignOptions){erase(renderer.alignedObjects,wrapper)}objectEach(wrapper,function(val,key){if(wrapper[key]&&wrapper[key].parentGroup===wrapper&&wrapper[key].destroy){wrapper[key].destroy()}delete wrapper[key]});return}dSetter(value,key,element){if(isArray(value)){if(typeof value[0]==="string"){value=this.renderer.pathToSegments(value)}this.pathArray=value;value=value.reduce((acc,seg,i)=>{if(!seg||!seg.join){return(seg||"").toString()}return(i?acc+" ":"")+seg.join(" ")},"")}if(/(NaN| {2}|^$)/.test(value)){value="M 0 0"}if(this[key]!==value){element.setAttribute(key,value);this[key]=value}}fillSetter(value,key,element){if(typeof value==="string"){element.setAttribute(key,value)}else if(value){this.complexColor(value,key,element)}}hrefSetter(value,key,element){element.setAttributeNS("http://www.w3.org/1999/xlink",key,value)}getBBox(reload,rot){const wrapper=this,{alignValue,element,renderer,styles,textStr}=wrapper,{cache,cacheKeys}=renderer,isSVG=element.namespaceURI===wrapper.SVG_NS,rotation=pick(rot,wrapper.rotation,0),fontSize=renderer.styledMode?element&&SVGElement.prototype.getStyle.call(element,"font-size"):styles.fontSize;let bBox,height,toggleTextShadowShim,cacheKey;if(defined(textStr)){cacheKey=textStr.toString();if(cacheKey.indexOf("<")===-1){cacheKey=cacheKey.replace(/\d/g,"0")}cacheKey+=["",renderer.rootFontSize,fontSize,rotation,wrapper.textWidth,alignValue,styles.lineClamp,styles.textOverflow,styles.fontWeight].join(",")}if(cacheKey&&!reload){bBox=cache[cacheKey]}if(!bBox||bBox.polygon){if(isSVG||renderer.forExport){try{toggleTextShadowShim=this.fakeTS&&function(display){const outline=element.querySelector(".highcharts-text-outline");if(outline){css(outline,{display:display})}};if(isFunction(toggleTextShadowShim)){toggleTextShadowShim("none")}bBox=element.getBBox?extend({},element.getBBox()):{width:element.offsetWidth,height:element.offsetHeight,x:0,y:0};if(isFunction(toggleTextShadowShim)){toggleTextShadowShim("")}}catch(e){""}if(!bBox||bBox.width<0){bBox={x:0,y:0,width:0,height:0}}}else{bBox=wrapper.htmlGetBBox()}height=bBox.height;if(isSVG){bBox.height=height={"11px,17":14,"13px,20":16}[`${fontSize||""},${Math.round(height)}`]||height}if(rotation){bBox=this.getRotatedBox(bBox,rotation)}const e={bBox:bBox};fireEvent(this,"afterGetBBox",e);bBox=e.bBox}if(cacheKey&&(textStr===""||bBox.height>0)){while(cacheKeys.length>250){delete cache[cacheKeys.shift()]}if(!cache[cacheKey]){cacheKeys.push(cacheKey)}cache[cacheKey]=bBox}return bBox}getRotatedBox(box,rotation){const{x:boxX,y:boxY,width,height}=box,{alignValue,translateY,rotationOriginX=0,rotationOriginY=0}=this,alignFactor=getAlignFactor(alignValue),baseline=Number(this.element.getAttribute("y")||0)-(translateY?0:boxY),rad=rotation*deg2rad,rad90=(rotation-90)*deg2rad,cosRad=Math.cos(rad),sinRad=Math.sin(rad),wCosRad=width*cosRad,wSinRad=width*sinRad,cosRad90=Math.cos(rad90),sinRad90=Math.sin(rad90),[[xOriginCosRad,xOriginSinRad],[yOriginCosRad,yOriginSinRad]]=[rotationOriginX,rotationOriginY].map(rotOrigin=>[rotOrigin-rotOrigin*cosRad,rotOrigin*sinRad]),pX=boxX+alignFactor*(width-wCosRad)+xOriginCosRad+yOriginSinRad,pY=boxY+baseline-alignFactor*wSinRad-xOriginSinRad+yOriginCosRad,aX=pX+baseline*cosRad90,bX=aX+wCosRad,cX=bX-height*cosRad90,dX=cX-wCosRad,aY=pY+baseline*sinRad90,bY=aY+wSinRad,cY=bY-height*sinRad90,dY=cY-wSinRad;const x=Math.min(aX,bX,cX,dX),y=Math.min(aY,bY,cY,dY),boxWidth=Math.max(aX,bX,cX,dX)-x,boxHeight=Math.max(aY,bY,cY,dY)-y;return{x:x,y:y,width:boxWidth,height:boxHeight,polygon:[[aX,aY],[bX,bY],[cX,cY],[dX,dY]]}}getStyle(prop){return win.getComputedStyle(this.element||this,"").getPropertyValue(prop)}hasClass(className){return(""+this.attr("class")).split(" ").indexOf(className)!==-1}hide(){return this.attr({visibility:"hidden"})}htmlGetBBox(){return{height:0,width:0,x:0,y:0}}constructor(renderer,nodeName){this.onEvents={};this.opacity=1;this.SVG_NS=SVG_NS;this.element=nodeName==="span"||nodeName==="body"?createElement(nodeName):doc.createElementNS(this.SVG_NS,nodeName);this.renderer=renderer;this.styles={};fireEvent(this,"afterInit")}on(eventType,handler){const{onEvents}=this;if(onEvents[eventType]){onEvents[eventType]()}onEvents[eventType]=addEvent(this.element,eventType,handler);return this}opacitySetter(value,key,element){const opacity=Number(Number(value).toFixed(3));this.opacity=opacity;element.setAttribute(key,opacity)}reAlign(){if(this.alignOptions?.width&&this.alignOptions.align!=="left"){this.alignOptions.width=this.getBBox().width;this.placed=false;this.align()}}removeClass(className){return this.attr("class",(""+this.attr("class")).replace(isString(className)?new RegExp(`(^| )${className}( |$)`):className," ").replace(/ +/g," ").trim())}removeTextOutline(){const outline=this.element.querySelector("tspan.highcharts-text-outline");if(outline){this.safeRemoveChild(outline)}}safeRemoveChild(element){const parentNode=element.parentNode;if(parentNode){parentNode.removeChild(element)}}setRadialReference(coordinates){const existingGradient=this.element.gradient&&this.renderer.gradients[this.element.gradient];this.element.radialReference=coordinates;if(existingGradient&&existingGradient.radAttr){existingGradient.animate(this.renderer.getRadialAttr(coordinates,existingGradient.radAttr))}return this}shadow(shadowOptions){const{renderer}=this,options=merge(this.parentGroup?.rotation===90?{offsetX:-1,offsetY:-1}:{},isObject(shadowOptions)?shadowOptions:{}),id=renderer.shadowDefinition(options);return this.attr({filter:shadowOptions?`url(${renderer.url}#${id})`:"none"})}show(inherit=true){return this.attr({visibility:inherit?"inherit":"visible"})}"stroke-widthSetter"(value,key,element){this[key]=value;element.setAttribute(key,value)}strokeWidth(){if(!this.renderer.styledMode){return this["stroke-width"]||0}const val=this.getStyle("stroke-width");let ret=0,tempElement;if(/px$/.test(val)){ret=pInt(val)}else if(val!==""){tempElement=doc.createElementNS(SVG_NS,"rect");attr(tempElement,{width:val,"stroke-width":0});this.element.parentNode.appendChild(tempElement);ret=tempElement.getBBox().width;tempElement.parentNode.removeChild(tempElement)}return ret}symbolAttr(hash){const wrapper=this;SVGElement.symbolCustomAttribs.forEach(function(key){wrapper[key]=pick(hash[key],wrapper[key])});wrapper.attr({d:wrapper.renderer.symbols[wrapper.symbolName](wrapper.x,wrapper.y,wrapper.width,wrapper.height,wrapper)})}textSetter(value){if(value!==this.textStr){delete this.textPxLength;this.textStr=value;if(this.added){this.renderer.buildText(this)}this.reAlign()}}titleSetter(value){const el=this.element;const titleNode=el.getElementsByTagName("title")[0]||doc.createElementNS(this.SVG_NS,"title");if(el.insertBefore){el.insertBefore(titleNode,el.firstChild)}else{el.appendChild(titleNode)}titleNode.textContent=replaceNested(pick(value,""),[/<[^>]*>/g,""]).replace(/&lt;/g,"<").replace(/&gt;/g,">")}toFront(){const element=this.element;element.parentNode.appendChild(element);return this}translate(x,y){return this.attr({translateX:x,translateY:y})}updateTransform(attrib="transform"){const{element,matrix,rotation=0,rotationOriginX,rotationOriginY,scaleX,scaleY,translateX=0,translateY=0}=this;const transform=["translate("+translateX+","+translateY+")"];if(defined(matrix)){transform.push("matrix("+matrix.join(",")+")")}if(rotation){transform.push("rotate("+rotation+" "+pick(rotationOriginX,element.getAttribute("x"),0)+" "+pick(rotationOriginY,element.getAttribute("y")||0)+")");if(this.text?.element.tagName==="SPAN"){this.text.attr({rotation:rotation,rotationOriginX:(rotationOriginX||0)-this.padding,rotationOriginY:(rotationOriginY||0)-this.padding})}}if(defined(scaleX)||defined(scaleY)){transform.push("scale("+pick(scaleX,1)+" "+pick(scaleY,1)+")")}if(transform.length&&!(this.text||this).textPath){element.setAttribute(attrib,transform.join(" "))}}visibilitySetter(value,key,element){if(value==="inherit"){element.removeAttribute(key)}else if(this[key]!==value){element.setAttribute(key,value)}this[key]=value}xGetter(key){if(this.element.nodeName==="circle"){if(key==="x"){key="cx"}else if(key==="y"){key="cy"}}return this._defaultGetter(key)}zIndexSetter(value,key){const renderer=this.renderer,parentGroup=this.parentGroup,parentWrapper=parentGroup||renderer,parentNode=parentWrapper.element||renderer.box,element=this.element,svgParent=parentNode===renderer.box;let childNodes,otherElement,otherZIndex,inserted=false,undefinedOtherZIndex,run=this.added,i;if(defined(value)){element.setAttribute("data-z-index",value);value=+value;if(this[key]===value){run=false}}else if(defined(this[key])){element.removeAttribute("data-z-index")}this[key]=value;if(run){value=this.zIndex;if(value&&parentGroup){parentGroup.handleZ=true}childNodes=parentNode.childNodes;for(i=childNodes.length-1;i>=0&&!inserted;i--){otherElement=childNodes[i];otherZIndex=otherElement.getAttribute("data-z-index");undefinedOtherZIndex=!defined(otherZIndex);if(otherElement!==element){if(value<0&&undefinedOtherZIndex&&!svgParent&&!i){parentNode.insertBefore(element,childNodes[i]);inserted=true}else if(pInt(otherZIndex)<=value||undefinedOtherZIndex&&(!defined(value)||value>=0)){parentNode.insertBefore(element,childNodes[i+1]);inserted=true}}}if(!inserted){parentNode.insertBefore(element,childNodes[svgParent?3:0]);inserted=true}}return inserted}}SVGElement.symbolCustomAttribs=["anchorX","anchorY","clockwise","end","height","innerR","r","start","width","x","y"];SVGElement.prototype.strokeSetter=SVGElement.prototype.fillSetter;SVGElement.prototype.yGetter=SVGElement.prototype.xGetter;SVGElement.prototype.matrixSetter=SVGElement.prototype.rotationOriginXSetter=SVGElement.prototype.rotationOriginYSetter=SVGElement.prototype.rotationSetter=SVGElement.prototype.scaleXSetter=SVGElement.prototype.scaleYSetter=SVGElement.prototype.translateXSetter=SVGElement.prototype.translateYSetter=SVGElement.prototype.verticalAlignSetter=function(value,key){this[key]=value;this.doTransform=true};export default SVGElement;"";