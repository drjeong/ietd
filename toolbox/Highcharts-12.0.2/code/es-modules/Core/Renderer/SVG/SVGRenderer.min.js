"use strict";import AST from"../HTML/AST.js";import D from"../../Defaults.js";const{defaultOptions}=D;import Color from"../../Color/Color.js";import H from"../../Globals.js";const{charts,deg2rad,doc,isFirefox,isMS,isWebKit,noop,SVG_NS,symbolSizes,win}=H;import RendererRegistry from"../RendererRegistry.js";import SVGElement from"./SVGElement.js";import SVGLabel from"./SVGLabel.js";import Symbols from"./Symbols.js";import TextBuilder from"./TextBuilder.js";import U from"../../Utilities.js";const{addEvent,attr,createElement,crisp,css,defined,destroyObjectProperties,extend,isArray,isNumber,isObject,isString,merge,pick,pInt,replaceNested,uniqueKey}=U;let hasInternalReferenceBug;class SVGRenderer{constructor(container,width,height,style,forExport,allowHTML,styledMode){const renderer=this,boxWrapper=renderer.createElement("svg").attr({version:"1.1",class:"highcharts-root"}),element=boxWrapper.element;if(!styledMode){boxWrapper.css(this.getStyle(style||{}))}container.appendChild(element);attr(container,"dir","ltr");if(container.innerHTML.indexOf("xmlns")===-1){attr(element,"xmlns",this.SVG_NS)}this.box=element;this.boxWrapper=boxWrapper;this.alignedObjects=[];this.url=this.getReferenceURL();const desc=this.createElement("desc").add();desc.element.appendChild(doc.createTextNode("Created with @product.name@ @product.version@"));this.defs=this.createElement("defs").add();this.allowHTML=allowHTML;this.forExport=forExport;this.styledMode=styledMode;this.gradients={};this.cache={};this.cacheKeys=[];this.imgCount=0;this.rootFontSize=boxWrapper.getStyle("font-size");renderer.setSize(width,height,false);let subPixelFix,rect;if(isFirefox&&container.getBoundingClientRect){subPixelFix=function(){css(container,{left:0,top:0});rect=container.getBoundingClientRect();css(container,{left:Math.ceil(rect.left)-rect.left+"px",top:Math.ceil(rect.top)-rect.top+"px"})};subPixelFix();renderer.unSubPixelFix=addEvent(win,"resize",subPixelFix)}}definition(def){const ast=new AST([def]);return ast.addToDOM(this.defs.element)}getReferenceURL(){if((isFirefox||isWebKit)&&doc.getElementsByTagName("base").length){if(!defined(hasInternalReferenceBug)){const id=uniqueKey();const ast=new AST([{tagName:"svg",attributes:{width:8,height:8},children:[{tagName:"defs",children:[{tagName:"clipPath",attributes:{id:id},children:[{tagName:"rect",attributes:{width:4,height:4}}]}]},{tagName:"rect",attributes:{id:"hitme",width:8,height:8,"clip-path":`url(#${id})`,fill:"rgba(0,0,0,0.001)"}}]}]);const svg=ast.addToDOM(doc.body);css(svg,{position:"fixed",top:0,left:0,zIndex:9e5});const hitElement=doc.elementFromPoint(6,6);hasInternalReferenceBug=(hitElement&&hitElement.id)==="hitme";doc.body.removeChild(svg)}if(hasInternalReferenceBug){return replaceNested(win.location.href.split("#")[0],[/<[^>]*>/g,""],[/([\('\)])/g,"\\$1"],[/ /g,"%20"])}}return""}getStyle(style){this.style=extend({fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", '+'Roboto, Helvetica, Arial, "Apple Color Emoji", '+'"Segoe UI Emoji", "Segoe UI Symbol", sans-serif',fontSize:"1rem"},style);return this.style}setStyle(style){this.boxWrapper.css(this.getStyle(style))}isHidden(){return!this.boxWrapper.getBBox().width}destroy(){const renderer=this,rendererDefs=renderer.defs;renderer.box=null;renderer.boxWrapper=renderer.boxWrapper.destroy();destroyObjectProperties(renderer.gradients||{});renderer.gradients=null;renderer.defs=rendererDefs.destroy();if(renderer.unSubPixelFix){renderer.unSubPixelFix()}renderer.alignedObjects=null;return null}createElement(nodeName){return new this.Element(this,nodeName)}getRadialAttr(radialReference,gradAttr){return{cx:radialReference[0]-radialReference[2]/2+(gradAttr.cx||0)*radialReference[2],cy:radialReference[1]-radialReference[2]/2+(gradAttr.cy||0)*radialReference[2],r:(gradAttr.r||0)*radialReference[2]}}shadowDefinition(shadowOptions){const id=[`highcharts-drop-shadow-${this.chartIndex}`,...Object.keys(shadowOptions).map(key=>`${key}-${shadowOptions[key]}`)].join("-").toLowerCase().replace(/[^a-z\d\-]/g,""),options=merge({color:"#000000",offsetX:1,offsetY:1,opacity:.15,width:5},shadowOptions);if(!this.defs.element.querySelector(`#${id}`)){this.definition({tagName:"filter",attributes:{id:id,filterUnits:options.filterUnits},children:this.getShadowFilterContent(options)})}return id}getShadowFilterContent(options){return[{tagName:"feDropShadow",attributes:{dx:options.offsetX,dy:options.offsetY,"flood-color":options.color,"flood-opacity":Math.min(options.opacity*5,1),stdDeviation:options.width/2}}]}buildText(wrapper){new TextBuilder(wrapper).buildSVG()}getContrast(color){const rgba=Color.parse(color).rgba.map(b8=>{const c=b8/255;return c<=.03928?c/12.92:Math.pow((c+.055)/1.055,2.4)});const l=.2126*rgba[0]+.7152*rgba[1]+.0722*rgba[2];return 1.05/(l+.05)>(l+.05)/.05?"#FFFFFF":"#000000"}button(text,x,y,callback,theme={},hoverState,selectState,disabledState,shape,useHTML){const label=this.label(text,x,y,shape,void 0,void 0,useHTML,void 0,"button"),styledMode=this.styledMode,args=arguments;let curState=0;theme=merge(defaultOptions.global.buttonTheme,theme);if(styledMode){delete theme.fill;delete theme.stroke;delete theme["stroke-width"]}const states=theme.states||{},normalStyle=theme.style||{};delete theme.states;delete theme.style;const stateAttribs=[AST.filterUserAttributes(theme)],stateStyles=[normalStyle];if(!styledMode){["hover","select","disabled"].forEach((stateName,i)=>{stateAttribs.push(merge(stateAttribs[0],AST.filterUserAttributes(args[i+5]||states[stateName]||{})));stateStyles.push(stateAttribs[i+1].style);delete stateAttribs[i+1].style})}addEvent(label.element,isMS?"mouseover":"mouseenter",function(){if(curState!==3){label.setState(1)}});addEvent(label.element,isMS?"mouseout":"mouseleave",function(){if(curState!==3){label.setState(curState)}});label.setState=(state=0)=>{if(state!==1){label.state=curState=state}label.removeClass(/highcharts-button-(normal|hover|pressed|disabled)/).addClass("highcharts-button-"+["normal","hover","pressed","disabled"][state]);if(!styledMode){label.attr(stateAttribs[state]);const css=stateStyles[state];if(isObject(css)){label.css(css)}}};label.attr(stateAttribs[0]);if(!styledMode){label.css(extend({cursor:"default"},normalStyle));if(useHTML){label.text.css({pointerEvents:"none"})}}return label.on("touchstart",e=>e.stopPropagation()).on("click",function(e){if(curState!==3){callback.call(label,e)}})}crispLine(points,width){const[start,end]=points;if(defined(start[1])&&start[1]===end[1]){start[1]=end[1]=crisp(start[1],width)}if(defined(start[2])&&start[2]===end[2]){start[2]=end[2]=crisp(start[2],width)}return points}path(path){const attribs=this.styledMode?{}:{fill:"none"};if(isArray(path)){attribs.d=path}else if(isObject(path)){extend(attribs,path)}return this.createElement("path").attr(attribs)}circle(x,y,r){const attribs=isObject(x)?x:typeof x==="undefined"?{}:{x:x,y:y,r:r},wrapper=this.createElement("circle");wrapper.xSetter=wrapper.ySetter=function(value,key,element){element.setAttribute("c"+key,value)};return wrapper.attr(attribs)}arc(x,y,r,innerR,start,end){let options;if(isObject(x)){options=x;y=options.y;r=options.r;innerR=options.innerR;start=options.start;end=options.end;x=options.x}else{options={innerR:innerR,start:start,end:end}}const arc=this.symbol("arc",x,y,r,r,options);arc.r=r;return arc}rect(x,y,width,height,r,strokeWidth){const attribs=isObject(x)?x:typeof x==="undefined"?{}:{x:x,y:y,r:r,width:Math.max(width||0,0),height:Math.max(height||0,0)},wrapper=this.createElement("rect");if(!this.styledMode){if(typeof strokeWidth!=="undefined"){attribs["stroke-width"]=strokeWidth;extend(attribs,wrapper.crisp(attribs))}attribs.fill="none"}wrapper.rSetter=function(value,_key,element){wrapper.r=value;attr(element,{rx:value,ry:value})};wrapper.rGetter=function(){return wrapper.r||0};return wrapper.attr(attribs)}roundedRect(attribs){return this.symbol("roundedRect").attr(attribs)}setSize(width,height,animate){const renderer=this;renderer.width=width;renderer.height=height;renderer.boxWrapper.animate({width:width,height:height},{step:function(){this.attr({viewBox:"0 0 "+this.attr("width")+" "+this.attr("height")})},duration:pick(animate,true)?void 0:0});renderer.alignElements()}g(name){const elem=this.createElement("g");return name?elem.attr({class:"highcharts-"+name}):elem}image(href,x,y,width,height,onload){const attribs={preserveAspectRatio:"none"};if(isNumber(x)){attribs.x=x}if(isNumber(y)){attribs.y=y}if(isNumber(width)){attribs.width=width}if(isNumber(height)){attribs.height=height}const elemWrapper=this.createElement("image").attr(attribs),onDummyLoad=function(e){elemWrapper.attr({href:href});onload.call(elemWrapper,e)};if(onload){elemWrapper.attr({href:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="});const dummy=new win.Image;addEvent(dummy,"load",onDummyLoad);dummy.src=href;if(dummy.complete){onDummyLoad({})}}else{elemWrapper.attr({href:href})}return elemWrapper}symbol(symbol,x,y,width,height,options){const ren=this,imageRegex=/^url\((.*?)\)$/,isImage=imageRegex.test(symbol),sym=!isImage&&(this.symbols[symbol]?symbol:"circle"),symbolFn=sym&&this.symbols[sym];let obj,path,imageSrc,centerImage;if(symbolFn){if(typeof x==="number"){path=symbolFn.call(this.symbols,x||0,y||0,width||0,height||0,options)}obj=this.path(path);if(!ren.styledMode){obj.attr("fill","none")}extend(obj,{symbolName:sym||void 0,x:x,y:y,width:width,height:height});if(options){extend(obj,options)}}else if(isImage){imageSrc=symbol.match(imageRegex)[1];const img=obj=this.image(imageSrc);img.imgwidth=pick(options&&options.width,symbolSizes[imageSrc]&&symbolSizes[imageSrc].width);img.imgheight=pick(options&&options.height,symbolSizes[imageSrc]&&symbolSizes[imageSrc].height);centerImage=obj=>obj.attr({width:obj.width,height:obj.height});["width","height"].forEach(key=>{img[`${key}Setter`]=function(value,key){this[key]=value;const{alignByTranslate,element,width,height,imgwidth,imgheight}=this,imgSize=key==="width"?imgwidth:imgheight;let scale=1;if(options&&options.backgroundSize==="within"&&width&&height&&imgwidth&&imgheight){scale=Math.min(width/imgwidth,height/imgheight);attr(element,{width:Math.round(imgwidth*scale),height:Math.round(imgheight*scale)})}else if(element&&imgSize){element.setAttribute(key,imgSize)}if(!alignByTranslate&&imgwidth&&imgheight){this.translate(((width||0)-imgwidth*scale)/2,((height||0)-imgheight*scale)/2)}}});if(defined(x)){img.attr({x:x,y:y})}img.isImg=true;img.symbolUrl=symbol;if(defined(img.imgwidth)&&defined(img.imgheight)){centerImage(img)}else{img.attr({width:0,height:0});createElement("img",{onload:function(){const chart=charts[ren.chartIndex];if(this.width===0){css(this,{position:"absolute",top:"-999em"});doc.body.appendChild(this)}symbolSizes[imageSrc]={width:this.width,height:this.height};img.imgwidth=this.width;img.imgheight=this.height;if(img.element){centerImage(img)}if(this.parentNode){this.parentNode.removeChild(this)}ren.imgCount--;if(!ren.imgCount&&chart&&!chart.hasLoaded){chart.onload()}},src:imageSrc});this.imgCount++}}return obj}clipRect(x,y,width,height){return this.rect(x,y,width,height,0)}text(str,x,y,useHTML){const renderer=this,attribs={};if(useHTML&&(renderer.allowHTML||!renderer.forExport)){return renderer.html(str,x,y)}attribs.x=Math.round(x||0);if(y){attribs.y=Math.round(y)}if(defined(str)){attribs.text=str}const wrapper=renderer.createElement("text").attr(attribs);if(!useHTML||renderer.forExport&&!renderer.allowHTML){wrapper.xSetter=function(value,key,element){const tspans=element.getElementsByTagName("tspan"),parentVal=element.getAttribute(key);for(let i=0,tspan;i<tspans.length;i++){tspan=tspans[i];if(tspan.getAttribute(key)===parentVal){tspan.setAttribute(key,value)}}element.setAttribute(key,value)}}return wrapper}fontMetrics(element){const f=pInt(SVGElement.prototype.getStyle.call(element,"font-size")||0);const h=f<24?f+3:Math.round(f*1.2),b=Math.round(h*.8);return{h:h,b:b,f:f}}rotCorr(baseline,rotation,alterY){let y=baseline;if(rotation&&alterY){y=Math.max(y*Math.cos(rotation*deg2rad),4)}return{x:-baseline/3*Math.sin(rotation*deg2rad),y:y}}pathToSegments(path){const ret=[];const segment=[];const commandLength={A:8,C:7,H:2,L:3,M:3,Q:5,S:5,T:3,V:2};for(let i=0;i<path.length;i++){if(isString(segment[0])&&isNumber(path[i])&&segment.length===commandLength[segment[0].toUpperCase()]){path.splice(i,0,segment[0].replace("M","L").replace("m","l"))}if(typeof path[i]==="string"){if(segment.length){ret.push(segment.slice(0))}segment.length=0}segment.push(path[i])}ret.push(segment.slice(0));return ret}label(str,x,y,shape,anchorX,anchorY,useHTML,baseline,className){return new SVGLabel(this,str,x,y,shape,anchorX,anchorY,useHTML,baseline,className)}alignElements(){this.alignedObjects.forEach(el=>el.align())}}extend(SVGRenderer.prototype,{Element:SVGElement,SVG_NS:SVG_NS,escapes:{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},symbols:Symbols,draw:noop});RendererRegistry.registerRendererType("svg",SVGRenderer,true);export default SVGRenderer;"";