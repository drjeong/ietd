"use strict";import AST from"./AST.js";import H from"../../Globals.js";const{composed}=H;import SVGElement from"../SVG/SVGElement.js";import U from"../../Utilities.js";const{attr,css,createElement,defined,extend,getAlignFactor,isNumber,pInt,pushUnique}=U;function commonSetter(value,key,elem){const style=this.div?.style||elem.style;SVGElement.prototype[`${key}Setter`].call(this,value,key,elem);if(style){style[key]=value}}const decorateSVGGroup=(g,container)=>{if(!g.div){const className=attr(g.element,"class"),cssProto=g.css;const div=createElement("div",className?{className:className}:void 0,{position:"absolute",left:`${g.translateX||0}px`,top:`${g.translateY||0}px`,...g.styles,display:g.display,opacity:g.opacity,visibility:g.visibility},g.parentGroup?.div||container);g.classSetter=(value,key,element)=>{element.setAttribute("class",value);div.className=value};g.translateXSetter=g.translateYSetter=(value,key)=>{g[key]=value;div.style[key==="translateX"?"left":"top"]=`${value}px`;g.doTransform=true};g.opacitySetter=g.visibilitySetter=commonSetter;g.css=styles=>{cssProto.call(g,styles);if(styles.cursor){div.style.cursor=styles.cursor}if(styles.pointerEvents){div.style.pointerEvents=styles.pointerEvents}return g};g.on=function(){SVGElement.prototype.on.apply({element:div,onEvents:g.onEvents},arguments);return g};g.div=div}return g.div};class HTMLElement extends SVGElement{static compose(SVGRendererClass){if(pushUnique(composed,this.compose)){SVGRendererClass.prototype.html=function(str,x,y){return new HTMLElement(this,"span").attr({text:str,x:Math.round(x),y:Math.round(y)})}}}constructor(renderer,nodeName){super(renderer,nodeName);this.css({position:"absolute",...renderer.styledMode?{}:{fontFamily:renderer.style.fontFamily,fontSize:renderer.style.fontSize}})}getSpanCorrection(width,baseline,alignCorrection){this.xCorr=-width*alignCorrection;this.yCorr=-baseline}css(styles){const{element}=this,isSettingWidth=element.tagName==="SPAN"&&styles&&"width"in styles,textWidth=isSettingWidth&&styles.width;let doTransform;if(isSettingWidth){delete styles.width;this.textWidth=pInt(textWidth)||void 0;doTransform=true}if(styles?.textOverflow==="ellipsis"){styles.overflow="hidden"}if(styles?.lineClamp){styles.display="-webkit-box";styles.WebkitLineClamp=styles.lineClamp;styles.WebkitBoxOrient="vertical";styles.overflow="hidden"}if(isNumber(Number(styles?.fontSize))){styles.fontSize=styles.fontSize+"px"}extend(this.styles,styles);css(element,styles);if(doTransform){this.updateTransform()}return this}htmlGetBBox(){const{element}=this;return{x:element.offsetLeft,y:element.offsetTop,width:element.offsetWidth,height:element.offsetHeight}}updateTransform(){if(!this.added){this.alignOnAdd=true;return}const{element,renderer,rotation,rotationOriginX,rotationOriginY,scaleX,scaleY,styles,textAlign="left",textWidth,translateX=0,translateY=0,x=0,y=0}=this,{display="block",whiteSpace}=styles;const getTextPxLength=()=>{if(this.textPxLength){return this.textPxLength}css(element,{width:"",whiteSpace:whiteSpace||"nowrap"});return element.offsetWidth};css(element,{marginLeft:`${translateX}px`,marginTop:`${translateY}px`});if(element.tagName==="SPAN"){const currentTextTransform=[rotation,textAlign,element.innerHTML,textWidth,this.textAlign].join(","),parentPadding=this.parentGroup?.padding*-1||0;let baseline,hasBoxWidthChanged=false;if(textWidth!==this.oldTextWidth){const textPxLength=getTextPxLength(),textWidthNum=textWidth||0;if((textWidthNum>this.oldTextWidth||textPxLength>textWidthNum)&&(/[ \-]/.test(element.textContent||element.innerText)||element.style.textOverflow==="ellipsis")){css(element,{width:textPxLength>textWidthNum||rotation||scaleX?textWidth+"px":"auto",display:display,whiteSpace:whiteSpace||"normal"});this.oldTextWidth=textWidth;hasBoxWidthChanged=true}}this.hasBoxWidthChanged=hasBoxWidthChanged;if(currentTextTransform!==this.cTT){baseline=renderer.fontMetrics(element).b;if(defined(rotation)&&(rotation!==(this.oldRotation||0)||textAlign!==this.oldAlign)){this.setSpanRotation(rotation,parentPadding,parentPadding)}this.getSpanCorrection(!defined(rotation)&&!this.textWidth&&this.textPxLength||element.offsetWidth,baseline,getAlignFactor(textAlign))}const{xCorr=0,yCorr=0}=this,rotOriginX=(rotationOriginX??x)-xCorr-x-parentPadding,rotOriginY=(rotationOriginY??y)-yCorr-y-parentPadding,styles={left:`${x+xCorr}px`,top:`${y+yCorr}px`,textAlign:textAlign,transformOrigin:`${rotOriginX}px ${rotOriginY}px`};if(scaleX||scaleY){styles.transform=`scale(${scaleX??1},${scaleY??1})`}css(element,styles);this.cTT=currentTextTransform;this.oldRotation=rotation;this.oldAlign=textAlign}}setSpanRotation(rotation,originX,originY){css(this.element,{transform:`rotate(${rotation}deg)`,transformOrigin:`${originX}% ${originY}px`})}add(parentGroup){const container=this.renderer.box.parentNode,parents=[];let div;this.parentGroup=parentGroup;if(parentGroup){div=parentGroup.div;if(!div){let svgGroup=parentGroup;while(svgGroup){parents.push(svgGroup);svgGroup=svgGroup.parentGroup}for(const parentGroup of parents.reverse()){div=decorateSVGGroup(parentGroup,container)}}}(div||container).appendChild(this.element);this.added=true;if(this.alignOnAdd){this.updateTransform()}return this}textSetter(value){if(value!==this.textStr){delete this.bBox;delete this.oldTextWidth;AST.setElementHTML(this.element,value??"");this.textStr=value;this.doTransform=true}}alignSetter(value){this.alignValue=this.textAlign=value;this.doTransform=true}xSetter(value,key){this[key]=value;this.doTransform=true}}const proto=HTMLElement.prototype;proto.visibilitySetter=proto.opacitySetter=commonSetter;proto.ySetter=proto.rotationSetter=proto.rotationOriginXSetter=proto.rotationOriginYSetter=proto.xSetter;export default HTMLElement;