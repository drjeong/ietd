"use strict";import U from"../Utilities.js";const{clamp,pick,pushUnique,stableSort}=U;var RendererUtilities;(function(RendererUtilities){function distribute(boxes,len,maxDistance){const origBoxes=boxes,reducedLen=origBoxes.reducedLen||len,sortByRank=(a,b)=>(b.rank||0)-(a.rank||0),sortByTarget=(a,b)=>a.target-b.target,restBoxes=[],boxesLength=boxes.length,forDeletion=[],push=restBoxes.push;let i,cursor,step,overlapping=true,box,target,total=0,equalRank;i=boxesLength;while(i--){total+=boxes[i].size}if(total>reducedLen){stableSort(boxes,sortByRank);equalRank=boxes[0].rank===boxes[boxes.length-1].rank;step=equalRank?boxesLength/2:-1;cursor=equalRank?step:boxesLength-1;while(step&&total>reducedLen){i=Math.floor(cursor);box=boxes[i];if(pushUnique(forDeletion,i)){total-=box.size}cursor+=step;if(equalRank&&cursor>=boxes.length){step/=2;cursor=step}}forDeletion.sort((a,b)=>b-a).forEach(i=>push.apply(restBoxes,boxes.splice(i,1)))}stableSort(boxes,sortByTarget);boxes=boxes.map(box=>({size:box.size,targets:[box.target],align:pick(box.align,.5)}));while(overlapping){i=boxes.length;while(i--){box=boxes[i];target=(Math.min.apply(0,box.targets)+Math.max.apply(0,box.targets))/2;box.pos=clamp(target-box.size*box.align,0,len-box.size)}i=boxes.length;overlapping=false;while(i--){if(i>0&&boxes[i-1].pos+boxes[i-1].size>boxes[i].pos){boxes[i-1].size+=boxes[i].size;boxes[i-1].targets=boxes[i-1].targets.concat(boxes[i].targets);boxes[i-1].align=.5;if(boxes[i-1].pos+boxes[i-1].size>len){boxes[i-1].pos=len-boxes[i-1].size}boxes.splice(i,1);overlapping=true}}}push.apply(origBoxes,restBoxes);i=0;boxes.some(box=>{let posInCompositeBox=0;return(box.targets||[]).some(()=>{origBoxes[i].pos=box.pos+posInCompositeBox;if(typeof maxDistance!=="undefined"&&Math.abs(origBoxes[i].pos-origBoxes[i].target)>maxDistance){origBoxes.slice(0,i+1).forEach(box=>delete box.pos);origBoxes.reducedLen=(origBoxes.reducedLen||len)-len*.1;if(origBoxes.reducedLen>len*.1){distribute(origBoxes,len,maxDistance)}return true}posInCompositeBox+=origBoxes[i].size;i++;return false})});stableSort(origBoxes,sortByTarget);return origBoxes}RendererUtilities.distribute=distribute})(RendererUtilities||(RendererUtilities={}));export default RendererUtilities;