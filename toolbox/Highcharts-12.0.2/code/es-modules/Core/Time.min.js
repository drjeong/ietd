"use strict";import H from"./Globals.js";const{win}=H;import U from"./Utilities.js";const{defined,error,extend,isNumber,isObject,isString,merge,objectEach,pad,splat,timeUnits,ucfirst}=U;const hasOldSafariBug=H.isSafari&&win.Intl&&!win.Intl.DateTimeFormat.prototype.formatRange;const isDateTimeFormatOptions=obj=>obj.main===void 0;const spanishWeekdayIndex=weekday=>["D","L","M","X","J","V","S"].indexOf(weekday);class Time{constructor(options){this.options={};this.variableTimezone=false;this.Date=win.Date;this.update(options)}update(options={}){let timezone=options.timezone??"UTC";this.dTLCache={};this.options=options=merge(true,this.options,options);const{timezoneOffset,useUTC}=options;this.Date=options.Date||win.Date||Date;if(defined(useUTC)){timezone=useUTC?"UTC":void 0}if(timezoneOffset&&timezoneOffset%60===0){timezone="Etc/GMT"+(timezoneOffset>0?"+":"")+timezoneOffset/60}this.variableTimezone=timezone!=="UTC"&&timezone?.indexOf("Etc/GMT")!==0;this.timezone=timezone;["months","shortMonths","weekdays","shortWeekdays"].forEach(name=>{const isMonth=/months/i.test(name),isShort=/short/.test(name),options={timeZone:"UTC"};options[isMonth?"month":"weekday"]=isShort?"short":"long";this[name]=(isMonth?[0,1,2,3,4,5,6,7,8,9,10,11]:[3,4,5,6,7,8,9]).map(position=>this.dateFormat(options,(isMonth?31:1)*24*36e5*position))})}toParts(timestamp){const[weekday,dayOfMonth,month,year,hours,minutes,seconds]=this.dateTimeFormat({weekday:"narrow",day:"numeric",month:"numeric",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"},timestamp,"es").split(/(?:, |\/|:)/g);return[year,+month-1,dayOfMonth,hours,minutes,seconds,Math.floor(Number(timestamp)||0)%1e3,spanishWeekdayIndex(weekday)].map(Number)}dateTimeFormat(options,timestamp,locale=this.options.locale){const cacheKey=JSON.stringify(options)+locale;if(isString(options)){options=this.str2dtf(options)}let dTL=this.dTLCache[cacheKey];if(!dTL){options.timeZone??(options.timeZone=this.timezone);try{dTL=new Intl.DateTimeFormat(locale,options)}catch(e){if(/Invalid time zone/i.test(e.message)){error(34);options.timeZone="UTC";dTL=new Intl.DateTimeFormat(locale,options)}else{error(e.message,false)}}}this.dTLCache[cacheKey]=dTL;return dTL?.format(timestamp)||""}str2dtf(s,dtf={}){const mapping={L:{fractionalSecondDigits:3},S:{second:"2-digit"},M:{minute:"numeric"},H:{hour:"2-digit"},k:{hour:"numeric"},E:{weekday:"narrow"},a:{weekday:"short"},A:{weekday:"long"},d:{day:"2-digit"},e:{day:"numeric"},b:{month:"short"},B:{month:"long"},m:{month:"2-digit"},o:{month:"numeric"},y:{year:"2-digit"},Y:{year:"numeric"}};Object.keys(mapping).forEach(key=>{if(s.indexOf(key)!==-1){extend(dtf,mapping[key])}});return dtf}makeTime(year,month,date=1,hours=0,minutes,seconds,milliseconds){let d=this.Date.UTC(year,month,date,hours,minutes||0,seconds||0,milliseconds||0);if(this.timezone!=="UTC"){const offset=this.getTimezoneOffset(d);d+=offset;if([2,3,8,9,10,11].indexOf(month)!==-1&&(hours<5||hours>20)){const newOffset=this.getTimezoneOffset(d);if(offset!==newOffset){d+=newOffset-offset}else if(offset-36e5===this.getTimezoneOffset(d-36e5)&&!hasOldSafariBug){d-=36e5}}}return d}parse(s){if(!isString(s)){return s??void 0}s=s.replace(/\//g,"-").replace(/(GMT|UTC)/,"");const hasTimezone=s.indexOf("Z")>-1||/([+-][0-9]{2}):?[0-9]{2}$/.test(s),isYYYYMMDD=/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(s);if(!hasTimezone&&!isYYYYMMDD){s+="Z"}const ts=Date.parse(s);if(isNumber(ts)){return ts+(!hasTimezone||isYYYYMMDD?this.getTimezoneOffset(ts):0)}}getTimezoneOffset(timestamp){if(this.timezone!=="UTC"){const[date,gmt,hours,colon,minutes=0]=this.dateTimeFormat({timeZoneName:"shortOffset"},timestamp,"en").split(/(GMT|:)/).map(Number),offset=-(hours+minutes/60)*60*6e4;if(isNumber(offset)){return offset}}return 0}dateFormat(format,timestamp,upperCaseFirst){const lang=H.defaultOptions?.lang;if(!defined(timestamp)||isNaN(timestamp)){return lang?.invalidDate||""}format=format??"%Y-%m-%d %H:%M:%S";if(isString(format)){const localeAwareRegex=/%\[([a-zA-Z]+)\]/g;let match;while(match=localeAwareRegex.exec(format)){format=format.replace(match[0],this.dateTimeFormat(match[1],timestamp))}}if(isString(format)&&format.indexOf("%")!==-1){const time=this,[fullYear,month,dayOfMonth,hours,minutes,seconds,milliseconds,weekday]=this.toParts(timestamp),langWeekdays=lang?.weekdays||this.weekdays,shortWeekdays=lang?.shortWeekdays||this.shortWeekdays,months=lang?.months||this.months,shortMonths=lang?.shortMonths||this.shortMonths,replacements=extend({a:shortWeekdays?shortWeekdays[weekday]:langWeekdays[weekday].substr(0,3),A:langWeekdays[weekday],d:pad(dayOfMonth),e:pad(dayOfMonth,2," "),w:weekday,b:shortMonths[month],B:months[month],m:pad(month+1),o:month+1,y:fullYear.toString().substr(2,2),Y:fullYear,H:pad(hours),k:hours,I:pad(hours%12||12),l:hours%12||12,M:pad(minutes),p:hours<12?"AM":"PM",P:hours<12?"am":"pm",S:pad(seconds),L:pad(milliseconds,3)},H.dateFormats);objectEach(replacements,function(val,key){if(isString(format)){while(format.indexOf("%"+key)!==-1){format=format.replace("%"+key,typeof val==="function"?val.call(time,timestamp):val)}}})}else if(isObject(format)){const tzHours=(this.getTimezoneOffset(timestamp)||0)/(6e4*60),timeZone=this.options.timezone||"Etc/GMT"+(tzHours>=0?"+":"")+tzHours,{prefix="",suffix=""}=format;format=prefix+this.dateTimeFormat(extend({timeZone:timeZone},format),timestamp)+suffix}return upperCaseFirst?ucfirst(format):format}resolveDTLFormat(f){if(!isObject(f,true)){f=splat(f);return{main:f[0],from:f[1],to:f[2]}}if(isObject(f,true)&&isDateTimeFormatOptions(f)){return{main:f}}return f}getTimeTicks(normalizedInterval,min,max,startOfWeek){const time=this,tickPositions=[],higherRanks={},{count=1,unitRange}=normalizedInterval;let[year,month,dayOfMonth,hours,minutes,seconds]=time.toParts(min),milliseconds=(min||0)%1e3,variableDayLength;startOfWeek??(startOfWeek=1);if(defined(min)){milliseconds=unitRange>=timeUnits.second?0:count*Math.floor(milliseconds/count);if(unitRange>=timeUnits.second){seconds=unitRange>=timeUnits.minute?0:count*Math.floor(seconds/count)}if(unitRange>=timeUnits.minute){minutes=unitRange>=timeUnits.hour?0:count*Math.floor(minutes/count)}if(unitRange>=timeUnits.hour){hours=unitRange>=timeUnits.day?0:count*Math.floor(hours/count)}if(unitRange>=timeUnits.day){dayOfMonth=unitRange>=timeUnits.month?1:Math.max(1,count*Math.floor(dayOfMonth/count))}if(unitRange>=timeUnits.month){month=unitRange>=timeUnits.year?0:count*Math.floor(month/count)}if(unitRange>=timeUnits.year){year-=year%count}if(unitRange===timeUnits.week){if(count){min=time.makeTime(year,month,dayOfMonth,hours,minutes,seconds,milliseconds)}const weekday=this.dateTimeFormat({timeZone:this.timezone,weekday:"narrow"},min,"es"),weekdayNo=spanishWeekdayIndex(weekday);dayOfMonth+=-weekdayNo+startOfWeek+(weekdayNo<startOfWeek?-7:0)}min=time.makeTime(year,month,dayOfMonth,hours,minutes,seconds,milliseconds);if(time.variableTimezone&&defined(max)){variableDayLength=max-min>4*timeUnits.month||time.getTimezoneOffset(min)!==time.getTimezoneOffset(max)}let t=min,i=1;while(t<max){tickPositions.push(t);if(unitRange===timeUnits.year){t=time.makeTime(year+i*count,0)}else if(unitRange===timeUnits.month){t=time.makeTime(year,month+i*count)}else if(variableDayLength&&(unitRange===timeUnits.day||unitRange===timeUnits.week)){t=time.makeTime(year,month,dayOfMonth+i*count*(unitRange===timeUnits.day?1:7))}else if(variableDayLength&&unitRange===timeUnits.hour&&count>1){t=time.makeTime(year,month,dayOfMonth,hours+i*count)}else{t+=unitRange*count}i++}tickPositions.push(t);if(unitRange<=timeUnits.hour&&tickPositions.length<1e4){tickPositions.forEach(t=>{if(t%18e5===0&&time.dateFormat("%H%M%S%L",t)==="000000000"){higherRanks[t]="day"}})}}tickPositions.info=extend(normalizedInterval,{higherRanks:higherRanks,totalRange:unitRange*count});return tickPositions}getDateFormat(range,timestamp,startOfWeek,dateTimeLabelFormats){const dateStr=this.dateFormat("%m-%d %H:%M:%S.%L",timestamp),blank="01-01 00:00:00.000",strpos={millisecond:15,second:12,minute:9,hour:6,day:3};let n="millisecond",lastN=n;for(n in timeUnits){if(range===timeUnits.week&&+this.dateFormat("%w",timestamp)===startOfWeek&&dateStr.substr(6)===blank.substr(6)){n="week";break}if(timeUnits[n]>range){n=lastN;break}if(strpos[n]&&dateStr.substr(strpos[n])!==blank.substr(strpos[n])){break}if(n!=="week"){lastN=n}}return this.resolveDTLFormat(dateTimeLabelFormats[n]).main}}export default Time;"";