"use strict";import A from"../Animation/AnimationUtilities.js";const{animObject,setAnimation}=A;import F from"../Foundation.js";const{registerEventOptions}=F;import H from"../Globals.js";const{composed,marginNames}=H;import Series from"../Series/Series.js";import Point from"../Series/Point.js";import R from"../Renderer/RendererUtilities.js";const{distribute}=R;import T from"../Templating.js";const{format}=T;import U from"../Utilities.js";const{addEvent,createElement,css,defined,discardElement,find,fireEvent,isNumber,merge,pick,pushUnique,relativeLength,stableSort,syncTimeout}=U;class Legend{constructor(chart,options){this.allItems=[];this.initialItemY=0;this.itemHeight=0;this.itemMarginBottom=0;this.itemMarginTop=0;this.itemX=0;this.itemY=0;this.lastItemY=0;this.lastLineHeight=0;this.legendHeight=0;this.legendWidth=0;this.maxItemWidth=0;this.maxLegendWidth=0;this.offsetWidth=0;this.padding=0;this.pages=[];this.symbolHeight=0;this.symbolWidth=0;this.titleHeight=0;this.totalItemWidth=0;this.widthOption=0;this.chart=chart;this.setOptions(options);if(options.enabled){this.render();registerEventOptions(this,options);addEvent(this.chart,"endResize",function(){this.legend.positionCheckboxes()})}addEvent(this.chart,"render",()=>{if(this.options.enabled&&this.proximate){this.proximatePositions();this.positionItems()}})}setOptions(options){const padding=pick(options.padding,8);this.options=options;if(!this.chart.styledMode){this.itemStyle=options.itemStyle;this.itemHiddenStyle=merge(this.itemStyle,options.itemHiddenStyle)}this.itemMarginTop=options.itemMarginTop;this.itemMarginBottom=options.itemMarginBottom;this.padding=padding;this.initialItemY=padding-5;this.symbolWidth=pick(options.symbolWidth,16);this.pages=[];this.proximate=options.layout==="proximate"&&!this.chart.inverted;this.baseline=void 0}update(options,redraw){const chart=this.chart;this.setOptions(merge(true,this.options,options));if("events"in this.options){registerEventOptions(this,this.options)}this.destroy();chart.isDirtyLegend=chart.isDirtyBox=true;if(pick(redraw,true)){chart.redraw()}fireEvent(this,"afterUpdate",{redraw:redraw})}colorizeItem(item,visible){const originalColor=item.color,{area,group,label,line,symbol}=item.legendItem||{};if(item instanceof Series||item instanceof Point){item.color=item.options?.legendSymbolColor||originalColor}group?.[visible?"removeClass":"addClass"]("highcharts-legend-item-hidden");if(!this.chart.styledMode){const{itemHiddenStyle={}}=this,hiddenColor=itemHiddenStyle.color,{fillColor,fillOpacity,lineColor,marker}=item.options,colorizeHidden=attr=>{if(!visible){if(attr.fill){attr.fill=hiddenColor}if(attr.stroke){attr.stroke=hiddenColor}}return attr};label?.css(merge(visible?this.itemStyle:itemHiddenStyle));line?.attr(colorizeHidden({stroke:lineColor||item.color}));if(symbol){symbol.attr(colorizeHidden(marker&&symbol.isMarker?item.pointAttribs():{fill:item.color}))}area?.attr(colorizeHidden({fill:fillColor||item.color,"fill-opacity":fillColor?1:fillOpacity??.75}))}item.color=originalColor;fireEvent(this,"afterColorizeItem",{item:item,visible:visible})}positionItems(){this.allItems.forEach(this.positionItem,this);if(!this.chart.isResizing){this.positionCheckboxes()}}positionItem(item){const legend=this,{group,x=0,y=0}=item.legendItem||{},options=legend.options,symbolPadding=options.symbolPadding,ltr=!options.rtl,checkbox=item.checkbox;if(group&&group.element){const attribs={translateX:ltr?x:legend.legendWidth-x-2*symbolPadding-4,translateY:y};const complete=()=>{fireEvent(this,"afterPositionItem",{item:item})};group[defined(group.translateY)?"animate":"attr"](attribs,void 0,complete)}if(checkbox){checkbox.x=x;checkbox.y=y}}destroyItem(item){const checkbox=item.checkbox,legendItem=item.legendItem||{};for(const key of["group","label","line","symbol"]){if(legendItem[key]){legendItem[key]=legendItem[key].destroy()}}if(checkbox){discardElement(checkbox)}item.legendItem=void 0}destroy(){const legend=this;for(const item of this.getAllItems()){this.destroyItem(item)}for(const key of["clipRect","up","down","pager","nav","box","title","group"]){if(legend[key]){legend[key]=legend[key].destroy()}}this.display=null}positionCheckboxes(){const alignAttr=this.group&&this.group.alignAttr,clipHeight=this.clipHeight||this.legendHeight,titleHeight=this.titleHeight;let translateY;if(alignAttr){translateY=alignAttr.translateY;this.allItems.forEach(function(item){const checkbox=item.checkbox;let top;if(checkbox){top=translateY+titleHeight+checkbox.y+(this.scrollOffset||0)+3;css(checkbox,{left:alignAttr.translateX+item.checkboxOffset+checkbox.x-20+"px",top:top+"px",display:this.proximate||top>translateY-6&&top<translateY+clipHeight-6?"":"none"})}},this)}}renderTitle(){const options=this.options,padding=this.padding,titleOptions=options.title;let bBox,titleHeight=0;if(titleOptions.text){if(!this.title){this.title=this.chart.renderer.label(titleOptions.text,padding-3,padding-4,void 0,void 0,void 0,options.useHTML,void 0,"legend-title").attr({zIndex:1});if(!this.chart.styledMode){this.title.css(titleOptions.style)}this.title.add(this.group)}if(!titleOptions.width){this.title.css({width:this.maxLegendWidth+"px"})}bBox=this.title.getBBox();titleHeight=bBox.height;this.offsetWidth=bBox.width;this.contentGroup.attr({translateY:titleHeight})}this.titleHeight=titleHeight}setText(item){const options=this.options;item.legendItem.label.attr({text:options.labelFormat?format(options.labelFormat,item,this.chart):options.labelFormatter.call(item)})}renderItem(item){const legend=this,legendItem=item.legendItem=item.legendItem||{},chart=legend.chart,renderer=chart.renderer,options=legend.options,horizontal=options.layout==="horizontal",symbolWidth=legend.symbolWidth,symbolPadding=options.symbolPadding||0,itemStyle=legend.itemStyle,itemHiddenStyle=legend.itemHiddenStyle,itemDistance=horizontal?pick(options.itemDistance,20):0,ltr=!options.rtl,isSeries=!item.series,series=!isSeries&&item.series.drawLegendSymbol?item.series:item,seriesOptions=series.options,showCheckbox=!!legend.createCheckboxForItem&&seriesOptions&&seriesOptions.showCheckbox,useHTML=options.useHTML,itemClassName=item.options.className;let label=legendItem.label,itemExtraWidth=symbolWidth+symbolPadding+itemDistance+(showCheckbox?20:0);if(!label){legendItem.group=renderer.g("legend-item").addClass("highcharts-"+series.type+"-series "+"highcharts-color-"+item.colorIndex+(itemClassName?" "+itemClassName:"")+(isSeries?" highcharts-series-"+item.index:"")).attr({zIndex:1}).add(legend.scrollGroup);legendItem.label=label=renderer.text("",ltr?symbolWidth+symbolPadding:-symbolPadding,legend.baseline||0,useHTML);if(!chart.styledMode){label.css(merge(item.visible?itemStyle:itemHiddenStyle))}label.attr({align:ltr?"left":"right",zIndex:2}).add(legendItem.group);if(!legend.baseline){legend.fontMetrics=renderer.fontMetrics(label);legend.baseline=legend.fontMetrics.f+3+legend.itemMarginTop;label.attr("y",legend.baseline);legend.symbolHeight=pick(options.symbolHeight,legend.fontMetrics.f);if(options.squareSymbol){legend.symbolWidth=pick(options.symbolWidth,Math.max(legend.symbolHeight,16));itemExtraWidth=legend.symbolWidth+symbolPadding+itemDistance+(showCheckbox?20:0);if(ltr){label.attr("x",legend.symbolWidth+symbolPadding)}}}series.drawLegendSymbol(legend,item);if(legend.setItemEvents){legend.setItemEvents(item,label,useHTML)}}if(showCheckbox&&!item.checkbox&&legend.createCheckboxForItem){legend.createCheckboxForItem(item)}legend.colorizeItem(item,item.visible);if(chart.styledMode||!itemStyle.width){label.css({width:(options.itemWidth||legend.widthOption||chart.spacingBox.width)-itemExtraWidth+"px"})}legend.setText(item);const bBox=label.getBBox();const fontMetricsH=legend.fontMetrics&&legend.fontMetrics.h||0;item.itemWidth=item.checkboxOffset=options.itemWidth||legendItem.labelWidth||bBox.width+itemExtraWidth;legend.maxItemWidth=Math.max(legend.maxItemWidth,item.itemWidth);legend.totalItemWidth+=item.itemWidth;legend.itemHeight=item.itemHeight=Math.round(legendItem.labelHeight||(bBox.height>fontMetricsH*1.5?bBox.height:fontMetricsH))}layoutItem(item){const options=this.options,padding=this.padding,horizontal=options.layout==="horizontal",itemHeight=item.itemHeight,itemMarginBottom=this.itemMarginBottom,itemMarginTop=this.itemMarginTop,itemDistance=horizontal?pick(options.itemDistance,20):0,maxLegendWidth=this.maxLegendWidth,itemWidth=options.alignColumns&&this.totalItemWidth>maxLegendWidth?this.maxItemWidth:item.itemWidth,legendItem=item.legendItem||{};if(horizontal&&this.itemX-padding+itemWidth>maxLegendWidth){this.itemX=padding;if(this.lastLineHeight){this.itemY+=itemMarginTop+this.lastLineHeight+itemMarginBottom}this.lastLineHeight=0}this.lastItemY=itemMarginTop+this.itemY+itemMarginBottom;this.lastLineHeight=Math.max(itemHeight,this.lastLineHeight);legendItem.x=this.itemX;legendItem.y=this.itemY;if(horizontal){this.itemX+=itemWidth}else{this.itemY+=itemMarginTop+itemHeight+itemMarginBottom;this.lastLineHeight=itemHeight}this.offsetWidth=this.widthOption||Math.max((horizontal?this.itemX-padding-(item.checkbox?0:itemDistance):itemWidth)+padding,this.offsetWidth)}getAllItems(){let allItems=[];this.chart.series.forEach(function(series){const seriesOptions=series&&series.options;if(series&&pick(seriesOptions.showInLegend,!defined(seriesOptions.linkedTo)?void 0:false,true)){allItems=allItems.concat((series.legendItem||{}).labels||(seriesOptions.legendType==="point"?series.data:series))}});fireEvent(this,"afterGetAllItems",{allItems:allItems});return allItems}getAlignment(){const options=this.options;if(this.proximate){return options.align.charAt(0)+"tv"}return options.floating?"":options.align.charAt(0)+options.verticalAlign.charAt(0)+options.layout.charAt(0)}adjustMargins(margin,spacing){const chart=this.chart,options=this.options,alignment=this.getAlignment();if(alignment){[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(alignments,side){if(alignments.test(alignment)&&!defined(margin[side])){chart[marginNames[side]]=Math.max(chart[marginNames[side]],chart.legend[(side+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][side]*options[side%2?"x":"y"]+pick(options.margin,12)+spacing[side]+(chart.titleOffset[side]||0))}})}}proximatePositions(){const chart=this.chart,boxes=[],alignLeft=this.options.align==="left";this.allItems.forEach(function(item){let lastPoint,height,useFirstPoint=alignLeft,target,top;if(item.yAxis){if(item.xAxis.options.reversed){useFirstPoint=!useFirstPoint}if(item.points){lastPoint=find(useFirstPoint?item.points:item.points.slice(0).reverse(),function(item){return isNumber(item.plotY)})}height=this.itemMarginTop+item.legendItem.label.getBBox().height+this.itemMarginBottom;top=item.yAxis.top-chart.plotTop;if(item.visible){target=lastPoint?lastPoint.plotY:item.yAxis.height;target+=top-.3*height}else{target=top+item.yAxis.height}boxes.push({target:target,size:height,item:item})}},this);let legendItem;for(const box of distribute(boxes,chart.plotHeight)){legendItem=box.item.legendItem||{};if(isNumber(box.pos)){legendItem.y=chart.plotTop-chart.spacing[0]+box.pos}}}render(){const legend=this,chart=legend.chart,renderer=chart.renderer,options=legend.options,padding=legend.padding,allItems=legend.getAllItems();let display,legendWidth,legendHeight,legendGroup=legend.group,allowedWidth,box=legend.box;legend.itemX=padding;legend.itemY=legend.initialItemY;legend.offsetWidth=0;legend.lastItemY=0;legend.widthOption=relativeLength(options.width,chart.spacingBox.width-padding);allowedWidth=chart.spacingBox.width-2*padding-options.x;if(["rm","lm"].indexOf(legend.getAlignment().substring(0,2))>-1){allowedWidth/=2}legend.maxLegendWidth=legend.widthOption||allowedWidth;if(!legendGroup){legend.group=legendGroup=renderer.g("legend").addClass(options.className||"").attr({zIndex:7}).add();legend.contentGroup=renderer.g().attr({zIndex:1}).add(legendGroup);legend.scrollGroup=renderer.g().add(legend.contentGroup)}legend.renderTitle();stableSort(allItems,(a,b)=>(a.options&&a.options.legendIndex||0)-(b.options&&b.options.legendIndex||0));if(options.reversed){allItems.reverse()}legend.allItems=allItems;legend.display=display=!!allItems.length;legend.lastLineHeight=0;legend.maxItemWidth=0;legend.totalItemWidth=0;legend.itemHeight=0;allItems.forEach(legend.renderItem,legend);allItems.forEach(legend.layoutItem,legend);legendWidth=(legend.widthOption||legend.offsetWidth)+padding;legendHeight=legend.lastItemY+legend.lastLineHeight+legend.titleHeight;legendHeight=legend.handleOverflow(legendHeight);legendHeight+=padding;if(!box){legend.box=box=renderer.rect().addClass("highcharts-legend-box").attr({r:options.borderRadius}).add(legendGroup)}if(!chart.styledMode){box.attr({stroke:options.borderColor,"stroke-width":options.borderWidth||0,fill:options.backgroundColor||"none"}).shadow(options.shadow)}if(legendWidth>0&&legendHeight>0){box[box.placed?"animate":"attr"](box.crisp.call({},{x:0,y:0,width:legendWidth,height:legendHeight},box.strokeWidth()))}legendGroup[display?"show":"hide"]();if(chart.styledMode&&legendGroup.getStyle("display")==="none"){legendWidth=legendHeight=0}legend.legendWidth=legendWidth;legend.legendHeight=legendHeight;if(display){legend.align()}if(!this.proximate){this.positionItems()}fireEvent(this,"afterRender")}align(alignTo=this.chart.spacingBox){const chart=this.chart,options=this.options;let y=alignTo.y;if(/(lth|ct|rth)/.test(this.getAlignment())&&chart.titleOffset[0]>0){y+=chart.titleOffset[0]}else if(/(lbh|cb|rbh)/.test(this.getAlignment())&&chart.titleOffset[2]>0){y-=chart.titleOffset[2]}if(y!==alignTo.y){alignTo=merge(alignTo,{y:y})}if(!chart.hasRendered){this.group.placed=false}this.group.align(merge(options,{width:this.legendWidth,height:this.legendHeight,verticalAlign:this.proximate?"top":options.verticalAlign}),true,alignTo)}handleOverflow(legendHeight){const legend=this,chart=this.chart,renderer=chart.renderer,options=this.options,optionsY=options.y,alignTop=options.verticalAlign==="top",padding=this.padding,maxHeight=options.maxHeight,navOptions=options.navigation,animation=pick(navOptions.animation,true),arrowSize=navOptions.arrowSize||12,pages=this.pages,allItems=this.allItems,clipToHeight=function(height){if(typeof height==="number"){clipRect.attr({height:height})}else if(clipRect){legend.clipRect=clipRect.destroy();legend.contentGroup.clip()}if(legend.contentGroup.div){legend.contentGroup.div.style.clip=height?"rect("+padding+"px,9999px,"+(padding+height)+"px,0)":"auto"}},addTracker=function(key){legend[key]=renderer.circle(0,0,arrowSize*1.3).translate(arrowSize/2,arrowSize/2).add(nav);if(!chart.styledMode){legend[key].attr("fill","rgba(0,0,0,0.0001)")}return legend[key]};let clipHeight,lastY,legendItem,spaceHeight=chart.spacingBox.height+(alignTop?-optionsY:optionsY)-padding,nav=this.nav,clipRect=this.clipRect;if(options.layout==="horizontal"&&options.verticalAlign!=="middle"&&!options.floating){spaceHeight/=2}if(maxHeight){spaceHeight=Math.min(spaceHeight,maxHeight)}pages.length=0;if(legendHeight&&spaceHeight>0&&legendHeight>spaceHeight&&navOptions.enabled!==false){this.clipHeight=clipHeight=Math.max(spaceHeight-20-this.titleHeight-padding,0);this.currentPage=pick(this.currentPage,1);this.fullHeight=legendHeight;allItems.forEach((item,i)=>{legendItem=item.legendItem||{};const y=legendItem.y||0,h=Math.round(legendItem.label.getBBox().height);let len=pages.length;if(!len||y-pages[len-1]>clipHeight&&(lastY||y)!==pages[len-1]){pages.push(lastY||y);len++}legendItem.pageIx=len-1;if(lastY){(allItems[i-1].legendItem||{}).pageIx=len-1}if(i===allItems.length-1&&y+h-pages[len-1]>clipHeight&&y>pages[len-1]){pages.push(y);legendItem.pageIx=len}if(y!==lastY){lastY=y}});if(!clipRect){clipRect=legend.clipRect=renderer.clipRect(0,padding-2,9999,0);legend.contentGroup.clip(clipRect)}clipToHeight(clipHeight);if(!nav){this.nav=nav=renderer.g().attr({zIndex:1}).add(this.group);this.up=renderer.symbol("triangle",0,0,arrowSize,arrowSize).add(nav);addTracker("upTracker").on("click",function(){legend.scroll(-1,animation)});this.pager=renderer.text("",15,10).addClass("highcharts-legend-navigation");if(!chart.styledMode&&navOptions.style){this.pager.css(navOptions.style)}this.pager.add(nav);this.down=renderer.symbol("triangle-down",0,0,arrowSize,arrowSize).add(nav);addTracker("downTracker").on("click",function(){legend.scroll(1,animation)})}legend.scroll(0);legendHeight=spaceHeight}else if(nav){clipToHeight();this.nav=nav.destroy();this.scrollGroup.attr({translateY:1});this.clipHeight=0}return legendHeight}scroll(scrollBy,animation){const chart=this.chart,pages=this.pages,pageCount=pages.length,clipHeight=this.clipHeight,navOptions=this.options.navigation,pager=this.pager,padding=this.padding;let currentPage=this.currentPage+scrollBy;if(currentPage>pageCount){currentPage=pageCount}if(currentPage>0){if(typeof animation!=="undefined"){setAnimation(animation,chart)}this.nav.attr({translateX:padding,translateY:clipHeight+this.padding+7+this.titleHeight,visibility:"inherit"});[this.up,this.upTracker].forEach(function(elem){elem.attr({class:currentPage===1?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})});pager.attr({text:currentPage+"/"+pageCount});[this.down,this.downTracker].forEach(function(elem){elem.attr({x:18+this.pager.getBBox().width,class:currentPage===pageCount?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this);if(!chart.styledMode){this.up.attr({fill:currentPage===1?navOptions.inactiveColor:navOptions.activeColor});this.upTracker.css({cursor:currentPage===1?"default":"pointer"});this.down.attr({fill:currentPage===pageCount?navOptions.inactiveColor:navOptions.activeColor});this.downTracker.css({cursor:currentPage===pageCount?"default":"pointer"})}this.scrollOffset=-pages[currentPage-1]+this.initialItemY;this.scrollGroup.animate({translateY:this.scrollOffset});this.currentPage=currentPage;this.positionCheckboxes();const animOptions=animObject(pick(animation,chart.renderer.globalAnimation,true));syncTimeout(()=>{fireEvent(this,"afterScroll",{currentPage:currentPage})},animOptions.duration)}}setItemEvents(item,legendLabel,useHTML){const legend=this,legendItem=item.legendItem||{},boxWrapper=legend.chart.renderer.boxWrapper,isPoint=item instanceof Point,isSeries=item instanceof Series,activeClass="highcharts-legend-"+(isPoint?"point":"series")+"-active",styledMode=legend.chart.styledMode,legendElements=useHTML?[legendLabel,legendItem.symbol]:[legendItem.group];const setOtherItemsState=state=>{legend.allItems.forEach(otherItem=>{if(item!==otherItem){[otherItem].concat(otherItem.linkedSeries||[]).forEach(otherItem=>{otherItem.setState(state,!isPoint)})}})};for(const element of legendElements){if(element){element.on("mouseover",function(){if(item.visible){setOtherItemsState("inactive")}item.setState("hover");if(item.visible){boxWrapper.addClass(activeClass)}if(!styledMode){legendLabel.css(legend.options.itemHoverStyle)}}).on("mouseout",function(){if(!legend.chart.styledMode){legendLabel.css(merge(item.visible?legend.itemStyle:legend.itemHiddenStyle))}setOtherItemsState("");boxWrapper.removeClass(activeClass);item.setState()}).on("click",function(event){const defaultItemClick=function(){if(item.setVisible){item.setVisible()}setOtherItemsState(item.visible?"inactive":"")};boxWrapper.removeClass(activeClass);fireEvent(legend,"itemClick",{browserEvent:event,legendItem:item},defaultItemClick);if(isPoint){item.firePointEvent("legendItemClick",{browserEvent:event})}else if(isSeries){fireEvent(item,"legendItemClick",{browserEvent:event})}})}}}createCheckboxForItem(item){const legend=this;item.checkbox=createElement("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:item.selected,defaultChecked:item.selected},legend.options.itemCheckboxStyle,legend.chart.container);addEvent(item.checkbox,"click",function(event){const target=event.target;fireEvent(item.series||item,"checkboxClick",{checked:target.checked,item:item},function(){item.select()})})}}(function(Legend){function compose(ChartClass){if(pushUnique(composed,"Core.Legend")){addEvent(ChartClass,"beforeMargins",function(){this.legend=new Legend(this,this.options.legend)})}}Legend.compose=compose})(Legend||(Legend={}));export default Legend;"";