"use strict";import U from"../../Core/Utilities.js";import AST from"../../Core/Renderer/HTML/AST.js";import StockToolsUtilities from"./StockToolsUtilities.js";const{addEvent,createElement,css,defined,fireEvent,getStyle,isArray,merge,pick}=U;const{shallowArraysEqual}=StockToolsUtilities;class Toolbar{constructor(options,langOptions,chart){this.width=0;this.isDirty=false;this.chart=chart;this.options=options;this.lang=langOptions;this.iconsURL=this.getIconsURL();this.guiEnabled=options.enabled;this.visible=pick(options.visible,true);this.guiClassName=options.className;this.toolbarClassName=options.toolbarClassName;this.eventsToUnbind=[];if(this.guiEnabled){this.createContainer();this.createButtons();this.showHideNavigation()}fireEvent(this,"afterInit")}createButtons(){const lang=this.lang,guiOptions=this.options,toolbar=this.toolbar,buttons=guiOptions.buttons,defs=guiOptions.definitions,allButtons=toolbar.childNodes;this.buttonList=buttons;buttons.forEach(btnName=>{const button=this.addButton(toolbar,defs,btnName,lang);this.eventsToUnbind.push(addEvent(button.buttonWrapper,"click",()=>this.eraseActiveButtons(allButtons,button.buttonWrapper)));if(isArray(defs[btnName].items)){this.addSubmenu(button,defs[btnName])}})}addSubmenu(parentBtn,button){const submenuArrow=parentBtn.submenuArrow,buttonWrapper=parentBtn.buttonWrapper,buttonWidth=getStyle(buttonWrapper,"width"),wrapper=this.wrapper,menuWrapper=this.listWrapper,allButtons=this.toolbar.childNodes,submenuWrapper=this.submenu=createElement("ul",{className:"highcharts-submenu-wrapper"},void 0,buttonWrapper);this.addSubmenuItems(buttonWrapper,button);this.eventsToUnbind.push(addEvent(submenuArrow,"click",e=>{e.stopPropagation();this.eraseActiveButtons(allButtons,buttonWrapper);if(buttonWrapper.className.indexOf("highcharts-current")>=0){menuWrapper.style.width=menuWrapper.startWidth+"px";buttonWrapper.classList.remove("highcharts-current");submenuWrapper.style.display="none"}else{submenuWrapper.style.display="block";let topMargin=submenuWrapper.offsetHeight-buttonWrapper.offsetHeight-3;if(!(submenuWrapper.offsetHeight+buttonWrapper.offsetTop>wrapper.offsetHeight&&buttonWrapper.offsetTop>topMargin)){topMargin=0}css(submenuWrapper,{top:-topMargin+"px",left:buttonWidth+3+"px"});buttonWrapper.className+=" highcharts-current";menuWrapper.startWidth=wrapper.offsetWidth;menuWrapper.style.width=menuWrapper.startWidth+getStyle(menuWrapper,"padding-left")+submenuWrapper.offsetWidth+3+"px"}}))}addSubmenuItems(buttonWrapper,button){const _self=this,submenuWrapper=this.submenu,lang=this.lang,menuWrapper=this.listWrapper,items=button.items;let submenuBtn;items.forEach(btnName=>{submenuBtn=this.addButton(submenuWrapper,button,btnName,lang);this.eventsToUnbind.push(addEvent(submenuBtn.mainButton,"click",function(){_self.switchSymbol(this,buttonWrapper,true);menuWrapper.style.width=menuWrapper.startWidth+"px";submenuWrapper.style.display="none"}))});const firstSubmenuItem=submenuWrapper.querySelectorAll("li > .highcharts-menu-item-btn")[0];this.switchSymbol(firstSubmenuItem,false)}eraseActiveButtons(buttons,currentButton,submenuItems){[].forEach.call(buttons,btn=>{if(btn!==currentButton){btn.classList.remove("highcharts-current");btn.classList.remove("highcharts-active");submenuItems=btn.querySelectorAll(".highcharts-submenu-wrapper");if(submenuItems.length>0){submenuItems[0].style.display="none"}}})}addButton(target,options,btnName,lang={}){const btnOptions=options[btnName],items=btnOptions.items,classMapping=Toolbar.prototype.classMapping,userClassName=btnOptions.className||"";const buttonWrapper=createElement("li",{className:pick(classMapping[btnName],"")+" "+userClassName,title:lang[btnName]||btnName},void 0,target);const elementType=btnOptions.elementType||"button";const mainButton=createElement(elementType,{className:"highcharts-menu-item-btn"},void 0,buttonWrapper);if(items&&items.length){const submenuArrow=createElement("button",{className:"highcharts-submenu-item-arrow "+"highcharts-arrow-right"},void 0,buttonWrapper);submenuArrow.style.backgroundImage="url("+this.iconsURL+"arrow-bottom.svg)";return{buttonWrapper:buttonWrapper,mainButton:mainButton,submenuArrow:submenuArrow}}mainButton.style.backgroundImage="url("+this.iconsURL+btnOptions.symbol+")";return{buttonWrapper:buttonWrapper,mainButton:mainButton}}addNavigation(){const wrapper=this.wrapper;this.arrowWrapper=createElement("div",{className:"highcharts-arrow-wrapper"});this.arrowUp=createElement("div",{className:"highcharts-arrow-up"},void 0,this.arrowWrapper);this.arrowUp.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)";this.arrowDown=createElement("div",{className:"highcharts-arrow-down"},void 0,this.arrowWrapper);this.arrowDown.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)";wrapper.insertBefore(this.arrowWrapper,wrapper.childNodes[0]);this.scrollButtons()}scrollButtons(){const wrapper=this.wrapper,toolbar=this.toolbar,step=.1*wrapper.offsetHeight;let targetY=0;this.eventsToUnbind.push(addEvent(this.arrowUp,"click",()=>{if(targetY>0){targetY-=step;toolbar.style.marginTop=-targetY+"px"}}));this.eventsToUnbind.push(addEvent(this.arrowDown,"click",()=>{if(wrapper.offsetHeight+targetY<=toolbar.offsetHeight+step){targetY+=step;toolbar.style.marginTop=-targetY+"px"}}))}createContainer(){const chart=this.chart,guiOptions=this.options,container=chart.container,navigation=chart.options.navigation,bindingsClassName=navigation?.bindingsClassName,self=this;let listWrapper,toolbar;const wrapper=this.wrapper=createElement("div",{className:"highcharts-stocktools-wrapper "+guiOptions.className+" "+bindingsClassName});container.appendChild(wrapper);this.showHideBtn=createElement("div",{className:"highcharts-toggle-toolbar highcharts-arrow-left"},void 0,wrapper);this.eventsToUnbind.push(addEvent(this.showHideBtn,"click",()=>{this.update({gui:{visible:!self.visible}})}));["mousedown","mousemove","click","touchstart"].forEach(eventType=>{addEvent(wrapper,eventType,e=>e.stopPropagation())});addEvent(wrapper,"mouseover",e=>chart.pointer?.onContainerMouseLeave(e));this.toolbar=toolbar=createElement("ul",{className:"highcharts-stocktools-toolbar "+guiOptions.toolbarClassName});this.listWrapper=listWrapper=createElement("div",{className:"highcharts-menu-wrapper"});wrapper.insertBefore(listWrapper,wrapper.childNodes[0]);listWrapper.insertBefore(toolbar,listWrapper.childNodes[0]);this.showHideToolbar();this.addNavigation()}showHideNavigation(){if(this.visible&&this.toolbar.offsetHeight>this.wrapper.offsetHeight-50){this.arrowWrapper.style.display="block"}else{this.toolbar.style.marginTop="0px";this.arrowWrapper.style.display="none"}}showHideToolbar(){const wrapper=this.wrapper,toolbar=this.listWrapper,submenu=this.submenu,showHideBtn=this.showHideBtn;let visible=this.visible;showHideBtn.style.backgroundImage="url("+this.iconsURL+"arrow-right.svg)";if(!visible){if(submenu){submenu.style.display="none"}showHideBtn.style.left="0px";visible=this.visible=false;toolbar.classList.add("highcharts-hide");showHideBtn.classList.add("highcharts-arrow-right");wrapper.style.height=showHideBtn.offsetHeight+"px"}else{wrapper.style.height="100%";toolbar.classList.remove("highcharts-hide");showHideBtn.classList.remove("highcharts-arrow-right");showHideBtn.style.top=getStyle(toolbar,"padding-top")+"px";showHideBtn.style.left=wrapper.offsetWidth+getStyle(toolbar,"padding-left")+"px"}}switchSymbol(button,redraw){const buttonWrapper=button.parentNode,buttonWrapperClass=buttonWrapper.className,mainNavButton=buttonWrapper.parentNode.parentNode;if(buttonWrapperClass.indexOf("highcharts-disabled-btn")>-1){return}mainNavButton.className="";if(buttonWrapperClass){mainNavButton.classList.add(buttonWrapperClass.trim())}mainNavButton.querySelectorAll(".highcharts-menu-item-btn")[0].style.backgroundImage=button.style.backgroundImage;if(redraw){this.toggleButtonActiveClass(mainNavButton)}}toggleButtonActiveClass(button){const classList=button.classList;if(classList.contains("highcharts-active")){classList.remove("highcharts-active")}else{classList.add("highcharts-active")}}unselectAllButtons(button){const activeBtns=button.parentNode.querySelectorAll(".highcharts-active");[].forEach.call(activeBtns,activeBtn=>{if(activeBtn!==button){activeBtn.classList.remove("highcharts-active")}})}update(options,redraw){this.isDirty=!!options.gui.definitions;merge(true,this.chart.options.stockTools,options);merge(true,this.options,options.gui);this.visible=pick(this.options.visible&&this.options.enabled,true);if(this.chart.navigationBindings){this.chart.navigationBindings.update()}this.chart.isDirtyBox=true;if(pick(redraw,true)){this.chart.redraw()}}destroy(){const stockToolsDiv=this.wrapper,parent=stockToolsDiv&&stockToolsDiv.parentNode;this.eventsToUnbind.forEach(unbinder=>unbinder());if(parent){parent.removeChild(stockToolsDiv)}}redraw(){if(this.options.enabled!==this.guiEnabled){this.handleGuiEnabledChange()}else{if(!this.guiEnabled){return}this.updateClassNames();this.updateButtons();this.updateVisibility();this.showHideNavigation();this.showHideToolbar()}}handleGuiEnabledChange(){if(this.options.enabled===false){this.destroy();this.visible=false}if(this.options.enabled===true){this.createContainer();this.createButtons()}this.guiEnabled=this.options.enabled}updateClassNames(){if(this.options.className!==this.guiClassName){if(this.guiClassName){this.wrapper.classList.remove(this.guiClassName)}if(this.options.className){this.wrapper.classList.add(this.options.className)}this.guiClassName=this.options.className}if(this.options.toolbarClassName!==this.toolbarClassName){if(this.toolbarClassName){this.toolbar.classList.remove(this.toolbarClassName)}if(this.options.toolbarClassName){this.toolbar.classList.add(this.options.toolbarClassName)}this.toolbarClassName=this.options.toolbarClassName}}updateButtons(){if(!shallowArraysEqual(this.options.buttons,this.buttonList)||this.isDirty){this.toolbar.innerHTML=AST.emptyHTML;this.createButtons()}}updateVisibility(){if(defined(this.options.visible)){this.visible=this.options.visible}}getIconsURL(){return this.chart.options.navigation.iconsURL||this.options.iconsURL||"https://code.highcharts.com/@product.version@/gfx/stock-icons/"}}Toolbar.prototype.classMapping={circle:"highcharts-circle-annotation",ellipse:"highcharts-ellipse-annotation",rectangle:"highcharts-rectangle-annotation",label:"highcharts-label-annotation",segment:"highcharts-segment",arrowSegment:"highcharts-arrow-segment",ray:"highcharts-ray",arrowRay:"highcharts-arrow-ray",line:"highcharts-infinity-line",arrowInfinityLine:"highcharts-arrow-infinity-line",verticalLine:"highcharts-vertical-line",horizontalLine:"highcharts-horizontal-line",crooked3:"highcharts-crooked3",crooked5:"highcharts-crooked5",elliott3:"highcharts-elliott3",elliott5:"highcharts-elliott5",pitchfork:"highcharts-pitchfork",fibonacci:"highcharts-fibonacci",fibonacciTimeZones:"highcharts-fibonacci-time-zones",parallelChannel:"highcharts-parallel-channel",measureX:"highcharts-measure-x",measureY:"highcharts-measure-y",measureXY:"highcharts-measure-xy",timeCycles:"highcharts-time-cycles",verticalCounter:"highcharts-vertical-counter",verticalLabel:"highcharts-vertical-label",verticalArrow:"highcharts-vertical-arrow",currentPriceIndicator:"highcharts-current-price-indicator",indicators:"highcharts-indicators",flagCirclepin:"highcharts-flag-circlepin",flagDiamondpin:"highcharts-flag-diamondpin",flagSquarepin:"highcharts-flag-squarepin",flagSimplepin:"highcharts-flag-simplepin",zoomX:"highcharts-zoom-x",zoomY:"highcharts-zoom-y",zoomXY:"highcharts-zoom-xy",typeLine:"highcharts-series-type-line",typeOHLC:"highcharts-series-type-ohlc",typeHLC:"highcharts-series-type-hlc",typeCandlestick:"highcharts-series-type-candlestick",typeHollowCandlestick:"highcharts-series-type-hollowcandlestick",typeHeikinAshi:"highcharts-series-type-heikinashi",fullScreen:"highcharts-full-screen",toggleAnnotations:"highcharts-toggle-annotations",saveChart:"highcharts-save-chart",separator:"highcharts-separator"};export default Toolbar;