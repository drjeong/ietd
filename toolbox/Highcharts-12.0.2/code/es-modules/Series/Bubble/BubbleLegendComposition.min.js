"use strict";import BubbleLegendDefaults from"./BubbleLegendDefaults.js";import BubbleLegendItem from"./BubbleLegendItem.js";import D from"../../Core/Defaults.js";const{setOptions}=D;import H from"../../Core/Globals.js";const{composed}=H;import U from"../../Core/Utilities.js";const{addEvent,objectEach,pushUnique,wrap}=U;function chartDrawChartBox(proceed,options,callback){const chart=this,legend=chart.legend,bubbleSeries=getVisibleBubbleSeriesIndex(chart)>=0;let bubbleLegendOptions,bubbleSizes,legendItem;if(legend&&legend.options.enabled&&legend.bubbleLegend&&legend.options.bubbleLegend.autoRanges&&bubbleSeries){bubbleLegendOptions=legend.bubbleLegend.options;bubbleSizes=legend.bubbleLegend.predictBubbleSizes();legend.bubbleLegend.updateRanges(bubbleSizes[0],bubbleSizes[1]);if(!bubbleLegendOptions.placed){legend.group.placed=false;legend.allItems.forEach(item=>{legendItem=item.legendItem||{};if(legendItem.group){legendItem.group.translateY=void 0}})}legend.render();if(!bubbleLegendOptions.placed){chart.getMargins();chart.axes.forEach(axis=>{axis.setScale();axis.updateNames();objectEach(axis.ticks,function(tick){tick.isNew=true;tick.isNewLabel=true})});chart.getMargins()}bubbleLegendOptions.placed=true;proceed.call(chart,options,callback);legend.bubbleLegend.correctSizes();retranslateItems(legend,getLinesHeights(legend))}else{proceed.call(chart,options,callback);if(legend&&legend.options.enabled&&legend.bubbleLegend){legend.render();retranslateItems(legend,getLinesHeights(legend))}}}function compose(ChartClass,LegendClass){if(pushUnique(composed,"Series.BubbleLegend")){setOptions({legend:{bubbleLegend:BubbleLegendDefaults}});wrap(ChartClass.prototype,"drawChartBox",chartDrawChartBox);addEvent(LegendClass,"afterGetAllItems",onLegendAfterGetAllItems);addEvent(LegendClass,"itemClick",onLegendItemClick)}}function getVisibleBubbleSeriesIndex(chart){const series=chart.series;let i=0;while(i<series.length){if(series[i]&&series[i].isBubble&&series[i].visible&&series[i].dataTable.rowCount){return i}i++}return-1}function getLinesHeights(legend){const items=legend.allItems,lines=[],length=items.length;let lastLine,legendItem,legendItem2,i=0,j=0;for(i=0;i<length;i++){legendItem=items[i].legendItem||{};legendItem2=(items[i+1]||{}).legendItem||{};if(legendItem.labelHeight){items[i].itemHeight=legendItem.labelHeight}if(items[i]===items[length-1]||legendItem.y!==legendItem2.y){lines.push({height:0});lastLine=lines[lines.length-1];for(j;j<=i;j++){if(items[j].itemHeight>lastLine.height){lastLine.height=items[j].itemHeight}}lastLine.step=i}}return lines}function onLegendAfterGetAllItems(e){const legend=this,bubbleLegend=legend.bubbleLegend,legendOptions=legend.options,options=legendOptions.bubbleLegend,bubbleSeriesIndex=getVisibleBubbleSeriesIndex(legend.chart);if(bubbleLegend&&bubbleLegend.ranges&&bubbleLegend.ranges.length){if(options.ranges.length){options.autoRanges=!!options.ranges[0].autoRanges}legend.destroyItem(bubbleLegend)}if(bubbleSeriesIndex>=0&&legendOptions.enabled&&options.enabled){options.seriesIndex=bubbleSeriesIndex;legend.bubbleLegend=new BubbleLegendItem(options,legend);legend.bubbleLegend.addToLegend(e.allItems)}}function onLegendItemClick(e){if(e.defaultPrevented){return false}const legend=this,series=e.legendItem,chart=legend.chart,visible=series.visible;let status;if(legend&&legend.bubbleLegend){series.visible=!visible;series.ignoreSeries=visible;status=getVisibleBubbleSeriesIndex(chart)>=0;if(legend.bubbleLegend.visible!==status){legend.update({bubbleLegend:{enabled:status}});legend.bubbleLegend.visible=status}series.visible=visible}}function retranslateItems(legend,lines){const items=legend.allItems,rtl=legend.options.rtl;let orgTranslateX,orgTranslateY,movementX,legendItem,actualLine=0;items.forEach((item,index)=>{legendItem=item.legendItem||{};if(!legendItem.group){return}orgTranslateX=legendItem.group.translateX||0;orgTranslateY=legendItem.y||0;movementX=item.movementX;if(movementX||rtl&&item.ranges){movementX=rtl?orgTranslateX-item.options.maxSize/2:orgTranslateX+movementX;legendItem.group.attr({translateX:movementX})}if(index>lines[actualLine].step){actualLine++}legendItem.group.attr({translateY:Math.round(orgTranslateY+lines[actualLine].height/2)});legendItem.y=orgTranslateY+lines[actualLine].height/2})}const BubbleLegendComposition={compose:compose};export default BubbleLegendComposition;