"use strict";import DPU from"../DrawPointUtilities.js";import H from"../../Core/Globals.js";const{noop}=H;import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";const{column:ColumnSeries}=SeriesRegistry.seriesTypes;import U from"../../Core/Utilities.js";const{extend,isArray,isNumber,isObject,merge}=U;import WordcloudPoint from"./WordcloudPoint.js";import WordcloudSeriesDefaults from"./WordcloudSeriesDefaults.js";import WU from"./WordcloudUtils.js";const{archimedeanSpiral,extendPlayingField,getBoundingBoxFromPolygon,getPlayingField,getPolygon,getRandomPosition,getRotation,getScale,getSpiral,intersectionTesting,isPolygonsColliding,rectangularSpiral,rotate2DToOrigin,rotate2DToPoint,squareSpiral,updateFieldBoundaries}=WU;class WordcloudSeries extends ColumnSeries{pointAttribs(point,state){const attribs=H.seriesTypes.column.prototype.pointAttribs.call(this,point,state);delete attribs.stroke;delete attribs["stroke-width"];return attribs}deriveFontSize(relativeWeight,maxFontSize,minFontSize){const weight=isNumber(relativeWeight)?relativeWeight:0,max=isNumber(maxFontSize)?maxFontSize:1,min=isNumber(minFontSize)?minFontSize:1;return Math.floor(Math.max(min,weight*max))}drawPoints(){const series=this,hasRendered=series.hasRendered,xAxis=series.xAxis,yAxis=series.yAxis,chart=series.chart,group=series.group,options=series.options,animation=options.animation,allowExtendPlayingField=options.allowExtendPlayingField,renderer=chart.renderer,placed=[],placementStrategy=series.placementStrategy[options.placementStrategy],rotation=options.rotation,weights=series.points.map(function(p){return p.weight}),maxWeight=Math.max.apply(null,weights),points=series.points.concat().sort((a,b)=>b.weight-a.weight);let testElement=renderer.text().add(group),field;series.group.attr({scaleX:1,scaleY:1});for(const point of points){const relativeWeight=1/maxWeight*point.weight,fontSize=series.deriveFontSize(relativeWeight,options.maxFontSize,options.minFontSize),css=extend({fontSize:fontSize+"px"},options.style);testElement.css(css).attr({x:0,y:0,text:point.name});const bBox=testElement.getBBox(true);point.dimensions={height:bBox.height,width:bBox.width}}field=getPlayingField(xAxis.len,yAxis.len,points);const spiral=getSpiral(series.spirals[options.spiral],{field:field});for(const point of points){const relativeWeight=1/maxWeight*point.weight,fontSize=series.deriveFontSize(relativeWeight,options.maxFontSize,options.minFontSize),css=extend({fontSize:fontSize+"px"},options.style),placement=placementStrategy(point,{data:points,field:field,placed:placed,rotation:rotation}),attr=extend(series.pointAttribs(point,point.selected&&"select"),{align:"center","alignment-baseline":"middle","dominant-baseline":"middle",x:placement.x,y:placement.y,text:point.name,rotation:isNumber(placement.rotation)?placement.rotation:void 0}),polygon=getPolygon(placement.x,placement.y,point.dimensions.width,point.dimensions.height,placement.rotation),rectangle=getBoundingBoxFromPolygon(polygon);let delta=intersectionTesting(point,{rectangle:rectangle,polygon:polygon,field:field,placed:placed,spiral:spiral,rotation:placement.rotation}),animate;if(!delta&&allowExtendPlayingField){field=extendPlayingField(field,rectangle);delta=intersectionTesting(point,{rectangle:rectangle,polygon:polygon,field:field,placed:placed,spiral:spiral,rotation:placement.rotation})}if(isObject(delta)){attr.x=(attr.x||0)+delta.x;attr.y=(attr.y||0)+delta.y;rectangle.left+=delta.x;rectangle.right+=delta.x;rectangle.top+=delta.y;rectangle.bottom+=delta.y;field=updateFieldBoundaries(field,rectangle);placed.push(point);point.isNull=false;point.isInside=true}else{point.isNull=true}if(animation){animate={x:attr.x,y:attr.y};if(!hasRendered){attr.x=0;attr.y=0}else{delete attr.x;delete attr.y}}DPU.draw(point,{animatableAttribs:animate,attribs:attr,css:css,group:group,renderer:renderer,shapeArgs:void 0,shapeType:"text"})}testElement=testElement.destroy();const scale=getScale(xAxis.len,yAxis.len,field);series.group.attr({scaleX:scale,scaleY:scale})}hasData(){const series=this;return isObject(series)&&series.visible===true&&isArray(series.points)&&series.points.length>0}getPlotBox(){const series=this,chart=series.chart,inverted=chart.inverted,xAxis=series[inverted?"yAxis":"xAxis"],yAxis=series[inverted?"xAxis":"yAxis"],width=xAxis?xAxis.len:chart.plotWidth,height=yAxis?yAxis.len:chart.plotHeight,x=xAxis?xAxis.left:chart.plotLeft,y=yAxis?yAxis.top:chart.plotTop;return{translateX:x+width/2,translateY:y+height/2,scaleX:1,scaleY:1}}}WordcloudSeries.defaultOptions=merge(ColumnSeries.defaultOptions,WordcloudSeriesDefaults);extend(WordcloudSeries.prototype,{animate:noop,animateDrilldown:noop,animateDrillupFrom:noop,isCartesian:false,pointClass:WordcloudPoint,setClip:noop,placementStrategy:{random:function(point,options){const field=options.field,r=options.rotation;return{x:getRandomPosition(field.width)-field.width/2,y:getRandomPosition(field.height)-field.height/2,rotation:getRotation(r.orientations,point.index,r.from,r.to)}},center:function(point,options){const r=options.rotation;return{x:0,y:0,rotation:getRotation(r.orientations,point.index,r.from,r.to)}}},pointArrayMap:["weight"],spirals:{archimedean:archimedeanSpiral,rectangular:rectangularSpiral,square:squareSpiral},utils:{extendPlayingField:extendPlayingField,getRotation:getRotation,isPolygonsColliding:isPolygonsColliding,rotate2DToOrigin:rotate2DToOrigin,rotate2DToPoint:rotate2DToPoint}});SeriesRegistry.registerSeriesType("wordcloud",WordcloudSeries);export default WordcloudSeries;