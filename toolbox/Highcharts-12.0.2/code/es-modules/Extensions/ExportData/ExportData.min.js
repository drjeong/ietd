"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import D from"../../Core/Defaults.js";const{getOptions,setOptions}=D;import DownloadURL from"../DownloadURL.js";const{downloadURL}=DownloadURL;import ExportDataDefaults from"./ExportDataDefaults.js";import H from"../../Core/Globals.js";const{doc,win}=H;import U from"../../Core/Utilities.js";const{addEvent,defined,extend,find,fireEvent,isNumber,pick}=U;function wrapLoading(fn){const showMessage=Boolean(this.options.exporting?.showExportInProgress);const timeoutFn=win.requestAnimationFrame||setTimeout;timeoutFn(()=>{showMessage&&this.showLoading(this.options.lang.exportInProgress);timeoutFn(()=>{try{fn.call(this)}finally{showMessage&&this.hideLoading()}})})}function chartDownloadCSV(){wrapLoading.call(this,()=>{const csv=this.getCSV(true);downloadURL(getBlobFromContent(csv,"text/csv")||"data:text/csv,\ufeff"+encodeURIComponent(csv),this.getFilename()+".csv")})}function chartDownloadXLS(){wrapLoading.call(this,()=>{const uri="data:application/vnd.ms-excel;base64,",template='<html xmlns:o="urn:schemas-microsoft-com:office:office" '+'xmlns:x="urn:schemas-microsoft-com:office:excel" '+'xmlns="http://www.w3.org/TR/REC-html40">'+"<head>\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook>"+"<x:ExcelWorksheets><x:ExcelWorksheet>"+"<x:Name>Ark1</x:Name>"+"<x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>"+"</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook>"+"</xml><![endif]--\x3e"+"<style>td{border:none;font-family: Calibri, sans-serif;} "+'.number{mso-number-format:"0.00";} '+'.text{ mso-number-format:"@";}</style>'+"<meta name=ProgId content=Excel.Sheet>"+"<meta charset=UTF-8>"+"</head><body>"+this.getTable(true)+"</body></html>",base64=function(s){return win.btoa(unescape(encodeURIComponent(s)))};downloadURL(getBlobFromContent(template,"application/vnd.ms-excel")||uri+base64(template),this.getFilename()+".xls")})}function chartGetCSV(useLocalDecimalPoint){let csv="";const rows=this.getDataRows(),csvOptions=this.options.exporting.csv,decimalPoint=pick(csvOptions.decimalPoint,csvOptions.itemDelimiter!==","&&useLocalDecimalPoint?1.1.toLocaleString()[1]:"."),itemDelimiter=pick(csvOptions.itemDelimiter,decimalPoint===","?";":","),lineDelimiter=csvOptions.lineDelimiter;rows.forEach((row,i)=>{let val="",j=row.length;while(j--){val=row[j];if(typeof val==="string"){val=`"${val}"`}if(typeof val==="number"){if(decimalPoint!=="."){val=val.toString().replace(".",decimalPoint)}}row[j]=val}row.length=rows.length?rows[0].length:0;csv+=row.join(itemDelimiter);if(i<rows.length-1){csv+=lineDelimiter}});return csv}function chartGetDataRows(multiLevelHeaders){const hasParallelCoords=this.hasParallelCoordinates,time=this.time,csvOptions=this.options.exporting&&this.options.exporting.csv||{},xAxes=this.xAxis,rows={},rowArr=[],topLevelColumnTitles=[],columnTitles=[],langOptions=this.options.lang,exportDataOptions=langOptions.exportData,categoryHeader=exportDataOptions.categoryHeader,categoryDatetimeHeader=exportDataOptions.categoryDatetimeHeader,columnHeaderFormatter=function(item,key,keyLength){if(csvOptions.columnHeaderFormatter){const s=csvOptions.columnHeaderFormatter(item,key,keyLength);if(s!==false){return s}}if(!item){return categoryHeader}if(!item.bindAxes){return item.options.title&&item.options.title.text||(item.dateTime?categoryDatetimeHeader:categoryHeader)}if(multiLevelHeaders){return{columnTitle:keyLength>1?key:item.name,topLevelColumnTitle:item.name}}return item.name+(keyLength>1?" ("+key+")":"")},getCategoryAndDateTimeMap=function(series,pointArrayMap,pIdx){const categoryMap={},dateTimeValueAxisMap={};pointArrayMap.forEach(function(prop){const axisName=(series.keyToAxis&&series.keyToAxis[prop]||prop)+"Axis",axis=isNumber(pIdx)?series.chart[axisName][pIdx]:series[axisName];categoryMap[prop]=axis&&axis.categories||[];dateTimeValueAxisMap[prop]=axis&&axis.dateTime});return{categoryMap:categoryMap,dateTimeValueAxisMap:dateTimeValueAxisMap}},getPointArray=function(series,xAxis){const pointArrayMap=series.pointArrayMap||["y"],namedPoints=series.data.some(d=>typeof d.y!=="undefined"&&d.name);if(namedPoints&&xAxis&&!xAxis.categories&&series.exportKey!=="name"){return["x",...pointArrayMap]}return pointArrayMap},xAxisIndices=[];let xAxis,dataRows,columnTitleObj,i=0,x,xTitle;this.series.forEach(function(series){const keys=series.options.keys,xAxis=series.xAxis,pointArrayMap=keys||getPointArray(series,xAxis),valueCount=pointArrayMap.length,xTaken=!series.requireSorting&&{},xAxisIndex=xAxes.indexOf(xAxis);let categoryAndDatetimeMap=getCategoryAndDateTimeMap(series,pointArrayMap),mockSeries,j;if(series.options.includeInDataExport!==false&&!series.options.isInternal&&series.visible!==false){if(!find(xAxisIndices,function(index){return index[0]===xAxisIndex})){xAxisIndices.push([xAxisIndex,i])}j=0;while(j<valueCount){columnTitleObj=columnHeaderFormatter(series,pointArrayMap[j],pointArrayMap.length);columnTitles.push(columnTitleObj.columnTitle||columnTitleObj);if(multiLevelHeaders){topLevelColumnTitles.push(columnTitleObj.topLevelColumnTitle||columnTitleObj)}j++}mockSeries={chart:series.chart,autoIncrement:series.autoIncrement,options:series.options,pointArrayMap:series.pointArrayMap,index:series.index};series.options.data.forEach(function eachData(options,pIdx){const mockPoint={series:mockSeries};let key,prop,val;if(hasParallelCoords){categoryAndDatetimeMap=getCategoryAndDateTimeMap(series,pointArrayMap,pIdx)}series.pointClass.prototype.applyOptions.apply(mockPoint,[options]);const name=series.data[pIdx]&&series.data[pIdx].name;key=(mockPoint.x??"")+","+name;j=0;if(!xAxis||series.exportKey==="name"||!hasParallelCoords&&xAxis&&xAxis.hasNames&&name){key=name}if(xTaken){if(xTaken[key]){key+="|"+pIdx}xTaken[key]=true}if(!rows[key]){rows[key]=[];rows[key].xValues=[];const arr=[];for(let i=0;i<series.chart.series.length;i++){arr[i]=0}rows[key].pointers=arr;rows[key].pointers[series.index]=1}else{const modifiedKey=`${key},${rows[key].pointers[series.index]}`,originalKey=key;if(rows[key].pointers[series.index]){if(!rows[modifiedKey]){rows[modifiedKey]=[];rows[modifiedKey].xValues=[];rows[modifiedKey].pointers=[]}key=modifiedKey}rows[originalKey].pointers[series.index]+=1}rows[key].x=mockPoint.x;rows[key].name=name;rows[key].xValues[xAxisIndex]=mockPoint.x;while(j<valueCount){prop=pointArrayMap[j];val=series.pointClass.prototype.getNestedProperty.apply(mockPoint,[prop]);rows[key][i+j]=pick(categoryAndDatetimeMap.categoryMap[prop][val],categoryAndDatetimeMap.dateTimeValueAxisMap[prop]?time.dateFormat(csvOptions.dateFormat,val):null,val);j++}});i=i+j}});for(x in rows){if(Object.hasOwnProperty.call(rows,x)){rowArr.push(rows[x])}}let xAxisIndex,column;dataRows=multiLevelHeaders?[topLevelColumnTitles,columnTitles]:[columnTitles];i=xAxisIndices.length;while(i--){xAxisIndex=xAxisIndices[i][0];column=xAxisIndices[i][1];xAxis=xAxes[xAxisIndex];rowArr.sort(function(a,b){return a.xValues[xAxisIndex]-b.xValues[xAxisIndex]});xTitle=columnHeaderFormatter(xAxis);dataRows[0].splice(column,0,xTitle);if(multiLevelHeaders&&dataRows[1]){dataRows[1].splice(column,0,xTitle)}rowArr.forEach(function(row){let category=row.name;if(xAxis&&!defined(category)){if(xAxis.dateTime){if(row.x instanceof Date){row.x=row.x.getTime()}category=time.dateFormat(csvOptions.dateFormat,row.x)}else if(xAxis.categories){category=pick(xAxis.names[row.x],xAxis.categories[row.x],row.x)}else{category=row.x}}row.splice(column,0,category)})}dataRows=dataRows.concat(rowArr);fireEvent(this,"exportData",{dataRows:dataRows});return dataRows}function chartGetTable(useLocalDecimalPoint){const serialize=node=>{if(!node.tagName||node.tagName==="#text"){return node.textContent||""}const attributes=node.attributes;let html=`<${node.tagName}`;if(attributes){Object.keys(attributes).forEach(key=>{const value=attributes[key];html+=` ${key}="${value}"`})}html+=">";html+=node.textContent||"";(node.children||[]).forEach(child=>{html+=serialize(child)});html+=`</${node.tagName}>`;return html};const tree=this.getTableAST(useLocalDecimalPoint);return serialize(tree)}function chartGetTableAST(useLocalDecimalPoint){let rowLength=0;const treeChildren=[];const options=this.options,decimalPoint=useLocalDecimalPoint?1.1.toLocaleString()[1]:".",useMultiLevelHeaders=pick(options.exporting.useMultiLevelHeaders,true),rows=this.getDataRows(useMultiLevelHeaders),topHeaders=useMultiLevelHeaders?rows.shift():null,subHeaders=rows.shift(),isRowEqual=function(row1,row2){let i=row1.length;if(row2.length===i){while(i--){if(row1[i]!==row2[i]){return false}}}else{return false}return true},getCellHTMLFromValue=function(tagName,classes,attributes,value){let textContent=pick(value,""),className="highcharts-text"+(classes?" "+classes:"");if(typeof textContent==="number"){textContent=textContent.toString();if(decimalPoint===","){textContent=textContent.replace(".",decimalPoint)}className="highcharts-number"}else if(!value){className="highcharts-empty"}attributes=extend({class:className},attributes);return{tagName:tagName,attributes:attributes,textContent:textContent}},getTableHeaderHTML=function(topheaders,subheaders,rowLength){const theadChildren=[];let i=0,len=rowLength||subheaders&&subheaders.length,next,cur,curColspan=0,rowspan;if(useMultiLevelHeaders&&topheaders&&subheaders&&!isRowEqual(topheaders,subheaders)){const trChildren=[];for(;i<len;++i){cur=topheaders[i];next=topheaders[i+1];if(cur===next){++curColspan}else if(curColspan){trChildren.push(getCellHTMLFromValue("th","highcharts-table-topheading",{scope:"col",colspan:curColspan+1},cur));curColspan=0}else{if(cur===subheaders[i]){if(options.exporting.useRowspanHeaders){rowspan=2;delete subheaders[i]}else{rowspan=1;subheaders[i]=""}}else{rowspan=1}const cell=getCellHTMLFromValue("th","highcharts-table-topheading",{scope:"col"},cur);if(rowspan>1&&cell.attributes){cell.attributes.valign="top";cell.attributes.rowspan=rowspan}trChildren.push(cell)}}theadChildren.push({tagName:"tr",children:trChildren})}if(subheaders){const trChildren=[];for(i=0,len=subheaders.length;i<len;++i){if(typeof subheaders[i]!=="undefined"){trChildren.push(getCellHTMLFromValue("th",null,{scope:"col"},subheaders[i]))}}theadChildren.push({tagName:"tr",children:trChildren})}return{tagName:"thead",children:theadChildren}};if(options.exporting.tableCaption!==false){treeChildren.push({tagName:"caption",attributes:{class:"highcharts-table-caption"},textContent:pick(options.exporting.tableCaption,options.title.text?options.title.text:"Chart")})}for(let i=0,len=rows.length;i<len;++i){if(rows[i].length>rowLength){rowLength=rows[i].length}}treeChildren.push(getTableHeaderHTML(topHeaders,subHeaders,Math.max(rowLength,subHeaders.length)));const trs=[];rows.forEach(function(row){const trChildren=[];for(let j=0;j<rowLength;j++){trChildren.push(getCellHTMLFromValue(j?"td":"th",null,j?{}:{scope:"row"},row[j]))}trs.push({tagName:"tr",children:trChildren})});treeChildren.push({tagName:"tbody",children:trs});const e={tree:{tagName:"table",id:`highcharts-data-table-${this.index}`,children:treeChildren}};fireEvent(this,"aftergetTableAST",e);return e.tree}function chartHideData(){this.toggleDataTable(false)}function chartToggleDataTable(show){show=pick(show,!this.isDataTableVisible);const createContainer=show&&!this.dataTableDiv;if(createContainer){this.dataTableDiv=doc.createElement("div");this.dataTableDiv.className="highcharts-data-table";this.renderTo.parentNode.insertBefore(this.dataTableDiv,this.renderTo.nextSibling)}if(this.dataTableDiv){const style=this.dataTableDiv.style,oldDisplay=style.display;style.display=show?"block":"none";if(show){this.dataTableDiv.innerHTML=AST.emptyHTML;const ast=new AST([this.getTableAST()]);ast.addToDOM(this.dataTableDiv);fireEvent(this,"afterViewData",{element:this.dataTableDiv,wasHidden:createContainer||oldDisplay!==style.display})}else{fireEvent(this,"afterHideData")}}this.isDataTableVisible=show;const exportDivElements=this.exportDivElements,options=this.options.exporting,menuItems=options&&options.buttons&&options.buttons.contextButton.menuItems,lang=this.options.lang;if(options&&options.menuItemDefinitions&&lang&&lang.viewData&&lang.hideData&&menuItems&&exportDivElements){const exportDivElement=exportDivElements[menuItems.indexOf("viewData")];if(exportDivElement){AST.setElementHTML(exportDivElement,this.isDataTableVisible?lang.hideData:lang.viewData)}}}function chartViewData(){this.toggleDataTable(true)}function compose(ChartClass,SeriesClass){const chartProto=ChartClass.prototype;if(!chartProto.getCSV){const exportingOptions=getOptions().exporting;addEvent(ChartClass,"afterViewData",onChartAfterViewData);addEvent(ChartClass,"render",onChartRenderer);addEvent(ChartClass,"destroy",onChartDestroy);chartProto.downloadCSV=chartDownloadCSV;chartProto.downloadXLS=chartDownloadXLS;chartProto.getCSV=chartGetCSV;chartProto.getDataRows=chartGetDataRows;chartProto.getTable=chartGetTable;chartProto.getTableAST=chartGetTableAST;chartProto.hideData=chartHideData;chartProto.toggleDataTable=chartToggleDataTable;chartProto.viewData=chartViewData;if(exportingOptions){extend(exportingOptions.menuItemDefinitions,{downloadCSV:{textKey:"downloadCSV",onclick:function(){this.downloadCSV()}},downloadXLS:{textKey:"downloadXLS",onclick:function(){this.downloadXLS()}},viewData:{textKey:"viewData",onclick:function(){wrapLoading.call(this,this.toggleDataTable)}}});if(exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems){exportingOptions.buttons.contextButton.menuItems.push("separator","downloadCSV","downloadXLS","viewData")}}setOptions(ExportDataDefaults);const{arearange:AreaRangeSeries,gantt:GanttSeries,map:MapSeries,mapbubble:MapBubbleSeries,treemap:TreemapSeries,xrange:XRangeSeries}=SeriesClass.types;if(AreaRangeSeries){AreaRangeSeries.prototype.keyToAxis={low:"y",high:"y"}}if(GanttSeries){GanttSeries.prototype.exportKey="name";GanttSeries.prototype.keyToAxis={start:"x",end:"x"}}if(MapSeries){MapSeries.prototype.exportKey="name"}if(MapBubbleSeries){MapBubbleSeries.prototype.exportKey="name"}if(TreemapSeries){TreemapSeries.prototype.exportKey="name"}if(XRangeSeries){XRangeSeries.prototype.keyToAxis={x2:"x"}}}}function getBlobFromContent(content,type){const nav=win.navigator,domurl=win.URL||win.webkitURL||win;try{if(nav.msSaveOrOpenBlob&&win.MSBlobBuilder){const blob=new win.MSBlobBuilder;blob.append(content);return blob.getBlob("image/svg+xml")}return domurl.createObjectURL(new win.Blob(["\ufeff"+content],{type:type}))}catch(e){}}function onChartAfterViewData(){const chart=this,dataTableDiv=chart.dataTableDiv,getCellValue=(tr,index)=>tr.children[index].textContent,comparer=(index,ascending)=>(a,b)=>{const sort=(v1,v2)=>v1!==""&&v2!==""&&!isNaN(v1)&&!isNaN(v2)?v1-v2:v1.toString().localeCompare(v2);return sort(getCellValue(ascending?a:b,index),getCellValue(ascending?b:a,index))};if(dataTableDiv&&chart.options.exporting&&chart.options.exporting.allowTableSorting){const row=dataTableDiv.querySelector("thead tr");if(row){row.childNodes.forEach(th=>{const table=th.closest("table");th.addEventListener("click",function(){const rows=[...dataTableDiv.querySelectorAll("tr:not(thead tr)")],headers=[...th.parentNode.children];rows.sort(comparer(headers.indexOf(th),chart.ascendingOrderInTable=!chart.ascendingOrderInTable)).forEach(tr=>{table.appendChild(tr)});headers.forEach(th=>{["highcharts-sort-ascending","highcharts-sort-descending"].forEach(className=>{if(th.classList.contains(className)){th.classList.remove(className)}})});th.classList.add(chart.ascendingOrderInTable?"highcharts-sort-ascending":"highcharts-sort-descending")})})}}}function onChartRenderer(){if(this.options&&this.options.exporting&&this.options.exporting.showTable&&!this.options.chart.forExport){this.viewData()}}function onChartDestroy(){this.dataTableDiv?.remove()}const ExportData={compose:compose};export default ExportData;"";