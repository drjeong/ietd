"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import D from"../../Core/Defaults.js";const{defaultOptions}=D;import DownloadURL from"../DownloadURL.js";const{downloadURL}=DownloadURL;import Exporting from"../Exporting/Exporting.js";import H from"../../Core/Globals.js";const{doc,win}=H;import HU from"../../Core/HttpUtilities.js";const{ajax}=HU;import OfflineExportingDefaults from"./OfflineExportingDefaults.js";import U from"../../Core/Utilities.js";const{addEvent,error,extend,fireEvent,merge}=U;AST.allowedAttributes.push("data-z-index","fill-opacity","filter","rx","ry","stroke-dasharray","stroke-linejoin","stroke-opacity","text-anchor","transform","version","viewBox","visibility","xmlns","xmlns:xlink");AST.allowedTags.push("desc","clippath","g");var OfflineExporting;(function(OfflineExporting){OfflineExporting.CanVGRenderer={},OfflineExporting.domurl=win.URL||win.webkitURL||win,OfflineExporting.loadEventDeferDelay=H.isMS?150:0;function compose(ChartClass){const chartProto=ChartClass.prototype;if(!chartProto.exportChartLocal){chartProto.getSVGForLocalExport=getSVGForLocalExport;chartProto.exportChartLocal=exportChartLocal;merge(true,defaultOptions.exporting,OfflineExportingDefaults)}return ChartClass}OfflineExporting.compose=compose;function downloadSVGLocal(svg,options,failCallback,successCallback){const dummySVGContainer=doc.createElement("div"),imageType=options.type||"image/png",filename=(options.filename||"chart")+"."+(imageType==="image/svg+xml"?"svg":imageType.split("/")[1]),scale=options.scale||1;let svgurl,blob,finallyHandler,libURL=options.libURL||defaultOptions.exporting.libURL,objectURLRevoke=true,pdfFont=options.pdfFont;libURL=libURL.slice(-1)!=="/"?libURL+"/":libURL;const loadPdfFonts=(svgElement,callback)=>{const hasNonASCII=s=>/[^\u0000-\u007F\u200B]+/.test(s);const addFont=(variant,base64)=>{win.jspdf.jsPDF.API.events.push(["initialized",function(){this.addFileToVFS(variant,base64);this.addFont(variant,"HighchartsFont",variant);if(!this.getFontList().HighchartsFont){this.setFont("HighchartsFont")}}])};if(pdfFont&&!hasNonASCII(svgElement.textContent||"")){pdfFont=void 0}const variants=["normal","italic","bold","bolditalic"];let normalBase64;const shiftAndLoadVariant=()=>{const variant=variants.shift();if(!variant){return callback()}const url=pdfFont&&pdfFont[variant];if(url){ajax({url:url,responseType:"blob",success:(data,xhr)=>{const reader=new FileReader;reader.onloadend=function(){if(typeof this.result==="string"){const base64=this.result.split(",")[1];addFont(variant,base64);if(variant==="normal"){normalBase64=base64}}shiftAndLoadVariant()};reader.readAsDataURL(xhr.response)},error:shiftAndLoadVariant})}else{if(normalBase64){addFont(variant,normalBase64)}shiftAndLoadVariant()}};shiftAndLoadVariant()};const downloadPDF=()=>{AST.setElementHTML(dummySVGContainer,svg);const textElements=dummySVGContainer.getElementsByTagName("text"),setStylePropertyFromParents=function(el,propName){let curParent=el;while(curParent&&curParent!==dummySVGContainer){if(curParent.style[propName]){let value=curParent.style[propName];if(propName==="fontSize"&&/em$/.test(value)){value=Math.round(parseFloat(value)*16)+"px"}el.style[propName]=value;break}curParent=curParent.parentNode}};let titleElements,outlineElements;[].forEach.call(textElements,function(el){["fontFamily","fontSize"].forEach(property=>{setStylePropertyFromParents(el,property)});el.style.fontFamily=pdfFont&&pdfFont.normal?"HighchartsFont":String(el.style.fontFamily&&el.style.fontFamily.split(" ").splice(-1));titleElements=el.getElementsByTagName("title");[].forEach.call(titleElements,function(titleElement){el.removeChild(titleElement)});outlineElements=el.getElementsByClassName("highcharts-text-outline");while(outlineElements.length>0){const outline=outlineElements[0];if(outline.parentNode){outline.parentNode.removeChild(outline)}}});const svgNode=dummySVGContainer.querySelector("svg");if(svgNode){loadPdfFonts(svgNode,()=>{svgToPdf(svgNode,0,scale,pdfData=>{try{downloadURL(pdfData,filename);if(successCallback){successCallback()}}catch(e){failCallback(e)}})})}};if(imageType==="image/svg+xml"){try{if(typeof win.MSBlobBuilder!=="undefined"){blob=new win.MSBlobBuilder;blob.append(svg);svgurl=blob.getBlob("image/svg+xml")}else{svgurl=svgToDataUrl(svg)}downloadURL(svgurl,filename);if(successCallback){successCallback()}}catch(e){failCallback(e)}}else if(imageType==="application/pdf"){if(win.jspdf&&win.jspdf.jsPDF){downloadPDF()}else{objectURLRevoke=true;getScript(libURL+"jspdf.js",function(){getScript(libURL+"svg2pdf.js",downloadPDF)})}}else{svgurl=svgToDataUrl(svg);finallyHandler=function(){try{OfflineExporting.domurl.revokeObjectURL(svgurl)}catch(e){}};imageToDataUrl(svgurl,imageType,{},scale,function(imageURL){try{downloadURL(imageURL,filename);if(successCallback){successCallback()}}catch(e){failCallback(e)}},function(){if(svg.length>1e8){throw new Error("Input too long")}const canvas=doc.createElement("canvas"),ctx=canvas.getContext("2d"),matchedImageWidth=svg.match(/^<svg[^>]*\s{,1000}width\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/),matchedImageHeight=svg.match(/^<svg[^>]*\s{0,1000}height\s{,1000}=\s{,1000}\"?(\d+)\"?[^>]*>/);if(ctx&&matchedImageWidth&&matchedImageHeight){const imageWidth=+matchedImageWidth[1]*scale,imageHeight=+matchedImageHeight[1]*scale,downloadWithCanVG=()=>{const v=win.canvg.Canvg.fromString(ctx,svg);v.start();try{downloadURL(win.navigator.msSaveOrOpenBlob?canvas.msToBlob():canvas.toDataURL(imageType),filename);if(successCallback){successCallback()}}catch(e){failCallback(e)}finally{finallyHandler()}};canvas.width=imageWidth;canvas.height=imageHeight;if(win.canvg){downloadWithCanVG()}else{objectURLRevoke=true;getScript(libURL+"canvg.js",downloadWithCanVG)}}},failCallback,failCallback,function(){if(objectURLRevoke){finallyHandler()}})}}OfflineExporting.downloadSVGLocal=downloadSVGLocal;function exportChartLocal(exportingOptions,chartOptions){const chart=this,options=merge(chart.options.exporting,exportingOptions),fallbackToExportServer=function(err){if(options.fallbackToExportServer===false){if(options.error){options.error(options,err)}else{error(28,true)}}else{chart.exportChart(options)}},svgSuccess=function(svg){if(svg.indexOf("<foreignObject")>-1&&options.type!=="image/svg+xml"&&(H.isMS||options.type==="application/pdf")){fallbackToExportServer(new Error("Image type not supported for charts with embedded HTML"))}else{OfflineExporting.downloadSVGLocal(svg,extend({filename:chart.getFilename()},options),fallbackToExportServer,()=>fireEvent(chart,"exportChartLocalSuccess"))}},hasExternalImages=function(){return[].some.call(chart.container.getElementsByTagName("image"),function(image){const href=image.getAttribute("href");return href!==""&&typeof href==="string"&&href.indexOf("data:")!==0})};if(H.isMS&&chart.styledMode&&!Exporting.inlineAllowlist.length){Exporting.inlineAllowlist.push(/^blockSize/,/^border/,/^caretColor/,/^color/,/^columnRule/,/^columnRuleColor/,/^cssFloat/,/^cursor/,/^fill$/,/^fillOpacity/,/^font/,/^inlineSize/,/^length/,/^lineHeight/,/^opacity/,/^outline/,/^parentRule/,/^rx$/,/^ry$/,/^stroke/,/^textAlign/,/^textAnchor/,/^textDecoration/,/^transform/,/^vectorEffect/,/^visibility/,/^x$/,/^y$/)}if(H.isMS&&(options.type==="application/pdf"||chart.container.getElementsByTagName("image").length&&options.type!=="image/svg+xml")||options.type==="application/pdf"&&hasExternalImages()){fallbackToExportServer(new Error("Image type not supported for this chart/browser."));return}chart.getSVGForLocalExport(options,chartOptions||{},fallbackToExportServer,svgSuccess)}function getScript(scriptLocation,callback){const head=doc.getElementsByTagName("head")[0],script=doc.createElement("script");script.type="text/javascript";script.src=scriptLocation;script.onload=callback;script.onerror=function(){error("Error loading script "+scriptLocation)};head.appendChild(script)}OfflineExporting.getScript=getScript;function getSVGForLocalExport(options,chartOptions,failCallback,successCallback){const chart=this,sanitize=svg=>chart.sanitizeSVG(svg,chartCopyOptions),checkDone=()=>{if(images&&imagesEmbedded===imagesLength){successCallback(sanitize(chartCopyContainer.innerHTML))}},embeddedSuccess=(imageURL,imageType,callbackArgs)=>{++imagesEmbedded;callbackArgs.imageElement.setAttributeNS("http://www.w3.org/1999/xlink","href",imageURL);checkDone()};let el,chartCopyContainer,chartCopyOptions,href=null,images,imagesLength=0,imagesEmbedded=0;chart.unbindGetSVG=addEvent(chart,"getSVG",e=>{chartCopyOptions=e.chartCopy.options;chartCopyContainer=e.chartCopy.container.cloneNode(true);images=chartCopyContainer&&chartCopyContainer.getElementsByTagName("image")||[];imagesLength=images.length});chart.getSVGForExport(options,chartOptions);try{if(!images||!images.length){successCallback(sanitize(chartCopyContainer.innerHTML));return}for(let i=0;i<images.length;i++){el=images[i];href=el.getAttributeNS("http://www.w3.org/1999/xlink","href");if(href){OfflineExporting.imageToDataUrl(href,"image/png",{imageElement:el},options.scale,embeddedSuccess,failCallback,failCallback,failCallback)}else{imagesEmbedded++;el.parentNode.removeChild(el);i--;checkDone()}}}catch(e){failCallback(e)}chart.unbindGetSVG()}function imageToDataUrl(imageURL,imageType,callbackArgs,scale,successCallback,taintedCallback,noCanvasSupportCallback,failedLoadCallback,finallyCallback){let img=new win.Image,taintedHandler;const loadHandler=()=>{setTimeout(function(){const canvas=doc.createElement("canvas"),ctx=canvas.getContext&&canvas.getContext("2d");let dataURL;try{if(!ctx){noCanvasSupportCallback(imageURL,imageType,callbackArgs,scale)}else{canvas.height=img.height*scale;canvas.width=img.width*scale;ctx.drawImage(img,0,0,canvas.width,canvas.height);try{dataURL=canvas.toDataURL(imageType);successCallback(dataURL,imageType,callbackArgs,scale)}catch(e){taintedHandler(imageURL,imageType,callbackArgs,scale)}}}finally{if(finallyCallback){finallyCallback(imageURL,imageType,callbackArgs,scale)}}},OfflineExporting.loadEventDeferDelay)},errorHandler=()=>{failedLoadCallback(imageURL,imageType,callbackArgs,scale);if(finallyCallback){finallyCallback(imageURL,imageType,callbackArgs,scale)}};taintedHandler=()=>{img=new win.Image;taintedHandler=taintedCallback;img.crossOrigin="Anonymous";img.onload=loadHandler;img.onerror=errorHandler;img.src=imageURL};img.onload=loadHandler;img.onerror=errorHandler;img.src=imageURL}OfflineExporting.imageToDataUrl=imageToDataUrl;function svgToDataUrl(svg){const userAgent=win.navigator.userAgent;const webKit=userAgent.indexOf("WebKit")>-1&&userAgent.indexOf("Chrome")<0;try{if(!webKit&&svg.indexOf("<foreignObject")===-1){return OfflineExporting.domurl.createObjectURL(new win.Blob([svg],{type:"image/svg+xml;charset-utf-16"}))}}catch(e){}return"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(svg)}OfflineExporting.svgToDataUrl=svgToDataUrl;function svgToPdf(svgElement,margin,scale,callback){const width=(Number(svgElement.getAttribute("width"))+2*margin)*scale,height=(Number(svgElement.getAttribute("height"))+2*margin)*scale,pdfDoc=new win.jspdf.jsPDF(height>width?"p":"l","pt",[width,height]);[].forEach.call(svgElement.querySelectorAll('*[visibility="hidden"]'),function(node){node.parentNode.removeChild(node)});const gradients=svgElement.querySelectorAll("linearGradient");for(let index=0;index<gradients.length;index++){const gradient=gradients[index];const stops=gradient.querySelectorAll("stop");let i=0;while(i<stops.length&&stops[i].getAttribute("offset")==="0"&&stops[i+1].getAttribute("offset")==="0"){stops[i].remove();i++}}[].forEach.call(svgElement.querySelectorAll("tspan"),tspan=>{if(tspan.textContent==="​"){tspan.textContent=" ";tspan.setAttribute("dx",-5)}});pdfDoc.svg(svgElement,{x:0,y:0,width:width,height:height,removeInvalid:true}).then(()=>callback(pdfDoc.output("datauristring")))}OfflineExporting.svgToPdf=svgToPdf})(OfflineExporting||(OfflineExporting={}));export default OfflineExporting;