"use strict";import BoostableMap from"./BoostableMap.js";import H from"../../Core/Globals.js";const{composed}=H;import U from"../../Core/Utilities.js";const{addEvent,pick,pushUnique}=U;function compose(ChartClass,wglMode){if(wglMode&&pushUnique(composed,"Boost.Chart")){ChartClass.prototype.callbacks.push(onChartCallback)}return ChartClass}function getBoostClipRect(chart,target){const navigator=chart.navigator;let clipBox={x:chart.plotLeft,y:chart.plotTop,width:chart.plotWidth,height:chart.plotHeight};if(navigator&&chart.inverted){clipBox.width+=navigator.top+navigator.height;if(!navigator.opposite){clipBox.x=navigator.left}}else if(navigator&&!chart.inverted){clipBox.height=navigator.top+navigator.height-chart.plotTop}if(target.getClipBox){const{xAxis,yAxis}=target;clipBox=target.getClipBox();if(chart.inverted){const lateral=clipBox.width;clipBox.width=clipBox.height;clipBox.height=lateral;clipBox.x=yAxis.pos;clipBox.y=xAxis.pos}else{clipBox.x=xAxis.pos;clipBox.y=yAxis.pos}}if(target===chart){const verticalAxes=chart.inverted?chart.xAxis:chart.yAxis;if(verticalAxes.length<=1){clipBox.y=Math.min(verticalAxes[0].pos,clipBox.y);clipBox.height=verticalAxes[0].pos-chart.plotTop+verticalAxes[0].len}}return clipBox}function isChartSeriesBoosting(chart){const allSeries=chart.series,boost=chart.boost=chart.boost||{},boostOptions=chart.options.boost||{},threshold=pick(boostOptions.seriesThreshold,50);if(allSeries.length>=threshold){return true}if(allSeries.length===1){return false}let allowBoostForce=boostOptions.allowForce;if(typeof allowBoostForce==="undefined"){allowBoostForce=true;for(const axis of chart.xAxis){if(pick(axis.min,-Infinity)>pick(axis.dataMin,-Infinity)||pick(axis.max,Infinity)<pick(axis.dataMax,Infinity)){allowBoostForce=false;break}}}if(typeof boost.forceChartBoost!=="undefined"){if(allowBoostForce){return boost.forceChartBoost}boost.forceChartBoost=void 0}let canBoostCount=0,needBoostCount=0,seriesOptions;for(const series of allSeries){seriesOptions=series.options;if(seriesOptions.boostThreshold===0||series.visible===false){continue}if(series.type==="heatmap"){continue}if(BoostableMap[series.type]){++canBoostCount}if(patientMax(series.getColumn("x",true),seriesOptions.data,series.points)>=(seriesOptions.boostThreshold||Number.MAX_VALUE)){++needBoostCount}}boost.forceChartBoost=allowBoostForce&&(canBoostCount===allSeries.length&&needBoostCount===canBoostCount||needBoostCount>5);return boost.forceChartBoost}function onChartCallback(chart){function canvasToSVG(){if(chart.boost&&chart.boost.wgl&&isChartSeriesBoosting(chart)){chart.boost.wgl.render(chart)}}function preRender(){chart.boost=chart.boost||{};chart.boost.forceChartBoost=void 0;chart.boosted=false;if(!chart.axes.some(axis=>axis.isPanning)){chart.boost.clear?.()}if(chart.boost.canvas&&chart.boost.wgl&&isChartSeriesBoosting(chart)){chart.boost.wgl.allocateBuffer(chart)}if(chart.boost.markerGroup&&chart.xAxis&&chart.xAxis.length>0&&chart.yAxis&&chart.yAxis.length>0){chart.boost.markerGroup.translate(chart.xAxis[0].pos,chart.yAxis[0].pos)}}addEvent(chart,"predraw",preRender);addEvent(chart,"load",canvasToSVG,{order:-1});addEvent(chart,"redraw",canvasToSVG);let prevX=-1;let prevY=-1;addEvent(chart.pointer,"afterGetHoverData",e=>{const series=e.hoverPoint?.series;chart.boost=chart.boost||{};if(chart.boost.markerGroup&&series){const xAxis=chart.inverted?series.yAxis:series.xAxis;const yAxis=chart.inverted?series.xAxis:series.yAxis;if(xAxis&&xAxis.pos!==prevX||yAxis&&yAxis.pos!==prevY){chart.series.forEach(s=>{s.halo?.hide()});chart.boost.markerGroup.translate(xAxis.pos,yAxis.pos);prevX=xAxis.pos;prevY=yAxis.pos}}})}function patientMax(...args){let r=-Number.MAX_VALUE;args.forEach(t=>{if(typeof t!=="undefined"&&t!==null&&typeof t.length!=="undefined"){if(t.length>0){r=t.length;return true}}});return r}const BoostChart={compose:compose,getBoostClipRect:getBoostClipRect,isChartSeriesBoosting:isChartSeriesBoosting};export default BoostChart;