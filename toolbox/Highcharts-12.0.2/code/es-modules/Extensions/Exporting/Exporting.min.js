"use strict";import AST from"../../Core/Renderer/HTML/AST.js";import Chart from"../../Core/Chart/Chart.js";import ChartNavigationComposition from"../../Core/Chart/ChartNavigationComposition.js";import D from"../../Core/Defaults.js";const{defaultOptions}=D;import ExportingDefaults from"./ExportingDefaults.js";import ExportingSymbols from"./ExportingSymbols.js";import Fullscreen from"./Fullscreen.js";import G from"../../Core/Globals.js";const{doc,SVG_NS,win}=G;import HU from"../../Core/HttpUtilities.js";import U from"../../Core/Utilities.js";const{addEvent,css,createElement,discardElement,extend,find,fireEvent,isObject,merge,objectEach,pick,removeEvent,uniqueKey}=U;var Exporting;(function(Exporting){const inlineDenylist=[/-/,/^(clipPath|cssText|d|height|width)$/,/^font$/,/[lL]ogical(Width|Height)$/,/^parentRule$/,/^(cssRules|ownerRules)$/,/perspective/,/TapHighlightColor/,/^transition/,/^length$/,/^\d+$/];const inlineToAttributes=["fill","stroke","strokeLinecap","strokeLinejoin","strokeWidth","textAnchor","x","y"];Exporting.inlineAllowlist=[];const unstyledElements=["clipPath","defs","desc"];let printingChart;function addButton(options){const chart=this,renderer=chart.renderer,btnOptions=merge(chart.options.navigation.buttonOptions,options),onclick=btnOptions.onclick,menuItems=btnOptions.menuItems,symbolSize=btnOptions.symbolSize||12;let symbol;if(!chart.btnCount){chart.btnCount=0}if(!chart.exportDivElements){chart.exportDivElements=[];chart.exportSVGElements=[]}if(btnOptions.enabled===false||!btnOptions.theme){return}const theme=chart.styledMode?{}:btnOptions.theme;let callback;if(onclick){callback=function(e){if(e){e.stopPropagation()}onclick.call(chart,e)}}else if(menuItems){callback=function(e){if(e){e.stopPropagation()}chart.contextMenu(button.menuClassName,menuItems,button.translateX||0,button.translateY||0,button.width||0,button.height||0,button);button.setState(2)}}if(btnOptions.text&&btnOptions.symbol){theme.paddingLeft=pick(theme.paddingLeft,30)}else if(!btnOptions.text){extend(theme,{width:btnOptions.width,height:btnOptions.height,padding:0})}const button=renderer.button(btnOptions.text,0,0,callback,theme,void 0,void 0,void 0,void 0,btnOptions.useHTML).addClass(options.className).attr({title:pick(chart.options.lang[btnOptions._titleKey||btnOptions.titleKey],"")});button.menuClassName=options.menuClassName||"highcharts-menu-"+chart.btnCount++;if(btnOptions.symbol){symbol=renderer.symbol(btnOptions.symbol,Math.round((btnOptions.symbolX||0)-symbolSize/2),Math.round((btnOptions.symbolY||0)-symbolSize/2),symbolSize,symbolSize,{width:symbolSize,height:symbolSize}).addClass("highcharts-button-symbol").attr({zIndex:1}).add(button);if(!chart.styledMode){symbol.attr({stroke:btnOptions.symbolStroke,fill:btnOptions.symbolFill,"stroke-width":btnOptions.symbolStrokeWidth||1})}}button.add(chart.exportingGroup).align(extend(btnOptions,{width:button.width,x:pick(btnOptions.x,chart.buttonOffset)}),true,"spacingBox");chart.buttonOffset+=((button.width||0)+btnOptions.buttonSpacing)*(btnOptions.align==="right"?-1:1);chart.exportSVGElements.push(button,symbol)}function afterPrint(){const chart=this;if(!chart.printReverseInfo){return void 0}const{childNodes,origDisplay,resetParams}=chart.printReverseInfo;chart.moveContainers(chart.renderTo);[].forEach.call(childNodes,function(node,i){if(node.nodeType===1){node.style.display=origDisplay[i]||""}});chart.isPrinting=false;if(resetParams){chart.setSize.apply(chart,resetParams)}delete chart.printReverseInfo;printingChart=void 0;fireEvent(chart,"afterPrint")}function beforePrint(){const chart=this,body=doc.body,printMaxWidth=chart.options.exporting.printMaxWidth,printReverseInfo={childNodes:body.childNodes,origDisplay:[],resetParams:void 0};chart.isPrinting=true;chart.pointer?.reset(void 0,0);fireEvent(chart,"beforePrint");const handleMaxWidth=printMaxWidth&&chart.chartWidth>printMaxWidth;if(handleMaxWidth){printReverseInfo.resetParams=[chart.options.chart.width,void 0,false];chart.setSize(printMaxWidth,void 0,false)}[].forEach.call(printReverseInfo.childNodes,function(node,i){if(node.nodeType===1){printReverseInfo.origDisplay[i]=node.style.display;node.style.display="none"}});chart.moveContainers(body);chart.printReverseInfo=printReverseInfo}function chartCallback(chart){const composition=chart;composition.renderExporting();addEvent(chart,"redraw",composition.renderExporting);addEvent(chart,"destroy",composition.destroyExport)}function compose(ChartClass,SVGRendererClass){ExportingSymbols.compose(SVGRendererClass);Fullscreen.compose(ChartClass);const chartProto=ChartClass.prototype;if(!chartProto.exportChart){chartProto.afterPrint=afterPrint;chartProto.exportChart=exportChart;chartProto.inlineStyles=inlineStyles;chartProto.print=print;chartProto.sanitizeSVG=sanitizeSVG;chartProto.getChartHTML=getChartHTML;chartProto.getSVG=getSVG;chartProto.getSVGForExport=getSVGForExport;chartProto.getFilename=getFilename;chartProto.moveContainers=moveContainers;chartProto.beforePrint=beforePrint;chartProto.contextMenu=contextMenu;chartProto.addButton=addButton;chartProto.destroyExport=destroyExport;chartProto.renderExporting=renderExporting;chartProto.callbacks.push(chartCallback);addEvent(ChartClass,"init",onChartInit);addEvent(ChartClass,"layOutTitle",onChartLayOutTitle);if(G.isSafari){win.matchMedia("print").addListener(function(mqlEvent){if(!printingChart){return void 0}if(mqlEvent.matches){printingChart.beforePrint()}else{printingChart.afterPrint()}})}defaultOptions.exporting=merge(ExportingDefaults.exporting,defaultOptions.exporting);defaultOptions.lang=merge(ExportingDefaults.lang,defaultOptions.lang);defaultOptions.navigation=merge(ExportingDefaults.navigation,defaultOptions.navigation)}}Exporting.compose=compose;function contextMenu(className,items,x,y,width,height,button){const chart=this,navOptions=chart.options.navigation,chartWidth=chart.chartWidth,chartHeight=chart.chartHeight,cacheName="cache-"+className,menuPadding=Math.max(width,height);let innerMenu,menu=chart[cacheName];if(!menu){chart.exportContextMenu=chart[cacheName]=menu=createElement("div",{className:className},{position:"absolute",zIndex:1e3,padding:menuPadding+"px",pointerEvents:"auto",...chart.renderer.style},chart.scrollablePlotArea?.fixedDiv||chart.container);innerMenu=createElement("ul",{className:"highcharts-menu"},chart.styledMode?{}:{listStyle:"none",margin:0,padding:0},menu);if(!chart.styledMode){css(innerMenu,extend({MozBoxShadow:"3px 3px 10px #888",WebkitBoxShadow:"3px 3px 10px #888",boxShadow:"3px 3px 10px #888"},navOptions.menuStyle))}menu.hideMenu=function(){css(menu,{display:"none"});if(button){button.setState(0)}chart.openMenu=false;css(chart.renderTo,{overflow:"hidden"});css(chart.container,{overflow:"hidden"});U.clearTimeout(menu.hideTimer);fireEvent(chart,"exportMenuHidden")};chart.exportEvents.push(addEvent(menu,"mouseleave",function(){menu.hideTimer=win.setTimeout(menu.hideMenu,500)}),addEvent(menu,"mouseenter",function(){U.clearTimeout(menu.hideTimer)}),addEvent(doc,"mouseup",function(e){if(!chart.pointer?.inClass(e.target,className)){menu.hideMenu()}}),addEvent(menu,"click",function(){if(chart.openMenu){menu.hideMenu()}}));items.forEach(function(item){if(typeof item==="string"){item=chart.options.exporting.menuItemDefinitions[item]}if(isObject(item,true)){let element;if(item.separator){element=createElement("hr",void 0,void 0,innerMenu)}else{if(item.textKey==="viewData"&&chart.isDataTableVisible){item.textKey="hideData"}element=createElement("li",{className:"highcharts-menu-item",onclick:function(e){if(e){e.stopPropagation()}menu.hideMenu();if(typeof item!=="string"&&item.onclick){item.onclick.apply(chart,arguments)}}},void 0,innerMenu);AST.setElementHTML(element,item.text||chart.options.lang[item.textKey]);if(!chart.styledMode){element.onmouseover=function(){css(this,navOptions.menuItemHoverStyle)};element.onmouseout=function(){css(this,navOptions.menuItemStyle)};css(element,extend({cursor:"pointer"},navOptions.menuItemStyle||{}))}}chart.exportDivElements.push(element)}});chart.exportDivElements.push(innerMenu,menu);chart.exportMenuWidth=menu.offsetWidth;chart.exportMenuHeight=menu.offsetHeight}const menuStyle={display:"block"};if(x+(chart.exportMenuWidth||0)>chartWidth){menuStyle.right=chartWidth-x-width-menuPadding+"px"}else{menuStyle.left=x-menuPadding+"px"}if(y+height+(chart.exportMenuHeight||0)>chartHeight&&button.alignOptions?.verticalAlign!=="top"){menuStyle.bottom=chartHeight-y-menuPadding+"px"}else{menuStyle.top=y+height-menuPadding+"px"}css(menu,menuStyle);css(chart.renderTo,{overflow:""});css(chart.container,{overflow:""});chart.openMenu=true;fireEvent(chart,"exportMenuShown")}function destroyExport(e){const chart=e?e.target:this,exportSVGElements=chart.exportSVGElements,exportDivElements=chart.exportDivElements,exportEvents=chart.exportEvents;let cacheName;if(exportSVGElements){exportSVGElements.forEach((elem,i)=>{if(elem){elem.onclick=elem.ontouchstart=null;cacheName="cache-"+elem.menuClassName;if(chart[cacheName]){delete chart[cacheName]}exportSVGElements[i]=elem.destroy()}});exportSVGElements.length=0}if(chart.exportingGroup){chart.exportingGroup.destroy();delete chart.exportingGroup}if(exportDivElements){exportDivElements.forEach(function(elem,i){if(elem){U.clearTimeout(elem.hideTimer);removeEvent(elem,"mouseleave");exportDivElements[i]=elem.onmouseout=elem.onmouseover=elem.ontouchstart=elem.onclick=null;discardElement(elem)}});exportDivElements.length=0}if(exportEvents){exportEvents.forEach(function(unbind){unbind()});exportEvents.length=0}}function exportChart(exportingOptions,chartOptions){const svg=this.getSVGForExport(exportingOptions,chartOptions);exportingOptions=merge(this.options.exporting,exportingOptions);HU.post(exportingOptions.url,{filename:exportingOptions.filename?exportingOptions.filename.replace(/\//g,"-"):this.getFilename(),type:exportingOptions.type,width:exportingOptions.width,scale:exportingOptions.scale,svg:svg},exportingOptions.fetchOptions)}function getChartHTML(applyStyleSheets){if(applyStyleSheets){this.inlineStyles()}return this.container.innerHTML}function getFilename(){const s=this.userOptions.title&&this.userOptions.title.text;let filename=this.options.exporting.filename;if(filename){return filename.replace(/\//g,"-")}if(typeof s==="string"){filename=s.toLowerCase().replace(/<\/?[^>]+(>|$)/g,"").replace(/[\s_]+/g,"-").replace(/[^a-z\d\-]/g,"").replace(/^[\-]+/g,"").replace(/[\-]+/g,"-").substr(0,24).replace(/[\-]+$/g,"")}if(!filename||filename.length<5){filename="chart"}return filename}function getSVG(chartOptions){const chart=this;let svg,seriesOptions,options=merge(chart.options,chartOptions);options.plotOptions=merge(chart.userOptions.plotOptions,chartOptions&&chartOptions.plotOptions);options.time=merge(chart.userOptions.time,chartOptions&&chartOptions.time);const sandbox=createElement("div",null,{position:"absolute",top:"-9999em",width:chart.chartWidth+"px",height:chart.chartHeight+"px"},doc.body);const cssWidth=chart.renderTo.style.width,cssHeight=chart.renderTo.style.height,sourceWidth=options.exporting.sourceWidth||options.chart.width||/px$/.test(cssWidth)&&parseInt(cssWidth,10)||(options.isGantt?800:600),sourceHeight=options.exporting.sourceHeight||options.chart.height||/px$/.test(cssHeight)&&parseInt(cssHeight,10)||400;extend(options.chart,{animation:false,renderTo:sandbox,forExport:true,renderer:"SVGRenderer",width:sourceWidth,height:sourceHeight});options.exporting.enabled=false;delete options.data;options.series=[];chart.series.forEach(function(serie){seriesOptions=merge(serie.userOptions,{animation:false,enableMouseTracking:false,showCheckbox:false,visible:serie.visible});if(!seriesOptions.isInternal){options.series.push(seriesOptions)}});const colls={};chart.axes.forEach(function(axis){if(!axis.userOptions.internalKey){axis.userOptions.internalKey=uniqueKey()}if(!axis.options.isInternal){if(!colls[axis.coll]){colls[axis.coll]=true;options[axis.coll]=[]}options[axis.coll].push(merge(axis.userOptions,{visible:axis.visible,type:axis.type,uniqueNames:axis.uniqueNames}))}});options.colorAxis=chart.userOptions.colorAxis;const chartCopy=new chart.constructor(options,chart.callback);if(chartOptions){["xAxis","yAxis","series"].forEach(function(coll){const collOptions={};if(chartOptions[coll]){collOptions[coll]=chartOptions[coll];chartCopy.update(collOptions)}})}chart.axes.forEach(function(axis){const axisCopy=find(chartCopy.axes,function(copy){return copy.options.internalKey===axis.userOptions.internalKey}),extremes=axis.getExtremes(),userMin=extremes.userMin,userMax=extremes.userMax;if(axisCopy&&(typeof userMin!=="undefined"&&userMin!==axisCopy.min||typeof userMax!=="undefined"&&userMax!==axisCopy.max)){axisCopy.setExtremes(userMin,userMax,true,false)}});svg=chartCopy.getChartHTML(chart.styledMode||options.exporting?.applyStyleSheets);fireEvent(this,"getSVG",{chartCopy:chartCopy});svg=chart.sanitizeSVG(svg,options);options=null;chartCopy.destroy();discardElement(sandbox);return svg}function getSVGForExport(options,chartOptions){const chartExportingOptions=this.options.exporting;return this.getSVG(merge({chart:{borderRadius:0}},chartExportingOptions.chartOptions,chartOptions,{exporting:{sourceWidth:options&&options.sourceWidth||chartExportingOptions.sourceWidth,sourceHeight:options&&options.sourceHeight||chartExportingOptions.sourceHeight}}))}function hyphenate(prop){return prop.replace(/[A-Z]/g,function(match){return"-"+match.toLowerCase()})}function inlineStyles(){const denylist=inlineDenylist,allowlist=Exporting.inlineAllowlist,defaultStyles={};let dummySVG;const iframe=doc.createElement("iframe");css(iframe,{width:"1px",height:"1px",visibility:"hidden"});doc.body.appendChild(iframe);const iframeDoc=iframe.contentWindow&&iframe.contentWindow.document;if(iframeDoc){iframeDoc.body.appendChild(iframeDoc.createElementNS(SVG_NS,"svg"))}function recurse(node){const filteredStyles={};let styles,parentStyles,dummy,denylisted,allowlisted,i;function filterStyles(val,prop){denylisted=allowlisted=false;if(allowlist.length){i=allowlist.length;while(i--&&!allowlisted){allowlisted=allowlist[i].test(prop)}denylisted=!allowlisted}if(prop==="transform"&&val==="none"){denylisted=true}i=denylist.length;while(i--&&!denylisted){if(prop.length>1e3){throw new Error("Input too long")}denylisted=denylist[i].test(prop)||typeof val==="function"}if(!denylisted){if((parentStyles[prop]!==val||node.nodeName==="svg")&&defaultStyles[node.nodeName][prop]!==val){if(!inlineToAttributes||inlineToAttributes.indexOf(prop)!==-1){if(val){node.setAttribute(hyphenate(prop),val)}}else{filteredStyles[prop]=val}}}}if(iframeDoc&&node.nodeType===1&&unstyledElements.indexOf(node.nodeName)===-1){styles=win.getComputedStyle(node,null);parentStyles=node.nodeName==="svg"?{}:win.getComputedStyle(node.parentNode,null);if(!defaultStyles[node.nodeName]){dummySVG=iframeDoc.getElementsByTagName("svg")[0];dummy=iframeDoc.createElementNS(node.namespaceURI,node.nodeName);dummySVG.appendChild(dummy);const s=win.getComputedStyle(dummy,null),defaults={};for(const key in s){if(key.length<1e3&&typeof s[key]==="string"&&!/^\d+$/.test(key)){defaults[key]=s[key]}}defaultStyles[node.nodeName]=defaults;if(node.nodeName==="text"){delete defaultStyles.text.fill}dummySVG.removeChild(dummy)}for(const p in styles){if(G.isFirefox||G.isMS||G.isSafari||Object.hasOwnProperty.call(styles,p)){filterStyles(styles[p],p)}}css(node,filteredStyles);if(node.nodeName==="svg"){node.setAttribute("stroke-width","1px")}if(node.nodeName==="text"){return}[].forEach.call(node.children||node.childNodes,recurse)}}function tearDown(){dummySVG.parentNode.removeChild(dummySVG);iframe.parentNode.removeChild(iframe)}recurse(this.container.querySelector("svg"));tearDown()}function moveContainers(moveTo){const{scrollablePlotArea}=this;(scrollablePlotArea?[scrollablePlotArea.fixedDiv,scrollablePlotArea.scrollingContainer]:[this.container]).forEach(function(div){moveTo.appendChild(div)})}function onChartInit(){const chart=this,update=(prop,options,redraw)=>{chart.isDirtyExporting=true;merge(true,chart.options[prop],options);if(pick(redraw,true)){chart.redraw()}};chart.exporting={update:function(options,redraw){update("exporting",options,redraw)}};ChartNavigationComposition.compose(chart).navigation.addUpdate((options,redraw)=>{update("navigation",options,redraw)})}function onChartLayOutTitle({alignTo,key,textPxLength}){const exportingOptions=this.options.exporting,{align,buttonSpacing=0,verticalAlign,width=0}=merge(this.options.navigation?.buttonOptions,exportingOptions?.buttons?.contextButton),space=alignTo.width-textPxLength,widthAdjust=width+buttonSpacing;if((exportingOptions?.enabled??true)&&key==="title"&&align==="right"&&verticalAlign==="top"){if(space<2*widthAdjust){if(space<widthAdjust){alignTo.width-=widthAdjust}else if(this.title?.alignValue!=="left"){alignTo.x-=widthAdjust-space/2}}}}function print(){const chart=this;if(chart.isPrinting){return}printingChart=chart;if(!G.isSafari){chart.beforePrint()}setTimeout(()=>{win.focus();win.print();if(!G.isSafari){setTimeout(()=>{chart.afterPrint()},1e3)}},1)}function renderExporting(){const chart=this,exportingOptions=chart.options.exporting,buttons=exportingOptions.buttons,isDirty=chart.isDirtyExporting||!chart.exportSVGElements;chart.buttonOffset=0;if(chart.isDirtyExporting){chart.destroyExport()}if(isDirty&&exportingOptions.enabled!==false){chart.exportEvents=[];chart.exportingGroup=chart.exportingGroup||chart.renderer.g("exporting-group").attr({zIndex:3}).add();objectEach(buttons,function(button){chart.addButton(button)});chart.isDirtyExporting=false}}function sanitizeSVG(svg,options){const split=svg.indexOf("</svg>")+6;let html=svg.substr(split);svg=svg.substr(0,split);if(options&&options.exporting&&options.exporting.allowHTML){if(html){html='<foreignObject x="0" y="0" '+'width="'+options.chart.width+'" '+'height="'+options.chart.height+'">'+'<body xmlns="http://www.w3.org/1999/xhtml">'+html.replace(/(<(?:img|br).*?(?=\>))>/g,"$1 />")+"</body>"+"</foreignObject>";svg=svg.replace("</svg>",html+"</svg>")}}svg=svg.replace(/zIndex="[^"]+"/g,"").replace(/symbolName="[^"]+"/g,"").replace(/jQuery\d+="[^"]+"/g,"").replace(/url\(("|&quot;)(.*?)("|&quot;)\;?\)/g,"url($2)").replace(/url\([^#]+#/g,"url(#").replace(/<svg /,'<svg xmlns:xlink="http://www.w3.org/1999/xlink" ').replace(/ (NS\d+\:)?href=/g," xlink:href=").replace(/\n+/g," ").replace(/(fill|stroke)="rgba\(([ \d]+,[ \d]+,[ \d]+),([ \d\.]+)\)"/g,'$1="rgb($2)" $1-opacity="$3"').replace(/&nbsp;/g," ").replace(/&shy;/g,"­");return svg}})(Exporting||(Exporting={}));export default Exporting;"";"";