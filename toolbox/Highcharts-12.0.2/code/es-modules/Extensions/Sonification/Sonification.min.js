"use strict";import D from"../../Core/Defaults.js";const{defaultOptions,getOptions}=D;import U from"../../Core/Utilities.js";const{addEvent,extend,fireEvent,merge,pick}=U;import H from"../../Core/Globals.js";const{doc,win}=H;import defaultSonificationOptions from"./Options.js";import SonificationInstrument from"./SonificationInstrument.js";import SonificationSpeaker from"./SonificationSpeaker.js";import SynthPatch from"./SynthPatch.js";import InstrumentPresets from"./InstrumentPresets.js";import timelineFromChart from"./TimelineFromChart.js";class Sonification{constructor(chart){this.chart=chart;this.retryContextCounter=0;this.lastUpdate=0;this.unbindKeydown=addEvent(doc,"keydown",function(e){if(chart&&chart.sonification&&(e.key==="Esc"||e.key==="Escape")){chart.sonification.cancel()}});try{this.audioContext=new win.AudioContext;this.audioContext.suspend();this.audioDestination=this.audioContext.destination}catch(e){}}setAudioDestination(audioDestination){this.audioDestination=audioDestination;this.update()}isPlaying(){return!!this.timeline&&this.timeline.isPlaying}playSegment(segment,onEnd){if(!this.ready(this.playSegment.bind(this,segment,onEnd))){return}if(this.timeline){this.timeline.playSegment(segment,onEnd)}}playAdjacent(next,onEnd,eventFilter){if(!this.ready(this.playAdjacent.bind(this,next,onEnd,eventFilter))){return}if(this.timeline){const opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playAdjacent(next,onEnd,onHit||(()=>{this.defaultBoundaryHit()}),eventFilter)}}playAdjacentSeries(next,prop="x",onEnd){const lastPlayed=this.getLastPlayedPoint();if(lastPlayed){const targetSeriesIx=lastPlayed.series.index+(next?1:-1);this.playClosestToProp(prop,lastPlayed[prop],e=>!!e.relatedPoint&&e.relatedPoint.series.index===targetSeriesIx,onEnd);return this.chart.series[targetSeriesIx]||null}return null}playClosestToProp(prop,targetValue,targetFilter,onEnd){if(!this.ready(this.playClosestToProp.bind(this,prop,targetValue,targetFilter,onEnd))){return}if(this.timeline){const opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playClosestToPropValue(prop,targetValue,onEnd,onHit||(()=>this.defaultBoundaryHit()),targetFilter)}}getLastPlayedPoint(){if(this.timeline){return this.timeline.getLastPlayedPoint()}return null}playNote(instrument,options,delayMs=0){if(!this.ready(this.playNote.bind(this,instrument,options))){return}const duration=options.noteDuration=options.noteDuration||500;const instr=new SonificationInstrument(this.audioContext,this.audioDestination,{synthPatch:instrument,capabilities:{filters:true,tremolo:true,pan:true}});instr.scheduleEventAtTime(delayMs/1e3,options);setTimeout(()=>instr&&instr.destroy(),delayMs+duration+500)}speak(text,speakerOptions,delayMs=0){const speaker=new SonificationSpeaker(merge({language:"en-US",rate:1.5,volume:.4},speakerOptions||{}));speaker.sayAtTime(delayMs,text)}cancel(){if(this.timeline){this.timeline.cancel()}fireEvent(this,"cancel")}downloadMIDI(){if(!this.ready(this.downloadMIDI.bind(this))){return}if(this.timeline){this.timeline.reset();this.timeline.downloadMIDI()}}sonifyChart(resetAfter,onEnd){if(!this.ready(this.sonifyChart.bind(this,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(void 0,void 0,resetAfter,onEnd)}}sonifySeries(series,resetAfter,onEnd){if(!this.ready(this.sonifySeries.bind(this,series,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(e=>!!e.relatedPoint&&e.relatedPoint.series===series,void 0,resetAfter,onEnd)}}sonifyPoint(point,onEnd){if(!this.ready(this.sonifyPoint.bind(this,point,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.anchorPlayMoment(e=>e.relatedPoint===point,onEnd)}}setMasterVolume(vol){if(this.timeline){this.timeline.setMasterVolume(vol)}}destroy(){this.unbindKeydown();if(this.timeline){this.timeline.destroy();delete this.timeline}if(this.boundaryInstrument){this.boundaryInstrument.stop()}if(this.audioContext){this.audioContext.close();delete this.audioContext}}update(){const sOpts=this.chart.options&&this.chart.options.sonification;if(!this.ready(this.update.bind(this))||!sOpts){return}const now=Date.now(),updateInterval=sOpts.updateInterval;if(now-this.lastUpdate<updateInterval&&!this.forceReady){clearTimeout(this.scheduledUpdate);this.scheduledUpdate=setTimeout(this.update.bind(this),updateInterval/2);return}const events=sOpts.events||{};if(events.beforeUpdate){events.beforeUpdate({chart:this.chart,timeline:this.timeline})}this.lastUpdate=now;if(this.timeline){this.timeline.destroy()}if(this.audioContext&&this.audioDestination){this.timeline=timelineFromChart(this.audioContext,this.audioDestination,this.chart);const sOpts=this.chart.options.sonification;this.timeline.setMasterVolume(pick(sOpts&&sOpts.masterVolume,1))}if(events.afterUpdate){events.afterUpdate({chart:this.chart,timeline:this.timeline})}}ready(whenReady){if(!this.audioContext||!this.audioDestination||!this.chart.options||this.chart.options.sonification&&this.chart.options.sonification.enabled===false){return false}if(this.audioContext.state==="suspended"&&!this.forceReady){if(this.retryContextCounter++<20){setTimeout(()=>{if(this.audioContext&&this.audioContext.state==="suspended"){this.audioContext.resume().then(whenReady)}else{whenReady()}},5)}return false}this.retryContextCounter=0;return true}beforePlay(){const opts=this.chart.options.sonification,beforePlay=opts&&opts.events&&opts.events.beforePlay;if(beforePlay){beforePlay({chart:this.chart,timeline:this.timeline})}}initBoundaryInstrument(){if(!this.boundaryInstrument){this.boundaryInstrument=new SynthPatch(this.audioContext,merge(InstrumentPresets.chop,{masterVolume:.3}));this.boundaryInstrument.startSilently();this.boundaryInstrument.connect(this.audioDestination)}}defaultBoundaryHit(){if(this.boundaryInstrument){this.boundaryInstrument.playFreqAtTime(.1,1,200);this.boundaryInstrument.playFreqAtTime(.2,1,200)}}}(function(Sonification){const composedClasses=[];function updateSonificationEnabled(){const sonification=this.sonification,sOptions=this.options&&this.options.sonification;if(sOptions&&sOptions.enabled){if(sonification){sonification.update()}else{this.sonification=new Sonification(this);this.sonification.update()}}else if(sonification){sonification.destroy();delete this.sonification}}function chartOnDestroy(){if(this&&this.sonification){this.sonification.destroy()}}function chartOnRender(){if(this.updateSonificationEnabled){this.updateSonificationEnabled()}}function chartOnUpdate(e){const newOptions=e.options.sonification;if(newOptions){merge(true,this.options.sonification,newOptions);chartOnRender.call(this)}}function compose(ChartClass,SeriesClass,PointClass){if(composedClasses.indexOf(ChartClass)===-1){composedClasses.push(ChartClass);extend(ChartClass.prototype,{updateSonificationEnabled:updateSonificationEnabled,sonify:function(onEnd){if(this.sonification){this.sonification.sonifyChart(false,onEnd)}},toggleSonify:function(reset=true,onEnd){if(!this.sonification){return}const timeline=this.sonification.timeline;if(win.speechSynthesis){win.speechSynthesis.cancel()}if(timeline&&this.sonification.isPlaying()){if(reset){this.sonification.cancel()}else{timeline.pause()}}else if(timeline&&timeline.isPaused){timeline.resume()}else{this.sonification.sonifyChart(reset,onEnd)}}});addEvent(ChartClass,"destroy",chartOnDestroy);addEvent(ChartClass,"render",chartOnRender);addEvent(ChartClass,"update",chartOnUpdate)}if(composedClasses.indexOf(SeriesClass)===-1){composedClasses.push(SeriesClass);SeriesClass.prototype.sonify=function(onEnd){if(this.chart.sonification){this.chart.sonification.sonifySeries(this,false,onEnd)}}}if(composedClasses.indexOf(PointClass)===-1){composedClasses.push(PointClass);PointClass.prototype.sonify=function(onEnd){if(this.series.chart.sonification){this.series.chart.sonification.sonifyPoint(this,onEnd)}}}const exportingOptions=getOptions().exporting;if(exportingOptions&&exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems){exportingOptions.buttons.contextButton.menuItems.push("separator","downloadMIDI","playAsSound")}}Sonification.compose=compose})(Sonification||(Sonification={}));merge(true,defaultOptions,defaultSonificationOptions);export default Sonification;"";