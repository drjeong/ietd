"use strict";import D from"../Core/Defaults.js";const{defaultOptions}=D;import H from"../Core/Globals.js";const{doc}=H;import U from"../Core/Utilities.js";const{addEvent,extend,fireEvent,merge}=U;import HU from"./Utils/HTMLUtilities.js";const{removeElement}=HU;import A11yI18n from"./A11yI18n.js";import ContainerComponent from"./Components/ContainerComponent.js";import FocusBorderComposition from"./FocusBorder.js";import InfoRegionsComponent from"./Components/InfoRegionsComponent.js";import KeyboardNavigation from"./KeyboardNavigation.js";import LegendComponent from"./Components/LegendComponent.js";import MenuComponent from"./Components/MenuComponent.js";import NavigatorComponent from"./Components/NavigatorComponent.js";import NewDataAnnouncer from"./Components/SeriesComponent/NewDataAnnouncer.js";import ProxyProvider from"./ProxyProvider.js";import RangeSelectorComponent from"./Components/RangeSelectorComponent.js";import SeriesComponent from"./Components/SeriesComponent/SeriesComponent.js";import ZoomComponent from"./Components/ZoomComponent.js";import whcm from"./HighContrastMode.js";import highContrastTheme from"./HighContrastTheme.js";import defaultOptionsA11Y from"./Options/A11yDefaults.js";import defaultLangOptions from"./Options/LangDefaults.js";import copyDeprecatedOptions from"./Options/DeprecatedOptions.js";class Accessibility{constructor(chart){this.init(chart)}init(chart){this.chart=chart;if(!doc.addEventListener){this.zombie=true;this.components={};chart.renderTo.setAttribute("aria-hidden",true);return}copyDeprecatedOptions(chart);this.proxyProvider=new ProxyProvider(this.chart);this.initComponents();this.keyboardNavigation=new KeyboardNavigation(chart,this.components)}initComponents(){const chart=this.chart;const proxyProvider=this.proxyProvider;const a11yOptions=chart.options.accessibility;this.components={container:new ContainerComponent,infoRegions:new InfoRegionsComponent,legend:new LegendComponent,chartMenu:new MenuComponent,rangeSelector:new RangeSelectorComponent,series:new SeriesComponent,zoom:new ZoomComponent,navigator:new NavigatorComponent};if(a11yOptions.customComponents){extend(this.components,a11yOptions.customComponents)}const components=this.components;this.getComponentOrder().forEach(function(componentName){components[componentName].initBase(chart,proxyProvider);components[componentName].init()})}getComponentOrder(){if(!this.components){return[]}if(!this.components.series){return Object.keys(this.components)}const componentsExceptSeries=Object.keys(this.components).filter(c=>c!=="series");return["series"].concat(componentsExceptSeries)}update(){const components=this.components,chart=this.chart,a11yOptions=chart.options.accessibility;fireEvent(chart,"beforeA11yUpdate");chart.types=this.getChartTypes();const kbdNavOrder=a11yOptions.keyboardNavigation.order;this.proxyProvider.updateGroupOrder(kbdNavOrder);this.getComponentOrder().forEach(function(componentName){components[componentName].onChartUpdate();fireEvent(chart,"afterA11yComponentUpdate",{name:componentName,component:components[componentName]})});this.keyboardNavigation.update(kbdNavOrder);if(!chart.highContrastModeActive&&a11yOptions.highContrastMode!==false&&(whcm.isHighContrastModeActive()||a11yOptions.highContrastMode===true)){whcm.setHighContrastTheme(chart)}fireEvent(chart,"afterA11yUpdate",{accessibility:this})}destroy(){const chart=this.chart||{};const components=this.components;Object.keys(components).forEach(function(componentName){components[componentName].destroy();components[componentName].destroyBase()});if(this.proxyProvider){this.proxyProvider.destroy()}if(chart.announcerContainer){removeElement(chart.announcerContainer)}if(this.keyboardNavigation){this.keyboardNavigation.destroy()}if(chart.renderTo){chart.renderTo.setAttribute("aria-hidden",true)}if(chart.focusElement){chart.focusElement.removeFocusBorder()}}getChartTypes(){const types={};this.chart.series.forEach(function(series){types[series.type]=1});return Object.keys(types)}}(function(Accessibility){Accessibility.i18nFormat=A11yI18n.i18nFormat;function chartOnDestroy(){if(this.accessibility){this.accessibility.destroy()}}function chartOnRender(){if(this.a11yDirty&&this.renderTo){delete this.a11yDirty;this.updateA11yEnabled()}const a11y=this.accessibility;if(a11y&&!a11y.zombie){a11y.proxyProvider.updateProxyElementPositions();a11y.getComponentOrder().forEach(function(componentName){a11y.components[componentName].onChartRender()})}}function chartOnUpdate(e){const newOptions=e.options.accessibility;if(newOptions){if(newOptions.customComponents){this.options.accessibility.customComponents=newOptions.customComponents;delete newOptions.customComponents}merge(true,this.options.accessibility,newOptions);if(this.accessibility&&this.accessibility.destroy){this.accessibility.destroy();delete this.accessibility}}this.a11yDirty=true}function chartUpdateA11yEnabled(){let a11y=this.accessibility;const accessibilityOptions=this.options.accessibility,svg=this.renderer.boxWrapper.element,title=this.title;if(accessibilityOptions&&accessibilityOptions.enabled){if(a11y&&!a11y.zombie){a11y.update()}else{this.accessibility=a11y=new Accessibility(this);if(a11y&&!a11y.zombie){a11y.update()}if(svg.getAttribute("role")==="img"){svg.removeAttribute("role")}}}else if(a11y){if(a11y.destroy){a11y.destroy()}delete this.accessibility}else{this.renderTo.setAttribute("role","img");this.renderTo.setAttribute("aria-hidden",false);this.renderTo.setAttribute("aria-label",(title&&title.element.textContent||"").replace(/</g,"&lt;"));svg.setAttribute("aria-hidden",true);const description=document.getElementsByClassName("highcharts-description")[0];if(description){description.setAttribute("aria-hidden",false);description.classList.remove("highcharts-linked-description")}}}function compose(ChartClass,LegendClass,PointClass,SeriesClass,SVGElementClass,RangeSelectorClass){KeyboardNavigation.compose(ChartClass);NewDataAnnouncer.compose(SeriesClass);LegendComponent.compose(ChartClass,LegendClass);MenuComponent.compose(ChartClass);SeriesComponent.compose(ChartClass,PointClass,SeriesClass);A11yI18n.compose(ChartClass);FocusBorderComposition.compose(ChartClass,SVGElementClass);if(RangeSelectorClass){RangeSelectorComponent.compose(ChartClass,RangeSelectorClass)}const chartProto=ChartClass.prototype;if(!chartProto.updateA11yEnabled){chartProto.updateA11yEnabled=chartUpdateA11yEnabled;addEvent(ChartClass,"destroy",chartOnDestroy);addEvent(ChartClass,"render",chartOnRender);addEvent(ChartClass,"update",chartOnUpdate);["addSeries","init"].forEach(event=>{addEvent(ChartClass,event,function(){this.a11yDirty=true})});["afterApplyDrilldown","drillupall"].forEach(event=>{addEvent(ChartClass,event,function chartOnAfterDrilldown(){const a11y=this.accessibility;if(a11y&&!a11y.zombie){a11y.update()}})});addEvent(PointClass,"update",pointOnUpdate);["update","updatedData","remove"].forEach(event=>{addEvent(SeriesClass,event,function(){if(this.chart.accessibility){this.chart.a11yDirty=true}})})}}Accessibility.compose=compose;function pointOnUpdate(){if(this.series.chart.accessibility){this.series.chart.a11yDirty=true}}})(Accessibility||(Accessibility={}));merge(true,defaultOptions,defaultOptionsA11Y,{accessibility:{highContrastTheme:highContrastTheme},lang:defaultLangOptions});export default Accessibility;