(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory(root["_Highcharts"],root["_Highcharts"]["Templating"]);else if(typeof define==="function"&&define.amd)define("highcharts/modules/sonification",["highcharts/highcharts"],function(amd1){return factory(amd1,amd1["Templating"])});else if(typeof exports==="object")exports["highcharts/modules/sonification"]=factory(root["_Highcharts"],root["_Highcharts"]["Templating"]);else root["Highcharts"]=factory(root["Highcharts"],root["Highcharts"]["Templating"])})(typeof window==="undefined"?this:window,(__WEBPACK_EXTERNAL_MODULE__944__,__WEBPACK_EXTERNAL_MODULE__984__)=>{return(()=>{"use strict";var __webpack_modules__={984:module=>{module.exports=__WEBPACK_EXTERNAL_MODULE__984__},944:module=>{module.exports=__WEBPACK_EXTERNAL_MODULE__944__}};var __webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(cachedModule!==undefined){return cachedModule.exports}var module=__webpack_module_cache__[moduleId]={exports:{}};__webpack_modules__[moduleId](module,module.exports,__webpack_require__);return module.exports}(()=>{__webpack_require__.n=module=>{var getter=module&&module.__esModule?()=>module["default"]:()=>module;__webpack_require__.d(getter,{a:getter});return getter}})();(()=>{__webpack_require__.d=(exports,definition)=>{for(var key in definition){if(__webpack_require__.o(definition,key)&&!__webpack_require__.o(exports,key)){Object.defineProperty(exports,key,{enumerable:true,get:definition[key]})}}}})();(()=>{__webpack_require__.o=(obj,prop)=>Object.prototype.hasOwnProperty.call(obj,prop)})();var __webpack_exports__={};__webpack_require__.d(__webpack_exports__,{default:()=>sonification_src});var highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_=__webpack_require__(944);var highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default=__webpack_require__.n(highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_);const Options={sonification:{enabled:true,duration:6e3,afterSeriesWait:700,updateInterval:200,masterVolume:.7,order:"sequential",showTooltip:true,showCrosshair:true,pointGrouping:{enabled:true,groupTimespan:15,algorithm:"minmax",prop:"y"},defaultInstrumentOptions:{roundToMusicalNotes:true,instrument:"piano",mapping:{time:"x",pan:"x",noteDuration:200,pitch:{mapTo:"y",min:"c2",max:"c6",within:"yAxis"},gapBetweenNotes:100}},defaultSpeechOptions:{language:"en-US",mapping:{time:"x",rate:1.3,volume:.4},pointGrouping:{algorithm:"last"}}},exporting:{menuItemDefinitions:{downloadMIDI:{textKey:"downloadMIDI",onclick:function(){if(this.sonification){this.sonification.downloadMIDI()}}},playAsSound:{textKey:"playAsSound",onclick:function(){const s=this.sonification;if(s&&s.isPlaying()){s.cancel()}else{this.sonify()}}}}},lang:{downloadMIDI:"Download MIDI",playAsSound:"Play as sound"}};const Sonification_Options=Options;"";const{clamp,defined,pick}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();function getPitchTrackedMultiplierVal(multiplier,freq){const a=.2414*multiplier-.2414,b=(3.5-1.7*multiplier)/1.8;return a*Math.log(freq)+b}function miniRampToVolAtTime(gainNode,time,vol){gainNode.gain.cancelScheduledValues(time);gainNode.gain.setTargetAtTime(vol,time,SynthPatch.stopRampTime/4);gainNode.gain.setValueAtTime(vol,time+SynthPatch.stopRampTime)}function scheduleGainEnvelope(envelope,type,time,gainNode,volumeMultiplier=1){const isAtk=type==="attack",gain=gainNode.gain;gain.cancelScheduledValues(time);if(!envelope.length){miniRampToVolAtTime(gainNode,time,isAtk?volumeMultiplier:0);return}if(envelope[0].t>1){envelope.unshift({t:0,vol:isAtk?0:1})}envelope.forEach((ep,ix)=>{const prev=envelope[ix-1],delta=prev?(ep.t-prev.t)/1e3:0,startTime=time+(prev?prev.t/1e3+SynthPatch.stopRampTime:0);gain.setTargetAtTime(ep.vol*volumeMultiplier,startTime,Math.max(delta,SynthPatch.stopRampTime)/2)})}class PulseOscNode{constructor(context,options){this.pulseWidth=Math.min(Math.max(0,options.pulseWidth||.5));const makeOsc=()=>new OscillatorNode(context,{type:"sawtooth",detune:options.detune,frequency:Math.max(1,options.frequency||350)});this.sawOscA=makeOsc();this.sawOscB=makeOsc();this.phaseInverter=new GainNode(context,{gain:-1});this.masterGain=new GainNode(context);this.delayNode=new DelayNode(context,{delayTime:this.pulseWidth/this.sawOscA.frequency.value});this.sawOscA.connect(this.masterGain);this.sawOscB.connect(this.phaseInverter);this.phaseInverter.connect(this.delayNode);this.delayNode.connect(this.masterGain)}connect(destination){this.masterGain.connect(destination)}getFrequencyFacade(){const pulse=this;return{cancelScheduledValues(fromTime){pulse.sawOscA.frequency.cancelScheduledValues(fromTime);pulse.sawOscB.frequency.cancelScheduledValues(fromTime);pulse.delayNode.delayTime.cancelScheduledValues(fromTime);return pulse.sawOscA.frequency},setValueAtTime(frequency,time){this.cancelScheduledValues(time);pulse.sawOscA.frequency.setValueAtTime(frequency,time);pulse.sawOscB.frequency.setValueAtTime(frequency,time);pulse.delayNode.delayTime.setValueAtTime(Math.round(1e4*pulse.pulseWidth/frequency)/1e4,time);return pulse.sawOscA.frequency},setTargetAtTime(frequency,time,timeConstant){this.cancelScheduledValues(time);pulse.sawOscA.frequency.setTargetAtTime(frequency,time,timeConstant);pulse.sawOscB.frequency.setTargetAtTime(frequency,time,timeConstant);pulse.delayNode.delayTime.setTargetAtTime(Math.round(1e4*pulse.pulseWidth/frequency)/1e4,time,timeConstant);return pulse.sawOscA.frequency}}}getPWMTarget(){return this.delayNode.delayTime}start(){this.sawOscA.start();this.sawOscB.start()}stop(time){this.sawOscA.stop(time);this.sawOscB.stop(time)}}class Oscillator{constructor(audioContext,options,destination){this.audioContext=audioContext;this.options=options;this.fmOscillatorIx=options.fmOscillator;this.vmOscillatorIx=options.vmOscillator;this.createSoundSource();this.createGain();this.createFilters();this.createVolTracking();if(destination){this.connect(destination)}}connect(destination){[this.lowpassNode,this.highpassNode,this.volTrackingNode,this.vmNode,this.gainNode,this.whiteNoise,this.pulseNode,this.oscNode].reduce((prev,cur)=>cur?(cur.connect(prev),cur):prev,destination)}start(){if(this.oscNode){this.oscNode.start()}if(this.whiteNoise){this.whiteNoise.start()}if(this.pulseNode){this.pulseNode.start()}}stopAtTime(time){if(this.oscNode){this.oscNode.stop(time)}if(this.whiteNoise){this.whiteNoise.stop(time)}if(this.pulseNode){this.pulseNode.stop(time)}}setFreqAtTime(time,frequency,glideDuration=0){const opts=this.options,f=clamp(pick(opts.fixedFrequency,frequency)*(opts.freqMultiplier||1),0,21e3),oscTarget=this.getOscTarget(),timeConstant=glideDuration/5e3;if(oscTarget){oscTarget.cancelScheduledValues(time);if(glideDuration&&time-(this.lastUpdateTime||-1)>.01){oscTarget.setTargetAtTime(f,time,timeConstant);oscTarget.setValueAtTime(f,time+timeConstant)}else{oscTarget.setValueAtTime(f,time)}}this.scheduleVolTrackingChange(f,time,glideDuration);this.scheduleFilterTrackingChange(f,time,glideDuration);this.lastUpdateTime=time}getFMTarget(){return this.oscNode&&this.oscNode.detune||this.whiteNoise&&this.whiteNoise.detune||this.pulseNode&&this.pulseNode.getPWMTarget()}getVMTarget(){return this.vmNode&&this.vmNode.gain}runEnvelopeAtTime(type,time){if(!this.gainNode){return}const env=(type==="attack"?this.options.attackEnvelope:this.options.releaseEnvelope)||[];scheduleGainEnvelope(env,type,time,this.gainNode,this.options.volume)}cancelScheduled(){if(this.gainNode){this.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime)}const oscTarget=this.getOscTarget();if(oscTarget){oscTarget.cancelScheduledValues(0)}if(this.lowpassNode){this.lowpassNode.frequency.cancelScheduledValues(0)}if(this.highpassNode){this.highpassNode.frequency.cancelScheduledValues(0)}if(this.volTrackingNode){this.volTrackingNode.gain.cancelScheduledValues(0)}}scheduleVolTrackingChange(frequency,time,glideDuration){if(this.volTrackingNode){const v=getPitchTrackedMultiplierVal(this.options.volumePitchTrackingMultiplier||1,frequency),rampTime=glideDuration?glideDuration/1e3:SynthPatch.stopRampTime;this.volTrackingNode.gain.cancelScheduledValues(time);this.volTrackingNode.gain.setTargetAtTime(v,time,rampTime/5);this.volTrackingNode.gain.setValueAtTime(v,time+rampTime)}}scheduleFilterTrackingChange(frequency,time,glideDuration){const opts=this.options,rampTime=glideDuration?glideDuration/1e3:SynthPatch.stopRampTime,scheduleFilterTarget=(filterNode,filterOptions)=>{const multiplier=getPitchTrackedMultiplierVal(filterOptions.frequencyPitchTrackingMultiplier||1,frequency),f=clamp((filterOptions.frequency||1e3)*multiplier,0,21e3);filterNode.frequency.cancelScheduledValues(time);filterNode.frequency.setTargetAtTime(f,time,rampTime/5);filterNode.frequency.setValueAtTime(f,time+rampTime)};if(this.lowpassNode&&opts.lowpass){scheduleFilterTarget(this.lowpassNode,opts.lowpass)}if(this.highpassNode&&opts.highpass){scheduleFilterTarget(this.highpassNode,opts.highpass)}}createGain(){const opts=this.options,needsGainNode=defined(opts.volume)||opts.attackEnvelope&&opts.attackEnvelope.length||opts.releaseEnvelope&&opts.releaseEnvelope.length;if(needsGainNode){this.gainNode=new GainNode(this.audioContext,{gain:pick(opts.volume,1)})}this.vmNode=new GainNode(this.audioContext)}createSoundSource(){const opts=this.options,ctx=this.audioContext,frequency=(opts.fixedFrequency||0)*(opts.freqMultiplier||1);if(opts.type==="whitenoise"){const bSize=ctx.sampleRate*2,buffer=ctx.createBuffer(1,bSize,ctx.sampleRate),data=buffer.getChannelData(0);for(let i=0;i<bSize;++i){data[i]=Math.random()*1.2-.6}const wn=this.whiteNoise=ctx.createBufferSource();wn.buffer=buffer;wn.loop=true}else if(opts.type==="pulse"){this.pulseNode=new PulseOscNode(ctx,{detune:opts.detune,pulseWidth:opts.pulseWidth,frequency:frequency})}else{this.oscNode=new OscillatorNode(ctx,{type:opts.type||"sine",detune:opts.detune,frequency:frequency})}}createFilters(){const opts=this.options;if(opts.lowpass&&opts.lowpass.frequency){this.lowpassNode=new BiquadFilterNode(this.audioContext,{type:"lowpass",Q:opts.lowpass.Q||1,frequency:opts.lowpass.frequency})}if(opts.highpass&&opts.highpass.frequency){this.highpassNode=new BiquadFilterNode(this.audioContext,{type:"highpass",Q:opts.highpass.Q||1,frequency:opts.highpass.frequency})}}createVolTracking(){const opts=this.options;if(opts.volumePitchTrackingMultiplier&&opts.volumePitchTrackingMultiplier!==1){this.volTrackingNode=new GainNode(this.audioContext,{gain:1})}}getOscTarget(){return this.oscNode?this.oscNode.frequency:this.pulseNode&&this.pulseNode.getFrequencyFacade()}}class SynthPatch{constructor(audioContext,options){this.audioContext=audioContext;this.options=options;this.eqNodes=[];this.midiInstrument=options.midiInstrument||1;this.outputNode=new GainNode(audioContext,{gain:0});this.createEqChain(this.outputNode);const inputNode=this.eqNodes.length?this.eqNodes[0]:this.outputNode;this.oscillators=(this.options.oscillators||[]).map(oscOpts=>new Oscillator(audioContext,oscOpts,defined(oscOpts.fmOscillator)||defined(oscOpts.vmOscillator)?void 0:inputNode));this.oscillators.forEach(osc=>{const connectTarget=(targetFunc,targetOsc)=>{if(targetOsc){const target=targetOsc[targetFunc]();if(target){osc.connect(target)}}};if(defined(osc.fmOscillatorIx)){connectTarget("getFMTarget",this.oscillators[osc.fmOscillatorIx])}if(defined(osc.vmOscillatorIx)){connectTarget("getVMTarget",this.oscillators[osc.vmOscillatorIx])}})}startSilently(){this.outputNode.gain.value=0;this.oscillators.forEach(o=>o.start())}stop(){const curTime=this.audioContext.currentTime,endTime=curTime+SynthPatch.stopRampTime;miniRampToVolAtTime(this.outputNode,curTime,0);this.oscillators.forEach(o=>o.stopAtTime(endTime));this.outputNode.disconnect()}silenceAtTime(time){if(!time&&this.outputNode.gain.value<.01){this.outputNode.gain.value=0;return}this.releaseAtTime((time||0)+this.audioContext.currentTime)}mute(){this.cancelScheduled();miniRampToVolAtTime(this.outputNode,this.audioContext.currentTime,0)}playFreqAtTime(time,frequency,noteDuration){const t=(time||0)+this.audioContext.currentTime,opts=this.options;this.oscillators.forEach(o=>{o.setFreqAtTime(t,frequency,opts.noteGlideDuration);o.runEnvelopeAtTime("attack",t)});scheduleGainEnvelope(opts.masterAttackEnvelope||[],"attack",t,this.outputNode,opts.masterVolume);if(noteDuration){this.releaseAtTime(t+noteDuration/1e3)}}cancelScheduled(){this.outputNode.gain.cancelScheduledValues(this.audioContext.currentTime);this.oscillators.forEach(o=>o.cancelScheduled())}connect(destinationNode){return this.outputNode.connect(destinationNode)}createEqChain(outputNode){this.eqNodes=(this.options.eq||[]).map(eqDef=>new BiquadFilterNode(this.audioContext,{type:"peaking",...eqDef}));this.eqNodes.reduceRight((chain,node)=>{node.connect(chain);return node},outputNode)}releaseAtTime(time){let maxReleaseDuration=0;this.oscillators.forEach(o=>{const env=o.options.releaseEnvelope;if(env&&env.length){maxReleaseDuration=Math.max(maxReleaseDuration,env[env.length-1].t);o.runEnvelopeAtTime("release",time)}});const masterEnv=this.options.masterReleaseEnvelope||[];if(masterEnv.length){scheduleGainEnvelope(masterEnv,"release",time,this.outputNode,this.options.masterVolume);maxReleaseDuration=Math.max(maxReleaseDuration,masterEnv[masterEnv.length-1].t)}miniRampToVolAtTime(this.outputNode,time+maxReleaseDuration/1e3,0)}}SynthPatch.stopRampTime=.012;const Sonification_SynthPatch=SynthPatch;"";const InstrumentPresets={piano:{masterVolume:.45,masterAttackEnvelope:[{t:1,vol:.71},{t:40,vol:.79},{t:82,vol:.64},{t:147,vol:.29},{t:260,vol:.15},{t:417,vol:.05},{t:589,vol:0}],eq:[{frequency:200,Q:.7,gain:6},{frequency:450,gain:6},{frequency:1300,gain:2},{frequency:2600,Q:.8,gain:8},{frequency:3500,Q:.8,gain:6},{frequency:6200,Q:.8,gain:10},{frequency:8e3,gain:-23},{frequency:1e4,Q:.4,gain:-12}],oscillators:[{type:"pulse",volume:.5,pulseWidth:.55,volumePitchTrackingMultiplier:.1,lowpass:{frequency:4.5,frequencyPitchTrackingMultiplier:900,Q:-2},highpass:{frequency:270},attackEnvelope:[{t:1,vol:1}],releaseEnvelope:[{t:1,vol:1},{t:282,vol:.64},{t:597,vol:0}]},{type:"whitenoise",volume:.8,lowpass:{frequency:400},highpass:{frequency:300},attackEnvelope:[{t:1,vol:1},{t:19,vol:0}]}]},plucked:{masterVolume:.5,midiInstrument:25,masterAttackEnvelope:[{t:1,vol:.71},{t:4,vol:.71},{t:31,vol:.4},{t:109,vol:.12},{t:234,vol:.04},{t:442,vol:0}],eq:[{frequency:800,gain:-8},{frequency:1400,Q:4,gain:4},{frequency:1600,gain:-14},{frequency:2200,gain:-8},{frequency:3600,gain:-2},{frequency:6400,Q:2,gain:-6}],oscillators:[{type:"sawtooth",volume:.9,volumePitchTrackingMultiplier:.6,highpass:{frequency:100},lowpass:{frequency:8e3},releaseEnvelope:[{t:1,vol:1},{t:315,vol:.56},{t:550,vol:0}]}]},flute:{masterVolume:1.1,midiInstrument:74,noteGlideDuration:30,masterAttackEnvelope:[{t:0,vol:0},{t:29,vol:1},{t:76,vol:.48},{t:600,vol:.36}],masterReleaseEnvelope:[{t:1,vol:.36},{t:24,vol:.15},{t:119,vol:0}],eq:[{frequency:150,Q:.6,gain:-10},{frequency:500,gain:4},{frequency:1100,gain:-4},{frequency:2200,gain:-14},{frequency:5e3,gain:8},{frequency:6400,gain:10},{frequency:8e3,gain:12},{frequency:10800,gain:8}],oscillators:[{type:"triangle",volume:1,volumePitchTrackingMultiplier:.4,lowpass:{frequency:12,frequencyPitchTrackingMultiplier:100},highpass:{frequency:200}},{type:"sine",fixedFrequency:5,volume:.2,vmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:48,vol:0},{t:225,vol:.05},{t:600,vol:.77}]},{type:"whitenoise",volume:.13,lowpass:{frequency:9e3,Q:3},highpass:{frequency:6e3,Q:3},vmOscillator:0,attackEnvelope:[{t:0,vol:0},{t:26,vol:1},{t:93,vol:.8}]}]},lead:{masterVolume:1,midiInstrument:20,masterAttackEnvelope:[{t:1,vol:.81},{t:98,vol:.5},{t:201,vol:.18},{t:377,vol:.04},{t:586,vol:0},{t:586,vol:0}],eq:[{frequency:200,gain:-6},{frequency:400,gain:-8},{frequency:800,Q:.5,gain:-10},{frequency:1200,gain:4},{frequency:3600,gain:-4},{frequency:4200,gain:-12},{frequency:7400,gain:-14},{frequency:1e4,gain:2}],oscillators:[{type:"triangle",volume:1.1,volumePitchTrackingMultiplier:.6,lowpass:{frequency:5e3},highpass:{frequency:100}},{type:"sawtooth",volume:.4,lowpass:{frequency:7e3},highpass:{frequency:800,Q:6},releaseEnvelope:[{t:0,vol:.99},{t:200,vol:.83},{t:495,vol:0}]}]},vibraphone:{masterVolume:1,midiInstrument:12,masterAttackEnvelope:[{t:1,vol:0},{t:10,vol:.63},{t:82,vol:.64},{t:149,vol:.26},{t:600,vol:0}],eq:[{frequency:200,Q:.8,gain:-12},{frequency:400,gain:-4},{frequency:1600,Q:.5,gain:6},{frequency:2200,Q:.5,gain:6},{frequency:6400,gain:4},{frequency:12800,gain:4}],oscillators:[{type:"sine",volume:1.5,volumePitchTrackingMultiplier:1e-7,attackEnvelope:[{t:1,vol:1}],releaseEnvelope:[{t:1,vol:1},{t:146,vol:.39},{t:597,vol:0}]},{type:"whitenoise",volume:.03,volumePitchTrackingMultiplier:1e-4,lowpass:{frequency:900},highpass:{frequency:800},attackEnvelope:[{t:1,vol:1},{t:9,vol:0}]},{type:"sine",freqMultiplier:4,volume:.15,volumePitchTrackingMultiplier:1e-4},{type:"sine",fixedFrequency:3,volume:6,fmOscillator:0,releaseEnvelope:[{t:1,vol:1},{t:190,vol:.41},{t:600,vol:0}]},{type:"sine",fixedFrequency:6,volume:3,fmOscillator:2},{type:"sine",freqMultiplier:9,volume:5e-4,volumePitchTrackingMultiplier:1e-4,releaseEnvelope:[{t:1,vol:.97},{t:530,vol:0}]}]},saxophone:{masterVolume:1,midiInstrument:67,noteGlideDuration:10,masterAttackEnvelope:[{t:1,vol:.57},{t:35,vol:1},{t:87,vol:.84},{t:111,vol:.6},{t:296,vol:.49},{t:600,vol:.58}],masterReleaseEnvelope:[{t:1,vol:.58},{t:47,vol:.16},{t:119,vol:0}],eq:[{frequency:200,gain:-2},{frequency:600,gain:2},{frequency:800,gain:-10},{frequency:1100,gain:-2},{frequency:2200,gain:-2},{frequency:3500,gain:10},{frequency:12800,gain:4}],oscillators:[{type:"sawtooth",volume:.45,volumePitchTrackingMultiplier:.06,lowpass:{frequency:18,frequencyPitchTrackingMultiplier:200},highpass:{frequency:300}},{type:"whitenoise",fixedFrequency:1,volume:.4,highpass:{frequency:7e3},vmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:51,vol:1},{t:86,vol:.84},{t:500,vol:.78}]},{type:"sine",fixedFrequency:4,volume:2,fmOscillator:0,attackEnvelope:[{t:0,vol:0},{t:15,vol:.94},{t:79,vol:1},{t:172,vol:.47},{t:500,vol:.26}]},{type:"sine",fixedFrequency:7,volume:6,fmOscillator:0,attackEnvelope:[{t:0,vol:0},{t:25,vol:.99},{t:85,vol:0},{t:85,vol:0},{t:387,vol:.02},{t:511,vol:.43},{t:600,vol:0}]}]},trumpet:{masterVolume:.3,midiInstrument:57,noteGlideDuration:40,masterAttackEnvelope:[{t:1,vol:0},{t:17,vol:1},{t:42,vol:.85},{t:76,vol:1},{t:202,vol:.65},{t:226,vol:.86},{t:282,vol:.63}],masterReleaseEnvelope:[{t:1,vol:.62},{t:34,vol:.14},{t:63,vol:.21},{t:96,vol:0}],eq:[{frequency:200,Q:.6,gain:10},{frequency:600,Q:.5,gain:6},{frequency:1500,Q:.7,gain:14},{frequency:3200,Q:2,gain:8},{frequency:3800,Q:.8,gain:10},{frequency:6200,gain:12},{frequency:8400,gain:-20},{frequency:12800,Q:.5,gain:-18}],oscillators:[{type:"sawtooth",volume:.15,pulseWidth:.5,volumePitchTrackingMultiplier:.5,lowpass:{frequency:1900,Q:3}},{type:"sine",fixedFrequency:6,volume:.2,vmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:102,vol:.13},{t:556,vol:.24}]},{type:"whitenoise",volume:.45,highpass:{frequency:7e3,Q:9},vmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:89,vol:.51},{t:577,vol:.29}]},{type:"sine",fixedFrequency:5.7,volume:20,fmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:89,vol:1},{t:137,vol:.46},{t:283,vol:.15},{t:600,vol:.28}]}]},sawsynth:{masterVolume:.3,midiInstrument:51,noteGlideDuration:40,masterAttackEnvelope:[{t:0,vol:.6},{t:9,vol:1},{t:102,vol:.48}],eq:[{frequency:200,gain:-6}],oscillators:[{type:"sawtooth",volume:.4,volumePitchTrackingMultiplier:.3},{type:"sawtooth",volume:.4,detune:11,volumePitchTrackingMultiplier:.3},{type:"sawtooth",volume:.4,detune:-11,volumePitchTrackingMultiplier:.3}]},basic1:{masterVolume:1,noteGlideDuration:0,masterReleaseEnvelope:[{t:1,vol:.36},{t:24,vol:.15},{t:119,vol:0}],eq:[{frequency:150,Q:.6,gain:-12},{frequency:1100,gain:-2},{frequency:2200,gain:-16},{frequency:5e3,gain:8},{frequency:6400,gain:10},{frequency:8e3,gain:12},{frequency:10800,gain:8}],oscillators:[{type:"triangle",volume:1,volumePitchTrackingMultiplier:.05,lowpass:{frequency:17,frequencyPitchTrackingMultiplier:100},highpass:{frequency:200}},{type:"whitenoise",volume:.04,lowpass:{frequency:9e3,Q:3},highpass:{frequency:6e3,Q:3},vmOscillator:0,attackEnvelope:[{t:0,vol:0},{t:26,vol:1},{t:71,vol:.73}]}]},basic2:{masterVolume:.3,eq:[{frequency:200,Q:.7,gain:6},{frequency:450,gain:2},{frequency:1300,gain:-2},{frequency:2600,Q:.8,gain:6},{frequency:3500,Q:.8,gain:6},{frequency:6200,Q:.8,gain:10},{frequency:8e3,gain:-18},{frequency:1e4,Q:.4,gain:-12}],oscillators:[{type:"pulse",volume:.4,pulseWidth:.55,volumePitchTrackingMultiplier:.1,lowpass:{frequency:4.5,frequencyPitchTrackingMultiplier:900,Q:-2},highpass:{frequency:270}}]},chord:{masterVolume:1,masterAttackEnvelope:[{t:1,vol:.79},{t:27,vol:.86},{t:62,vol:.81},{t:150,vol:.35},{t:408,vol:.04},{t:600,vol:0}],eq:[{frequency:200,gain:-8},{frequency:600,Q:2,gain:4},{frequency:800,gain:-10},{frequency:1600,gain:-2},{frequency:2200,gain:-6},{frequency:3600,Q:.7,gain:-2},{frequency:6400,gain:6},{frequency:12800,gain:6}],oscillators:[{type:"triangle",volume:1.1,volumePitchTrackingMultiplier:.05,lowpass:{frequency:8e3},highpass:{frequency:100},releaseEnvelope:[{t:1,vol:1},{t:315,vol:.56},{t:540,vol:0}]},{type:"triangle",freqMultiplier:1.17,volume:.4,volumePitchTrackingMultiplier:.07,lowpass:{frequency:5e3},highpass:{frequency:100},releaseEnvelope:[{t:0,vol:1},{t:476,vol:0}]},{type:"triangle",freqMultiplier:1.58333,volume:.7,volumePitchTrackingMultiplier:.02,highpass:{frequency:200},releaseEnvelope:[{t:0,vol:1},{t:422,vol:.56},{t:577,vol:0}]},{type:"sine",fixedFrequency:10,volume:4,fmOscillator:0,attackEnvelope:[{t:1,vol:1},{t:157,vol:.65}]},{type:"sine",fixedFrequency:5,volume:.3,vmOscillator:2,attackEnvelope:[{t:1,vol:1},{t:155,vol:.91},{t:289,vol:.78}]}]},wobble:{masterVolume:.9,masterReleaseEnvelope:[{t:1,vol:.36},{t:24,vol:.15},{t:119,vol:0}],eq:[{frequency:150,Q:.6,gain:-12},{frequency:1100,gain:-2},{frequency:2200,gain:-16},{frequency:5e3,gain:8},{frequency:6400,gain:10},{frequency:8e3,gain:12},{frequency:10800,gain:8}],oscillators:[{type:"triangle",volume:.9,volumePitchTrackingMultiplier:.1,lowpass:{frequency:17,frequencyPitchTrackingMultiplier:100},highpass:{frequency:200}},{type:"whitenoise",volume:.04,lowpass:{frequency:9e3,Q:3},highpass:{frequency:6e3,Q:3},vmOscillator:0,attackEnvelope:[{t:0,vol:0},{t:26,vol:1},{t:71,vol:.73}]},{type:"sine",freqMultiplier:.011,volume:30,fmOscillator:0}]},sine:{masterVolume:1,oscillators:[{type:"sine",volumePitchTrackingMultiplier:.07}]},sineGlide:{masterVolume:1,noteGlideDuration:100,oscillators:[{type:"sine",volumePitchTrackingMultiplier:.07}]},triangle:{masterVolume:.5,oscillators:[{type:"triangle",volume:1,volumePitchTrackingMultiplier:.07}]},sawtooth:{masterVolume:.25,midiInstrument:82,oscillators:[{type:"sawtooth",volume:.3,volumePitchTrackingMultiplier:.07}]},square:{masterVolume:.3,midiInstrument:81,oscillators:[{type:"square",volume:.2,volumePitchTrackingMultiplier:.07}]},chop:{masterVolume:1,midiInstrument:116,masterAttackEnvelope:[{t:1,vol:1},{t:44,vol:0}],oscillators:[{type:"whitenoise",volume:1,lowpass:{frequency:600},highpass:{frequency:200}}]},shaker:{masterVolume:.4,midiInstrument:116,masterAttackEnvelope:[{t:1,vol:1},{t:44,vol:0}],oscillators:[{type:"whitenoise",volume:1,lowpass:{frequency:6500},highpass:{frequency:5e3}}]},step:{masterVolume:1,midiInstrument:116,masterAttackEnvelope:[{t:1,vol:1},{t:44,vol:0}],eq:[{frequency:200,gain:-1},{frequency:400,gain:-14},{frequency:800,gain:8},{frequency:1e3,Q:5,gain:-24},{frequency:1600,gain:8},{frequency:2200,gain:-10},{frequency:5400,gain:4},{frequency:12800,gain:-36}],oscillators:[{type:"whitenoise",volume:1.5,lowpass:{frequency:300},highpass:{frequency:100,Q:6}}]},kick:{masterVolume:.55,masterAttackEnvelope:[{t:1,vol:.8},{t:15,vol:1},{t:45,vol:.35},{t:121,vol:.11},{t:242,vol:0}],eq:[{frequency:50,gain:6},{frequency:400,gain:-18},{frequency:1600,gain:18}],oscillators:[{type:"triangle",fixedFrequency:90,volume:1,lowpass:{frequency:300},attackEnvelope:[{t:1,vol:1},{t:6,vol:1},{t:45,vol:.01}]},{type:"whitenoise",volume:.4,lowpass:{frequency:200},attackEnvelope:[{t:1,vol:1},{t:30,vol:0}]},{type:"triangle",freqMultiplier:.1,volume:1,lowpass:{frequency:200}}]},shortnote:{masterVolume:.8,midiInstrument:116,masterAttackEnvelope:[{t:1,vol:1},{t:15,vol:0}],eq:[{frequency:400,gain:-4},{frequency:800,gain:-12},{frequency:2400,gain:4},{frequency:7200,gain:-20},{frequency:1e3,Q:5,gain:-12},{frequency:5400,gain:-32},{frequency:12800,gain:-14}],oscillators:[{type:"sawtooth",volume:.6,lowpass:{frequency:1e3}},{type:"whitenoise",volume:.2,lowpass:{frequency:1e4},highpass:{frequency:7e3},attackEnvelope:[{t:1,vol:1},{t:10,vol:0}]},{type:"whitenoise",volume:1.3,lowpass:{frequency:700,Q:4},highpass:{frequency:250}}]},noise:{masterVolume:.3,midiInstrument:122,oscillators:[{type:"whitenoise"}]},filteredNoise:{masterVolume:.3,midiInstrument:122,eq:[{frequency:1600,gain:-8},{frequency:2200,gain:-4}],oscillators:[{type:"whitenoise",lowpass:{frequency:5,frequencyPitchTrackingMultiplier:1300,Q:6},highpass:{frequency:5,frequencyPitchTrackingMultiplier:300,Q:6}}]},wind:{masterVolume:.75,midiInstrument:122,noteGlideDuration:150,masterReleaseEnvelope:[{t:0,vol:1},{t:124,vol:.24},{t:281,vol:0}],oscillators:[{type:"whitenoise",volume:1,lowpass:{frequency:100,frequencyPitchTrackingMultiplier:6,Q:23},highpass:{frequency:170,frequencyPitchTrackingMultiplier:6}},{type:"sine",freqMultiplier:.016,volume:1e3,fmOscillator:0}]}};const Sonification_InstrumentPresets=InstrumentPresets;"";const{defined:SonificationInstrument_defined,extend}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();class SonificationInstrument{constructor(audioContext,outputNode,options){this.audioContext=audioContext;this.curParams={};this.midiTrackName=options.midiTrackName;this.masterVolNode=new GainNode(audioContext);this.masterVolNode.connect(outputNode);this.volumeNode=new GainNode(audioContext);this.createNodesFromCapabilities(extend({pan:true},options.capabilities||{}));this.connectCapabilityNodes(this.volumeNode,this.masterVolNode);this.synthPatch=new Sonification_SynthPatch(audioContext,typeof options.synthPatch==="string"?Sonification_InstrumentPresets[options.synthPatch]:options.synthPatch);this.midiInstrument=this.synthPatch.midiInstrument||1;this.synthPatch.startSilently();this.synthPatch.connect(this.volumeNode)}setMasterVolume(volume){this.masterVolNode.gain.setTargetAtTime(volume,0,SonificationInstrument.rampTime)}scheduleEventAtTime(time,params){const mergedParams=extend(this.curParams,params),freq=SonificationInstrument_defined(params.frequency)?params.frequency:SonificationInstrument_defined(params.note)?SonificationInstrument.musicalNoteToFrequency(params.note):220;if(SonificationInstrument_defined(freq)){this.synthPatch.playFreqAtTime(time,freq,mergedParams.noteDuration)}if(SonificationInstrument_defined(mergedParams.tremoloDepth)||SonificationInstrument_defined(mergedParams.tremoloSpeed)){this.setTremoloAtTime(time,mergedParams.tremoloDepth,mergedParams.tremoloSpeed)}if(SonificationInstrument_defined(mergedParams.pan)){this.setPanAtTime(time,mergedParams.pan)}if(SonificationInstrument_defined(mergedParams.volume)){this.setVolumeAtTime(time,mergedParams.volume)}if(SonificationInstrument_defined(mergedParams.lowpassFreq)||SonificationInstrument_defined(mergedParams.lowpassResonance)){this.setFilterAtTime("lowpass",time,mergedParams.lowpassFreq,mergedParams.lowpassResonance)}if(SonificationInstrument_defined(mergedParams.highpassFreq)||SonificationInstrument_defined(mergedParams.highpassResonance)){this.setFilterAtTime("highpass",time,mergedParams.highpassFreq,mergedParams.highpassResonance)}}silenceAtTime(time){this.synthPatch.silenceAtTime(time)}cancel(){this.synthPatch.mute();[this.tremoloDepth&&this.tremoloDepth.gain,this.tremoloOsc&&this.tremoloOsc.frequency,this.lowpassNode&&this.lowpassNode.frequency,this.lowpassNode&&this.lowpassNode.Q,this.highpassNode&&this.highpassNode.frequency,this.highpassNode&&this.highpassNode.Q,this.panNode&&this.panNode.pan,this.volumeNode.gain].forEach(p=>p&&p.cancelScheduledValues(0))}destroy(){this.cancel();this.synthPatch.stop();if(this.tremoloOsc){this.tremoloOsc.stop()}[this.tremoloDepth,this.tremoloOsc,this.lowpassNode,this.highpassNode,this.panNode,this.volumeNode,this.masterVolNode].forEach(n=>n&&n.disconnect())}setPanAtTime(time,pan){if(this.panNode){this.panNode.pan.setTargetAtTime(pan,time+this.audioContext.currentTime,SonificationInstrument.rampTime)}}setFilterAtTime(filter,time,frequency,resonance){const node=this[filter+"Node"],audioTime=this.audioContext.currentTime+time;if(node){if(SonificationInstrument_defined(resonance)){node.Q.setTargetAtTime(resonance,audioTime,SonificationInstrument.rampTime)}if(SonificationInstrument_defined(frequency)){node.frequency.setTargetAtTime(frequency,audioTime,SonificationInstrument.rampTime)}}}setVolumeAtTime(time,volume){if(this.volumeNode){this.volumeNode.gain.setTargetAtTime(volume,time+this.audioContext.currentTime,SonificationInstrument.rampTime)}}setTremoloAtTime(time,depth,speed){const audioTime=this.audioContext.currentTime+time;if(this.tremoloDepth&&SonificationInstrument_defined(depth)){this.tremoloDepth.gain.setTargetAtTime(depth,audioTime,SonificationInstrument.rampTime)}if(this.tremoloOsc&&SonificationInstrument_defined(speed)){this.tremoloOsc.frequency.setTargetAtTime(15*speed,audioTime,SonificationInstrument.rampTime)}}createNodesFromCapabilities(capabilities){const ctx=this.audioContext;if(capabilities.pan){this.panNode=new StereoPannerNode(ctx)}if(capabilities.tremolo){this.tremoloOsc=new OscillatorNode(ctx,{type:"sine",frequency:3});this.tremoloDepth=new GainNode(ctx);this.tremoloOsc.connect(this.tremoloDepth);this.tremoloDepth.connect(this.masterVolNode.gain);this.tremoloOsc.start()}if(capabilities.filters){this.lowpassNode=new BiquadFilterNode(ctx,{type:"lowpass",frequency:2e4});this.highpassNode=new BiquadFilterNode(ctx,{type:"highpass",frequency:0})}}connectCapabilityNodes(input,output){[this.panNode,this.lowpassNode,this.highpassNode,input].reduce((prev,cur)=>cur?(cur.connect(prev),cur):prev,output)}static noteStringToC0Distance(note){const match=note.match(/^([a-g][#b]?)([0-8])$/i),semitone=match?match[1]:"a",wholetone=semitone[0].toLowerCase(),accidental=semitone[1],octave=match?parseInt(match[2],10):4,accidentalOffset=accidental==="#"?1:accidental==="b"?-1:0;return({c:0,d:2,e:4,f:5,g:7,a:9,b:11}[wholetone]||0)+accidentalOffset+octave*12}static musicalNoteToFrequency(note){const notesFromC0=typeof note==="string"?this.noteStringToC0Distance(note):note;return 16.3516*Math.pow(2,Math.min(notesFromC0,107)/12)}}SonificationInstrument.rampTime=Sonification_SynthPatch.stopRampTime/4;const Sonification_SonificationInstrument=SonificationInstrument;"";const{pick:SonificationSpeaker_pick}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();class SonificationSpeaker{constructor(options){this.options=options;this.masterVolume=1;this.synthesis=window.speechSynthesis;if(typeof speechSynthesis.onvoiceschanged!=="undefined"){speechSynthesis.onvoiceschanged=this.setVoice.bind(this)}this.setVoice();this.scheduled=[]}say(message,options){if(this.synthesis){this.synthesis.cancel();const utterance=new SpeechSynthesisUtterance(message);if(this.voice){utterance.voice=this.voice}utterance.rate=options&&options.rate||this.options.rate||1;utterance.pitch=options&&options.pitch||this.options.pitch||1;utterance.volume=SonificationSpeaker_pick(options&&options.volume,this.options.volume,1)*this.masterVolume;this.synthesis.speak(utterance)}}sayAtTime(time,message,options){this.scheduled.push(setTimeout(this.say.bind(this,message,options),time))}cancel(){this.scheduled.forEach(clearTimeout);this.scheduled=[];this.synthesis.cancel()}destroy(){this.cancel()}setMasterVolume(vol){this.masterVolume=vol}setVoice(){if(this.synthesis){const name=this.options.name,lang=this.options.language||"en-US",voices=this.synthesis.getVoices(),len=voices.length;let langFallback;for(let i=0;i<len;++i){if(name&&voices[i].name===name){this.voice=voices[i];return}if(!langFallback&&voices[i].lang===lang){langFallback=voices[i];if(!name){break}}}this.voice=langFallback}}}const Sonification_SonificationSpeaker=SonificationSpeaker;"";class TimelineChannel{constructor(type,engine,showPlayMarker=false,events,muted){this.type=type;this.engine=engine;this.showPlayMarker=showPlayMarker;this.muted=muted;this.events=events||[]}addEvent(event){const lastEvent=this.events[this.events.length-1];if(lastEvent&&event.time<lastEvent.time){let i=this.events.length;while(i--&&this.events[i].time>event.time){}this.events.splice(i+1,0,event)}else{this.events.push(event)}return event}mute(){this.muted=true}unmute(){this.muted=false}cancel(){this.engine.cancel()}destroy(){this.engine.destroy()}}const Sonification_TimelineChannel=TimelineChannel;"";const{pick:MIDI_pick}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();const freqToNote=f=>Math.round(12*Math.log(f)/Math.LN2-48.37632),b=(byte,n)=>n>>>8*byte&255,getHeader=nTracks=>[77,84,104,100,0,0,0,6,0,nTracks>1?1:0,b(1,nTracks),b(0,nTracks),1,244],timeInfo=[0,255,81,3,7,161,32],varLenEnc=n=>{let buf=n&127;const res=[];while(n>>=7){buf<<=8;buf|=n&127|128}while(true){res.push(buf&255);if(buf&128){buf>>=8}else{break}}return res},toMIDIEvents=events=>{let cachedVel,cachedDur;const res=[],add=el=>{let ix=res.length;while(ix--&&res[ix].timeMS>el.timeMS){}res.splice(ix+1,0,el)};events.forEach(e=>{const o=e.instrumentEventOptions||{},t=e.time,dur=cachedDur=MIDI_pick(o.noteDuration,cachedDur),tNOF=dur&&e.time+dur,ctrl=[{valMap:n=>64+63*n&127,data:{10:o.pan,92:o.tremoloDepth,93:o.tremoloSpeed}},{valMap:n=>127*n/2e4&127,data:{74:o.lowpassFreq,75:o.highpassFreq}},{valMap:n=>63*Math.min(18,Math.max(-18,n))/18+63&127,data:{71:o.lowpassResonance,76:o.highpassResonance}}],v=cachedVel=o.volume===void 0?MIDI_pick(cachedVel,127):127*o.volume&127,freq=o.frequency,note=o.note||0,noteVal=12+(freq?freqToNote(freq):typeof note==="string"?Sonification_SonificationInstrument.noteStringToC0Distance(note):note)&127;ctrl.forEach(ctrlDef=>Object.keys(ctrlDef.data).forEach(ctrlSignal=>{const val=ctrlDef.data[ctrlSignal];if(val!==void 0){add({timeMS:t,type:"CTRL_CHG",data:[176,parseInt(ctrlSignal,10),ctrlDef.valMap(val)]})}}));if(tNOF){add({timeMS:t,type:"NON",data:[144,noteVal,v]});add({timeMS:tNOF,type:"NOF",data:[128,noteVal,v]})}});return res},getMetaEvents=(midiTrackName,midiInstrument)=>{const events=[];if(midiInstrument){events.push(0,192,midiInstrument&127)}if(midiTrackName){const textArr=[];for(let i=0;i<midiTrackName.length;++i){const code=midiTrackName.charCodeAt(i);if(code<128){textArr.push(code)}}return events.concat([0,255,3],varLenEnc(textArr.length),textArr)}return events},getTrackChunk=(events,addTimeInfo,midiTrackName,midiInstrument)=>{let prevTime=0;const metaEvents=getMetaEvents(midiTrackName,midiInstrument),trackEvents=toMIDIEvents(events).reduce((data,e)=>{const t=varLenEnc(e.timeMS-prevTime);prevTime=e.timeMS;return data.concat(t,e.data)},[]);const trackEnd=[0,255,47,0],size=(addTimeInfo?timeInfo.length:0)+metaEvents.length+trackEvents.length+trackEnd.length;return[77,84,114,107,b(3,size),b(2,size),b(1,size),b(0,size)].concat(addTimeInfo?timeInfo:[],metaEvents,trackEvents,trackEnd)};function toMIDI(channels){const channelsToAdd=channels.filter(c=>!!c.events.length),numCh=channelsToAdd.length,multiCh=numCh>1;return new Uint8Array(getHeader(multiCh?numCh+1:numCh).concat(multiCh?getTrackChunk([],true):[],channelsToAdd.reduce((chunks,channel)=>{const engine=channel.engine;return chunks.concat(getTrackChunk(channel.events,!multiCh,engine.midiTrackName,engine.midiInstrument))},[])))}const MIDI=toMIDI;const{isSafari,win,win:{document:doc}}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();const domurl=win.URL||win.webkitURL||win;function dataURLtoBlob(dataURL){const parts=dataURL.replace(/filename=.*;/,"").match(/data:([^;]*)(;base64)?,([A-Z+\d\/]+)/i);if(parts&&parts.length>3&&win.atob&&win.ArrayBuffer&&win.Uint8Array&&win.Blob&&domurl.createObjectURL){const binStr=win.atob(parts[3]),buf=new win.ArrayBuffer(binStr.length),binary=new win.Uint8Array(buf);for(let i=0;i<binary.length;++i){binary[i]=binStr.charCodeAt(i)}return domurl.createObjectURL(new win.Blob([binary],{type:parts[1]}))}}function downloadURL(dataURL,filename){const nav=win.navigator,a=doc.createElement("a");if(typeof dataURL!=="string"&&!(dataURL instanceof String)&&nav.msSaveOrOpenBlob){nav.msSaveOrOpenBlob(dataURL,filename);return}dataURL=""+dataURL;if(nav.userAgent.length>1e3){throw new Error("Input too long")}const isOldEdgeBrowser=/Edge\/\d+/.test(nav.userAgent),safariBlob=isSafari&&typeof dataURL==="string"&&dataURL.indexOf("data:application/pdf")===0;if(safariBlob||isOldEdgeBrowser||dataURL.length>2e6){dataURL=dataURLtoBlob(dataURL)||"";if(!dataURL){throw new Error("Failed to convert to blob")}}if(typeof a.download!=="undefined"){a.href=dataURL;a.download=filename;doc.body.appendChild(a);a.click();doc.body.removeChild(a)}else{try{if(!win.open(dataURL,"chart")){throw new Error("Failed to open window")}}catch{win.location.href=dataURL}}}const DownloadURL={dataURLtoBlob:dataURLtoBlob,downloadURL:downloadURL};const Extensions_DownloadURL=DownloadURL;const{downloadURL:SonificationTimeline_downloadURL}=Extensions_DownloadURL;const{defined:SonificationTimeline_defined,find,merge}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();function filterChannels(filter,channels){const filtered=channels.map(channel=>{channel.cancel();return{channel:channel,filteredEvents:channel.muted?[]:channel.events.filter(filter)}}),minTime=filtered.reduce((acc,cur)=>Math.min(acc,cur.filteredEvents.length?cur.filteredEvents[0].time:Infinity),Infinity);return filtered.map(c=>new Sonification_TimelineChannel(c.channel.type,c.channel.engine,c.channel.showPlayMarker,c.filteredEvents.map(e=>merge(e,{time:e.time-minTime})),c.channel.muted))}class SonificationTimeline{constructor(options,chart){this.chart=chart;this.isPaused=false;this.isPlaying=false;this.channels=[];this.scheduledCallbacks=[];this.playTimestamp=0;this.resumeFromTime=0;this.options=options||{}}addChannel(type,engine,showPlayMarker=false,events){if(type==="instrument"&&!engine.scheduleEventAtTime||type==="speech"&&!engine.sayAtTime){throw new Error("Highcharts Sonification: Invalid channel engine.")}const channel=new Sonification_TimelineChannel(type,engine,showPlayMarker,events);this.channels.push(channel);return channel}play(filter,filterPersists=true,resetAfter=true,onEnd){if(this.isPlaying){this.cancel()}else{this.clearScheduledCallbacks()}this.onEndArgument=onEnd;this.playTimestamp=Date.now();this.resumeFromTime=0;this.isPaused=false;this.isPlaying=true;const skipThreshold=this.options.skipThreshold||2,onPlay=this.options.onPlay,showTooltip=this.options.showTooltip,showCrosshair=this.options.showCrosshair,channels=filter?filterChannels(filter,this.playingChannels||this.channels):this.channels,getEventKeysSignature=e=>Object.keys(e.speechOptions||{}).concat(Object.keys(e.instrumentEventOptions||{})).join(),pointsPlayed=[];if(filterPersists){this.playingChannels=channels}if(onPlay){onPlay({chart:this.chart,timeline:this})}let maxTime=0;channels.forEach(channel=>{if(channel.muted){return}const numEvents=channel.events.length;let lastCallbackTime=-Infinity,lastEventTime=-Infinity,lastEventKeys="";maxTime=Math.max(channel.events[numEvents-1]&&channel.events[numEvents-1].time||0,maxTime);for(let i=0;i<numEvents;++i){const e=channel.events[i],keysSig=getEventKeysSignature(e);if(keysSig===lastEventKeys&&e.time-lastEventTime<skipThreshold){continue}lastEventKeys=keysSig;lastEventTime=e.time;if(channel.type==="instrument"){channel.engine.scheduleEventAtTime(e.time/1e3,e.instrumentEventOptions||{})}else{channel.engine.sayAtTime(e.time,e.message||"",e.speechOptions||{})}const point=e.relatedPoint,chart=point&&point.series&&point.series.chart,needsCallback=e.callback||point&&(showTooltip||showCrosshair)&&channel.showPlayMarker!==false&&(e.time-lastCallbackTime>50||i===numEvents-1);if(point){pointsPlayed.push(point)}if(needsCallback){this.scheduledCallbacks.push(setTimeout(()=>{if(e.callback){e.callback()}if(point){if(showCrosshair){const s=point.series;if(s&&s.xAxis&&s.xAxis.crosshair){s.xAxis.drawCrosshair(void 0,point)}if(s&&s.yAxis&&s.yAxis.crosshair){s.yAxis.drawCrosshair(void 0,point)}}if(showTooltip&&!(chart&&chart.hoverPoints&&chart.hoverPoints.length>1&&find(chart.hoverPoints,p=>p===point)&&point.onMouseOver)){point.onMouseOver()}}},e.time));lastCallbackTime=e.time}}});const onEndOpt=this.options.onEnd,onStop=this.options.onStop;this.scheduledCallbacks.push(setTimeout(()=>{const chart=this.chart,context={chart:chart,timeline:this,pointsPlayed:pointsPlayed};this.isPlaying=false;if(resetAfter){this.resetPlayState()}if(onStop){onStop(context)}if(onEndOpt){onEndOpt(context)}if(onEnd){onEnd(context)}if(chart){if(chart.tooltip){chart.tooltip.hide(0)}if(chart.hoverSeries){chart.hoverSeries.onMouseOut()}chart.axes.forEach(a=>a.hideCrosshair())}},maxTime+250));this.resumeFromTime=filterPersists?maxTime:this.getLength()}pause(){this.isPaused=true;this.cancel();this.resumeFromTime=Date.now()-this.playTimestamp-10;return this.resumeFromTime}getCurrentTime(){return this.isPlaying?Date.now()-this.playTimestamp:this.resumeFromTime}getLength(){return this.channels.reduce((maxTime,channel)=>{const lastEvent=channel.events[channel.events.length-1];return lastEvent?Math.max(lastEvent.time,maxTime):maxTime},0)}resume(){if(this.playingChannels){const resumeFrom=this.resumeFromTime-50;this.play(e=>e.time>resumeFrom,false,false,this.onEndArgument);this.playTimestamp-=resumeFrom}else{this.play(void 0,false,false,this.onEndArgument)}}anchorPlayMoment(eventFilter,onEnd){if(this.isPlaying){this.pause()}let finalEventTime=0;this.play((e,ix,arr)=>{const res=eventFilter(e,ix,arr);if(res&&e.time>finalEventTime){finalEventTime=e.time}return res},false,false,onEnd);this.playingChannels=this.playingChannels||this.channels;this.isPaused=true;this.isPlaying=false;this.resumeFromTime=finalEventTime}playAdjacent(next,onEnd,onBoundaryHit,eventFilter){if(this.isPlaying){this.pause()}const fromTime=this.resumeFromTime,closestTime=this.channels.reduce((time,channel)=>{const events=eventFilter?channel.events.filter(eventFilter):channel.events;let s=0,e=events.length,lastValidTime=time;while(s<e){const mid=s+e>>1,t=events[mid].time,cmp=t-fromTime;if(cmp>0){if(next&&t<lastValidTime){lastValidTime=t}e=mid}else if(cmp<0){if(!next&&t>lastValidTime){lastValidTime=t}s=mid+1}else{if(next){s=mid+1}else{e=mid}}}return lastValidTime},next?Infinity:-Infinity),margin=.02;if(closestTime===Infinity||closestTime===-Infinity){if(onBoundaryHit){onBoundaryHit({chart:this.chart,timeline:this,attemptedNext:next})}return}this.anchorPlayMoment((e,ix,arr)=>{const withinTime=next?e.time>fromTime&&e.time<=closestTime+margin:e.time<fromTime&&e.time>=closestTime-margin;return eventFilter?withinTime&&eventFilter(e,ix,arr):withinTime},onEnd)}playClosestToPropValue(prop,targetVal,onEnd,onBoundaryHit,eventFilter){const filter=(e,ix,arr)=>!!(eventFilter?eventFilter(e,ix,arr)&&e.relatedPoint:e.relatedPoint);let closestValDiff=Infinity,closestEvent=null;(this.playingChannels||this.channels).forEach(channel=>{const events=channel.events;let i=events.length;while(i--){if(!filter(events[i],i,events)){continue}const val=events[i].relatedPoint[prop],diff=SonificationTimeline_defined(val)&&Math.abs(targetVal-val);if(diff!==false&&diff<closestValDiff){closestValDiff=diff;closestEvent=events[i]}}});if(closestEvent){this.play(e=>!!(closestEvent&&e.time<closestEvent.time+1&&e.time>closestEvent.time-1&&e.relatedPoint===closestEvent.relatedPoint),false,false,onEnd);this.playingChannels=this.playingChannels||this.channels;this.isPaused=true;this.isPlaying=false;this.resumeFromTime=closestEvent.time}else if(onBoundaryHit){onBoundaryHit({chart:this.chart,timeline:this})}}getEventsForPoint(point){return this.channels.reduce((events,channel)=>{const pointEvents=channel.events.filter(e=>e.relatedPoint===point);return events.concat(pointEvents)},[])}playSegment(segment,onEnd){const numSegments=100;const eventTimes={first:Infinity,last:-Infinity};this.channels.forEach(c=>{if(c.events.length){eventTimes.first=Math.min(c.events[0].time,eventTimes.first);eventTimes.last=Math.max(c.events[c.events.length-1].time,eventTimes.last)}});if(eventTimes.first<Infinity){const segmentSize=(eventTimes.last-eventTimes.first)/numSegments,fromTime=eventTimes.first+segment*segmentSize,toTime=fromTime+segmentSize;if(!this.channels.some(c=>{const events=c.events;let s=0,e=events.length;while(s<e){const mid=s+e>>1,t=events[mid].time;if(t<fromTime){s=mid+1}else if(t>toTime){e=mid}else{return true}}return false})){return}this.play(e=>e.time>=fromTime&&e.time<=toTime,false,false,onEnd);this.playingChannels=this.playingChannels||this.channels;this.isPaused=true;this.isPlaying=false;this.resumeFromTime=toTime}}getLastPlayedPoint(filter){const curTime=this.getCurrentTime(),channels=this.playingChannels||this.channels;let closestDiff=Infinity,closestPoint=null;channels.forEach(c=>{const events=c.events.filter((e,ix,arr)=>!!(e.relatedPoint&&e.time<=curTime&&(!filter||filter(e,ix,arr)))),closestEvent=events[events.length-1];if(closestEvent){const closestTime=closestEvent.time,diff=Math.abs(closestTime-curTime);if(diff<closestDiff){closestDiff=diff;closestPoint=closestEvent.relatedPoint}}});return closestPoint}reset(){if(this.isPlaying){this.cancel()}this.resetPlayState()}cancel(){const onStop=this.options.onStop;if(onStop){onStop({chart:this.chart,timeline:this})}this.isPlaying=false;this.channels.forEach(c=>c.cancel());if(this.playingChannels&&this.playingChannels!==this.channels){this.playingChannels.forEach(c=>c.cancel())}this.clearScheduledCallbacks();this.resumeFromTime=0}destroy(){this.cancel();if(this.playingChannels&&this.playingChannels!==this.channels){this.playingChannels.forEach(c=>c.destroy())}this.channels.forEach(c=>c.destroy())}setMasterVolume(vol){this.channels.forEach(c=>c.engine.setMasterVolume(vol))}getMIDIData(){return MIDI(this.channels.filter(c=>c.type==="instrument"))}downloadMIDI(filename){const data=this.getMIDIData(),name=(filename||this.chart&&this.chart.options.title&&this.chart.options.title.text||"chart")+".mid",blob=new Blob([data],{type:"application/octet-stream"}),url=window.URL.createObjectURL(blob);SonificationTimeline_downloadURL(url,name);window.URL.revokeObjectURL(url)}resetPlayState(){delete this.playingChannels;delete this.onEndArgument;this.playTimestamp=this.resumeFromTime=0;this.isPaused=false}clearScheduledCallbacks(){this.scheduledCallbacks.forEach(clearTimeout);this.scheduledCallbacks=[]}}const Sonification_SonificationTimeline=SonificationTimeline;"";var highcharts_Templating_commonjs_highcharts_Templating_commonjs2_highcharts_Templating_root_Highcharts_Templating_=__webpack_require__(984);var highcharts_Templating_commonjs_highcharts_Templating_commonjs2_highcharts_Templating_root_Highcharts_Templating_default=__webpack_require__.n(highcharts_Templating_commonjs_highcharts_Templating_commonjs2_highcharts_Templating_root_Highcharts_Templating_);const{clamp:TimelineFromChart_clamp,defined:TimelineFromChart_defined,extend:TimelineFromChart_extend,getNestedProperty,merge:TimelineFromChart_merge,pick:TimelineFromChart_pick}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();const{format}=highcharts_Templating_commonjs_highcharts_Templating_commonjs2_highcharts_Templating_root_Highcharts_Templating_default();const isNoteDefinition=str=>/^([a-g][#b]?)[0-8]$/i.test(str);function getPointPropValue(point,prop){let ret;if(prop){ret=point[prop];if(typeof ret==="number"){return ret}ret=getNestedProperty(prop,point)}return typeof ret==="number"?ret:void 0}function getChartExtremesForProps(chart,props,perSeriesProps){const series=chart.series,numProps=props.length,numSeriesProps=perSeriesProps.length,initCache=propList=>propList.reduce((cache,prop)=>{cache[prop]={min:Infinity,max:-Infinity},cache;return cache},{}),updateCache=(cache,point,prop)=>{let val=point[prop];if(val===void 0){val=getNestedProperty(prop,point)}if(typeof val==="number"){cache[prop].min=Math.min(cache[prop].min,val);cache[prop].max=Math.max(cache[prop].max,val)}},globalExtremes=initCache(props);let i=series.length;const allSeriesExtremes=new Array(i);while(i--){const seriesExtremes=initCache(perSeriesProps);const opts=series[i].options;if(!series[i].visible||opts&&opts.sonification&&opts.sonification.enabled===false){continue}const points=series[i].points||[];let j=points.length;while(j--){let k=numProps;while(k--){updateCache(globalExtremes,points[j],props[k])}k=numSeriesProps;while(k--){updateCache(seriesExtremes,points[j],perSeriesProps[k])}}allSeriesExtremes[i]=seriesExtremes}return{globalExtremes:globalExtremes,seriesExtremes:allSeriesExtremes}}function getPropMetrics(chart){const globalOpts=chart.options.sonification||{},defaultInstrMapping=(globalOpts.defaultInstrumentOptions||{}).mapping||{time:"x",pitch:"y"},defaultSpeechMapping=globalOpts.defaultSpeechOptions&&globalOpts.defaultSpeechOptions.mapping||{},seriesTimeProps=[],commonTimeProps={},addTimeProp=(prop,seriesIx)=>{if(seriesIx!==null){seriesTimeProps[seriesIx]=seriesTimeProps[seriesIx]||{};seriesTimeProps[seriesIx][prop]=true}else{commonTimeProps[prop]=true}},props={},perSeriesProps={},addPropFromMappingParam=(param,val,seriesIx)=>{const removeInvertedFlag=s=>s.charAt(0)==="-"?s.slice(1):s;if(typeof val==="string"&&param!=="text"){if(param==="pitch"&&isNoteDefinition(val)){return}if(param==="time"){perSeriesProps[val]=true;addTimeProp(val,seriesIx)}props[removeInvertedFlag(val)]=true;return}const paramOpts=val;if(paramOpts&&paramOpts.mapTo&&typeof paramOpts.mapTo==="string"){const mapTo=removeInvertedFlag(paramOpts.mapTo);if(param==="time"){addTimeProp(mapTo,seriesIx)}if(param==="time"||paramOpts.within==="series"){perSeriesProps[mapTo]=true}props[mapTo]=true;return}if(["tremolo","lowpass","highpass"].indexOf(param)>-1&&typeof val==="object"){Object.keys(val).forEach(subParam=>addPropFromMappingParam(subParam,val[subParam],seriesIx))}},addPropsFromMappingOptions=(mapping,seriesIx)=>{Object.keys(mapping).forEach(param=>addPropFromMappingParam(param,mapping[param],seriesIx))},addPropsFromContextTracks=tracks=>tracks.forEach(track=>{props[track.valueProp||"x"]=perSeriesProps[track.valueProp||"x"]=true});addPropsFromMappingOptions(defaultInstrMapping,null);addPropsFromMappingOptions(defaultSpeechMapping,null);addPropsFromContextTracks(globalOpts.globalContextTracks||[]);const hasCommonTimeProps=Object.keys(commonTimeProps).length;chart.series.forEach(series=>{const sOpts=series.options.sonification;if(series.visible&&!(sOpts&&sOpts.enabled===false)){if(hasCommonTimeProps){seriesTimeProps[series.index]=TimelineFromChart_merge(commonTimeProps)}if(sOpts){const defaultInstrMapping=(sOpts.defaultInstrumentOptions||{}).mapping,defaultSpeechMapping=(sOpts.defaultSpeechOptions||{}).mapping;if(defaultInstrMapping){addPropsFromMappingOptions(defaultInstrMapping,series.index)}if(defaultSpeechMapping){addPropsFromMappingOptions(defaultSpeechMapping,series.index)}addPropsFromContextTracks(sOpts.contextTracks||[]);(sOpts.tracks||[]).concat(sOpts.contextTracks||[]).forEach(trackOpts=>{if(trackOpts.mapping){addPropsFromMappingOptions(trackOpts.mapping,series.index)}})}}});return{seriesTimeProps:seriesTimeProps,...getChartExtremesForProps(chart,Object.keys(props),Object.keys(perSeriesProps))}}function mapToVirtualAxis(value,valueExtremes,virtualAxisExtremes,invert,logarithmic){const lenValueAxis=valueExtremes.max-valueExtremes.min;if(lenValueAxis<=0){return virtualAxisExtremes.min}const lenVirtualAxis=virtualAxisExtremes.max-virtualAxisExtremes.min,valueDelta=value-valueExtremes.min;let virtualValueDelta=lenVirtualAxis*valueDelta/lenValueAxis;if(logarithmic){const log=valueExtremes.min>0?x=>Math.log(x)/Math.LOG10E:x=>{let adjustedNum=Math.abs(x);if(adjustedNum<10){adjustedNum+=(10-adjustedNum)/10}const res=Math.log(adjustedNum)/Math.LN10;return x<0?-res:res};const logValMin=log(valueExtremes.min);virtualValueDelta=lenVirtualAxis*(log(value)-logValMin)/(log(valueExtremes.max)-logValMin)}const val=invert?virtualAxisExtremes.max-virtualValueDelta:virtualAxisExtremes.min+virtualValueDelta;return TimelineFromChart_clamp(val,virtualAxisExtremes.min,virtualAxisExtremes.max)}function getMappingParameterValue(context,propMetrics,useSeriesExtremes,defaultMapping,mappingOptions,contextValueProp){if(typeof mappingOptions==="number"){return mappingOptions}if(typeof mappingOptions==="function"){return mappingOptions(TimelineFromChart_extend({time:0},context))}let mapTo=mappingOptions,mapFunc=defaultMapping.mapFunction,min=defaultMapping.min,max=defaultMapping.max,within=defaultMapping.within,scale;if(typeof mappingOptions==="object"){mapTo=mappingOptions.mapTo;mapFunc=mappingOptions.mapFunction||mapFunc;min=TimelineFromChart_pick(mappingOptions.min,min);max=TimelineFromChart_pick(mappingOptions.max,max);within=mappingOptions.within||defaultMapping.within;scale=mappingOptions.scale}if(!mapTo){return null}const isInverted=mapTo.charAt(0)==="-";if(isInverted){mapTo=mapTo.slice(1)}let value=context.value;const useContextValue=mapTo==="value"&&value!==void 0&&contextValueProp;if(!useContextValue){const fixedValue=mappingOptions.value;if(fixedValue!==void 0){value=fixedValue}else{if(!context.point){return null}value=context.point[mapTo]}if(value===void 0){value=getNestedProperty(mapTo,context.point)}}if(typeof value!=="number"||value===null){return null}let extremes=null;if(context.point){if(within==="xAxis"||within==="yAxis"){const axis=context.point.series[within];if(axis&&TimelineFromChart_defined(axis.dataMin)&&TimelineFromChart_defined(axis.dataMax)){extremes={min:axis.dataMin,max:axis.dataMax}}}else if((within==="series"||useSeriesExtremes)&&context.point.series){extremes=propMetrics.seriesExtremes[context.point.series.index][useContextValue?contextValueProp:mapTo]}}if(!extremes){extremes=propMetrics.globalExtremes[useContextValue?contextValueProp:mapTo]}if(scale){const scaleAxis=[],minOctave=Math.floor(min/12),maxOctave=Math.ceil(max/12)+1,lenScale=scale.length;for(let octave=minOctave;octave<maxOctave;++octave){for(let scaleIx=0;scaleIx<lenScale;++scaleIx){const note=12*octave+scale[scaleIx];if(note>=min&&note<=max){scaleAxis.push(note)}}}const noteNum=mapToVirtualAxis(value,extremes,{min:0,max:scaleAxis.length-1},isInverted,mapFunc==="logarithmic");return scaleAxis[Math.round(noteNum)]}return mapToVirtualAxis(value,extremes,{min:min,max:max},isInverted,mapFunc==="logarithmic")}function getParamValWithDefault(context,propMetrics,useSeriesExtremes,mappingParamOptions,fallback,defaults,contextValueProp){return TimelineFromChart_pick(getMappingParameterValue(context,propMetrics,useSeriesExtremes,TimelineFromChart_extend({min:0,max:1,mapTo:"y",mapFunction:"linear",within:"chart"},defaults||{}),mappingParamOptions,contextValueProp),fallback)}function getPointTime(point,startTime,duration,timeMappingOptions,propMetrics,useSeriesExtremes){const time=getParamValWithDefault({point:point,time:0},propMetrics,useSeriesExtremes,timeMappingOptions,0,{min:0,max:duration,mapTo:"x"});return time+startTime}function getAvailableDurationForSeries(series,totalDuration,propMetrics,afterSeriesWait){let timeProp,seriesDuration;const availableDuration=totalDuration-(series.chart.series.length-1)*afterSeriesWait,hasGlobalTimeProp=propMetrics.seriesTimeProps.every(timeProps=>{const props=Object.keys(timeProps);if(props.length>1){return false}if(!timeProp){timeProp=props[0]}return timeProp===props[0]});if(hasGlobalTimeProp){const seriesExtremes=propMetrics.seriesExtremes[series.index][timeProp],seriesTimeLen=seriesExtremes.max-seriesExtremes.min,totalTimeLen=propMetrics.seriesExtremes.reduce((sum,s)=>s[timeProp]?sum+s[timeProp].max-s[timeProp].min:sum,0);seriesDuration=Math.round(seriesTimeLen/totalTimeLen*availableDuration)}else{const totalPoints=series.chart.series.reduce((sum,s)=>sum+s.points.length,0);seriesDuration=Math.round((series.points||[]).length/totalPoints*availableDuration)}return Math.max(50,seriesDuration)}function addTimelineChannelFromTrack(timeline,audioContext,destinationNode,options){const speechOpts=options,instrMappingOpts=options.mapping||{},engine=options.type==="speech"?new Sonification_SonificationSpeaker({language:speechOpts.language,name:speechOpts.preferredVoice}):new Sonification_SonificationInstrument(audioContext,destinationNode,{capabilities:{pan:!!instrMappingOpts.pan,tremolo:!!instrMappingOpts.tremolo,filters:!!(instrMappingOpts.highpass||instrMappingOpts.lowpass)},synthPatch:options.instrument,midiTrackName:options.midiName});return timeline.addChannel(options.type||"instrument",engine,TimelineFromChart_pick(options.showPlayMarker,true))}function addMappedInstrumentEvent(context,channel,mappingOptions,propMetrics,roundToMusicalNotes,contextValueProp){const getParam=(param,fallback,defaults,parent)=>getParamValWithDefault(context,propMetrics,false,(parent||mappingOptions)[param],fallback,defaults,contextValueProp);const eventsAdded=[],eventOpts={noteDuration:getParam("noteDuration",200,{min:40,max:1e3}),pan:getParam("pan",0,{min:-1,max:1}),volume:getParam("volume",1,{min:.1,max:1})};if(mappingOptions.frequency){eventOpts.frequency=getParam("frequency",440,{min:50,max:6e3})}if(mappingOptions.lowpass){eventOpts.lowpassFreq=getParam("frequency",2e4,{min:0,max:2e4},mappingOptions.lowpass);eventOpts.lowpassResonance=getParam("resonance",0,{min:-6,max:12},mappingOptions.lowpass)}if(mappingOptions.highpass){eventOpts.highpassFreq=getParam("frequency",2e4,{min:0,max:2e4},mappingOptions.highpass);eventOpts.highpassResonance=getParam("resonance",0,{min:-6,max:12},mappingOptions.highpass)}if(mappingOptions.tremolo){eventOpts.tremoloDepth=getParam("depth",0,{min:0,max:.8},mappingOptions.tremolo);eventOpts.tremoloSpeed=getParam("speed",0,{min:0,max:.8},mappingOptions.tremolo)}const gapBetweenNotes=getParam("gapBetweenNotes",150,{min:50,max:1e3}),playDelay=getParam("playDelay",0,{max:200});const addNoteEvent=(noteDef,ix=0)=>{let opts=noteDef;if(noteDef.mapTo){if(typeof noteDef.min==="string"){opts.min=Sonification_SonificationInstrument.noteStringToC0Distance(noteDef.min)}if(typeof noteDef.max==="string"){opts.max=Sonification_SonificationInstrument.noteStringToC0Distance(noteDef.max)}}else if(typeof noteDef==="string"&&isNoteDefinition(noteDef)){opts=Sonification_SonificationInstrument.noteStringToC0Distance(noteDef)}eventOpts.note=getParamValWithDefault(context,propMetrics,false,opts,-1,{min:0,max:107},contextValueProp);if(eventOpts.note>-1){if(roundToMusicalNotes){eventOpts.note=Math.round(eventOpts.note)}eventsAdded.push(channel.addEvent({time:context.time+playDelay+gapBetweenNotes*ix,relatedPoint:context.point,instrumentEventOptions:ix!==void 0?TimelineFromChart_extend({},eventOpts):eventOpts}))}};if(mappingOptions.pitch&&mappingOptions.pitch.constructor===Array){mappingOptions.pitch.forEach(addNoteEvent)}else if(mappingOptions.pitch){addNoteEvent(mappingOptions.pitch)}else if(mappingOptions.frequency){eventsAdded.push(channel.addEvent({time:context.time+playDelay,relatedPoint:context.point,instrumentEventOptions:eventOpts}))}return eventsAdded}function getSpeechMessageValue(context,messageParam){return format(typeof messageParam==="function"?messageParam(context):messageParam,context,context.point&&context.point.series.chart)}function addMappedSpeechEvent(context,channel,mappingOptions,propMetrics,contextValueProp){const getParam=(param,fallback,defaults)=>getParamValWithDefault(context,propMetrics,false,mappingOptions[param],fallback,defaults,contextValueProp);const playDelay=getParam("playDelay",0,{max:200}),pitch=getParam("pitch",1,{min:.3,max:2}),rate=getParam("rate",1,{min:.4,max:4}),volume=getParam("volume",1,{min:.1}),message=getSpeechMessageValue(context,mappingOptions.text);if(message){return channel.addEvent({time:context.time+playDelay,relatedPoint:context.point,speechOptions:{pitch:pitch,rate:rate,volume:volume},message:message})}}function addMappedEventForPoint(context,channel,trackOptions,propMetrics){let eventsAdded=[];if(trackOptions.type==="speech"&&trackOptions.mapping){const eventAdded=addMappedSpeechEvent(context,channel,trackOptions.mapping,propMetrics);if(eventAdded){eventsAdded=[eventAdded]}}else if(trackOptions.mapping){eventsAdded=addMappedInstrumentEvent(context,channel,trackOptions.mapping,propMetrics,TimelineFromChart_pick(trackOptions.roundToMusicalNotes,true))}return eventsAdded}function getGroupedPoints(pointGroupOpts,points){const alg=pointGroupOpts.algorithm||"minmax",r=ix=>points[ix]?[points[ix].point]:[];if(alg==="first"){return r(0)}if(alg==="last"){return r(points.length-1)}if(alg==="middle"){return r(points.length>>1)}if(alg==="firstlast"){return r(0).concat(r(points.length-1))}if(alg==="minmax"){const prop=pointGroupOpts.prop||"y";let min,max,minVal,maxVal;points.forEach(p=>{const val=getPointPropValue(p.point,prop);if(val===void 0){return}if(!min||val<minVal){min=p;minVal=val}if(!max||val>maxVal){max=p;maxVal=val}});if(min&&max){if(min.point===max.point){return[min.point]}return min.time>max.time?[max.point,min.point]:[min.point,max.point]}}return[]}function isActive(context,activeWhen,lastPropValue){if(typeof activeWhen==="function"){return activeWhen(context)}if(typeof activeWhen==="object"){const prop=activeWhen.prop,val=TimelineFromChart_pick(context.value,context.point&&getPointPropValue(context.point,prop));if(typeof val!=="number"){return false}let crossingOk=true;const crossingUp=activeWhen.crossingUp,crossingDown=activeWhen.crossingDown,hasLastValue=typeof lastPropValue==="number";if(crossingUp&&crossingDown){crossingOk=hasLastValue&&(lastPropValue<crossingUp&&val>=crossingUp||lastPropValue>crossingDown&&val<=crossingDown)}else{crossingOk=(crossingUp===void 0||hasLastValue&&lastPropValue<crossingUp&&val>=crossingUp)&&(crossingDown===void 0||hasLastValue&&lastPropValue>crossingDown&&val<=crossingDown)}const max=TimelineFromChart_pick(activeWhen.max,Infinity),min=TimelineFromChart_pick(activeWhen.min,-Infinity);return val<=max&&val>=min&&crossingOk}return true}function timelineFromChart(audioContext,destinationNode,chart){const options=chart.options.sonification||{},defaultInstrOpts=options.defaultInstrumentOptions,defaultSpeechOpts=options.defaultSpeechOptions,defaultPointGroupOpts=TimelineFromChart_merge({enabled:true,groupTimespan:15,algorithm:"minmax",prop:"y"},options.pointGrouping),globalTracks=options.globalTracks||[],globalContextTracks=options.globalContextTracks||[],isSequential=options.order==="sequential",totalDuration=Math.max(50,options.duration-300),afterSeriesWait=options.afterSeriesWait,eventOptions=options.events||{},propMetrics=getPropMetrics(chart),timeline=new Sonification_SonificationTimeline({onPlay:eventOptions.onPlay,onEnd:eventOptions.onEnd,onStop:eventOptions.onStop,showCrosshair:options.showCrosshair,showTooltip:options.showTooltip},chart);if(chart.sonification){chart.sonification.propMetrics=propMetrics}let startTime=0;chart.series.forEach((series,seriesIx)=>{const sOptions=series.options.sonification||{};if(series.visible&&sOptions.enabled!==false){const seriesDuration=isSequential?getAvailableDurationForSeries(series,totalDuration,propMetrics,afterSeriesWait):totalDuration,seriesDefaultInstrOpts=TimelineFromChart_merge(defaultInstrOpts,sOptions.defaultInstrumentOptions),seriesDefaultSpeechOpts=TimelineFromChart_merge(defaultSpeechOpts,sOptions.defaultSpeechOptions),seriesPointGroupOpts=TimelineFromChart_merge(defaultPointGroupOpts,sOptions.pointGrouping),mainTracks=(sOptions.tracks||[seriesDefaultInstrOpts]).concat(globalTracks),hasAddedSeries=!!timeline.channels.length,contextTracks=hasAddedSeries&&!isSequential?sOptions.contextTracks||[]:(sOptions.contextTracks||[]).concat(globalContextTracks),eventsAdded=[];let lastPropValue;mainTracks.forEach(trackOpts=>{const mergedOpts=TimelineFromChart_merge({pointGrouping:seriesPointGroupOpts,midiName:trackOpts.midiName||series.name},trackOpts.type==="speech"?seriesDefaultSpeechOpts:seriesDefaultInstrOpts,trackOpts),pointGroupOpts=mergedOpts.pointGrouping,activeWhen=mergedOpts.activeWhen,updateLastPropValue=point=>{if(typeof activeWhen==="object"&&activeWhen.prop){lastPropValue=getPointPropValue(point,activeWhen.prop)}};const channel=addTimelineChannelFromTrack(timeline,audioContext,destinationNode,mergedOpts),add=c=>eventsAdded.push(...addMappedEventForPoint(c,channel,mergedOpts,propMetrics));let pointGroup=[],pointGroupTime=0;const addCurrentPointGroup=groupSpanTime=>{if(pointGroup.length===1){add({point:pointGroup[0].point,time:pointGroupTime+groupSpanTime/2})}else{const points=getGroupedPoints(pointGroupOpts,pointGroup),t=groupSpanTime/points.length;points.forEach((p,ix)=>add({point:p,time:pointGroupTime+t/2+t*ix}))}pointGroup=[]};(series.points||[]).forEach((point,pointIx)=>{const isLastPoint=pointIx===series.points.length-1;const time=getPointTime(point,startTime,seriesDuration,mergedOpts.mapping&&mergedOpts.mapping.time||0,propMetrics,isSequential);const context={point:point,time:time};if(!mergedOpts.mapping||!isActive(context,activeWhen,lastPropValue)){updateLastPropValue(point);if(isLastPoint&&pointGroup.length){addCurrentPointGroup(pointGroup[pointGroup.length-1].time-pointGroup[0].time)}return}updateLastPropValue(point);if(!pointGroupOpts.enabled){add(context)}else{const dT=time-pointGroupTime,groupSpan=pointGroupOpts.groupTimespan,spanTime=isLastPoint&&dT<=groupSpan?dT:groupSpan;if(isLastPoint||dT>groupSpan){if(dT<=groupSpan){pointGroup.push(context)}addCurrentPointGroup(spanTime);pointGroupTime=Math.floor(time/groupSpan)*groupSpan;if(isLastPoint&&dT>groupSpan){add({point:context.point,time:pointGroupTime+spanTime/2})}else{pointGroup=[context]}}else{pointGroup.push(context)}}})});const firstEvent=eventsAdded.reduce((first,e)=>e.time<first.time?e:first,{time:Infinity});const lastEvent=eventsAdded.reduce((last,e)=>e.time>last.time?e:last,{time:-Infinity});firstEvent.callback=eventOptions.onSeriesStart?eventOptions.onSeriesStart.bind(null,{series:series,timeline:timeline}):void 0;lastEvent.callback=eventOptions.onSeriesEnd?eventOptions.onSeriesEnd.bind(null,{series:series,timeline:timeline}):void 0;contextTracks.forEach(trackOpts=>{const mergedOpts=trackOpts.type==="speech"?TimelineFromChart_merge(defaultSpeechOpts,trackOpts):TimelineFromChart_merge(defaultInstrOpts,{mapping:{pitch:{mapTo:"value"}}},trackOpts);const contextChannel=addTimelineChannelFromTrack(timeline,audioContext,destinationNode,mergedOpts);lastPropValue=void 0;const{timeInterval,valueInterval}=mergedOpts,valueProp=mergedOpts.valueProp||"x",activeWhen=mergedOpts.activeWhen,contextExtremes=propMetrics.seriesExtremes[seriesIx][valueProp],addContextEvent=(time,value)=>{if(!mergedOpts.mapping||!isActive({time:time,value:value},typeof activeWhen==="object"?TimelineFromChart_extend({prop:valueProp},activeWhen):activeWhen,lastPropValue)){lastPropValue=value;return}lastPropValue=value;if(mergedOpts.type==="speech"){addMappedSpeechEvent({time:time,value:value},contextChannel,mergedOpts.mapping,propMetrics,valueProp)}else{addMappedInstrumentEvent({time:time,value:value},contextChannel,mergedOpts.mapping,propMetrics,TimelineFromChart_pick(mergedOpts.roundToMusicalNotes,true),valueProp)}};if(timeInterval){let time=0;while(time<=seriesDuration){const val=mapToVirtualAxis(time,{min:0,max:seriesDuration},contextExtremes);addContextEvent(time+startTime,val);time+=timeInterval}}if(valueInterval){let val=contextExtremes.min;while(val<=contextExtremes.max){const time=mapToVirtualAxis(val,contextExtremes,{min:0,max:seriesDuration},false,mergedOpts.valueMapFunction==="logarithmic");addContextEvent(time+startTime,val);val+=valueInterval}}});if(isSequential){startTime+=seriesDuration+afterSeriesWait}}});return timeline}const TimelineFromChart=timelineFromChart;const{defaultOptions,getOptions}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();const{addEvent,extend:Sonification_extend,fireEvent,merge:Sonification_merge,pick:Sonification_pick}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();const{doc:Sonification_doc,win:Sonification_win}=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();class Sonification{constructor(chart){this.chart=chart;this.retryContextCounter=0;this.lastUpdate=0;this.unbindKeydown=addEvent(Sonification_doc,"keydown",function(e){if(chart&&chart.sonification&&(e.key==="Esc"||e.key==="Escape")){chart.sonification.cancel()}});try{this.audioContext=new Sonification_win.AudioContext;this.audioContext.suspend();this.audioDestination=this.audioContext.destination}catch(e){}}setAudioDestination(audioDestination){this.audioDestination=audioDestination;this.update()}isPlaying(){return!!this.timeline&&this.timeline.isPlaying}playSegment(segment,onEnd){if(!this.ready(this.playSegment.bind(this,segment,onEnd))){return}if(this.timeline){this.timeline.playSegment(segment,onEnd)}}playAdjacent(next,onEnd,eventFilter){if(!this.ready(this.playAdjacent.bind(this,next,onEnd,eventFilter))){return}if(this.timeline){const opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playAdjacent(next,onEnd,onHit||(()=>{this.defaultBoundaryHit()}),eventFilter)}}playAdjacentSeries(next,prop="x",onEnd){const lastPlayed=this.getLastPlayedPoint();if(lastPlayed){const targetSeriesIx=lastPlayed.series.index+(next?1:-1);this.playClosestToProp(prop,lastPlayed[prop],e=>!!e.relatedPoint&&e.relatedPoint.series.index===targetSeriesIx,onEnd);return this.chart.series[targetSeriesIx]||null}return null}playClosestToProp(prop,targetValue,targetFilter,onEnd){if(!this.ready(this.playClosestToProp.bind(this,prop,targetValue,targetFilter,onEnd))){return}if(this.timeline){const opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playClosestToPropValue(prop,targetValue,onEnd,onHit||(()=>this.defaultBoundaryHit()),targetFilter)}}getLastPlayedPoint(){if(this.timeline){return this.timeline.getLastPlayedPoint()}return null}playNote(instrument,options,delayMs=0){if(!this.ready(this.playNote.bind(this,instrument,options))){return}const duration=options.noteDuration=options.noteDuration||500;const instr=new Sonification_SonificationInstrument(this.audioContext,this.audioDestination,{synthPatch:instrument,capabilities:{filters:true,tremolo:true,pan:true}});instr.scheduleEventAtTime(delayMs/1e3,options);setTimeout(()=>instr&&instr.destroy(),delayMs+duration+500)}speak(text,speakerOptions,delayMs=0){const speaker=new Sonification_SonificationSpeaker(Sonification_merge({language:"en-US",rate:1.5,volume:.4},speakerOptions||{}));speaker.sayAtTime(delayMs,text)}cancel(){if(this.timeline){this.timeline.cancel()}fireEvent(this,"cancel")}downloadMIDI(){if(!this.ready(this.downloadMIDI.bind(this))){return}if(this.timeline){this.timeline.reset();this.timeline.downloadMIDI()}}sonifyChart(resetAfter,onEnd){if(!this.ready(this.sonifyChart.bind(this,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(void 0,void 0,resetAfter,onEnd)}}sonifySeries(series,resetAfter,onEnd){if(!this.ready(this.sonifySeries.bind(this,series,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(e=>!!e.relatedPoint&&e.relatedPoint.series===series,void 0,resetAfter,onEnd)}}sonifyPoint(point,onEnd){if(!this.ready(this.sonifyPoint.bind(this,point,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.anchorPlayMoment(e=>e.relatedPoint===point,onEnd)}}setMasterVolume(vol){if(this.timeline){this.timeline.setMasterVolume(vol)}}destroy(){this.unbindKeydown();if(this.timeline){this.timeline.destroy();delete this.timeline}if(this.boundaryInstrument){this.boundaryInstrument.stop()}if(this.audioContext){this.audioContext.close();delete this.audioContext}}update(){const sOpts=this.chart.options&&this.chart.options.sonification;if(!this.ready(this.update.bind(this))||!sOpts){return}const now=Date.now(),updateInterval=sOpts.updateInterval;if(now-this.lastUpdate<updateInterval&&!this.forceReady){clearTimeout(this.scheduledUpdate);this.scheduledUpdate=setTimeout(this.update.bind(this),updateInterval/2);return}const events=sOpts.events||{};if(events.beforeUpdate){events.beforeUpdate({chart:this.chart,timeline:this.timeline})}this.lastUpdate=now;if(this.timeline){this.timeline.destroy()}if(this.audioContext&&this.audioDestination){this.timeline=TimelineFromChart(this.audioContext,this.audioDestination,this.chart);const sOpts=this.chart.options.sonification;this.timeline.setMasterVolume(Sonification_pick(sOpts&&sOpts.masterVolume,1))}if(events.afterUpdate){events.afterUpdate({chart:this.chart,timeline:this.timeline})}}ready(whenReady){if(!this.audioContext||!this.audioDestination||!this.chart.options||this.chart.options.sonification&&this.chart.options.sonification.enabled===false){return false}if(this.audioContext.state==="suspended"&&!this.forceReady){if(this.retryContextCounter++<20){setTimeout(()=>{if(this.audioContext&&this.audioContext.state==="suspended"){this.audioContext.resume().then(whenReady)}else{whenReady()}},5)}return false}this.retryContextCounter=0;return true}beforePlay(){const opts=this.chart.options.sonification,beforePlay=opts&&opts.events&&opts.events.beforePlay;if(beforePlay){beforePlay({chart:this.chart,timeline:this.timeline})}}initBoundaryInstrument(){if(!this.boundaryInstrument){this.boundaryInstrument=new Sonification_SynthPatch(this.audioContext,Sonification_merge(Sonification_InstrumentPresets.chop,{masterVolume:.3}));this.boundaryInstrument.startSilently();this.boundaryInstrument.connect(this.audioDestination)}}defaultBoundaryHit(){if(this.boundaryInstrument){this.boundaryInstrument.playFreqAtTime(.1,1,200);this.boundaryInstrument.playFreqAtTime(.2,1,200)}}}(function(Sonification){const composedClasses=[];function updateSonificationEnabled(){const sonification=this.sonification,sOptions=this.options&&this.options.sonification;if(sOptions&&sOptions.enabled){if(sonification){sonification.update()}else{this.sonification=new Sonification(this);this.sonification.update()}}else if(sonification){sonification.destroy();delete this.sonification}}function chartOnDestroy(){if(this&&this.sonification){this.sonification.destroy()}}function chartOnRender(){if(this.updateSonificationEnabled){this.updateSonificationEnabled()}}function chartOnUpdate(e){const newOptions=e.options.sonification;if(newOptions){Sonification_merge(true,this.options.sonification,newOptions);chartOnRender.call(this)}}function compose(ChartClass,SeriesClass,PointClass){if(composedClasses.indexOf(ChartClass)===-1){composedClasses.push(ChartClass);Sonification_extend(ChartClass.prototype,{updateSonificationEnabled:updateSonificationEnabled,sonify:function(onEnd){if(this.sonification){this.sonification.sonifyChart(false,onEnd)}},toggleSonify:function(reset=true,onEnd){if(!this.sonification){return}const timeline=this.sonification.timeline;if(Sonification_win.speechSynthesis){Sonification_win.speechSynthesis.cancel()}if(timeline&&this.sonification.isPlaying()){if(reset){this.sonification.cancel()}else{timeline.pause()}}else if(timeline&&timeline.isPaused){timeline.resume()}else{this.sonification.sonifyChart(reset,onEnd)}}});addEvent(ChartClass,"destroy",chartOnDestroy);addEvent(ChartClass,"render",chartOnRender);addEvent(ChartClass,"update",chartOnUpdate)}if(composedClasses.indexOf(SeriesClass)===-1){composedClasses.push(SeriesClass);SeriesClass.prototype.sonify=function(onEnd){if(this.chart.sonification){this.chart.sonification.sonifySeries(this,false,onEnd)}}}if(composedClasses.indexOf(PointClass)===-1){composedClasses.push(PointClass);PointClass.prototype.sonify=function(onEnd){if(this.series.chart.sonification){this.series.chart.sonification.sonifyPoint(this,onEnd)}}}const exportingOptions=getOptions().exporting;if(exportingOptions&&exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems){exportingOptions.buttons.contextButton.menuItems.push("separator","downloadMIDI","playAsSound")}}Sonification.compose=compose})(Sonification||(Sonification={}));Sonification_merge(true,defaultOptions,Sonification_Options);const Sonification_Sonification=Sonification;"";const Scales={minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],harmonicMinor:[0,2,3,5,7,8,11],phrygian:[0,1,3,5,7,8,11],major:[0,2,4,5,7,9,11],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],majorPentatonic:[0,2,4,7,9],minorPentatonic:[0,3,5,7,10]};const Sonification_Scales=Scales;"";const G=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();G.sonification={InstrumentPresets:Sonification_InstrumentPresets,Scales:Sonification_Scales,SynthPatch:Sonification_SynthPatch,SonificationInstrument:Sonification_SonificationInstrument,SonificationSpeaker:Sonification_SonificationSpeaker,SonificationTimeline:Sonification_SonificationTimeline,Sonification:Sonification_Sonification};Sonification_Sonification.compose(G.Chart,G.Series,G.Point);const sonification_src=highcharts_commonjs_highcharts_commonjs2_highcharts_root_Highcharts_default();__webpack_exports__=__webpack_exports__["default"];return __webpack_exports__})()});