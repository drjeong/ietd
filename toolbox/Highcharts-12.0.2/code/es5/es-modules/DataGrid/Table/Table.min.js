"use strict";import DGUtils from"../Utils.js";import Column from"./Column.js";import TableHeader from"./Header/TableHeader.js";import RowsVirtualizer from"./Actions/RowsVirtualizer.js";import ColumnsResizer from"./Actions/ColumnsResizer.js";import Globals from"../Globals.js";import Utils from"../../Core/Utilities.js";import CellEditing from"./Actions/CellEditing.js";var makeHTMLElement=DGUtils.makeHTMLElement;var getStyle=Utils.getStyle;var Table=function(){function Table(dataGrid,tableElement){var _a;var _this=this;var _b,_c,_d,_e,_f,_g,_h;this.columns=[];this.rows=[];this.onTBodyFocus=function(e){var _a,_b;e.preventDefault();(_b=(_a=_this.rows[_this.rowsVirtualizer.rowCursor-_this.rows[0].index])===null||_a===void 0?void 0:_a.cells[0])===null||_b===void 0?void 0:_b.htmlElement.focus()};this.onResize=function(){_this.reflow()};this.onScroll=function(){var _a;_this.rowsVirtualizer.scroll();(_a=_this.header)===null||_a===void 0?void 0:_a.scrollHorizontally(_this.tbodyElement.scrollLeft)};this.dataGrid=dataGrid;this.dataTable=this.dataGrid.presentationTable;var dgOptions=dataGrid.options;var customClassName=(_c=(_b=dgOptions===null||dgOptions===void 0?void 0:dgOptions.rendering)===null||_b===void 0?void 0:_b.table)===null||_c===void 0?void 0:_c.className;this.columnDistribution=(_e=(_d=dgOptions===null||dgOptions===void 0?void 0:dgOptions.rendering)===null||_d===void 0?void 0:_d.columns)===null||_e===void 0?void 0:_e.distribution;this.renderCaption();if((_g=(_f=dgOptions===null||dgOptions===void 0?void 0:dgOptions.rendering)===null||_f===void 0?void 0:_f.header)===null||_g===void 0?void 0:_g.enabled){this.theadElement=makeHTMLElement("thead",{},tableElement)}this.tbodyElement=makeHTMLElement("tbody",{},tableElement);this.rowsVirtualizer=new RowsVirtualizer(this);if((_h=dgOptions===null||dgOptions===void 0?void 0:dgOptions.columnDefaults)===null||_h===void 0?void 0:_h.resizing){this.columnsResizer=new ColumnsResizer(this)}this.cellEditing=new CellEditing;if(customClassName){(_a=tableElement.classList).add.apply(_a,customClassName.split(/\s+/g))}this.init();this.resizeObserver=new ResizeObserver(this.onResize);this.resizeObserver.observe(tableElement);this.tbodyElement.addEventListener("scroll",this.onScroll);this.tbodyElement.addEventListener("focus",this.onTBodyFocus)}Table.prototype.init=function(){var _a,_b,_c;this.loadColumns();if((_c=(_b=(_a=this.dataGrid.options)===null||_a===void 0?void 0:_a.rendering)===null||_b===void 0?void 0:_b.header)===null||_c===void 0?void 0:_c.enabled){this.header=new TableHeader(this);this.header.render()}this.rowsVirtualizer.initialRender()};Table.prototype.loadColumns=function(){var enabledColumns=this.dataGrid.enabledColumns;if(!enabledColumns){return}var columnId;for(var i=0,iEnd=enabledColumns.length;i<iEnd;++i){columnId=enabledColumns[i];this.columns.push(new Column(this,columnId,i))}};Table.prototype.loadPresentationData=function(){this.dataTable=this.dataGrid.presentationTable;for(var _i=0,_a=this.columns;_i<_a.length;_i++){var column=_a[_i];column.loadData()}this.rowsVirtualizer.rerender()};Table.prototype.reflow=function(){var _a,_b,_c,_d,_e;var tableEl=this.dataGrid.tableElement;var borderWidth=tableEl?(getStyle(tableEl,"border-top-width",true)||0)+(getStyle(tableEl,"border-bottom-width",true)||0):0;this.tbodyElement.style.height=this.tbodyElement.style.minHeight="".concat((((_a=this.dataGrid.container)===null||_a===void 0?void 0:_a.clientHeight)||0)-(((_b=this.theadElement)===null||_b===void 0?void 0:_b.offsetHeight)||0)-(((_c=this.captionElement)===null||_c===void 0?void 0:_c.offsetHeight)||0)-(((_d=this.dataGrid.credits)===null||_d===void 0?void 0:_d.getHeight())||0)-borderWidth,"px");if(this.columnDistribution==="fixed"){var rowsWidth=0;for(var i=0,iEnd=this.columns.length;i<iEnd;++i){rowsWidth+=this.columns[i].width}this.rowsWidth=rowsWidth}(_e=this.header)===null||_e===void 0?void 0:_e.reflow();this.rowsVirtualizer.reflowRows()};Table.prototype.scrollToRow=function(index){this.tbodyElement.scrollTop=index*this.rowsVirtualizer.defaultRowHeight};Table.prototype.getRatioFromWidth=function(width){return width/this.tbodyElement.clientWidth};Table.prototype.getWidthFromRatio=function(ratio){return this.tbodyElement.clientWidth*ratio};Table.prototype.renderCaption=function(){var _a;var _b;var captionOptions=(_b=this.dataGrid.options)===null||_b===void 0?void 0:_b.caption;if(!(captionOptions===null||captionOptions===void 0?void 0:captionOptions.text)){return}this.captionElement=makeHTMLElement("caption",{innerText:captionOptions.text,className:Globals.classNames.captionElement},this.dataGrid.tableElement);if(captionOptions.className){(_a=this.captionElement.classList).add.apply(_a,captionOptions.className.split(/\s+/g))}};Table.prototype.destroy=function(){var _a;this.tbodyElement.removeEventListener("focus",this.onTBodyFocus);this.tbodyElement.removeEventListener("scroll",this.onScroll);this.resizeObserver.disconnect();(_a=this.columnsResizer)===null||_a===void 0?void 0:_a.removeEventListeners();for(var i=0,iEnd=this.rows.length;i<iEnd;++i){this.rows[i].destroy()}};Table.prototype.getStateMeta=function(){return{scrollTop:this.tbodyElement.scrollTop,scrollLeft:this.tbodyElement.scrollLeft,columnDistribution:this.columnDistribution,columnWidths:this.columns.map(function(column){return column.width}),focusCursor:this.focusCursor}};Table.prototype.applyStateMeta=function(meta){var _a;this.tbodyElement.scrollTop=meta.scrollTop;this.tbodyElement.scrollLeft=meta.scrollLeft;if(this.columnDistribution===meta.columnDistribution&&this.columns.length===meta.columnWidths.length){var widths=meta.columnWidths;for(var i=0,iEnd=widths.length;i<iEnd;++i){this.columns[i].width=widths[i]}this.reflow();if(meta.focusCursor){var _b=meta.focusCursor,rowIndex=_b[0],columnIndex=_b[1];var row=this.rows[rowIndex-this.rows[0].index];(_a=row===null||row===void 0?void 0:row.cells[columnIndex])===null||_a===void 0?void 0:_a.htmlElement.focus()}}};Table.prototype.getColumn=function(id){var columns=this.dataGrid.enabledColumns;if(!columns){return}var columnIndex=columns.indexOf(id);if(columnIndex<0){return}return this.columns[columnIndex]};Table.prototype.getRow=function(id){return this.rows.find(function(row){return row.id===id})};return Table}();export default Table;