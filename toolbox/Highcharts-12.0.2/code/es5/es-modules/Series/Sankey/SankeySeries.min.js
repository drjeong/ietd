"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();import H from"../../Core/Globals.js";import NodesComposition from"../NodesComposition.js";import SankeyPoint from"./SankeyPoint.js";import SankeySeriesDefaults from"./SankeySeriesDefaults.js";import SeriesRegistry from"../../Core/Series/SeriesRegistry.js";import SankeyColumnComposition from"./SankeyColumnComposition.js";var _a=SeriesRegistry.seriesTypes,ColumnSeries=_a.column,LineSeries=_a.line;import Color from"../../Core/Color/Color.js";var color=Color.parse;import TU from"../TreeUtilities.js";var getLevelOptions=TU.getLevelOptions,getNodeWidth=TU.getNodeWidth;import U from"../../Core/Utilities.js";var clamp=U.clamp,crisp=U.crisp,extend=U.extend,isObject=U.isObject,merge=U.merge,pick=U.pick,relativeLength=U.relativeLength,stableSort=U.stableSort;import SVGElement from"../../Core/Renderer/SVG/SVGElement.js";import TextPath from"../../Extensions/TextPath.js";TextPath.compose(SVGElement);var SankeySeries=function(_super){__extends(SankeySeries,_super);function SankeySeries(){return _super!==null&&_super.apply(this,arguments)||this}SankeySeries.getDLOptions=function(params){var optionsPoint=isObject(params.optionsPoint)?params.optionsPoint.dataLabels:{},optionsLevel=isObject(params.level)?params.level.dataLabels:{},options=merge({style:{}},optionsLevel,optionsPoint);return options};SankeySeries.prototype.createNodeColumns=function(){var columns=[];for(var _i=0,_a=this.nodes;_i<_a.length;_i++){var node=_a[_i];node.setNodeColumn();if(!columns[node.column]){columns[node.column]=SankeyColumnComposition.compose([],this)}columns[node.column].push(node)}for(var i=0;i<columns.length;i++){if(typeof columns[i]==="undefined"){columns[i]=SankeyColumnComposition.compose([],this)}}return columns};SankeySeries.prototype.order=function(node,level){var series=this;if(typeof node.level==="undefined"){node.level=level;for(var _i=0,_a=node.linksFrom;_i<_a.length;_i++){var link=_a[_i];if(link.toNode){series.order(link.toNode,level+1)}}}};SankeySeries.prototype.generatePoints=function(){NodesComposition.generatePoints.apply(this,arguments);if(this.orderNodes){for(var _i=0,_a=this.nodes;_i<_a.length;_i++){var node=_a[_i];if(node.linksTo.length===0){this.order(node,0)}}stableSort(this.nodes,function(a,b){return a.level-b.level})}};SankeySeries.prototype.getNodePadding=function(){var nodePadding=this.options.nodePadding||0;if(this.nodeColumns){var maxLength=this.nodeColumns.reduce(function(acc,col){return Math.max(acc,col.length)},0);if(maxLength*nodePadding>this.chart.plotSizeY){nodePadding=this.chart.plotSizeY/maxLength}}return nodePadding};SankeySeries.prototype.hasData=function(){return!!this.dataTable.rowCount};SankeySeries.prototype.pointAttribs=function(point,state){if(!point){return{}}var series=this,level=point.isNode?point.level:point.fromNode.level,levelOptions=series.mapOptionsToLevel[level||0]||{},options=point.options,stateOptions=levelOptions.states&&levelOptions.states[state||""]||{},values=["colorByPoint","borderColor","borderWidth","linkOpacity","opacity"].reduce(function(obj,key){obj[key]=pick(stateOptions[key],options[key],levelOptions[key],series.options[key]);return obj},{}),color=pick(stateOptions.color,options.color,values.colorByPoint?point.color:levelOptions.color);if(point.isNode){return{fill:color,stroke:values.borderColor,"stroke-width":values.borderWidth,opacity:values.opacity}}return{fill:Color.parse(color).setOpacity(values.linkOpacity).get()}};SankeySeries.prototype.drawTracker=function(){ColumnSeries.prototype.drawTracker.call(this,this.points);ColumnSeries.prototype.drawTracker.call(this,this.nodes)};SankeySeries.prototype.drawPoints=function(){ColumnSeries.prototype.drawPoints.call(this,this.points);ColumnSeries.prototype.drawPoints.call(this,this.nodes)};SankeySeries.prototype.drawDataLabels=function(){ColumnSeries.prototype.drawDataLabels.call(this,this.points);ColumnSeries.prototype.drawDataLabels.call(this,this.nodes)};SankeySeries.prototype.translate=function(){this.generatePoints();this.nodeColumns=this.createNodeColumns();var series=this,chart=this.chart,options=this.options,nodeColumns=this.nodeColumns,columnCount=nodeColumns.length;this.nodeWidth=getNodeWidth(this,columnCount);this.nodePadding=this.getNodePadding();this.translationFactor=nodeColumns.reduce(function(translationFactor,column){return Math.min(translationFactor,column.sankeyColumn.getTranslationFactor(series))},Infinity);this.colDistance=(chart.plotSizeX-this.nodeWidth-options.borderWidth)/Math.max(1,nodeColumns.length-1);series.mapOptionsToLevel=getLevelOptions({from:1,levels:options.levels,to:nodeColumns.length-1,defaults:{borderColor:options.borderColor,borderRadius:options.borderRadius,borderWidth:options.borderWidth,color:series.color,colorByPoint:options.colorByPoint,levelIsConstant:true,linkColor:options.linkColor,linkLineWidth:options.linkLineWidth,linkOpacity:options.linkOpacity,states:options.states}});for(var _i=0,nodeColumns_1=nodeColumns;_i<nodeColumns_1.length;_i++){var column=nodeColumns_1[_i];for(var _a=0,column_1=column;_a<column_1.length;_a++){var node=column_1[_a];series.translateNode(node,column)}}for(var _b=0,_c=this.nodes;_b<_c.length;_b++){var node=_c[_b];for(var _d=0,_e=node.linksFrom;_d<_e.length;_d++){var linkPoint=_e[_d];if((linkPoint.weight||linkPoint.isNull)&&linkPoint.to){series.translateLink(linkPoint);linkPoint.allowShadow=false}}}};SankeySeries.prototype.translateLink=function(point){var getY=function(node,fromOrTo){var linkTop=node.offset(point,fromOrTo)*translationFactor;var y=Math.min(node.nodeY+linkTop,node.nodeY+(node.shapeArgs&&node.shapeArgs.height||0)-linkHeight);return y};var fromNode=point.fromNode,toNode=point.toNode,chart=this.chart,inverted=chart.inverted,translationFactor=this.translationFactor,options=this.options,linkColorMode=pick(point.linkColorMode,options.linkColorMode),curvy=(chart.inverted?-this.colDistance:this.colDistance)*options.curveFactor,nodeLeft=fromNode.nodeX,right=toNode.nodeX,outgoing=point.outgoing;var linkHeight=Math.max(point.weight*translationFactor,this.options.minLinkWidth),fromY=getY(fromNode,"linksFrom"),toY=getY(toNode,"linksTo"),nodeW=this.nodeWidth,straight=right>nodeLeft+nodeW;if(chart.inverted){fromY=chart.plotSizeY-fromY;toY=(chart.plotSizeY||0)-toY;nodeW=-nodeW;linkHeight=-linkHeight;straight=nodeLeft>right}point.shapeType="path";point.linkBase=[fromY,fromY+linkHeight,toY,toY+linkHeight];if(straight&&typeof toY==="number"){point.shapeArgs={d:[["M",nodeLeft+nodeW,fromY],["C",nodeLeft+nodeW+curvy,fromY,right-curvy,toY,right,toY],["L",right+(outgoing?nodeW:0),toY+linkHeight/2],["L",right,toY+linkHeight],["C",right-curvy,toY+linkHeight,nodeLeft+nodeW+curvy,fromY+linkHeight,nodeLeft+nodeW,fromY+linkHeight],["Z"]]}}else if(typeof toY==="number"){var bend=20,vDist=chart.plotHeight-fromY-linkHeight,x1=right-bend-linkHeight,x2=right-bend,x3=right,x4=nodeLeft+nodeW,x5=x4+bend,x6=x5+linkHeight,fy1=fromY,fy2=fromY+linkHeight,fy3=fy2+bend,y4=fy3+vDist,y5=y4+bend,y6=y5+linkHeight,ty1=toY,ty2=ty1+linkHeight,ty3=ty2+bend,cfy1=fy2-linkHeight*.7,cy2=y5+linkHeight*.7,cty1=ty2-linkHeight*.7,cx1=x3-linkHeight*.7,cx2=x4+linkHeight*.7;point.shapeArgs={d:[["M",x4,fy1],["C",cx2,fy1,x6,cfy1,x6,fy3],["L",x6,y4],["C",x6,cy2,cx2,y6,x4,y6],["L",x3,y6],["C",cx1,y6,x1,cy2,x1,y4],["L",x1,ty3],["C",x1,cty1,cx1,ty1,x3,ty1],["L",x3,ty2],["C",x2,ty2,x2,ty2,x2,ty3],["L",x2,y4],["C",x2,y5,x2,y5,x3,y5],["L",x4,y5],["C",x5,y5,x5,y5,x5,y4],["L",x5,fy3],["C",x5,fy2,x5,fy2,x4,fy2],["Z"]]}}point.dlBox={x:nodeLeft+(right-nodeLeft+nodeW)/2,y:fromY+(toY-fromY)/2,height:linkHeight,width:0};point.tooltipPos=chart.inverted?[chart.plotSizeY-point.dlBox.y-linkHeight/2,chart.plotSizeX-point.dlBox.x]:[point.dlBox.x,point.dlBox.y+linkHeight/2];point.y=point.plotY=1;point.x=point.plotX=1;if(!point.options.color){if(linkColorMode==="from"){point.color=fromNode.color}else if(linkColorMode==="to"){point.color=toNode.color}else if(linkColorMode==="gradient"){var fromColor=color(fromNode.color).get(),toColor=color(toNode.color).get();point.color={linearGradient:{x1:1,x2:0,y1:0,y2:0},stops:[[0,inverted?fromColor:toColor],[1,inverted?toColor:fromColor]]}}}};SankeySeries.prototype.translateNode=function(node,column){var translationFactor=this.translationFactor,chart=this.chart,options=this.options,borderRadius=options.borderRadius,_a=options.borderWidth,borderWidth=_a===void 0?0:_a,sum=node.getSum(),nodeHeight=Math.max(Math.round(sum*translationFactor),this.options.minLinkWidth),nodeWidth=Math.round(this.nodeWidth),nodeOffset=column.sankeyColumn.offset(node,translationFactor),fromNodeTop=crisp(pick(nodeOffset.absoluteTop,column.sankeyColumn.top(translationFactor)+nodeOffset.relativeTop),borderWidth),left=crisp(this.colDistance*node.column+borderWidth/2,borderWidth)+relativeLength(node.options[chart.inverted?"offsetVertical":"offsetHorizontal"]||0,nodeWidth),nodeLeft=chart.inverted?chart.plotSizeX-left:left;node.sum=sum;if(sum){node.shapeType="roundedRect";node.nodeX=nodeLeft;node.nodeY=fromNodeTop;var x=nodeLeft,y=fromNodeTop,width=node.options.width||options.width||nodeWidth,height=node.options.height||options.height||nodeHeight;var r=clamp(relativeLength(typeof borderRadius==="object"?borderRadius.radius:borderRadius||0,width),0,nodeHeight/2);if(chart.inverted){x=nodeLeft-nodeWidth;y=chart.plotSizeY-fromNodeTop-nodeHeight;width=node.options.height||options.height||nodeWidth;height=node.options.width||options.width||nodeHeight}node.dlOptions=SankeySeries.getDLOptions({level:this.mapOptionsToLevel[node.level],optionsPoint:node.options});node.plotX=1;node.plotY=1;node.tooltipPos=chart.inverted?[chart.plotSizeY-y-height/2,chart.plotSizeX-x-width/2]:[x+width/2,y+height/2];node.shapeArgs={x:x,y:y,width:width,height:height,r:r,display:node.hasShape()?"":"none"}}else{node.dlOptions={enabled:false}}};SankeySeries.defaultOptions=merge(ColumnSeries.defaultOptions,SankeySeriesDefaults);return SankeySeries}(ColumnSeries);NodesComposition.compose(SankeyPoint,SankeySeries);extend(SankeySeries.prototype,{animate:LineSeries.prototype.animate,createNode:NodesComposition.createNode,forceDL:true,invertible:true,isCartesian:false,orderNodes:true,noSharedTooltip:true,pointArrayMap:["from","to","weight"],pointClass:SankeyPoint,searchPoint:H.noop});SeriesRegistry.registerSeriesType("sankey",SankeySeries);export default SankeySeries;"";