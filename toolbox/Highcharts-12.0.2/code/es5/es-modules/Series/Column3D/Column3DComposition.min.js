"use strict";import H from"../../Core/Globals.js";var composed=H.composed;import Math3D from"../../Core/Math3D.js";var perspective=Math3D.perspective;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,pick=U.pick,pushUnique=U.pushUnique,wrap=U.wrap;function columnSeriesTranslate3dShapes(){var series=this,chart=series.chart,seriesOptions=series.options,depth=seriesOptions.depth,stack=seriesOptions.stacking?seriesOptions.stack||0:series.index;var z=stack*(depth+(seriesOptions.groupZPadding||1)),borderCrisp=series.borderWidth%2?.5:0,point2dPos;if(chart.inverted&&!series.yAxis.reversed){borderCrisp*=-1}if(seriesOptions.grouping!==false){z=0}z+=seriesOptions.groupZPadding||1;for(var _i=0,_a=series.points;_i<_a.length;_i++){var point=_a[_i];point.outside3dPlot=null;if(point.y!==null){var shapeArgs=extend({x:0,y:0,width:0,height:0},point.shapeArgs||{}),dimensions=[["x","width"],["y","height"]],tooltipPos=point.tooltipPos;var borderlessBase=void 0;for(var _b=0,dimensions_1=dimensions;_b<dimensions_1.length;_b++){var d=dimensions_1[_b];borderlessBase=shapeArgs[d[0]]-borderCrisp;if(borderlessBase<0){shapeArgs[d[1]]+=shapeArgs[d[0]]+borderCrisp;shapeArgs[d[0]]=-borderCrisp;borderlessBase=0}if(borderlessBase+shapeArgs[d[1]]>series[d[0]+"Axis"].len&&shapeArgs[d[1]]!==0){shapeArgs[d[1]]=series[d[0]+"Axis"].len-shapeArgs[d[0]]}if(shapeArgs[d[1]]!==0&&(shapeArgs[d[0]]>=series[d[0]+"Axis"].len||shapeArgs[d[0]]+shapeArgs[d[1]]<=borderCrisp)){for(var key in shapeArgs){shapeArgs[key]=key==="y"?-9999:0}point.outside3dPlot=true}}if(point.shapeType==="roundedRect"){point.shapeType="cuboid"}point.shapeArgs=extend(shapeArgs,{z:z,depth:depth,insidePlotArea:true});point2dPos={x:shapeArgs.x+shapeArgs.width/2,y:shapeArgs.y,z:z+depth/2};if(chart.inverted){point2dPos.x=shapeArgs.height;point2dPos.y=point.clientX||0}point.axisXpos=point2dPos.x;point.axisYpos=point2dPos.y;point.axisZpos=point2dPos.z;point.plot3d=perspective([point2dPos],chart,true,false)[0];if(tooltipPos){var translatedTTPos=perspective([{x:tooltipPos[0],y:tooltipPos[1],z:z+depth/2}],chart,true,false)[0];point.tooltipPos=[translatedTTPos.x,translatedTTPos.y]}}}series.z=z}function compose(SeriesClass,StackItemClass){if(pushUnique(composed,"Column3D")){var seriesProto=SeriesClass.prototype,stackItemProto=StackItemClass.prototype,_a=SeriesClass.types,ColumnSeriesClass=_a.column,ColumnRangeSeriesClass=_a.columnRange;wrap(seriesProto,"alignDataLabel",wrapSeriesAlignDataLabel);wrap(seriesProto,"justifyDataLabel",wrapSeriesJustifyDataLabel);wrap(stackItemProto,"getStackBox",wrapStackItemGetStackBox);if(ColumnSeriesClass){var columnSeriesProto=ColumnSeriesClass.prototype,columnPointProto=columnSeriesProto.pointClass.prototype;columnSeriesProto.translate3dPoints=function(){return void 0};columnSeriesProto.translate3dShapes=columnSeriesTranslate3dShapes;addEvent(columnSeriesProto,"afterInit",onColumnSeriesAfterInit);wrap(columnPointProto,"hasNewShapeType",wrapColumnPointHasNewShapeType);wrap(columnSeriesProto,"animate",wrapColumnSeriesAnimate);wrap(columnSeriesProto,"plotGroup",wrapColumnSeriesPlotGroup);wrap(columnSeriesProto,"pointAttribs",wrapColumnSeriesPointAttribs);wrap(columnSeriesProto,"setState",wrapColumnSeriesSetState);wrap(columnSeriesProto,"setVisible",wrapColumnSeriesSetVisible);wrap(columnSeriesProto,"translate",wrapColumnSeriesTranslate)}if(ColumnRangeSeriesClass){var columnRangeSeriesProto=ColumnRangeSeriesClass.prototype,columnRangePointProto=columnRangeSeriesProto.pointClass.prototype;wrap(columnRangePointProto,"hasNewShapeType",wrapColumnPointHasNewShapeType);wrap(columnRangeSeriesProto,"plotGroup",wrapColumnSeriesPlotGroup);wrap(columnRangeSeriesProto,"pointAttribs",wrapColumnSeriesPointAttribs);wrap(columnRangeSeriesProto,"setState",wrapColumnSeriesSetState);wrap(columnRangeSeriesProto,"setVisible",wrapColumnSeriesSetVisible)}}}function retrieveStacks(chart,stacking){var series=chart.series,stacks={totalStacks:0};var stackNumber,i=1;series.forEach(function(s){stackNumber=pick(s.options.stack,stacking?0:series.length-1-s.index);if(!stacks[stackNumber]){stacks[stackNumber]={series:[s],position:i};i++}else{stacks[stackNumber].series.push(s)}});stacks.totalStacks=i+1;return stacks}function onColumnSeriesAfterInit(){if(this.chart.is3d()){var series=this,seriesOptions=series.options,grouping=seriesOptions.grouping,stacking=seriesOptions.stacking,reversedStacks=series.yAxis.options.reversedStacks;var z=0;if(!(typeof grouping!=="undefined"&&!grouping)){var stacks=retrieveStacks(this.chart,stacking),stack=seriesOptions.stack||0;var i=void 0;for(i=0;i<stacks[stack].series.length;i++){if(stacks[stack].series[i]===this){break}}z=10*(stacks.totalStacks-stacks[stack].position)+(reversedStacks?i:-i);if(!this.xAxis.reversed){z=stacks.totalStacks*10-z}}seriesOptions.depth=seriesOptions.depth||25;series.z=series.z||0;seriesOptions.zIndex=z}}function wrapColumnPointHasNewShapeType(proceed){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}return this.series.chart.is3d()?this.graphic&&this.graphic.element.nodeName!=="g":proceed.apply(this,args)}function wrapColumnSeriesAnimate(proceed){if(!this.chart.is3d()){proceed.apply(this,[].slice.call(arguments,1))}else{var args=arguments,init=args[1],yAxis=this.yAxis,series=this,reversed=this.yAxis.reversed;if(init){for(var _i=0,_a=series.points;_i<_a.length;_i++){var point=_a[_i];if(point.y!==null){point.height=point.shapeArgs.height;point.shapey=point.shapeArgs.y;point.shapeArgs.height=1;if(!reversed){if(point.stackY){point.shapeArgs.y=point.plotY+yAxis.translate(point.stackY)}else{point.shapeArgs.y=point.plotY+(point.negative?-point.height:point.height)}}}}}else{for(var _b=0,_c=series.points;_b<_c.length;_b++){var point=_c[_b];if(point.y!==null){point.shapeArgs.height=point.height;point.shapeArgs.y=point.shapey;if(point.graphic){point.graphic[point.outside3dPlot?"attr":"animate"](point.shapeArgs,series.options.animation)}}}this.drawDataLabels()}}}function wrapColumnSeriesPlotGroup(proceed,prop,_name,_visibility,_zIndex,parent){if(prop!=="dataLabelsGroup"&&prop!=="markerGroup"){if(this.chart.is3d()){if(this[prop]){delete this[prop]}if(parent){if(!this.chart.columnGroup){this.chart.columnGroup=this.chart.renderer.g("columnGroup").add(parent)}this[prop]=this.chart.columnGroup;this.chart.columnGroup.attr(this.getPlotBox());this[prop].survive=true;if(prop==="group"){arguments[3]="visible"}}}}return proceed.apply(this,Array.prototype.slice.call(arguments,1))}function wrapColumnSeriesPointAttribs(proceed){var attr=proceed.apply(this,[].slice.call(arguments,1));if(this.chart.is3d&&this.chart.is3d()){attr.stroke=this.options.edgeColor||attr.fill;attr["stroke-width"]=pick(this.options.edgeWidth,1)}return attr}function wrapColumnSeriesSetState(proceed,state,inherit){var is3d=this.chart.is3d&&this.chart.is3d();if(is3d){this.options.inactiveOtherPoints=true}proceed.call(this,state,inherit);if(is3d){this.options.inactiveOtherPoints=false}}function wrapColumnSeriesSetVisible(proceed,vis){var series=this;if(series.chart.is3d()){for(var _i=0,_a=series.points;_i<_a.length;_i++){var point=_a[_i];point.visible=point.options.visible=vis=typeof vis==="undefined"?!pick(series.visible,point.visible):vis;series.options.data[series.data.indexOf(point)]=point.options;if(point.graphic){point.graphic.attr({visibility:vis?"visible":"hidden"})}}}proceed.apply(this,Array.prototype.slice.call(arguments,1))}function wrapColumnSeriesTranslate(proceed){proceed.apply(this,[].slice.call(arguments,1));if(this.chart.is3d()){this.translate3dShapes()}}function wrapSeriesAlignDataLabel(proceed,point,_dataLabel,options,alignTo){var chart=this.chart;options.outside3dPlot=point.outside3dPlot;if(chart.is3d()&&this.is("column")){var series=this,seriesOptions=series.options,inside=pick(options.inside,!!series.options.stacking),options3d=chart.options.chart.options3d,xOffset=point.pointWidth/2||0;var dLPosition={x:alignTo.x+xOffset,y:alignTo.y,z:series.z+seriesOptions.depth/2};if(chart.inverted){if(inside){alignTo.width=0;dLPosition.x+=point.shapeArgs.height/2}if(options3d.alpha>=90&&options3d.alpha<=270){dLPosition.y+=point.shapeArgs.width}}dLPosition=perspective([dLPosition],chart,true,false)[0];alignTo.x=dLPosition.x-xOffset;alignTo.y=point.outside3dPlot?-9e9:dLPosition.y}proceed.apply(this,[].slice.call(arguments,1))}function wrapSeriesJustifyDataLabel(proceed){return!arguments[2].outside3dPlot?proceed.apply(this,[].slice.call(arguments,1)):false}function wrapStackItemGetStackBox(proceed,stackBoxProps){var stackBox=proceed.apply(this,[].slice.call(arguments,1));var stackItem=this,chart=this.axis.chart,xWidth=stackBoxProps.width;if(chart.is3d()&&stackItem.base){var baseSeriesInd=+stackItem.base.split(",")[0];var columnSeries=chart.series[baseSeriesInd];var options3d=chart.options.chart.options3d;if(columnSeries&&columnSeries.type==="column"){var dLPosition={x:stackBox.x+(chart.inverted?stackBox.height:xWidth/2),y:stackBox.y,z:columnSeries.options.depth/2};if(chart.inverted){stackBox.width=0;if(options3d.alpha>=90&&options3d.alpha<=270){dLPosition.y+=xWidth}}dLPosition=perspective([dLPosition],chart,true,false)[0];stackBox.x=dLPosition.x-xWidth/2;stackBox.y=dLPosition.y}}return stackBox}var Column3DComposition={compose:compose};export default Column3DComposition;"";