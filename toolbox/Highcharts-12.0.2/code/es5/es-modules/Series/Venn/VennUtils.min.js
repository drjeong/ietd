"use strict";var __assign=this&&this.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};import CU from"../../Core/Geometry/CircleUtilities.js";var getAreaOfCircle=CU.getAreaOfCircle,getCircleCircleIntersection=CU.getCircleCircleIntersection,getOverlapBetweenCirclesByDistance=CU.getOverlapBetweenCircles,isPointInsideAllCircles=CU.isPointInsideAllCircles,isPointInsideCircle=CU.isPointInsideCircle,isPointOutsideAllCircles=CU.isPointOutsideAllCircles;import GU from"../../Core/Geometry/GeometryUtilities.js";var getDistanceBetweenPoints=GU.getDistanceBetweenPoints;import U from"../../Core/Utilities.js";var extend=U.extend,isArray=U.isArray,isNumber=U.isNumber,isObject=U.isObject,isString=U.isString;function addOverlapToSets(relations){var mapOfIdToProps={};relations.filter(function(relation){return relation.sets.length===2}).forEach(function(relation){relation.sets.forEach(function(set,i,arr){var _a;if(!isObject(mapOfIdToProps[set])){mapOfIdToProps[set]={totalOverlap:0,overlapping:{}}}mapOfIdToProps[set]={totalOverlap:(mapOfIdToProps[set].totalOverlap||0)+relation.value,overlapping:__assign(__assign({},mapOfIdToProps[set].overlapping||{}),(_a={},_a[arr[1-i]]=relation.value,_a))}})});relations.filter(isSet).forEach(function(set){var properties=mapOfIdToProps[set.sets[0]];extend(set,properties)});return relations}function bisect(f,a,b,tolerance,maxIterations){var fA=f(a),fB=f(b),nMax=maxIterations||100,tol=tolerance||1e-10;var delta=b-a,x,fX,n=1;if(a>=b){throw new Error("a must be smaller than b.")}else if(fA*fB>0){throw new Error("f(a) and f(b) must have opposite signs.")}if(fA===0){x=a}else if(fB===0){x=b}else{while(n++<=nMax&&fX!==0&&delta>tol){delta=(b-a)/2;x=a+delta;fX=f(x);if(fA*fX>0){a=x}else{b=x}}}return x}function getCentroid(simplex){var arr=simplex.slice(0,-1),length=arr.length,result=[],sum=function(data,point){data.sum+=point[data.i];return data};for(var i=0;i<length;i++){result[i]=arr.reduce(sum,{sum:0,i:i}).sum/length}return result}function getDistanceBetweenCirclesByOverlap(r1,r2,overlap){var maxDistance=r1+r2;var distance;if(overlap<=0){distance=maxDistance}else if(getAreaOfCircle(r1<r2?r1:r2)<=overlap){distance=0}else{distance=bisect(function(x){var actualOverlap=getOverlapBetweenCirclesByDistance(r1,r2,x);return overlap-actualOverlap},0,maxDistance)}return distance}function getLabelWidth(pos,internal,external){var radius=internal.reduce(function(min,circle){return Math.min(circle.r,min)},Infinity),filteredExternals=external.filter(function(circle){return!isPointInsideCircle(pos,circle)});var findDistance=function(maxDistance,direction){return bisect(function(x){var testPos={x:pos.x+direction*x,y:pos.y},isValid=isPointInsideAllCircles(testPos,internal)&&isPointOutsideAllCircles(testPos,filteredExternals);return-(maxDistance-x)+(isValid?0:Number.MAX_VALUE)},0,maxDistance)};return Math.min(findDistance(radius,-1),findDistance(radius,1))*2}function getMarginFromCircles(point,internal,external){var margin=internal.reduce(function(margin,circle){var m=circle.r-getDistanceBetweenPoints(point,circle);return m<=margin?m:margin},Number.MAX_VALUE);margin=external.reduce(function(margin,circle){var m=getDistanceBetweenPoints(point,circle)-circle.r;return m<=margin?m:margin},margin);return margin}function getOverlapBetweenCircles(circles){var overlap=0;if(circles.length===2){var circle1=circles[0];var circle2=circles[1];overlap=getOverlapBetweenCirclesByDistance(circle1.r,circle2.r,getDistanceBetweenPoints(circle1,circle2))}return overlap}function isSet(x){return isArray(x.sets)&&x.sets.length===1}function isValidRelation(x){var map={};return isObject(x)&&(isNumber(x.value)&&x.value>-1)&&(isArray(x.sets)&&x.sets.length>0)&&!x.sets.some(function(set){var invalid=false;if(!map[set]&&isString(set)){map[set]=true}else{invalid=true}return invalid})}function isValidSet(x){return isValidRelation(x)&&isSet(x)&&x.value>0}function layoutGreedyVenn(relations){var positionedSets=[],mapOfIdToCircles={};relations.filter(function(relation){return relation.sets.length===1}).forEach(function(relation){mapOfIdToCircles[relation.sets[0]]=relation.circle={x:Number.MAX_VALUE,y:Number.MAX_VALUE,r:Math.sqrt(relation.value/Math.PI)}});var positionSet=function(set,coordinates){var circle=set.circle;if(circle){circle.x=coordinates.x;circle.y=coordinates.y}positionedSets.push(set)};addOverlapToSets(relations);var sortedByOverlap=relations.filter(isSet).sort(sortByTotalOverlap);positionSet(sortedByOverlap.shift(),{x:0,y:0});var relationsWithTwoSets=relations.filter(function(x){return x.sets.length===2});var _loop_1=function(set){var circle=set.circle;if(!circle){return"continue"}var radius=circle.r,overlapping=set.overlapping;var bestPosition=positionedSets.reduce(function(best,positionedSet,i){var positionedCircle=positionedSet.circle;if(!positionedCircle||!overlapping){return best}var overlap=overlapping[positionedSet.sets[0]];var distance=getDistanceBetweenCirclesByOverlap(radius,positionedCircle.r,overlap);var possibleCoordinates=[{x:positionedCircle.x+distance,y:positionedCircle.y},{x:positionedCircle.x-distance,y:positionedCircle.y},{x:positionedCircle.x,y:positionedCircle.y+distance},{x:positionedCircle.x,y:positionedCircle.y-distance}];for(var _i=0,_a=positionedSets.slice(i+1);_i<_a.length;_i++){var positionedSet2=_a[_i];var positionedCircle2=positionedSet2.circle,overlap2=overlapping[positionedSet2.sets[0]];if(!positionedCircle2){continue}var distance2=getDistanceBetweenCirclesByOverlap(radius,positionedCircle2.r,overlap2);possibleCoordinates=possibleCoordinates.concat(getCircleCircleIntersection({x:positionedCircle.x,y:positionedCircle.y,r:distance},{x:positionedCircle2.x,y:positionedCircle2.y,r:distance2}))}for(var _b=0,possibleCoordinates_1=possibleCoordinates;_b<possibleCoordinates_1.length;_b++){var coordinates=possibleCoordinates_1[_b];circle.x=coordinates.x;circle.y=coordinates.y;var currentLoss=loss(mapOfIdToCircles,relationsWithTwoSets);if(currentLoss<best.loss){best.loss=currentLoss;best.coordinates=coordinates}}return best},{loss:Number.MAX_VALUE,coordinates:void 0});positionSet(set,bestPosition.coordinates)};for(var _i=0,sortedByOverlap_1=sortedByOverlap;_i<sortedByOverlap_1.length;_i++){var set=sortedByOverlap_1[_i];_loop_1(set)}return mapOfIdToCircles}function loss(mapOfIdToCircle,relations){var precision=1e11;return relations.reduce(function(totalLoss,relation){var loss=0;if(relation.sets.length>1){var wantedOverlap=relation.value;var actualOverlap=getOverlapBetweenCircles(relation.sets.map(function(set){return mapOfIdToCircle[set]}));var diff=wantedOverlap-actualOverlap;loss=Math.round(diff*diff*precision)/precision}return totalLoss+loss},0)}function nelderMead(fn,initial){var maxIterations=100,sortByFx=function(a,b){return a.fx-b.fx},pRef=1,pExp=2,pCon=-.5,pOCon=pCon*pRef,pShrink=.5;var weightedSum=function(weight1,v1,weight2,v2){return v1.map(function(x,i){return weight1*x+weight2*v2[i]})};var getSimplex=function(initial){var n=initial.length,simplex=new Array(n+1);simplex[0]=initial;simplex[0].fx=fn(initial);for(var i=0;i<n;++i){var point=initial.slice();point[i]=point[i]?point[i]*1.05:.001;point.fx=fn(point);simplex[i+1]=point}return simplex};var updateSimplex=function(simplex,point){point.fx=fn(point);simplex[simplex.length-1]=point;return simplex};var shrinkSimplex=function(simplex){var best=simplex[0];return simplex.map(function(point){var p=weightedSum(1-pShrink,best,pShrink,point);p.fx=fn(p);return p})};var getPoint=function(centroid,worst,a,b){var point=weightedSum(a,centroid,b,worst);point.fx=fn(point);return point};var simplex=getSimplex(initial);for(var i=0;i<maxIterations;i++){simplex.sort(sortByFx);var worst=simplex[simplex.length-1];var centroid=getCentroid(simplex);var reflected=getPoint(centroid,worst,1+pRef,-pRef);if(reflected.fx<simplex[0].fx){var expanded=getPoint(centroid,worst,1+pExp,-pExp);simplex=updateSimplex(simplex,expanded.fx<reflected.fx?expanded:reflected)}else if(reflected.fx>=simplex[simplex.length-2].fx){var contracted=void 0;if(reflected.fx>worst.fx){contracted=getPoint(centroid,worst,1+pCon,-pCon);if(contracted.fx<worst.fx){simplex=updateSimplex(simplex,contracted)}else{simplex=shrinkSimplex(simplex)}}else{contracted=getPoint(centroid,worst,1-pOCon,pOCon);if(contracted.fx<reflected.fx){simplex=updateSimplex(simplex,contracted)}else{simplex=shrinkSimplex(simplex)}}}else{simplex=updateSimplex(simplex,reflected)}}return simplex[0]}function processVennData(data,splitter){var d=isArray(data)?data:[];var validSets=d.reduce(function(arr,x){if(x.sets&&isValidSet(x)&&arr.indexOf(x.sets[0])===-1){arr.push(x.sets[0])}return arr},[]).sort();var mapOfIdToRelation=d.reduce(function(mapOfIdToRelation,relation){if(relation.sets&&isValidRelation(relation)&&!relation.sets.some(function(set){return validSets.indexOf(set)===-1})){mapOfIdToRelation[relation.sets.sort().join(splitter)]={sets:relation.sets,value:relation.value||0}}return mapOfIdToRelation},{});validSets.reduce(function(combinations,set,i,arr){var remaining=arr.slice(i+1);remaining.forEach(function(set2){combinations.push(set+splitter+set2)});return combinations},[]).forEach(function(combination){if(!mapOfIdToRelation[combination]){var obj={sets:combination.split(splitter),value:0};mapOfIdToRelation[combination]=obj}});return Object.keys(mapOfIdToRelation).map(function(id){return mapOfIdToRelation[id]})}function sortByTotalOverlap(a,b){if(typeof b.totalOverlap!=="undefined"&&typeof a.totalOverlap!=="undefined"){return b.totalOverlap-a.totalOverlap}return NaN}var VennUtils={geometry:GU,geometryCircles:CU,addOverlapToSets:addOverlapToSets,getCentroid:getCentroid,getDistanceBetweenCirclesByOverlap:getDistanceBetweenCirclesByOverlap,getLabelWidth:getLabelWidth,getMarginFromCircles:getMarginFromCircles,isSet:isSet,layoutGreedyVenn:layoutGreedyVenn,loss:loss,nelderMead:nelderMead,processVennData:processVennData,sortByTotalOverlap:sortByTotalOverlap};export default VennUtils;