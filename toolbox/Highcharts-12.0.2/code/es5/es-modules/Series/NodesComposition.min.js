"use strict";import SeriesRegistry from"../Core/Series/SeriesRegistry.js";var _a=SeriesRegistry.series,seriesProto=_a.prototype,pointProto=_a.prototype.pointClass.prototype;import U from"../Core/Utilities.js";var defined=U.defined,extend=U.extend,find=U.find,merge=U.merge,pick=U.pick;var NodesComposition;(function(NodesComposition){function compose(PointClass,SeriesClass){var pointProto=PointClass.prototype,seriesProto=SeriesClass.prototype;pointProto.setNodeState=setNodeState;pointProto.setState=setNodeState;pointProto.update=updateNode;seriesProto.destroy=destroy;seriesProto.setData=setData;return SeriesClass}NodesComposition.compose=compose;function createNode(id){var PointClass=this.pointClass,findById=function(nodes,id){return find(nodes,function(node){return node.id===id})};var node=findById(this.nodes,id),options;if(!node){options=this.options.nodes&&findById(this.options.nodes,id);var newNode_1=new PointClass(this,extend({className:"highcharts-node",isNode:true,id:id,y:1},options));newNode_1.linksTo=[];newNode_1.linksFrom=[];newNode_1.getSum=function(){var sumTo=0,sumFrom=0;newNode_1.linksTo.forEach(function(link){sumTo+=link.weight||0});newNode_1.linksFrom.forEach(function(link){sumFrom+=link.weight||0});return Math.max(sumTo,sumFrom)};newNode_1.offset=function(point,coll){var offset=0;for(var i=0;i<newNode_1[coll].length;i++){if(newNode_1[coll][i]===point){return offset}offset+=newNode_1[coll][i].weight}};newNode_1.hasShape=function(){var outgoing=0;newNode_1.linksTo.forEach(function(link){if(link.outgoing){outgoing++}});return!newNode_1.linksTo.length||outgoing!==newNode_1.linksTo.length};newNode_1.index=this.nodes.push(newNode_1)-1;node=newNode_1}node.formatPrefix="node";node.name=node.name||node.options.id||"";node.mass=pick(node.options.mass,node.options.marker&&node.options.marker.radius,this.options.marker&&this.options.marker.radius,4);return node}NodesComposition.createNode=createNode;function destroy(){this.data=[].concat(this.points||[],this.nodes);return seriesProto.destroy.apply(this,arguments)}NodesComposition.destroy=destroy;function generatePoints(){var _this=this;var chart=this.chart,nodeLookup={};seriesProto.generatePoints.call(this);if(!this.nodes){this.nodes=[]}this.colorCounter=0;this.nodes.forEach(function(node){node.linksFrom.length=0;node.linksTo.length=0;node.level=node.options.level});this.points.forEach(function(point){if(defined(point.from)){if(!nodeLookup[point.from]){nodeLookup[point.from]=_this.createNode(point.from)}nodeLookup[point.from].linksFrom.push(point);point.fromNode=nodeLookup[point.from];if(chart.styledMode){point.colorIndex=pick(point.options.colorIndex,nodeLookup[point.from].colorIndex)}else{point.color=point.options.color||nodeLookup[point.from].color}}if(defined(point.to)){if(!nodeLookup[point.to]){nodeLookup[point.to]=_this.createNode(point.to)}nodeLookup[point.to].linksTo.push(point);point.toNode=nodeLookup[point.to]}point.name=point.name||point.id},this);this.nodeLookup=nodeLookup}NodesComposition.generatePoints=generatePoints;function setData(){if(this.nodes){this.nodes.forEach(function(node){node.destroy()});this.nodes.length=0}seriesProto.setData.apply(this,arguments)}function setNodeState(state){var args=arguments,others=this.isNode?this.linksTo.concat(this.linksFrom):[this.fromNode,this.toNode];if(state!=="select"){others.forEach(function(linkOrNode){if(linkOrNode&&linkOrNode.series){pointProto.setState.apply(linkOrNode,args);if(!linkOrNode.isNode){if(linkOrNode.fromNode.graphic){pointProto.setState.apply(linkOrNode.fromNode,args)}if(linkOrNode.toNode&&linkOrNode.toNode.graphic){pointProto.setState.apply(linkOrNode.toNode,args)}}}})}pointProto.setState.apply(this,args)}NodesComposition.setNodeState=setNodeState;function updateNode(options,redraw,animation,runEvent){var _this=this;var nodes=this.series.options.nodes,data=this.series.options.data,dataLength=(data===null||data===void 0?void 0:data.length)||0,linkConfig=data===null||data===void 0?void 0:data[this.index];pointProto.update.call(this,options,this.isNode?false:redraw,animation,runEvent);if(this.isNode){var nodeIndex=(nodes||[]).reduce(function(prevIndex,n,index){return _this.id===n.id?index:prevIndex},-1),nodeConfig=merge(nodes&&nodes[nodeIndex]||{},(data===null||data===void 0?void 0:data[this.index])||{});if(data){if(linkConfig){data[this.index]=linkConfig}else{data.length=dataLength}}if(nodes){if(nodeIndex>=0){nodes[nodeIndex]=nodeConfig}else{nodes.push(nodeConfig)}}else{this.series.options.nodes=[nodeConfig]}if(pick(redraw,true)){this.series.chart.redraw(animation)}}}NodesComposition.updateNode=updateNode})(NodesComposition||(NodesComposition={}));export default NodesComposition;