"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var __assign=this&&this.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};var __spreadArray=this&&this.__spreadArray||function(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i]}}return to.concat(ar||Array.prototype.slice.call(from))};import Chart from"../../../Core/Chart/Chart.js";import SeriesRegistry from"../../../Core/Series/SeriesRegistry.js";var LineSeries=SeriesRegistry.seriesTypes.line;import U from"../../../Core/Utilities.js";var addEvent=U.addEvent,fireEvent=U.fireEvent,error=U.error,extend=U.extend,isArray=U.isArray,merge=U.merge,pick=U.pick;var tableToMultiYData=function(series,processed){var yData=[],pointArrayMap=series.pointArrayMap,table=processed&&series.dataTable.modified||series.dataTable;if(!pointArrayMap){return series.getColumn("y",processed)}var columns=pointArrayMap.map(function(key){return series.getColumn(key,processed)});var _loop_1=function(i){var values=pointArrayMap.map(function(key,colIndex){var _a;return((_a=columns[colIndex])===null||_a===void 0?void 0:_a[i])||0});yData.push(values)};for(var i=0;i<table.rowCount;i++){_loop_1(i)}return yData};var SMAIndicator=function(_super){__extends(SMAIndicator,_super);function SMAIndicator(){return _super!==null&&_super.apply(this,arguments)||this}SMAIndicator.prototype.destroy=function(){this.dataEventsToUnbind.forEach(function(unbinder){unbinder()});_super.prototype.destroy.apply(this,arguments)};SMAIndicator.prototype.getName=function(){var params=[];var name=this.name;if(!name){(this.nameComponents||[]).forEach(function(component,index){params.push(this.options.params[component]+pick(this.nameSuffixes[index],""))},this);name=(this.nameBase||this.type.toUpperCase())+(this.nameComponents?" ("+params.join(", ")+")":"")}return name};SMAIndicator.prototype.getValues=function(series,params){var period=params.period,xVal=series.xData||[],yVal=series.yData,yValLen=yVal.length,SMA=[],xData=[],yData=[];var i,index=-1,range=0,SMAPoint,sum=0;if(xVal.length<period){return}if(isArray(yVal[0])){index=params.index?params.index:0}while(range<period-1){sum+=index<0?yVal[range]:yVal[range][index];range++}for(i=range;i<yValLen;i++){sum+=index<0?yVal[i]:yVal[i][index];SMAPoint=[xVal[i],sum/period];SMA.push(SMAPoint);xData.push(SMAPoint[0]);yData.push(SMAPoint[1]);sum-=index<0?yVal[i-range]:yVal[i-range][index]}return{values:SMA,xData:xData,yData:yData}};SMAIndicator.prototype.init=function(chart,options){var indicator=this;_super.prototype.init.call(indicator,chart,options);var linkedSeriesUnbiner=addEvent(Chart,"afterLinkSeries",function(_a){var isUpdating=_a.isUpdating;if(isUpdating){return}var hasEvents=!!indicator.dataEventsToUnbind.length;if(indicator.linkedParent){if(!hasEvents){indicator.dataEventsToUnbind.push(addEvent(indicator.linkedParent,"updatedData",function(){indicator.recalculateValues()}));if(indicator.calculateOn.xAxis){indicator.dataEventsToUnbind.push(addEvent(indicator.linkedParent.xAxis,indicator.calculateOn.xAxis,function(){indicator.recalculateValues()}))}}if(indicator.calculateOn.chart==="init"){if(!indicator.closestPointRange){indicator.recalculateValues()}}else if(!hasEvents){var unbinder_1=addEvent(indicator.chart,indicator.calculateOn.chart,function(){indicator.recalculateValues();unbinder_1()})}}else{return error("Series "+indicator.options.linkedTo+" not found! Check `linkedTo`.",false,chart)}},{order:0});indicator.dataEventsToUnbind=[];indicator.eventsToUnbind.push(linkedSeriesUnbiner)};SMAIndicator.prototype.recalculateValues=function(){var _this=this;var _a;var croppedDataValues=[],indicator=this,table=this.dataTable,oldData=indicator.points||[],oldDataLength=indicator.dataTable.rowCount,emptySet={values:[],xData:[],yData:[]};var overwriteData=true,oldFirstPointIndex,oldLastPointIndex,min,max;var yData=indicator.linkedParent.yData,processedYData=indicator.linkedParent.processedYData;indicator.linkedParent.xData=indicator.linkedParent.getColumn("x");indicator.linkedParent.yData=tableToMultiYData(indicator.linkedParent);indicator.linkedParent.processedYData=tableToMultiYData(indicator.linkedParent,true);var processedData=indicator.linkedParent.options&&indicator.linkedParent.dataTable.rowCount?indicator.getValues(indicator.linkedParent,indicator.options.params)||emptySet:emptySet;delete indicator.linkedParent.xData;indicator.linkedParent.yData=yData;indicator.linkedParent.processedYData=processedYData;var pointArrayMap=indicator.pointArrayMap||["y"],valueColumns={};processedData.yData.forEach(function(values){pointArrayMap.forEach(function(key,index){var column=valueColumns[key]||[];column.push(isArray(values)?values[index]:values);if(!valueColumns[key]){valueColumns[key]=column}})});if(oldDataLength&&!indicator.hasGroupedData&&indicator.visible&&indicator.points){if(indicator.cropped){if(indicator.xAxis){min=indicator.xAxis.min;max=indicator.xAxis.max}var croppedData=indicator.cropData(table,min,max);var keys=__spreadArray(["x"],indicator.pointArrayMap||["y"],true);var _loop_2=function(i){var values=keys.map(function(key){return _this.getColumn(key)[i]||0});croppedDataValues.push(values)};for(var i=0;i<(((_a=croppedData.modified)===null||_a===void 0?void 0:_a.rowCount)||0);i++){_loop_2(i)}var indicatorXData=indicator.getColumn("x");oldFirstPointIndex=processedData.xData.indexOf(indicatorXData[0]);oldLastPointIndex=processedData.xData.indexOf(indicatorXData[indicatorXData.length-1]);if(oldFirstPointIndex===-1&&oldLastPointIndex===processedData.xData.length-2){if(croppedDataValues[0][0]===oldData[0].x){croppedDataValues.shift()}}indicator.updateData(croppedDataValues)}else if(indicator.updateAllPoints||processedData.xData.length!==oldDataLength-1&&processedData.xData.length!==oldDataLength+1){overwriteData=false;indicator.updateData(processedData.values)}}if(overwriteData){table.setColumns(__assign(__assign({},valueColumns),{x:processedData.xData}));indicator.options.data=processedData.values}if(indicator.calculateOn.xAxis&&indicator.getColumn("x",true).length){indicator.isDirty=true;indicator.redraw()}indicator.isDirtyData=!!indicator.linkedSeries.length;fireEvent(indicator,"updatedData")};SMAIndicator.prototype.processData=function(){var series=this,compareToMain=series.options.compareToMain,linkedParent=series.linkedParent;_super.prototype.processData.apply(series,arguments);if(series.dataModify&&linkedParent&&linkedParent.dataModify&&linkedParent.dataModify.compareValue&&compareToMain){series.dataModify.compareValue=linkedParent.dataModify.compareValue}return};SMAIndicator.defaultOptions=merge(LineSeries.defaultOptions,{name:void 0,tooltip:{valueDecimals:4},linkedTo:void 0,compareToMain:false,params:{index:3,period:14}});return SMAIndicator}(LineSeries);extend(SMAIndicator.prototype,{calculateOn:{chart:"init"},hasDerivedData:true,nameComponents:["period"],nameSuffixes:[],useCommonDataGrouping:true});SeriesRegistry.registerSeriesType("sma",SMAIndicator);export default SMAIndicator;"";