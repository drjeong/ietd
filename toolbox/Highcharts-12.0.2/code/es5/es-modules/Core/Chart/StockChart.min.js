"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();import Chart from"../Chart/Chart.js";import F from"../Templating.js";var format=F.format;import D from"../Defaults.js";var getOptions=D.getOptions;import NavigatorDefaults from"../../Stock/Navigator/NavigatorDefaults.js";import RangeSelectorDefaults from"../../Stock/RangeSelector/RangeSelectorDefaults.js";import ScrollbarDefaults from"../../Stock/Scrollbar/ScrollbarDefaults.js";import StockUtilities from"../../Stock/Utilities/StockUtilities.js";var setFixedRange=StockUtilities.setFixedRange;import U from"../Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,crisp=U.crisp,defined=U.defined,extend=U.extend,find=U.find,isNumber=U.isNumber,isString=U.isString,merge=U.merge,pick=U.pick,splat=U.splat;function getDefaultAxisOptions(coll,options,defaultOptions){var _a,_b,_c,_d;if(coll==="xAxis"){return{minPadding:0,maxPadding:0,overscroll:0,ordinal:true}}if(coll==="yAxis"){return{labels:{y:-2},opposite:(_b=(_a=defaultOptions.opposite)!==null&&_a!==void 0?_a:options.opposite)!==null&&_b!==void 0?_b:true,showLastLabel:!!(options.categories||options.type==="category"),title:{text:((_c=defaultOptions.title)===null||_c===void 0?void 0:_c.text)!=="Values"?(_d=defaultOptions.title)===null||_d===void 0?void 0:_d.text:null}}}return{}}function getForcedAxisOptions(type,chartOptions){if(type==="xAxis"){var navigatorEnabled=pick(chartOptions.navigator&&chartOptions.navigator.enabled,NavigatorDefaults.enabled,true);var axisOptions={type:"datetime",categories:void 0};if(navigatorEnabled){axisOptions.startOnTick=false;axisOptions.endOnTick=false}return axisOptions}return{}}var StockChart=function(_super){__extends(StockChart,_super);function StockChart(){return _super!==null&&_super.apply(this,arguments)||this}StockChart.prototype.init=function(userOptions,callback){var defaultOptions=getOptions(),xAxisOptions=userOptions.xAxis,yAxisOptions=userOptions.yAxis,navigatorEnabled=pick(userOptions.navigator&&userOptions.navigator.enabled,NavigatorDefaults.enabled,true);userOptions.xAxis=userOptions.yAxis=void 0;var options=merge({chart:{panning:{enabled:true,type:"x"},zooming:{pinchType:"x",mouseWheel:{type:"x"}}},navigator:{enabled:navigatorEnabled},scrollbar:{enabled:pick(ScrollbarDefaults.enabled,true)},rangeSelector:{enabled:pick(RangeSelectorDefaults.rangeSelector.enabled,true)},title:{text:null},tooltip:{split:pick(defaultOptions.tooltip&&defaultOptions.tooltip.split,true),crosshairs:true},legend:{enabled:false}},userOptions,{isStock:true});userOptions.xAxis=xAxisOptions;userOptions.yAxis=yAxisOptions;options.xAxis=splat(userOptions.xAxis||{}).map(function(xAxisOptions){return merge(getDefaultAxisOptions("xAxis",xAxisOptions,defaultOptions.xAxis),xAxisOptions,getForcedAxisOptions("xAxis",userOptions))});options.yAxis=splat(userOptions.yAxis||{}).map(function(yAxisOptions){return merge(getDefaultAxisOptions("yAxis",yAxisOptions,defaultOptions.yAxis),yAxisOptions)});_super.prototype.init.call(this,options,callback)};StockChart.prototype.createAxis=function(coll,options){options.axis=merge(getDefaultAxisOptions(coll,options.axis,getOptions()[coll]),options.axis,getForcedAxisOptions(coll,this.userOptions));return _super.prototype.createAxis.call(this,coll,options)};return StockChart}(Chart);addEvent(Chart,"update",function(e){var chart=this,options=e.options;if("scrollbar"in options&&chart.navigator){merge(true,chart.options.scrollbar,options.scrollbar);chart.navigator.update({enabled:!!chart.navigator.navigatorEnabled});delete options.scrollbar}});(function(StockChart){function compose(ChartClass,AxisClass,SeriesClass,SVGRendererClass){var seriesProto=SeriesClass.prototype;if(!seriesProto.forceCropping){addEvent(AxisClass,"afterDrawCrosshair",onAxisAfterDrawCrosshair);addEvent(AxisClass,"afterHideCrosshair",onAxisAfterHideCrosshair);addEvent(AxisClass,"autoLabelAlign",onAxisAutoLabelAlign);addEvent(AxisClass,"destroy",onAxisDestroy);addEvent(AxisClass,"getPlotLinePath",onAxisGetPlotLinePath);ChartClass.prototype.setFixedRange=setFixedRange;seriesProto.forceCropping=seriesForceCropping;addEvent(SeriesClass,"setOptions",onSeriesSetOptions);SVGRendererClass.prototype.crispPolyLine=svgRendererCrispPolyLine}}StockChart.compose=compose;function onAxisAfterDrawCrosshair(event){var _a,_b,_c;var axis=this;if(!(((_b=(_a=axis.crosshair)===null||_a===void 0?void 0:_a.label)===null||_b===void 0?void 0:_b.enabled)&&axis.cross&&isNumber(axis.min)&&isNumber(axis.max))){return}var chart=axis.chart,log=axis.logarithmic,options=axis.crosshair.label,horiz=axis.horiz,opposite=axis.opposite,left=axis.left,top=axis.top,width=axis.width,tickInside=axis.options.tickPosition==="inside",snap=axis.crosshair.snap!==false,e=event.e||((_c=axis.cross)===null||_c===void 0?void 0:_c.e),point=event.point;var crossLabel=axis.crossLabel,posx,posy,formatOption=options.format,formatFormat="",limit,offset=0,min=axis.min,max=axis.max;if(log){min=log.lin2log(axis.min);max=log.lin2log(axis.max)}var align=horiz?"center":opposite?axis.labelAlign==="right"?"right":"left":axis.labelAlign==="left"?"left":"center";if(!crossLabel){crossLabel=axis.crossLabel=chart.renderer.label("",0,void 0,options.shape||"callout").addClass("highcharts-crosshair-label highcharts-color-"+(point&&point.series?point.series.colorIndex:axis.series[0]&&this.series[0].colorIndex)).attr({align:options.align||align,padding:pick(options.padding,8),r:pick(options.borderRadius,3),zIndex:2}).add(axis.labelGroup);if(!chart.styledMode){crossLabel.attr({fill:options.backgroundColor||point&&point.series&&point.series.color||"#666666",stroke:options.borderColor||"","stroke-width":options.borderWidth||0}).css(extend({color:"#ffffff",fontWeight:"normal",fontSize:"0.7em",textAlign:"center"},options.style||{}))}}if(horiz){posx=snap?(point.plotX||0)+left:e.chartX;posy=top+(opposite?0:axis.height)}else{posx=left+axis.offset+(opposite?width:0);posy=snap?(point.plotY||0)+top:e.chartY}if(!formatOption&&!options.formatter){if(axis.dateTime){formatFormat="%b %d, %Y"}formatOption="{value"+(formatFormat?":"+formatFormat:"")+"}"}var value=snap?axis.isXAxis?point.x:point.y:axis.toValue(horiz?e.chartX:e.chartY);var isInside=point&&point.series?point.series.isPointInside(point):isNumber(value)&&value>min&&value<max;var text="";if(formatOption){text=format(formatOption,{value:value},chart)}else if(options.formatter&&isNumber(value)){text=options.formatter.call(axis,value)}crossLabel.attr({text:text,x:posx,y:posy,visibility:isInside?"inherit":"hidden"});var crossBox=crossLabel.getBBox();if(isNumber(crossLabel.x)&&!horiz&&!opposite){posx=crossLabel.x-crossBox.width/2}if(isNumber(crossLabel.y)){if(horiz){if(tickInside&&!opposite||!tickInside&&opposite){posy=crossLabel.y-crossBox.height}}else{posy=crossLabel.y-crossBox.height/2}}if(horiz){limit={left:left,right:left+axis.width}}else{limit={left:axis.labelAlign==="left"?left:0,right:axis.labelAlign==="right"?left+axis.width:chart.chartWidth}}var translateX=crossLabel.translateX||0;if(translateX<limit.left){offset=limit.left-translateX}if(translateX+crossBox.width>=limit.right){offset=-(translateX+crossBox.width-limit.right)}crossLabel.attr({x:Math.max(0,posx+offset),y:Math.max(0,posy),anchorX:horiz?posx:axis.opposite?0:chart.chartWidth,anchorY:horiz?axis.opposite?chart.chartHeight:0:posy+crossBox.height/2})}function onAxisAfterHideCrosshair(){var axis=this;if(axis.crossLabel){axis.crossLabel=axis.crossLabel.hide()}}function onAxisAutoLabelAlign(e){var axis=this,chart=axis.chart,options=axis.options,panes=chart._labelPanes=chart._labelPanes||{},labelOptions=options.labels;if(chart.options.isStock&&axis.coll==="yAxis"){var key=options.top+","+options.height;if(!panes[key]&&labelOptions.enabled){if(labelOptions.distance===15&&axis.side===1){labelOptions.distance=0}if(typeof labelOptions.align==="undefined"){labelOptions.align="right"}panes[key]=axis;e.align="right";e.preventDefault()}}}function onAxisDestroy(){var axis=this,chart=axis.chart,key=axis.options&&axis.options.top+","+axis.options.height;if(key&&chart._labelPanes&&chart._labelPanes[key]===axis){delete chart._labelPanes[key]}}function onAxisGetPlotLinePath(e){var axis=this,series=axis.isLinked&&!axis.series&&axis.linkedParent?axis.linkedParent.series:axis.series,chart=axis.chart,renderer=chart.renderer,axisLeft=axis.left,axisTop=axis.top,result=[],translatedValue=e.translatedValue,value=e.value,force=e.force,getAxis=function(coll){var otherColl=coll==="xAxis"?"yAxis":"xAxis",opt=axis.options[otherColl];if(isNumber(opt)){return[chart[otherColl][opt]]}if(isString(opt)){return[chart.get(opt)]}return series.map(function(s){return s[otherColl]})};var x1,y1,x2,y2,axes=[],axes2,uniqueAxes,transVal;if(chart.options.isStock&&e.acrossPanes!==false&&axis.coll==="xAxis"||axis.coll==="yAxis"){e.preventDefault();axes=getAxis(axis.coll);axes2=axis.isXAxis?chart.yAxis:chart.xAxis;for(var _i=0,axes2_1=axes2;_i<axes2_1.length;_i++){var A=axes2_1[_i];if(!A.options.isInternal){var a=A.isXAxis?"yAxis":"xAxis",relatedAxis=defined(A.options[a])?chart[a][A.options[a]]:chart[a][0];if(axis===relatedAxis){axes.push(A)}}}uniqueAxes=axes.length?[]:[axis.isXAxis?chart.yAxis[0]:chart.xAxis[0]];var _loop_1=function(axis2){if(uniqueAxes.indexOf(axis2)===-1&&!find(uniqueAxes,function(unique){return unique.pos===axis2.pos&&unique.len===axis2.len})){uniqueAxes.push(axis2)}};for(var _a=0,axes_1=axes;_a<axes_1.length;_a++){var axis2=axes_1[_a];_loop_1(axis2)}transVal=pick(translatedValue,axis.translate(value||0,void 0,void 0,e.old));if(isNumber(transVal)){if(axis.horiz){for(var _b=0,uniqueAxes_1=uniqueAxes;_b<uniqueAxes_1.length;_b++){var axis2=uniqueAxes_1[_b];var skip=void 0;y1=axis2.pos;y2=y1+axis2.len;x1=x2=Math.round(transVal+axis.transB);if(force!=="pass"&&(x1<axisLeft||x1>axisLeft+axis.width)){if(force){x1=x2=clamp(x1,axisLeft,axisLeft+axis.width)}else{skip=true}}if(!skip){result.push(["M",x1,y1],["L",x2,y2])}}}else{for(var _c=0,uniqueAxes_2=uniqueAxes;_c<uniqueAxes_2.length;_c++){var axis2=uniqueAxes_2[_c];var skip=void 0;x1=axis2.pos;x2=x1+axis2.len;y1=y2=Math.round(axisTop+axis.height-transVal);if(force!=="pass"&&(y1<axisTop||y1>axisTop+axis.height)){if(force){y1=y2=clamp(y1,axisTop,axisTop+axis.height)}else{skip=true}}if(!skip){result.push(["M",x1,y1],["L",x2,y2])}}}}e.path=result.length>0?renderer.crispPolyLine(result,e.lineWidth||1):void 0}}function onSeriesSetOptions(e){var series=this;if(series.chart.options.isStock){var overrides=void 0;if(series.is("column")||series.is("columnrange")){overrides={borderWidth:0,shadow:false}}else if(!series.is("scatter")&&!series.is("sma")){overrides={marker:{enabled:false,radius:2}}}if(overrides){e.plotOptions[series.type]=merge(e.plotOptions[series.type],overrides)}}}function seriesForceCropping(){var series=this,chart=series.chart,options=series.options,dataGroupingOptions=options.dataGrouping,groupingEnabled=series.allowDG!==false&&dataGroupingOptions&&pick(dataGroupingOptions.enabled,chart.options.isStock);return groupingEnabled}function stockChart(a,b,c){return new StockChart(a,b,c)}StockChart.stockChart=stockChart;function svgRendererCrispPolyLine(points,width){for(var i=0;i<points.length;i=i+2){var start=points[i],end=points[i+1];if(defined(start[1])&&start[1]===end[1]){start[1]=end[1]=crisp(start[1],width)}if(defined(start[2])&&start[2]===end[2]){start[2]=end[2]=crisp(start[2],width)}}return points}})(StockChart||(StockChart={}));export default StockChart;