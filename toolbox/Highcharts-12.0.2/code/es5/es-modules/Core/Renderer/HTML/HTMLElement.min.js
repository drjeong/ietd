"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var __assign=this&&this.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};import AST from"./AST.js";import H from"../../Globals.js";var composed=H.composed;import SVGElement from"../SVG/SVGElement.js";import U from"../../Utilities.js";var attr=U.attr,css=U.css,createElement=U.createElement,defined=U.defined,extend=U.extend,getAlignFactor=U.getAlignFactor,isNumber=U.isNumber,pInt=U.pInt,pushUnique=U.pushUnique;function commonSetter(value,key,elem){var _a;var style=((_a=this.div)===null||_a===void 0?void 0:_a.style)||elem.style;SVGElement.prototype["".concat(key,"Setter")].call(this,value,key,elem);if(style){style[key]=value}}var decorateSVGGroup=function(g,container){var _a;if(!g.div){var className=attr(g.element,"class"),cssProto_1=g.css;var div_1=createElement("div",className?{className:className}:void 0,__assign(__assign({position:"absolute",left:"".concat(g.translateX||0,"px"),top:"".concat(g.translateY||0,"px")},g.styles),{display:g.display,opacity:g.opacity,visibility:g.visibility}),((_a=g.parentGroup)===null||_a===void 0?void 0:_a.div)||container);g.classSetter=function(value,key,element){element.setAttribute("class",value);div_1.className=value};g.translateXSetter=g.translateYSetter=function(value,key){g[key]=value;div_1.style[key==="translateX"?"left":"top"]="".concat(value,"px");g.doTransform=true};g.opacitySetter=g.visibilitySetter=commonSetter;g.css=function(styles){cssProto_1.call(g,styles);if(styles.cursor){div_1.style.cursor=styles.cursor}if(styles.pointerEvents){div_1.style.pointerEvents=styles.pointerEvents}return g};g.on=function(){SVGElement.prototype.on.apply({element:div_1,onEvents:g.onEvents},arguments);return g};g.div=div_1}return g.div};var HTMLElement=function(_super){__extends(HTMLElement,_super);function HTMLElement(renderer,nodeName){var _this=_super.call(this,renderer,nodeName)||this;_this.css(__assign({position:"absolute"},renderer.styledMode?{}:{fontFamily:renderer.style.fontFamily,fontSize:renderer.style.fontSize}));return _this}HTMLElement.compose=function(SVGRendererClass){if(pushUnique(composed,this.compose)){SVGRendererClass.prototype.html=function(str,x,y){return new HTMLElement(this,"span").attr({text:str,x:Math.round(x),y:Math.round(y)})}}};HTMLElement.prototype.getSpanCorrection=function(width,baseline,alignCorrection){this.xCorr=-width*alignCorrection;this.yCorr=-baseline};HTMLElement.prototype.css=function(styles){var element=this.element,isSettingWidth=element.tagName==="SPAN"&&styles&&"width"in styles,textWidth=isSettingWidth&&styles.width;var doTransform;if(isSettingWidth){delete styles.width;this.textWidth=pInt(textWidth)||void 0;doTransform=true}if((styles===null||styles===void 0?void 0:styles.textOverflow)==="ellipsis"){styles.overflow="hidden"}if(styles===null||styles===void 0?void 0:styles.lineClamp){styles.display="-webkit-box";styles.WebkitLineClamp=styles.lineClamp;styles.WebkitBoxOrient="vertical";styles.overflow="hidden"}if(isNumber(Number(styles===null||styles===void 0?void 0:styles.fontSize))){styles.fontSize=styles.fontSize+"px"}extend(this.styles,styles);css(element,styles);if(doTransform){this.updateTransform()}return this};HTMLElement.prototype.htmlGetBBox=function(){var element=this.element;return{x:element.offsetLeft,y:element.offsetTop,width:element.offsetWidth,height:element.offsetHeight}};HTMLElement.prototype.updateTransform=function(){var _this=this;var _a;if(!this.added){this.alignOnAdd=true;return}var _b=this,element=_b.element,renderer=_b.renderer,rotation=_b.rotation,rotationOriginX=_b.rotationOriginX,rotationOriginY=_b.rotationOriginY,scaleX=_b.scaleX,scaleY=_b.scaleY,styles=_b.styles,_c=_b.textAlign,textAlign=_c===void 0?"left":_c,textWidth=_b.textWidth,_d=_b.translateX,translateX=_d===void 0?0:_d,_e=_b.translateY,translateY=_e===void 0?0:_e,_f=_b.x,x=_f===void 0?0:_f,_g=_b.y,y=_g===void 0?0:_g,_h=styles.display,display=_h===void 0?"block":_h,whiteSpace=styles.whiteSpace;var getTextPxLength=function(){if(_this.textPxLength){return _this.textPxLength}css(element,{width:"",whiteSpace:whiteSpace||"nowrap"});return element.offsetWidth};css(element,{marginLeft:"".concat(translateX,"px"),marginTop:"".concat(translateY,"px")});if(element.tagName==="SPAN"){var currentTextTransform=[rotation,textAlign,element.innerHTML,textWidth,this.textAlign].join(","),parentPadding=((_a=this.parentGroup)===null||_a===void 0?void 0:_a.padding)*-1||0;var baseline=void 0,hasBoxWidthChanged=false;if(textWidth!==this.oldTextWidth){var textPxLength=getTextPxLength(),textWidthNum=textWidth||0;if((textWidthNum>this.oldTextWidth||textPxLength>textWidthNum)&&(/[ \-]/.test(element.textContent||element.innerText)||element.style.textOverflow==="ellipsis")){css(element,{width:textPxLength>textWidthNum||rotation||scaleX?textWidth+"px":"auto",display:display,whiteSpace:whiteSpace||"normal"});this.oldTextWidth=textWidth;hasBoxWidthChanged=true}}this.hasBoxWidthChanged=hasBoxWidthChanged;if(currentTextTransform!==this.cTT){baseline=renderer.fontMetrics(element).b;if(defined(rotation)&&(rotation!==(this.oldRotation||0)||textAlign!==this.oldAlign)){this.setSpanRotation(rotation,parentPadding,parentPadding)}this.getSpanCorrection(!defined(rotation)&&!this.textWidth&&this.textPxLength||element.offsetWidth,baseline,getAlignFactor(textAlign))}var _j=this,_k=_j.xCorr,xCorr=_k===void 0?0:_k,_l=_j.yCorr,yCorr=_l===void 0?0:_l,rotOriginX=(rotationOriginX!==null&&rotationOriginX!==void 0?rotationOriginX:x)-xCorr-x-parentPadding,rotOriginY=(rotationOriginY!==null&&rotationOriginY!==void 0?rotationOriginY:y)-yCorr-y-parentPadding,styles_1={left:"".concat(x+xCorr,"px"),top:"".concat(y+yCorr,"px"),textAlign:textAlign,transformOrigin:"".concat(rotOriginX,"px ").concat(rotOriginY,"px")};if(scaleX||scaleY){styles_1.transform="scale(".concat(scaleX!==null&&scaleX!==void 0?scaleX:1,",").concat(scaleY!==null&&scaleY!==void 0?scaleY:1,")")}css(element,styles_1);this.cTT=currentTextTransform;this.oldRotation=rotation;this.oldAlign=textAlign}};HTMLElement.prototype.setSpanRotation=function(rotation,originX,originY){css(this.element,{transform:"rotate(".concat(rotation,"deg)"),transformOrigin:"".concat(originX,"% ").concat(originY,"px")})};HTMLElement.prototype.add=function(parentGroup){var container=this.renderer.box.parentNode,parents=[];var div;this.parentGroup=parentGroup;if(parentGroup){div=parentGroup.div;if(!div){var svgGroup=parentGroup;while(svgGroup){parents.push(svgGroup);svgGroup=svgGroup.parentGroup}for(var _i=0,_a=parents.reverse();_i<_a.length;_i++){var parentGroup_1=_a[_i];div=decorateSVGGroup(parentGroup_1,container)}}}(div||container).appendChild(this.element);this.added=true;if(this.alignOnAdd){this.updateTransform()}return this};HTMLElement.prototype.textSetter=function(value){if(value!==this.textStr){delete this.bBox;delete this.oldTextWidth;AST.setElementHTML(this.element,value!==null&&value!==void 0?value:"");this.textStr=value;this.doTransform=true}};HTMLElement.prototype.alignSetter=function(value){this.alignValue=this.textAlign=value;this.doTransform=true};HTMLElement.prototype.xSetter=function(value,key){this[key]=value;this.doTransform=true};return HTMLElement}(SVGElement);var proto=HTMLElement.prototype;proto.visibilitySetter=proto.opacitySetter=commonSetter;proto.ySetter=proto.rotationSetter=proto.rotationOriginXSetter=proto.rotationOriginYSetter=proto.xSetter;export default HTMLElement;