"use strict";import AST from"../HTML/AST.js";import H from"../../Globals.js";var doc=H.doc,SVG_NS=H.SVG_NS,win=H.win;import U from"../../Utilities.js";var attr=U.attr,extend=U.extend,fireEvent=U.fireEvent,isString=U.isString,objectEach=U.objectEach,pick=U.pick;var stringWithEllipsis=function(text,currentIndex){return text.substring(0,currentIndex)+"…"};var TextBuilder=function(){function TextBuilder(svgElement){var textStyles=svgElement.styles;this.renderer=svgElement.renderer;this.svgElement=svgElement;this.width=svgElement.textWidth;this.textLineHeight=textStyles&&textStyles.lineHeight;this.textOutline=textStyles&&textStyles.textOutline;this.ellipsis=Boolean(textStyles&&textStyles.textOverflow==="ellipsis");this.lineClamp=textStyles===null||textStyles===void 0?void 0:textStyles.lineClamp;this.noWrap=Boolean(textStyles&&textStyles.whiteSpace==="nowrap")}TextBuilder.prototype.buildSVG=function(){var wrapper=this.svgElement,textNode=wrapper.element,renderer=wrapper.renderer,textStr=pick(wrapper.textStr,"").toString(),hasMarkup=textStr.indexOf("<")!==-1,childNodes=textNode.childNodes,tempParent=!wrapper.added&&renderer.box,regexMatchBreaks=/<br.*?>/g,textCache=[textStr,this.ellipsis,this.noWrap,this.textLineHeight,this.textOutline,wrapper.getStyle("font-size"),wrapper.styles.lineClamp,this.width].join(",");if(textCache===wrapper.textCache){return}wrapper.textCache=textCache;delete wrapper.actualWidth;for(var i=childNodes.length;i--;){textNode.removeChild(childNodes[i])}if(!hasMarkup&&!this.ellipsis&&!this.width&&!wrapper.textPath&&(textStr.indexOf(" ")===-1||this.noWrap&&!regexMatchBreaks.test(textStr))){textNode.appendChild(doc.createTextNode(this.unescapeEntities(textStr)))}else if(textStr!==""){if(tempParent){tempParent.appendChild(textNode)}var ast=new AST(textStr);this.modifyTree(ast.nodes);ast.addToDOM(textNode);this.modifyDOM();if(this.ellipsis&&(textNode.textContent||"").indexOf("…")!==-1){wrapper.attr("title",this.unescapeEntities(wrapper.textStr||"",["&lt;","&gt;"]))}if(tempParent){tempParent.removeChild(textNode)}}if(isString(this.textOutline)&&wrapper.applyTextOutline){wrapper.applyTextOutline(this.textOutline)}};TextBuilder.prototype.modifyDOM=function(){var _this=this;var wrapper=this.svgElement;var x=attr(wrapper.element,"x");wrapper.firstLineMetrics=void 0;var firstChild;while(firstChild=wrapper.element.firstChild){if(/^[\s\u200B]*$/.test(firstChild.textContent||" ")){wrapper.element.removeChild(firstChild)}else{break}}[].forEach.call(wrapper.element.querySelectorAll("tspan.highcharts-br"),function(br,i){if(br.nextSibling&&br.previousSibling){if(i===0&&br.previousSibling.nodeType===1){wrapper.firstLineMetrics=wrapper.renderer.fontMetrics(br.previousSibling)}attr(br,{dy:_this.getLineHeight(br.nextSibling),x:x})}});var width=this.width||0;if(!width){return}var modifyTextNode=function(textNode,parentElement){var _a;var text=textNode.textContent||"";var words=text.replace(/([^\^])-/g,"$1- ").split(" ");var hasWhiteSpace=!_this.noWrap&&(words.length>1||wrapper.element.childNodes.length>1);var dy=_this.getLineHeight(parentElement),ellipsisWidth=Math.max(0,width-.8*dy);var lineNo=0;var startAt=wrapper.actualWidth;if(hasWhiteSpace){var lines=[];var precedingSiblings=[];while(parentElement.firstChild&&parentElement.firstChild!==textNode){precedingSiblings.push(parentElement.firstChild);parentElement.removeChild(parentElement.firstChild)}while(words.length){if(words.length&&!_this.noWrap&&lineNo>0){lines.push(textNode.textContent||"");textNode.textContent=words.join(" ").replace(/- /g,"-")}_this.truncate(textNode,void 0,words,lineNo===0?startAt||0:0,width,ellipsisWidth,function(t,currentIndex){return words.slice(0,currentIndex).join(" ").replace(/- /g,"-")});startAt=wrapper.actualWidth;lineNo++;if(_this.lineClamp&&lineNo>=_this.lineClamp){if(words.length){_this.truncate(textNode,textNode.textContent||"",void 0,0,width,ellipsisWidth,stringWithEllipsis);textNode.textContent=((_a=textNode.textContent)===null||_a===void 0?void 0:_a.replace("…",""))+"…"}break}}precedingSiblings.forEach(function(childNode){parentElement.insertBefore(childNode,textNode)});lines.forEach(function(line){parentElement.insertBefore(doc.createTextNode(line),textNode);var br=doc.createElementNS(SVG_NS,"tspan");br.textContent="​";attr(br,{dy:dy,x:x});parentElement.insertBefore(br,textNode)})}else if(_this.ellipsis){if(text){_this.truncate(textNode,text,void 0,0,width,ellipsisWidth,stringWithEllipsis)}}};var modifyChildren=function(node){var childNodes=[].slice.call(node.childNodes);childNodes.forEach(function(childNode){if(childNode.nodeType===win.Node.TEXT_NODE){modifyTextNode(childNode,node)}else{if(childNode.className.baseVal.indexOf("highcharts-br")!==-1){wrapper.actualWidth=0}modifyChildren(childNode)}})};modifyChildren(wrapper.element)};TextBuilder.prototype.getLineHeight=function(node){var element=node.nodeType===win.Node.TEXT_NODE?node.parentElement:node;return this.textLineHeight?parseInt(this.textLineHeight.toString(),10):this.renderer.fontMetrics(element||this.svgElement.element).h};TextBuilder.prototype.modifyTree=function(nodes){var _this=this;var modifyChild=function(node,i){var _a=node.attributes,attributes=_a===void 0?{}:_a,children=node.children,_b=node.style,style=_b===void 0?{}:_b,tagName=node.tagName,styledMode=_this.renderer.styledMode;if(tagName==="b"||tagName==="strong"){if(styledMode){attributes["class"]="highcharts-strong"}else{style.fontWeight="bold"}}else if(tagName==="i"||tagName==="em"){if(styledMode){attributes["class"]="highcharts-emphasized"}else{style.fontStyle="italic"}}if(style&&style.color){style.fill=style.color}if(tagName==="br"){attributes["class"]="highcharts-br";node.textContent="​";var nextNode=nodes[i+1];if(nextNode&&nextNode.textContent){nextNode.textContent=nextNode.textContent.replace(/^ +/gm,"")}}else if(tagName==="a"&&children&&children.some(function(child){return child.tagName==="#text"})){node.children=[{children:children,tagName:"tspan"}]}if(tagName!=="#text"&&tagName!=="a"){node.tagName="tspan"}extend(node,{attributes:attributes,style:style});if(children){children.filter(function(c){return c.tagName!=="#text"}).forEach(modifyChild)}};nodes.forEach(modifyChild);fireEvent(this.svgElement,"afterModifyTree",{nodes:nodes})};TextBuilder.prototype.truncate=function(textNode,text,words,startAt,width,ellipsisWidth,getString){var svgElement=this.svgElement;var rotation=svgElement.rotation;var lengths=[];var minIndex=words&&!startAt?1:0;var maxIndex=(text||words||"").length;var currentIndex=maxIndex;var str;var actualWidth;if(!words){width=ellipsisWidth}var getSubStringLength=function(charEnd,concatenatedEnd){var end=concatenatedEnd||charEnd;var parentNode=textNode.parentNode;if(parentNode&&typeof lengths[end]==="undefined"){if(parentNode.getSubStringLength){try{lengths[end]=startAt+parentNode.getSubStringLength(0,words?end+1:end)}catch(e){""}}}return lengths[end]};svgElement.rotation=0;actualWidth=getSubStringLength(textNode.textContent.length);if(startAt+actualWidth>width){while(minIndex<=maxIndex){currentIndex=Math.ceil((minIndex+maxIndex)/2);if(words){str=getString(words,currentIndex)}actualWidth=getSubStringLength(currentIndex,str&&str.length-1);if(minIndex===maxIndex){minIndex=maxIndex+1}else if(actualWidth>width){maxIndex=currentIndex-1}else{minIndex=currentIndex}}if(maxIndex===0){textNode.textContent=""}else if(!(text&&maxIndex===text.length-1)){textNode.textContent=str||getString(text||words,currentIndex)}if(this.ellipsis&&actualWidth>width){this.truncate(textNode,textNode.textContent||"",void 0,0,width,ellipsisWidth,stringWithEllipsis)}}if(words){words.splice(0,currentIndex)}svgElement.actualWidth=actualWidth;svgElement.rotation=rotation};TextBuilder.prototype.unescapeEntities=function(inputStr,except){objectEach(this.renderer.escapes,function(value,key){if(!except||except.indexOf(value)===-1){inputStr=inputStr.toString().replace(new RegExp(value,"g"),key)}});return inputStr};return TextBuilder}();export default TextBuilder;