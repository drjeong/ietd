"use strict";var __assign=this&&this.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};import Axis from"./Axis.js";import DataTableCore from"../../Data/DataTableCore.js";import H from"../Globals.js";import U from"../Utilities.js";var addEvent=U.addEvent,correctFloat=U.correctFloat,css=U.css,defined=U.defined,error=U.error,isNumber=U.isNumber,pick=U.pick,timeUnits=U.timeUnits,isString=U.isString;var OrdinalAxis;(function(OrdinalAxis){function compose(AxisClass,SeriesClass,ChartClass){var axisProto=AxisClass.prototype;if(!axisProto.ordinal2lin){axisProto.getTimeTicks=getTimeTicks;axisProto.index2val=index2val;axisProto.lin2val=lin2val;axisProto.val2lin=val2lin;axisProto.ordinal2lin=axisProto.val2lin;addEvent(AxisClass,"afterInit",onAxisAfterInit);addEvent(AxisClass,"foundExtremes",onAxisFoundExtremes);addEvent(AxisClass,"afterSetScale",onAxisAfterSetScale);addEvent(AxisClass,"initialAxisTranslation",onAxisInitialAxisTranslation);addEvent(ChartClass,"pan",onChartPan);addEvent(ChartClass,"touchpan",onChartPan);addEvent(SeriesClass,"updatedData",onSeriesUpdatedData)}return AxisClass}OrdinalAxis.compose=compose;function getTimeTicks(normalizedInterval,min,max,startOfWeek,positions,closestDistance,findHigherRanks){if(positions===void 0){positions=[]}if(closestDistance===void 0){closestDistance=0}var higherRanks={},tickPixelIntervalOption=this.options.tickPixelInterval,time=this.chart.time,segmentStarts=[];var end,segmentPositions,hasCrossedHigherRank,info,outsideMax,start=0,groupPositions=[],lastGroupPosition=-Number.MAX_VALUE;if(!this.options.ordinal&&!this.options.breaks||!positions||positions.length<3||typeof min==="undefined"){return time.getTimeTicks.apply(time,arguments)}var posLength=positions.length;for(end=0;end<posLength;end++){outsideMax=end&&positions[end-1]>max;if(positions[end]<min){start=end}if(end===posLength-1||positions[end+1]-positions[end]>closestDistance*5||outsideMax){if(positions[end]>lastGroupPosition){segmentPositions=time.getTimeTicks(normalizedInterval,positions[start],positions[end],startOfWeek);while(segmentPositions.length&&segmentPositions[0]<=lastGroupPosition){segmentPositions.shift()}if(segmentPositions.length){lastGroupPosition=segmentPositions[segmentPositions.length-1]}segmentStarts.push(groupPositions.length);groupPositions=groupPositions.concat(segmentPositions)}start=end+1}if(outsideMax){break}}if(segmentPositions){info=segmentPositions.info;if(findHigherRanks&&info.unitRange<=timeUnits.hour){end=groupPositions.length-1;for(start=1;start<end;start++){if(time.dateFormat("%d",groupPositions[start])!==time.dateFormat("%d",groupPositions[start-1])){higherRanks[groupPositions[start]]="day";hasCrossedHigherRank=true}}if(hasCrossedHigherRank){higherRanks[groupPositions[0]]="day"}info.higherRanks=higherRanks}info.segmentStarts=segmentStarts;groupPositions.info=info}else{error(12,false,this.chart)}if(findHigherRanks&&defined(tickPixelIntervalOption)){var length_1=groupPositions.length,translatedArr=[],distances=[];var itemToRemove=void 0,translated=void 0,lastTranslated=void 0,medianDistance=void 0,distance=void 0,i=length_1;while(i--){translated=this.translate(groupPositions[i]);if(lastTranslated){distances[i]=lastTranslated-translated}translatedArr[i]=lastTranslated=translated}distances.sort(function(a,b){return a-b});medianDistance=distances[Math.floor(distances.length/2)];if(medianDistance<tickPixelIntervalOption*.6){medianDistance=null}i=groupPositions[length_1-1]>max?length_1-1:length_1;lastTranslated=void 0;while(i--){translated=translatedArr[i];distance=Math.abs(lastTranslated-translated);if(lastTranslated&&distance<tickPixelIntervalOption*.8&&(medianDistance===null||distance<medianDistance*.8)){if(higherRanks[groupPositions[i]]&&!higherRanks[groupPositions[i+1]]){itemToRemove=i+1;lastTranslated=translated}else{itemToRemove=i}groupPositions.splice(itemToRemove,1)}else{lastTranslated=translated}}}return groupPositions}function index2val(index){var axis=this,ordinal=axis.ordinal,ordinalPositions=ordinal.positions;if(!ordinalPositions){return index}var i=ordinalPositions.length-1,distance;if(index<0){index=ordinalPositions[0]}else if(index>i){index=ordinalPositions[i]}else{i=Math.floor(index);distance=index-i}if(typeof distance!=="undefined"&&typeof ordinalPositions[i]!=="undefined"){return ordinalPositions[i]+(distance?distance*(ordinalPositions[i+1]-ordinalPositions[i]):0)}return index}function lin2val(val){var axis=this,ordinal=axis.ordinal,localMin=axis.old?axis.old.min:axis.min,localA=axis.old?axis.old.transA:axis.transA;var positions=ordinal.getExtendedPositions();if(positions===null||positions===void 0?void 0:positions.length){var pixelVal=correctFloat((val-localMin)*localA+axis.minPixelPadding),index=correctFloat(ordinal.getIndexOfPoint(pixelVal,positions)),mantissa=correctFloat(index%1);if(index>=0&&index<=positions.length-1){var leftNeighbour=positions[Math.floor(index)],rightNeighbour=positions[Math.ceil(index)],distance=rightNeighbour-leftNeighbour;return positions[Math.floor(index)]+mantissa*distance}}return val}function getIndexInArray(ordinalPositions,val){var index=OrdinalAxis.Additions.findIndexOf(ordinalPositions,val,true);if(ordinalPositions[index]===val){return index}var percent=(val-ordinalPositions[index])/(ordinalPositions[index+1]-ordinalPositions[index]);return index+percent}function onAxisAfterInit(){var axis=this;if(!axis.ordinal){axis.ordinal=new OrdinalAxis.Additions(axis)}}function onAxisFoundExtremes(){var axis=this,eventArgs=axis.eventArgs,options=axis.options;if(axis.isXAxis&&defined(options.overscroll)&&options.overscroll!==0&&isNumber(axis.max)&&isNumber(axis.min)){if(axis.options.ordinal&&!axis.ordinal.originalOrdinalRange){axis.ordinal.getExtendedPositions(false)}if(axis.max===axis.dataMax&&((eventArgs===null||eventArgs===void 0?void 0:eventArgs.trigger)!=="pan"||axis.isInternal)&&(eventArgs===null||eventArgs===void 0?void 0:eventArgs.trigger)!=="navigator"){var overscroll=axis.ordinal.convertOverscroll(options.overscroll);axis.max+=overscroll;if(!axis.isInternal&&defined(axis.userMin)&&(eventArgs===null||eventArgs===void 0?void 0:eventArgs.trigger)!=="mousewheel"){axis.min+=overscroll}}}}function onAxisAfterSetScale(){var axis=this;if(axis.horiz&&!axis.isDirty){axis.isDirty=axis.isOrdinal&&axis.chart.navigator&&!axis.chart.navigator.adaptToUpdatedData}}function onAxisInitialAxisTranslation(){var axis=this;if(axis.ordinal){axis.ordinal.beforeSetTickPositions();axis.tickInterval=axis.ordinal.postProcessTickInterval(axis.tickInterval)}}function onChartPan(e){var chart=this,xAxis=chart.xAxis[0],overscroll=xAxis.ordinal.convertOverscroll(xAxis.options.overscroll),chartX=e.originalEvent.chartX,panning=chart.options.chart.panning;var runBase=false;if(panning&&panning.type!=="y"&&xAxis.options.ordinal&&xAxis.series.length&&(!e.touches||e.touches.length<=1)){var mouseDownX=chart.mouseDownX,extremes=xAxis.getExtremes(),dataMin=extremes.dataMin,dataMax=extremes.dataMax,min=extremes.min,max=extremes.max,hoverPoints=chart.hoverPoints,closestPointRange=xAxis.closestPointRange||xAxis.ordinal&&xAxis.ordinal.overscrollPointsRange,pointPixelWidth=xAxis.translationSlope*(xAxis.ordinal.slope||closestPointRange),movedUnits=Math.round((mouseDownX-chartX)/pointPixelWidth),extendedOrdinalPositions=xAxis.ordinal.getExtendedPositions(),extendedAxis={ordinal:{positions:extendedOrdinalPositions,extendedOrdinalPositions:extendedOrdinalPositions}},index2val_1=xAxis.index2val,val2lin_1=xAxis.val2lin;var trimmedRange=void 0,ordinalPositions=void 0;if(min<=dataMin&&movedUnits<0||max+overscroll>=dataMax&&movedUnits>0){return}if(!extendedAxis.ordinal.positions){runBase=true}else if(Math.abs(movedUnits)>1){if(hoverPoints){hoverPoints.forEach(function(point){point.setState()})}ordinalPositions=extendedAxis.ordinal.positions;if(dataMax>ordinalPositions[ordinalPositions.length-1]){ordinalPositions.push(dataMax)}chart.setFixedRange(max-min);trimmedRange=xAxis.navigatorAxis.toFixedRange(void 0,void 0,index2val_1.apply(extendedAxis,[val2lin_1.apply(extendedAxis,[min,true])+movedUnits]),index2val_1.apply(extendedAxis,[val2lin_1.apply(extendedAxis,[max,true])+movedUnits]));if(trimmedRange.min>=Math.min(ordinalPositions[0],min)&&trimmedRange.max<=Math.max(ordinalPositions[ordinalPositions.length-1],max)+overscroll){xAxis.setExtremes(trimmedRange.min,trimmedRange.max,true,false,{trigger:"pan"})}chart.mouseDownX=chartX;css(chart.container,{cursor:"move"})}}else{runBase=true}if(runBase||panning&&/y/.test(panning.type)){if(overscroll){xAxis.max=xAxis.dataMax+overscroll}}else{e.preventDefault()}}function onSeriesUpdatedData(){var xAxis=this.xAxis;if(xAxis&&xAxis.options.ordinal){delete xAxis.ordinal.index;delete xAxis.ordinal.originalOrdinalRange}}function val2lin(val,toIndex){var axis=this,ordinal=axis.ordinal,ordinalPositions=ordinal.positions;var slope=ordinal.slope,extendedOrdinalPositions;if(!ordinalPositions){return val}var ordinalLength=ordinalPositions.length;var ordinalIndex;if(ordinalPositions[0]<=val&&ordinalPositions[ordinalLength-1]>=val){ordinalIndex=getIndexInArray(ordinalPositions,val)}else{extendedOrdinalPositions=ordinal.getExtendedPositions&&ordinal.getExtendedPositions();if(!(extendedOrdinalPositions&&extendedOrdinalPositions.length)){return val}var length_2=extendedOrdinalPositions.length;if(!slope){slope=(extendedOrdinalPositions[length_2-1]-extendedOrdinalPositions[0])/length_2}var originalPositionsReference=getIndexInArray(extendedOrdinalPositions,ordinalPositions[0]);if(val>=extendedOrdinalPositions[0]&&val<=extendedOrdinalPositions[length_2-1]){ordinalIndex=getIndexInArray(extendedOrdinalPositions,val)-originalPositionsReference}else{if(!toIndex){return val}if(val<extendedOrdinalPositions[0]){var diff=extendedOrdinalPositions[0]-val,approximateIndexOffset=diff/slope;ordinalIndex=-originalPositionsReference-approximateIndexOffset}else{var diff=val-extendedOrdinalPositions[length_2-1],approximateIndexOffset=diff/slope;ordinalIndex=approximateIndexOffset+length_2-originalPositionsReference}}}return toIndex?ordinalIndex:slope*(ordinalIndex||0)+ordinal.offset}var Additions=function(){function Additions(axis){this.index={};this.axis=axis}Additions.prototype.beforeSetTickPositions=function(){var _a;var axis=this.axis,ordinal=axis.ordinal,extremes=axis.getExtremes(),min=extremes.min,max=extremes.max,hasBreaks=(_a=axis.brokenAxis)===null||_a===void 0?void 0:_a.hasBreaks,isOrdinal=axis.options.ordinal;var len,uniqueOrdinalPositions,dist,minIndex,maxIndex,slope,i,ordinalPositions=[],overscrollPointsRange=Number.MAX_VALUE,useOrdinal=false,adjustOrdinalExtremesPoints=false,isBoosted=false;if(isOrdinal||hasBreaks){var distanceBetweenPoint_1=0;axis.series.forEach(function(series,i){var xData=series.getColumn("x",true);uniqueOrdinalPositions=[];if(i>0&&series.options.id!=="highcharts-navigator-series"&&xData.length>1){adjustOrdinalExtremesPoints=distanceBetweenPoint_1!==xData[1]-xData[0]}distanceBetweenPoint_1=xData[1]-xData[0];if(series.boosted){isBoosted=series.boosted}if(series.reserveSpace()&&(series.takeOrdinalPosition!==false||hasBreaks)){ordinalPositions=ordinalPositions.concat(xData);len=ordinalPositions.length;ordinalPositions.sort(function(a,b){return a-b});overscrollPointsRange=Math.min(overscrollPointsRange,pick(series.closestPointRange,overscrollPointsRange));if(len){i=0;while(i<len-1){if(ordinalPositions[i]!==ordinalPositions[i+1]){uniqueOrdinalPositions.push(ordinalPositions[i+1])}i++}if(uniqueOrdinalPositions[0]!==ordinalPositions[0]){uniqueOrdinalPositions.unshift(ordinalPositions[0])}ordinalPositions=uniqueOrdinalPositions}}});if(!axis.ordinal.originalOrdinalRange){axis.ordinal.originalOrdinalRange=(ordinalPositions.length-1)*overscrollPointsRange}if(adjustOrdinalExtremesPoints&&isBoosted){ordinalPositions.pop();ordinalPositions.shift()}len=ordinalPositions.length;if(len>2){dist=ordinalPositions[1]-ordinalPositions[0];i=len-1;while(i--&&!useOrdinal){if(ordinalPositions[i+1]-ordinalPositions[i]!==dist){useOrdinal=true}}if(!axis.options.keepOrdinalPadding&&(ordinalPositions[0]-min>dist||max-ordinalPositions[ordinalPositions.length-1]>dist)){useOrdinal=true}}else if(axis.options.overscroll){if(len===2){overscrollPointsRange=ordinalPositions[1]-ordinalPositions[0]}else if(len===1){overscrollPointsRange=axis.ordinal.convertOverscroll(axis.options.overscroll);ordinalPositions=[ordinalPositions[0],ordinalPositions[0]+overscrollPointsRange]}else{overscrollPointsRange=ordinal.overscrollPointsRange}}if(useOrdinal||axis.forceOrdinal){if(axis.options.overscroll){ordinal.overscrollPointsRange=overscrollPointsRange;ordinalPositions=ordinalPositions.concat(ordinal.getOverscrollPositions())}ordinal.positions=ordinalPositions;minIndex=axis.ordinal2lin(Math.max(min,ordinalPositions[0]),true);maxIndex=Math.max(axis.ordinal2lin(Math.min(max,ordinalPositions[ordinalPositions.length-1]),true),1);ordinal.slope=slope=(max-min)/(maxIndex-minIndex);ordinal.offset=min-minIndex*slope}else{ordinal.overscrollPointsRange=pick(axis.closestPointRange,ordinal.overscrollPointsRange);ordinal.positions=axis.ordinal.slope=ordinal.offset=void 0}}axis.isOrdinal=isOrdinal&&useOrdinal;ordinal.groupIntervalFactor=null};Additions.findIndexOf=function(sortedArray,key,indirectSearch){var start=0,end=sortedArray.length-1,middle;while(start<end){middle=Math.ceil((start+end)/2);if(sortedArray[middle]<=key){start=middle}else{end=middle-1}}if(sortedArray[start]===key){return start}return!indirectSearch?-1:start};Additions.prototype.getExtendedPositions=function(withOverscroll){if(withOverscroll===void 0){withOverscroll=true}var ordinal=this,axis=ordinal.axis,axisProto=axis.constructor.prototype,chart=axis.chart,key=axis.series.reduce(function(k,series){var grouping=series.currentDataGrouping;return k+(grouping?grouping.count+grouping.unitName:"raw")},""),overscroll=withOverscroll?axis.ordinal.convertOverscroll(axis.options.overscroll):0,extremes=axis.getExtremes();var fakeAxis,fakeSeries=void 0,ordinalIndex=ordinal.index;if(!ordinalIndex){ordinalIndex=ordinal.index={}}if(!ordinalIndex[key]){fakeAxis={series:[],chart:chart,forceOrdinal:false,getExtremes:function(){return{min:extremes.dataMin,max:extremes.dataMax+overscroll}},applyGrouping:axisProto.applyGrouping,getGroupPixelWidth:axisProto.getGroupPixelWidth,getTimeTicks:axisProto.getTimeTicks,options:{ordinal:true},ordinal:{getGroupIntervalFactor:this.getGroupIntervalFactor},ordinal2lin:axisProto.ordinal2lin,getIndexOfPoint:axisProto.getIndexOfPoint,val2lin:axisProto.val2lin};fakeAxis.ordinal.axis=fakeAxis;axis.series.forEach(function(series){var _a,_b,_c;fakeSeries={xAxis:fakeAxis,chart:chart,groupPixelWidth:series.groupPixelWidth,destroyGroupedData:H.noop,getColumn:series.getColumn,applyGrouping:series.applyGrouping,getProcessedData:series.getProcessedData,reserveSpace:series.reserveSpace,visible:series.visible};var xData=series.getColumn("x").concat(withOverscroll?ordinal.getOverscrollPositions():[]);fakeSeries.dataTable=new DataTableCore({columns:{x:xData}});fakeSeries.options=__assign(__assign({},series.options),{dataGrouping:series.currentDataGrouping?{firstAnchor:(_a=series.options.dataGrouping)===null||_a===void 0?void 0:_a.firstAnchor,anchor:(_b=series.options.dataGrouping)===null||_b===void 0?void 0:_b.anchor,lastAnchor:(_c=series.options.dataGrouping)===null||_c===void 0?void 0:_c.firstAnchor,enabled:true,forced:true,approximation:"open",units:[[series.currentDataGrouping.unitName,[series.currentDataGrouping.count]]]}:{enabled:false}});fakeAxis.series.push(fakeSeries);series.processData.apply(fakeSeries)});fakeAxis.applyGrouping({hasExtremesChanged:true});if((fakeSeries===null||fakeSeries===void 0?void 0:fakeSeries.closestPointRange)!==(fakeSeries===null||fakeSeries===void 0?void 0:fakeSeries.basePointRange)&&fakeSeries.currentDataGrouping){fakeAxis.forceOrdinal=true}axis.ordinal.beforeSetTickPositions.apply({axis:fakeAxis});if(!axis.ordinal.originalOrdinalRange&&fakeAxis.ordinal.originalOrdinalRange){axis.ordinal.originalOrdinalRange=fakeAxis.ordinal.originalOrdinalRange}if(fakeAxis.ordinal.positions){ordinalIndex[key]=fakeAxis.ordinal.positions}}return ordinalIndex[key]};Additions.prototype.getGroupIntervalFactor=function(xMin,xMax,series){var ordinal=this,processedXData=series.getColumn("x",true),len=processedXData.length,distances=[];var median,i,groupIntervalFactor=ordinal.groupIntervalFactor;if(!groupIntervalFactor){for(i=0;i<len-1;i++){distances[i]=processedXData[i+1]-processedXData[i]}distances.sort(function(a,b){return a-b});median=distances[Math.floor(len/2)];xMin=Math.max(xMin,processedXData[0]);xMax=Math.min(xMax,processedXData[len-1]);ordinal.groupIntervalFactor=groupIntervalFactor=len*median/(xMax-xMin)}return groupIntervalFactor};Additions.prototype.getIndexOfPoint=function(pixelVal,ordinalArray){var ordinal=this,axis=ordinal.axis,min=axis.min,minX=axis.minPixelPadding,indexOfMin=getIndexInArray(ordinalArray,min);var ordinalPointPixelInterval=axis.translationSlope*(ordinal.slope||axis.closestPointRange||ordinal.overscrollPointsRange);var shiftIndex=correctFloat((pixelVal-minX)/ordinalPointPixelInterval);return indexOfMin+shiftIndex};Additions.prototype.getOverscrollPositions=function(){var ordinal=this,axis=ordinal.axis,extraRange=ordinal.convertOverscroll(axis.options.overscroll),distance=ordinal.overscrollPointsRange,positions=[];var max=axis.dataMax;if(defined(distance)){while(max<axis.dataMax+extraRange){max+=distance;positions.push(max)}}return positions};Additions.prototype.postProcessTickInterval=function(tickInterval){var ordinal=this,axis=ordinal.axis,ordinalSlope=ordinal.slope,closestPointRange=axis.closestPointRange;var ret;if(ordinalSlope&&closestPointRange){if(!axis.options.breaks){ret=tickInterval/(ordinalSlope/closestPointRange)}else{ret=closestPointRange||tickInterval}}else{ret=tickInterval}return ret};Additions.prototype.convertOverscroll=function(overscroll){if(overscroll===void 0){overscroll=0}var ordinal=this,axis=ordinal.axis,calculateOverscroll=function(overscrollPercentage){return pick(ordinal.originalOrdinalRange,defined(axis.dataMax)&&defined(axis.dataMin)?axis.dataMax-axis.dataMin:0)*overscrollPercentage};if(isString(overscroll)){var overscrollValue=parseInt(overscroll,10);if(/%$/.test(overscroll)){return calculateOverscroll(overscrollValue/100)}if(/px/.test(overscroll)){var limitedOverscrollValue=Math.min(overscrollValue,axis.len*.9),pixelToPercent=limitedOverscrollValue/axis.len;return calculateOverscroll(pixelToPercent/(1-pixelToPercent))}return 0}return overscroll};return Additions}();OrdinalAxis.Additions=Additions})(OrdinalAxis||(OrdinalAxis={}));export default OrdinalAxis;