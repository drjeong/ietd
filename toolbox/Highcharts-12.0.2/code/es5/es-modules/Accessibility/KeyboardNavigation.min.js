"use strict";import H from"../Core/Globals.js";var doc=H.doc,win=H.win;import MenuComponent from"./Components/MenuComponent.js";import U from"../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,fireEvent=U.fireEvent;import EventProvider from"./Utils/EventProvider.js";import HTMLUtilities from"./Utils/HTMLUtilities.js";var getElement=HTMLUtilities.getElement,simulatedEventTarget=HTMLUtilities.simulatedEventTarget;var KeyboardNavigation=function(){function KeyboardNavigation(chart,components){this.currentModuleIx=NaN;this.modules=[];this.init(chart,components)}KeyboardNavigation.prototype.init=function(chart,components){var _this=this;var ep=this.eventProvider=new EventProvider;this.chart=chart;this.components=components;this.modules=[];this.currentModuleIx=0;this.update();ep.addEvent(this.tabindexContainer,"keydown",function(e){return _this.onKeydown(e)});ep.addEvent(this.tabindexContainer,"focus",function(e){return _this.onFocus(e)});["mouseup","touchend"].forEach(function(eventName){return ep.addEvent(doc,eventName,function(e){return _this.onMouseUp(e)})});["mousedown","touchstart"].forEach(function(eventName){return ep.addEvent(chart.renderTo,eventName,function(){_this.isClickingChart=true})})};KeyboardNavigation.prototype.update=function(order){var a11yOptions=this.chart.options.accessibility,keyboardOptions=a11yOptions&&a11yOptions.keyboardNavigation,components=this.components;this.updateContainerTabindex();if(keyboardOptions&&keyboardOptions.enabled&&order&&order.length){this.modules=order.reduce(function(modules,componentName){var navModules=components[componentName].getKeyboardNavigation();return modules.concat(navModules)},[]);this.updateExitAnchor()}else{this.modules=[];this.currentModuleIx=0;this.removeExitAnchor()}};KeyboardNavigation.prototype.updateExitAnchor=function(){var endMarkerId="highcharts-end-of-chart-marker-".concat(this.chart.index),endMarker=getElement(endMarkerId);this.removeExitAnchor();if(endMarker){this.makeElementAnExitAnchor(endMarker);this.exitAnchor=endMarker}else{this.createExitAnchor()}};KeyboardNavigation.prototype.move=function(direction){var curModule=this.modules&&this.modules[this.currentModuleIx];if(curModule&&curModule.terminate){curModule.terminate(direction)}if(this.chart.focusElement){this.chart.focusElement.removeFocusBorder()}this.currentModuleIx+=direction;var newModule=this.modules&&this.modules[this.currentModuleIx];if(newModule){if(newModule.validate&&!newModule.validate()){return this.move(direction)}if(newModule.init){newModule.init(direction);return true}}this.currentModuleIx=0;this.exiting=true;if(direction>0){this.exitAnchor&&this.exitAnchor.focus()}else{this.tabindexContainer.focus()}return false};KeyboardNavigation.prototype.onFocus=function(e){var chart=this.chart,focusComesFromChart=e.relatedTarget&&chart.container.contains(e.relatedTarget),a11yOptions=chart.options.accessibility,keyboardOptions=a11yOptions&&a11yOptions.keyboardNavigation,enabled=keyboardOptions&&keyboardOptions.enabled;if(enabled&&!this.exiting&&!this.tabbingInBackwards&&!this.isClickingChart&&!focusComesFromChart){var ix=this.getFirstValidModuleIx();if(ix!==null){this.currentModuleIx=ix;this.modules[ix].init(1)}}this.keyboardReset=false;this.exiting=false};KeyboardNavigation.prototype.onMouseUp=function(e){delete this.isClickingChart;if(!this.keyboardReset&&e.relatedTarget!==simulatedEventTarget){var chart=this.chart;if(!e.target||!chart.container.contains(e.target)){var curMod=this.modules&&this.modules[this.currentModuleIx||0];if(curMod&&curMod.terminate){curMod.terminate()}this.currentModuleIx=0}if(chart.focusElement){chart.focusElement.removeFocusBorder();delete chart.focusElement}this.keyboardReset=true}};KeyboardNavigation.prototype.onKeydown=function(ev){var e=ev||win.event,curNavModule=this.modules&&this.modules.length&&this.modules[this.currentModuleIx];var preventDefault;var target=e.target;if(target&&target.nodeName==="INPUT"&&!target.classList.contains("highcharts-a11y-proxy-element")){return}this.keyboardReset=false;this.exiting=false;if(curNavModule){var response=curNavModule.run(e);if(response===curNavModule.response.success){preventDefault=true}else if(response===curNavModule.response.prev){preventDefault=this.move(-1)}else if(response===curNavModule.response.next){preventDefault=this.move(1)}if(preventDefault){e.preventDefault();e.stopPropagation()}}};KeyboardNavigation.prototype.updateContainerTabindex=function(){var a11yOptions=this.chart.options.accessibility,keyboardOptions=a11yOptions&&a11yOptions.keyboardNavigation,shouldHaveTabindex=!(keyboardOptions&&keyboardOptions.enabled===false),chart=this.chart,container=chart.container;var tabindexContainer;if(chart.renderTo.hasAttribute("tabindex")){container.removeAttribute("tabindex");tabindexContainer=chart.renderTo}else{tabindexContainer=container}this.tabindexContainer=tabindexContainer;var curTabindex=tabindexContainer.getAttribute("tabindex");if(shouldHaveTabindex&&!curTabindex){tabindexContainer.setAttribute("tabindex","0")}else if(!shouldHaveTabindex){chart.container.removeAttribute("tabindex")}};KeyboardNavigation.prototype.createExitAnchor=function(){var chart=this.chart,exitAnchor=this.exitAnchor=doc.createElement("div");chart.renderTo.appendChild(exitAnchor);this.makeElementAnExitAnchor(exitAnchor)};KeyboardNavigation.prototype.makeElementAnExitAnchor=function(el){var chartTabindex=this.tabindexContainer.getAttribute("tabindex")||0;el.setAttribute("class","highcharts-exit-anchor");el.setAttribute("tabindex",chartTabindex);el.setAttribute("aria-hidden",false);this.addExitAnchorEventsToEl(el)};KeyboardNavigation.prototype.removeExitAnchor=function(){var _this=this;if(this.exitAnchor){var el=this.eventProvider.eventRemovers.find(function(el){return el.element===_this.exitAnchor});if(el&&defined(el.remover)){this.eventProvider.removeEvent(el.remover)}if(this.exitAnchor.parentNode){this.exitAnchor.parentNode.removeChild(this.exitAnchor)}delete this.exitAnchor}};KeyboardNavigation.prototype.addExitAnchorEventsToEl=function(element){var chart=this.chart,keyboardNavigation=this;this.eventProvider.addEvent(element,"focus",function(ev){var e=ev||win.event,focusComesFromChart=e.relatedTarget&&chart.container.contains(e.relatedTarget),comingInBackwards=!(focusComesFromChart||keyboardNavigation.exiting);if(chart.focusElement){delete chart.focusElement}if(comingInBackwards){keyboardNavigation.tabbingInBackwards=true;keyboardNavigation.tabindexContainer.focus();delete keyboardNavigation.tabbingInBackwards;e.preventDefault();if(keyboardNavigation.modules&&keyboardNavigation.modules.length){keyboardNavigation.currentModuleIx=keyboardNavigation.modules.length-1;var curModule=keyboardNavigation.modules[keyboardNavigation.currentModuleIx];if(curModule&&curModule.validate&&!curModule.validate()){keyboardNavigation.move(-1)}else if(curModule){curModule.init(-1)}}}else{keyboardNavigation.exiting=false}})};KeyboardNavigation.prototype.getFirstValidModuleIx=function(){var len=this.modules.length;for(var i=0;i<len;++i){var mod=this.modules[i];if(!mod.validate||mod.validate()){return i}}return null};KeyboardNavigation.prototype.destroy=function(){this.removeExitAnchor();this.eventProvider.removeAddedEvents();this.chart.container.removeAttribute("tabindex")};return KeyboardNavigation}();(function(KeyboardNavigation){function compose(ChartClass){MenuComponent.compose(ChartClass);var chartProto=ChartClass.prototype;if(!chartProto.dismissPopupContent){chartProto.dismissPopupContent=chartDismissPopupContent;addEvent(doc,"keydown",documentOnKeydown)}return ChartClass}KeyboardNavigation.compose=compose;function chartDismissPopupContent(){var chart=this;fireEvent(this,"dismissPopupContent",{},function(){if(chart.tooltip){chart.tooltip.hide(0)}chart.hideExportMenu()})}function documentOnKeydown(e){var keycode=e.which||e.keyCode;var esc=27;if(keycode===esc&&H.charts){H.charts.forEach(function(chart){if(chart&&chart.dismissPopupContent){chart.dismissPopupContent()}})}}})(KeyboardNavigation||(KeyboardNavigation={}));export default KeyboardNavigation;