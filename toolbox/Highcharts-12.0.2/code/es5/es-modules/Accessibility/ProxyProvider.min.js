"use strict";import H from"../Core/Globals.js";var doc=H.doc;import U from"../Core/Utilities.js";var attr=U.attr,css=U.css;import CU from"./Utils/ChartUtilities.js";var unhideChartElementFromAT=CU.unhideChartElementFromAT;import DOMElementProvider from"./Utils/DOMElementProvider.js";import HU from"./Utils/HTMLUtilities.js";var removeChildNodes=HU.removeChildNodes;import ProxyElement from"./ProxyElement.js";var ProxyProvider=function(){function ProxyProvider(chart){this.chart=chart;this.domElementProvider=new DOMElementProvider;this.groups={};this.groupOrder=[];this.beforeChartProxyPosContainer=this.createProxyPosContainer("before");this.afterChartProxyPosContainer=this.createProxyPosContainer("after");this.update()}ProxyProvider.prototype.addProxyElement=function(groupKey,target,proxyElementType,attributes){if(proxyElementType===void 0){proxyElementType="button"}var group=this.groups[groupKey];if(!group){throw new Error("ProxyProvider.addProxyElement: Invalid group key "+groupKey)}var wrapperElementType=group.type==="ul"||group.type==="ol"?"li":void 0,proxy=new ProxyElement(this.chart,target,proxyElementType,wrapperElementType,attributes);group.proxyContainerElement.appendChild(proxy.element);group.proxyElements.push(proxy);return proxy};ProxyProvider.prototype.addGroup=function(groupKey,groupElementType,attributes){if(groupElementType===void 0){groupElementType="div"}var existingGroup=this.groups[groupKey];if(existingGroup){return existingGroup.groupElement}var proxyContainer=this.domElementProvider.createElement(groupElementType);var groupElement;if(attributes&&attributes.role&&groupElementType!=="div"){groupElement=this.domElementProvider.createElement("div");groupElement.appendChild(proxyContainer)}else{groupElement=proxyContainer}groupElement.className="highcharts-a11y-proxy-group highcharts-a11y-proxy-group-"+groupKey.replace(/\W/g,"-");this.groups[groupKey]={proxyContainerElement:proxyContainer,groupElement:groupElement,type:groupElementType,proxyElements:[]};attr(groupElement,attributes||{});if(groupElementType==="ul"){proxyContainer.setAttribute("role","list")}this.afterChartProxyPosContainer.appendChild(groupElement);this.updateGroupOrder(this.groupOrder);return groupElement};ProxyProvider.prototype.updateGroupAttrs=function(groupKey,attributes){var group=this.groups[groupKey];if(!group){throw new Error("ProxyProvider.updateGroupAttrs: Invalid group key "+groupKey)}attr(group.groupElement,attributes)};ProxyProvider.prototype.updateGroupOrder=function(groupKeys){var _this=this;this.groupOrder=groupKeys.slice();if(this.isDOMOrderGroupOrder()){return}var seriesIx=groupKeys.indexOf("series");var beforeKeys=seriesIx>-1?groupKeys.slice(0,seriesIx):groupKeys;var afterKeys=seriesIx>-1?groupKeys.slice(seriesIx+1):[];var activeElement=doc.activeElement;["before","after"].forEach(function(pos){var posContainer=_this[pos==="before"?"beforeChartProxyPosContainer":"afterChartProxyPosContainer"];var keys=pos==="before"?beforeKeys:afterKeys;removeChildNodes(posContainer);keys.forEach(function(groupKey){var group=_this.groups[groupKey];if(group){posContainer.appendChild(group.groupElement)}})});if((this.beforeChartProxyPosContainer.contains(activeElement)||this.afterChartProxyPosContainer.contains(activeElement))&&activeElement&&activeElement.focus){activeElement.focus()}};ProxyProvider.prototype.clearGroup=function(groupKey){var group=this.groups[groupKey];if(!group){throw new Error("ProxyProvider.clearGroup: Invalid group key "+groupKey)}removeChildNodes(group.proxyContainerElement)};ProxyProvider.prototype.removeGroup=function(groupKey){var group=this.groups[groupKey];if(group){this.domElementProvider.removeElement(group.groupElement);if(group.groupElement!==group.proxyContainerElement){this.domElementProvider.removeElement(group.proxyContainerElement)}delete this.groups[groupKey]}};ProxyProvider.prototype.update=function(){this.updatePosContainerPositions();this.updateGroupOrder(this.groupOrder);this.updateProxyElementPositions()};ProxyProvider.prototype.updateProxyElementPositions=function(){Object.keys(this.groups).forEach(this.updateGroupProxyElementPositions.bind(this))};ProxyProvider.prototype.updateGroupProxyElementPositions=function(groupKey){var group=this.groups[groupKey];if(group){group.proxyElements.forEach(function(el){return el.refreshPosition()})}};ProxyProvider.prototype.destroy=function(){this.domElementProvider.destroyCreatedElements()};ProxyProvider.prototype.createProxyPosContainer=function(classNamePostfix){var el=this.domElementProvider.createElement("div");el.setAttribute("aria-hidden","false");el.className="highcharts-a11y-proxy-container"+(classNamePostfix?"-"+classNamePostfix:"");css(el,{top:"0",left:"0"});if(!this.chart.styledMode){el.style.whiteSpace="nowrap";el.style.position="absolute"}return el};ProxyProvider.prototype.getCurrentGroupOrderInDOM=function(){var _this=this;var getGroupKeyFromElement=function(el){var allGroups=Object.keys(_this.groups);var i=allGroups.length;while(i--){var groupKey=allGroups[i];var group=_this.groups[groupKey];if(group&&el===group.groupElement){return groupKey}}};var getChildrenGroupOrder=function(el){var childrenOrder=[];var children=el.children;for(var i=0;i<children.length;++i){var groupKey=getGroupKeyFromElement(children[i]);if(groupKey){childrenOrder.push(groupKey)}}return childrenOrder};var before=getChildrenGroupOrder(this.beforeChartProxyPosContainer);var after=getChildrenGroupOrder(this.afterChartProxyPosContainer);before.push("series");return before.concat(after)};ProxyProvider.prototype.isDOMOrderGroupOrder=function(){var _this=this;var domOrder=this.getCurrentGroupOrderInDOM();var groupOrderWithGroups=this.groupOrder.filter(function(x){return x==="series"||!!_this.groups[x]});var i=domOrder.length;if(i!==groupOrderWithGroups.length){return false}while(i--){if(domOrder[i]!==groupOrderWithGroups[i]){return false}}return true};ProxyProvider.prototype.updatePosContainerPositions=function(){var chart=this.chart;if(chart.renderer.forExport){return}var rendererSVGEl=chart.renderer.box;chart.container.insertBefore(this.afterChartProxyPosContainer,rendererSVGEl.nextSibling);chart.container.insertBefore(this.beforeChartProxyPosContainer,rendererSVGEl);unhideChartElementFromAT(this.chart,this.afterChartProxyPosContainer);unhideChartElementFromAT(this.chart,this.beforeChartProxyPosContainer)};return ProxyProvider}();export default ProxyProvider;