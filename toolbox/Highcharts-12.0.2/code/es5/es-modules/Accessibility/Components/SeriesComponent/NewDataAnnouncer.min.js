"use strict";import H from"../../../Core/Globals.js";var composed=H.composed;import U from"../../../Core/Utilities.js";var addEvent=U.addEvent,defined=U.defined,pushUnique=U.pushUnique;import Announcer from"../../Utils/Announcer.js";import ChartUtilities from"../../Utils/ChartUtilities.js";var getChartTitle=ChartUtilities.getChartTitle;import EventProvider from"../../Utils/EventProvider.js";import SeriesDescriber from"./SeriesDescriber.js";var defaultPointDescriptionFormatter=SeriesDescriber.defaultPointDescriptionFormatter,defaultSeriesDescriptionFormatter=SeriesDescriber.defaultSeriesDescriptionFormatter;function chartHasAnnounceEnabled(chart){return!!chart.options.accessibility.announceNewData.enabled}function findPointInDataArray(point){var candidates=point.series.data.filter(function(candidate){return point.x===candidate.x&&point.y===candidate.y});return candidates.length===1?candidates[0]:point}function getUniqueSeries(arrayA,arrayB){var uniqueSeries=(arrayA||[]).concat(arrayB||[]).reduce(function(acc,cur){acc[cur.name+cur.index]=cur;return acc},{});return Object.keys(uniqueSeries).map(function(ix){return uniqueSeries[ix]})}var NewDataAnnouncer=function(){function NewDataAnnouncer(chart){this.dirty={allSeries:{}};this.lastAnnouncementTime=0;this.chart=chart}NewDataAnnouncer.prototype.init=function(){var chart=this.chart;var announceOptions=chart.options.accessibility.announceNewData;var announceType=announceOptions.interruptUser?"assertive":"polite";this.lastAnnouncementTime=0;this.dirty={allSeries:{}};this.eventProvider=new EventProvider;this.announcer=new Announcer(chart,announceType);this.addEventListeners()};NewDataAnnouncer.prototype.destroy=function(){this.eventProvider.removeAddedEvents();this.announcer.destroy()};NewDataAnnouncer.prototype.addEventListeners=function(){var announcer=this,chart=this.chart,e=this.eventProvider;e.addEvent(chart,"afterApplyDrilldown",function(){announcer.lastAnnouncementTime=0});e.addEvent(chart,"afterAddSeries",function(e){announcer.onSeriesAdded(e.series)});e.addEvent(chart,"redraw",function(){announcer.announceDirtyData()})};NewDataAnnouncer.prototype.onSeriesAdded=function(series){if(chartHasAnnounceEnabled(this.chart)){this.dirty.hasDirty=true;this.dirty.allSeries[series.name+series.index]=series;this.dirty.newSeries=defined(this.dirty.newSeries)?void 0:series}};NewDataAnnouncer.prototype.announceDirtyData=function(){var chart=this.chart,announcer=this;if(chart.options.accessibility.announceNewData&&this.dirty.hasDirty){var newPoint=this.dirty.newPoint;if(newPoint){newPoint=findPointInDataArray(newPoint)}this.queueAnnouncement(Object.keys(this.dirty.allSeries).map(function(ix){return announcer.dirty.allSeries[ix]}),this.dirty.newSeries,newPoint);this.dirty={allSeries:{}}}};NewDataAnnouncer.prototype.queueAnnouncement=function(dirtySeries,newSeries,newPoint){var _this=this;var chart=this.chart;var annOptions=chart.options.accessibility.announceNewData;if(annOptions.enabled){var now=+new Date;var dTime=now-this.lastAnnouncementTime;var time=Math.max(0,annOptions.minAnnounceInterval-dTime);var allSeries=getUniqueSeries(this.queuedAnnouncement&&this.queuedAnnouncement.series,dirtySeries);var message=this.buildAnnouncementMessage(allSeries,newSeries,newPoint);if(message){if(this.queuedAnnouncement){clearTimeout(this.queuedAnnouncementTimer)}this.queuedAnnouncement={time:now,message:message,series:allSeries};this.queuedAnnouncementTimer=setTimeout(function(){if(_this&&_this.announcer){_this.lastAnnouncementTime=+new Date;_this.announcer.announce(_this.queuedAnnouncement.message);delete _this.queuedAnnouncement;delete _this.queuedAnnouncementTimer}},time)}}};NewDataAnnouncer.prototype.buildAnnouncementMessage=function(dirtySeries,newSeries,newPoint){var chart=this.chart,annOptions=chart.options.accessibility.announceNewData;if(annOptions.announcementFormatter){var formatterRes=annOptions.announcementFormatter(dirtySeries,newSeries,newPoint);if(formatterRes!==false){return formatterRes.length?formatterRes:null}}var multiple=H.charts&&H.charts.length>1?"Multiple":"Single",langKey=newSeries?"newSeriesAnnounce"+multiple:newPoint?"newPointAnnounce"+multiple:"newDataAnnounce",chartTitle=getChartTitle(chart);return chart.langFormat("accessibility.announceNewData."+langKey,{chartTitle:chartTitle,seriesDesc:newSeries?defaultSeriesDescriptionFormatter(newSeries):null,pointDesc:newPoint?defaultPointDescriptionFormatter(newPoint):null,point:newPoint,series:newSeries})};return NewDataAnnouncer}();(function(NewDataAnnouncer){function compose(SeriesClass){if(pushUnique(composed,"A11y.NDA")){addEvent(SeriesClass,"addPoint",seriesOnAddPoint);addEvent(SeriesClass,"updatedData",seriesOnUpdatedData)}}NewDataAnnouncer.compose=compose;function seriesOnAddPoint(e){var _a;var chart=this.chart,newDataAnnouncer=(_a=chart.accessibility)===null||_a===void 0?void 0:_a.components.series.newDataAnnouncer;if(newDataAnnouncer&&newDataAnnouncer.chart===chart&&chartHasAnnounceEnabled(chart)){newDataAnnouncer.dirty.newPoint=defined(newDataAnnouncer.dirty.newPoint)?void 0:e.point}}function seriesOnUpdatedData(){var _a;var chart=this.chart,newDataAnnouncer=(_a=chart.accessibility)===null||_a===void 0?void 0:_a.components.series.newDataAnnouncer;if(newDataAnnouncer&&newDataAnnouncer.chart===chart&&chartHasAnnounceEnabled(chart)){newDataAnnouncer.dirty.hasDirty=true;newDataAnnouncer.dirty.allSeries[this.name+this.index]=this}}})(NewDataAnnouncer||(NewDataAnnouncer={}));export default NewDataAnnouncer;