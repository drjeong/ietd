"use strict";import AxisResizerDefaults from"./AxisResizerDefaults.js";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,clamp=U.clamp,isNumber=U.isNumber,relativeLength=U.relativeLength;var AxisResizer=function(){function AxisResizer(axis){this.init(axis)}AxisResizer.prototype.init=function(axis,update){this.axis=axis;this.options=axis.options.resize||{};this.render();if(!update){this.addMouseEvents()}};AxisResizer.prototype.render=function(){var resizer=this,axis=resizer.axis,chart=axis.chart,options=resizer.options,x=options.x||0,y=options.y,pos=clamp(axis.top+axis.height+y,chart.plotTop,chart.plotTop+chart.plotHeight);var attr={};if(!chart.styledMode){attr={cursor:options.cursor,stroke:options.lineColor,"stroke-width":options.lineWidth,dashstyle:options.lineDashStyle}}resizer.lastPos=pos-y;if(!resizer.controlLine){resizer.controlLine=chart.renderer.path().addClass("highcharts-axis-resizer")}resizer.controlLine.add(axis.axisGroup);var lineWidth=chart.styledMode?resizer.controlLine.strokeWidth():options.lineWidth;attr.d=chart.renderer.crispLine([["M",axis.left+x,pos],["L",axis.left+axis.width+x,pos]],lineWidth);resizer.controlLine.attr(attr)};AxisResizer.prototype.addMouseEvents=function(){var resizer=this,ctrlLineElem=resizer.controlLine.element,container=resizer.axis.chart.container,eventsToUnbind=[];var mouseMoveHandler,mouseUpHandler,mouseDownHandler;resizer.mouseMoveHandler=mouseMoveHandler=function(e){return resizer.onMouseMove(e)};resizer.mouseUpHandler=mouseUpHandler=function(e){return resizer.onMouseUp(e)};resizer.mouseDownHandler=mouseDownHandler=function(){return resizer.onMouseDown()};eventsToUnbind.push(addEvent(container,"mousemove",mouseMoveHandler),addEvent(container.ownerDocument,"mouseup",mouseUpHandler),addEvent(ctrlLineElem,"mousedown",mouseDownHandler),addEvent(container,"touchmove",mouseMoveHandler),addEvent(container.ownerDocument,"touchend",mouseUpHandler),addEvent(ctrlLineElem,"touchstart",mouseDownHandler));resizer.eventsToUnbind=eventsToUnbind};AxisResizer.prototype.onMouseMove=function(e){if(!e.touches||e.touches[0].pageX!==0){var pointer=this.axis.chart.pointer;if(this.grabbed&&pointer){this.hasDragged=true;this.updateAxes(pointer.normalize(e).chartY-(this.options.y||0))}}};AxisResizer.prototype.onMouseUp=function(e){var pointer=this.axis.chart.pointer;if(this.hasDragged&&pointer){this.updateAxes(pointer.normalize(e).chartY-(this.options.y||0))}this.grabbed=this.hasDragged=this.axis.chart.activeResizer=void 0};AxisResizer.prototype.onMouseDown=function(){var _a;(_a=this.axis.chart.pointer)===null||_a===void 0?void 0:_a.reset(false,0);this.grabbed=this.axis.chart.activeResizer=true};AxisResizer.prototype.updateAxes=function(chartY){var resizer=this,chart=resizer.axis.chart,axes=resizer.options.controlledAxis,nextAxes=axes.next.length===0?[chart.yAxis.indexOf(resizer.axis)+1]:axes.next,prevAxes=[resizer.axis].concat(axes.prev),axesConfigs=[],plotTop=chart.plotTop,plotHeight=chart.plotHeight,plotBottom=plotTop+plotHeight,calculatePercent=function(value){return value*100/plotHeight+"%"},normalize=function(val,min,max){return Math.round(clamp(val,min,max))};chartY=clamp(chartY,plotTop,plotBottom);var stopDrag=false,yDelta=chartY-resizer.lastPos;if(yDelta*yDelta<1){return}var isFirst=true;for(var _i=0,_a=[prevAxes,nextAxes];_i<_a.length;_i++){var axesGroup=_a[_i];for(var _b=0,axesGroup_1=axesGroup;_b<axesGroup_1.length;_b++){var axisInfo=axesGroup_1[_b];var axis=isNumber(axisInfo)?chart.yAxis[axisInfo]:isFirst?axisInfo:chart.get(axisInfo),axisOptions=axis&&axis.options,optionsToUpdate={};var height=void 0,top_1=void 0;if(!axisOptions||axisOptions.isInternal){isFirst=false;continue}top_1=axis.top;var minLength=Math.round(relativeLength(axisOptions.minLength||NaN,plotHeight)),maxLength=Math.round(relativeLength(axisOptions.maxLength||NaN,plotHeight));if(!isFirst){yDelta=chartY-resizer.lastPos;height=normalize(axis.len-yDelta,minLength,maxLength);top_1=axis.top+yDelta;if(top_1+height>plotBottom){var hDelta=plotBottom-height-top_1;chartY+=hDelta;top_1+=hDelta}if(top_1<plotTop){top_1=plotTop;if(top_1+height>plotBottom){height=plotHeight}}if(height===minLength){stopDrag=true}axesConfigs.push({axis:axis,options:{top:calculatePercent(top_1-plotTop),height:calculatePercent(height)}})}else{height=normalize(chartY-top_1,minLength,maxLength);if(height===maxLength){stopDrag=true}chartY=top_1+height;axesConfigs.push({axis:axis,options:{height:calculatePercent(height)}})}isFirst=false;optionsToUpdate.height=height}}if(!stopDrag){for(var _c=0,axesConfigs_1=axesConfigs;_c<axesConfigs_1.length;_c++){var config=axesConfigs_1[_c];config.axis.update(config.options,false)}chart.redraw(false)}};AxisResizer.prototype.destroy=function(){var resizer=this,axis=resizer.axis;delete axis.resizer;if(this.eventsToUnbind){this.eventsToUnbind.forEach(function(unbind){return unbind()})}resizer.controlLine.destroy();for(var _i=0,_a=Object.keys(resizer);_i<_a.length;_i++){var key=_a[_i];resizer[key]=null}};AxisResizer.resizerOptions=AxisResizerDefaults;return AxisResizer}();export default AxisResizer;