"use strict";import U from"../../Core/Utilities.js";var addEvent=U.addEvent,erase=U.erase,find=U.find,fireEvent=U.fireEvent,pick=U.pick,wrap=U.wrap;function chartAddAnnotation(userOptions,redraw){var annotation=this.initAnnotation(userOptions);this.options.annotations.push(annotation.options);if(pick(redraw,true)){annotation.redraw();annotation.graphic.attr({opacity:1})}return annotation}function chartCallback(){var chart=this;chart.plotBoxClip=this.renderer.clipRect(this.plotBox);chart.controlPointsGroup=chart.renderer.g("control-points").attr({zIndex:99}).clip(chart.plotBoxClip).add();chart.options.annotations.forEach(function(annotationOptions,i){if(!chart.annotations.some(function(annotation){return annotation.options===annotationOptions})){var annotation=chart.initAnnotation(annotationOptions);chart.options.annotations[i]=annotation.options}});chart.drawAnnotations();addEvent(chart,"redraw",chart.drawAnnotations);addEvent(chart,"destroy",function(){chart.plotBoxClip.destroy();chart.controlPointsGroup.destroy()});addEvent(chart,"exportData",function(event){var annotations=chart.annotations,csvColumnHeaderFormatter=(this.options.exporting&&this.options.exporting.csv||{}).columnHeaderFormatter,multiLevelHeaders=!event.dataRows[1].xValues,annotationHeader=chart.options.lang&&chart.options.lang.exportData&&chart.options.lang.exportData.annotationHeader,columnHeaderFormatter=function(index){var s;if(csvColumnHeaderFormatter){s=csvColumnHeaderFormatter(index);if(s!==false){return s}}s=annotationHeader+" "+index;if(multiLevelHeaders){return{columnTitle:s,topLevelColumnTitle:s}}return s},startRowLength=event.dataRows[0].length,annotationSeparator=chart.options.exporting&&chart.options.exporting.csv&&chart.options.exporting.csv.annotations&&chart.options.exporting.csv.annotations.itemDelimiter,joinAnnotations=chart.options.exporting&&chart.options.exporting.csv&&chart.options.exporting.csv.annotations&&chart.options.exporting.csv.annotations.join;annotations.forEach(function(annotation){if(annotation.options.labelOptions&&annotation.options.labelOptions.includeInDataExport){annotation.labels.forEach(function(label){if(label.options.text){var annotationText_1=label.options.text;label.points.forEach(function(points){var annotationX=points.x,xAxisIndex=points.series.xAxis?points.series.xAxis.index:-1;var wasAdded=false;if(xAxisIndex===-1){var n=event.dataRows[0].length,newRow=new Array(n);for(var i=0;i<n;++i){newRow[i]=""}newRow.push(annotationText_1);newRow.xValues=[];newRow.xValues[xAxisIndex]=annotationX;event.dataRows.push(newRow);wasAdded=true}if(!wasAdded){event.dataRows.forEach(function(row){if(!wasAdded&&row.xValues&&xAxisIndex!==void 0&&annotationX===row.xValues[xAxisIndex]){if(joinAnnotations&&row.length>startRowLength){row[row.length-1]+=annotationSeparator+annotationText_1}else{row.push(annotationText_1)}wasAdded=true}})}if(!wasAdded){var n=event.dataRows[0].length,newRow=new Array(n);for(var i=0;i<n;++i){newRow[i]=""}newRow[0]=annotationX;newRow.push(annotationText_1);newRow.xValues=[];if(xAxisIndex!==void 0){newRow.xValues[xAxisIndex]=annotationX}event.dataRows.push(newRow)}})}})}});var maxRowLen=0;event.dataRows.forEach(function(row){maxRowLen=Math.max(maxRowLen,row.length)});var newRows=maxRowLen-event.dataRows[0].length;for(var i=0;i<newRows;i++){var header=columnHeaderFormatter(i+1);if(multiLevelHeaders){event.dataRows[0].push(header.topLevelColumnTitle);event.dataRows[1].push(header.columnTitle)}else{event.dataRows[0].push(header)}}})}function chartDrawAnnotations(){this.plotBoxClip.attr(this.plotBox);this.annotations.forEach(function(annotation){annotation.redraw();annotation.graphic.animate({opacity:1},annotation.animationConfig)})}function chartRemoveAnnotation(idOrAnnotation){var annotations=this.annotations,annotation=idOrAnnotation.coll==="annotations"?idOrAnnotation:find(annotations,function(annotation){return annotation.options.id===idOrAnnotation});if(annotation){fireEvent(annotation,"remove");erase(this.options.annotations,annotation.options);erase(annotations,annotation);annotation.destroy()}}function onChartAfterInit(){var chart=this;chart.annotations=[];if(!this.options.annotations){this.options.annotations=[]}}function wrapPointerOnContainerMouseDown(proceed){if(!this.chart.hasDraggedAnnotation){proceed.apply(this,Array.prototype.slice.call(arguments,1))}}var AnnotationChart;(function(AnnotationChart){function compose(AnnotationClass,ChartClass,PointerClass){var chartProto=ChartClass.prototype;if(!chartProto.addAnnotation){var pointerProto=PointerClass.prototype;addEvent(ChartClass,"afterInit",onChartAfterInit);chartProto.addAnnotation=chartAddAnnotation;chartProto.callbacks.push(chartCallback);chartProto.collectionsWithInit.annotations=[chartAddAnnotation];chartProto.collectionsWithUpdate.push("annotations");chartProto.drawAnnotations=chartDrawAnnotations;chartProto.removeAnnotation=chartRemoveAnnotation;chartProto.initAnnotation=function chartInitAnnotation(userOptions){var Constructor=AnnotationClass.types[userOptions.type]||AnnotationClass,annotation=new Constructor(this,userOptions);this.annotations.push(annotation);return annotation};wrap(pointerProto,"onContainerMouseDown",wrapPointerOnContainerMouseDown)}}AnnotationChart.compose=compose})(AnnotationChart||(AnnotationChart={}));export default AnnotationChart;