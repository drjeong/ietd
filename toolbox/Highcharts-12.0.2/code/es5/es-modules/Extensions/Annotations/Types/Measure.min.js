"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();import Annotation from"../Annotation.js";import ControlPoint from"../ControlPoint.js";import U from"../../../Core/Utilities.js";var defined=U.defined,extend=U.extend,isNumber=U.isNumber,merge=U.merge,pick=U.pick;function average(){var average="";if(this.max!==""&&this.min!==""){average=(this.max+this.min)/2}return average}function bins(){var series=this.chart.series,ext=getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax);var bins=0,isCalculated=false;series.forEach(function(serie){if(serie.visible&&serie.options.id!=="highcharts-navigator-series"){serie.points.forEach(function(point){if(!point.isNull&&point.x>ext.xAxisMin&&point.x<=ext.xAxisMax&&point.y>ext.yAxisMin&&point.y<=ext.yAxisMax){bins++;isCalculated=true}})}});if(!isCalculated){bins=""}return bins}function defaultFormatter(){return"Min: "+this.min+"<br>Max: "+this.max+"<br>Average: "+this.average+"<br>Bins: "+this.bins}function getExtremes(xAxisMin,xAxisMax,yAxisMin,yAxisMax){return{xAxisMin:Math.min(xAxisMax,xAxisMin),xAxisMax:Math.max(xAxisMax,xAxisMin),yAxisMin:Math.min(yAxisMax,yAxisMin),yAxisMax:Math.max(yAxisMax,yAxisMin)}}function getPointPos(axis,value,offset){return axis.toValue(axis.toPixels(value)+offset)}function init(){var options=this.options.typeOptions,chart=this.chart,inverted=chart.inverted,xAxis=chart.xAxis[options.xAxis],yAxis=chart.yAxis[options.yAxis],bck=options.background,width=inverted?bck.height:bck.width,height=inverted?bck.width:bck.height,selectType=options.selectType,top=inverted?xAxis.left:yAxis.top,left=inverted?yAxis.top:xAxis.left;this.startXMin=options.point.x;this.startYMin=options.point.y;if(isNumber(width)){this.startXMax=this.startXMin+width}else{this.startXMax=getPointPos(xAxis,this.startXMin,parseFloat(width))}if(isNumber(height)){this.startYMax=this.startYMin-height}else{this.startYMax=getPointPos(yAxis,this.startYMin,parseFloat(height))}if(selectType==="x"){this.startYMin=yAxis.toValue(top);this.startYMax=yAxis.toValue(top+yAxis.len)}else if(selectType==="y"){this.startXMin=xAxis.toValue(left);this.startXMax=xAxis.toValue(left+xAxis.len)}}function max(){var series=this.chart.series,ext=getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax);var max=-Infinity,isCalculated=false;series.forEach(function(serie){if(serie.visible&&serie.options.id!=="highcharts-navigator-series"){serie.points.forEach(function(point){if(!point.isNull&&point.y>max&&point.x>ext.xAxisMin&&point.x<=ext.xAxisMax&&point.y>ext.yAxisMin&&point.y<=ext.yAxisMax){max=point.y;isCalculated=true}})}});if(!isCalculated){max=""}return max}function min(){var series=this.chart.series,ext=getExtremes(this.xAxisMin,this.xAxisMax,this.yAxisMin,this.yAxisMax);var min=Infinity,isCalculated=false;series.forEach(function(serie){if(serie.visible&&serie.options.id!=="highcharts-navigator-series"){serie.points.forEach(function(point){if(!point.isNull&&point.y<min&&point.x>ext.xAxisMin&&point.x<=ext.xAxisMax&&point.y>ext.yAxisMin&&point.y<=ext.yAxisMax){min=point.y;isCalculated=true}})}});if(!isCalculated){min=""}return min}function recalculate(resize){var options=this.options.typeOptions,xAxis=this.chart.xAxis[options.xAxis],yAxis=this.chart.yAxis[options.yAxis],offsetX=this.offsetX,offsetY=this.offsetY;this.xAxisMin=getPointPos(xAxis,this.startXMin,offsetX);this.xAxisMax=getPointPos(xAxis,this.startXMax,offsetX);this.yAxisMin=getPointPos(yAxis,this.startYMin,offsetY);this.yAxisMax=getPointPos(yAxis,this.startYMax,offsetY);this.min=min.call(this);this.max=max.call(this);this.average=average.call(this);this.bins=bins.call(this);if(resize){this.resize(0,0)}}function updateStartPoints(redraw,resize,cpIndex,dx,dy){var options=this.options.typeOptions,selectType=options.selectType,xAxis=this.chart.xAxis[options.xAxis],yAxis=this.chart.yAxis[options.yAxis],startXMin=this.startXMin,startXMax=this.startXMax,startYMin=this.startYMin,startYMax=this.startYMax,offsetX=this.offsetX,offsetY=this.offsetY;if(resize){if(selectType==="x"){if(cpIndex===0){this.startXMin=getPointPos(xAxis,startXMin,dx)}else{this.startXMax=getPointPos(xAxis,startXMax,dx)}}else if(selectType==="y"){if(cpIndex===0){this.startYMin=getPointPos(yAxis,startYMin,dy)}else{this.startYMax=getPointPos(yAxis,startYMax,dy)}}else{this.startXMax=getPointPos(xAxis,startXMax,dx);this.startYMax=getPointPos(yAxis,startYMax,dy)}}if(redraw){this.startXMin=getPointPos(xAxis,startXMin,offsetX);this.startXMax=getPointPos(xAxis,startXMax,offsetX);this.startYMin=getPointPos(yAxis,startYMin,offsetY);this.startYMax=getPointPos(yAxis,startYMax,offsetY);this.offsetX=0;this.offsetY=0}this.options.typeOptions.point={x:this.startXMin,y:this.startYMin};this.userOptions.typeOptions.point={x:this.startXMin,y:this.startYMin}}var Measure=function(_super){__extends(Measure,_super);function Measure(){return _super!==null&&_super.apply(this,arguments)||this}Measure.prototype.init=function(annotationOrChart,userOptions,index){_super.prototype.init.call(this,annotationOrChart,userOptions,index);this.offsetX=0;this.offsetY=0;this.resizeX=0;this.resizeY=0;init.call(this);this.addValues();this.addShapes()};Measure.prototype.setClipAxes=function(){this.clipXAxis=this.chart.xAxis[this.options.typeOptions.xAxis];this.clipYAxis=this.chart.yAxis[this.options.typeOptions.yAxis]};Measure.prototype.pointsOptions=function(){return this.options.points};Measure.prototype.shapePointsOptions=function(){var options=this.options.typeOptions,xAxis=options.xAxis,yAxis=options.yAxis;return[{x:this.xAxisMin,y:this.yAxisMin,xAxis:xAxis,yAxis:yAxis},{x:this.xAxisMax,y:this.yAxisMin,xAxis:xAxis,yAxis:yAxis},{x:this.xAxisMax,y:this.yAxisMax,xAxis:xAxis,yAxis:yAxis},{x:this.xAxisMin,y:this.yAxisMax,xAxis:xAxis,yAxis:yAxis},{command:"Z"}]};Measure.prototype.addControlPoints=function(){var inverted=this.chart.inverted,options=this.options.controlPointOptions,selectType=this.options.typeOptions.selectType;if(!defined(this.userOptions.controlPointOptions&&this.userOptions.controlPointOptions.style.cursor)){if(selectType==="x"){options.style.cursor=inverted?"ns-resize":"ew-resize"}else if(selectType==="y"){options.style.cursor=inverted?"ew-resize":"ns-resize"}}var controlPoint=new ControlPoint(this.chart,this,this.options.controlPointOptions,0);this.controlPoints.push(controlPoint);if(selectType!=="xy"){controlPoint=new ControlPoint(this.chart,this,this.options.controlPointOptions,1);this.controlPoints.push(controlPoint)}};Measure.prototype.addValues=function(resize){var typeOptions=this.options.typeOptions,formatter=typeOptions.label.formatter;recalculate.call(this,resize);if(!typeOptions.label.enabled){return}if(this.labels.length>0){this.labels[0].text=formatter&&formatter.call(this)||defaultFormatter.call(this)}else{this.initLabel(extend({shape:"rect",backgroundColor:"none",color:"black",borderWidth:0,dashStyle:"Dash",overflow:"allow",align:"left",y:0,x:0,verticalAlign:"top",crop:true,xAxis:0,yAxis:0,point:function(target){var annotation=target.annotation,options=target.options;return{x:annotation.xAxisMin,y:annotation.yAxisMin,xAxis:pick(typeOptions.xAxis,options.xAxis),yAxis:pick(typeOptions.yAxis,options.yAxis)}},text:formatter&&formatter.call(this)||defaultFormatter.call(this)},typeOptions.label),void 0)}};Measure.prototype.addShapes=function(){this.addCrosshairs();this.addBackground()};Measure.prototype.addBackground=function(){var shapePoints=this.shapePointsOptions();if(typeof shapePoints[0].x==="undefined"){return}this.initShape(extend({type:"path",points:shapePoints,className:"highcharts-measure-background"},this.options.typeOptions.background),2)};Measure.prototype.addCrosshairs=function(){var chart=this.chart,options=this.options.typeOptions,point=this.options.typeOptions.point,xAxis=chart.xAxis[options.xAxis],yAxis=chart.yAxis[options.yAxis],inverted=chart.inverted,defaultOptions={point:point,type:"path"};var xAxisMin=xAxis.toPixels(this.xAxisMin),xAxisMax=xAxis.toPixels(this.xAxisMax),yAxisMin=yAxis.toPixels(this.yAxisMin),yAxisMax=yAxis.toPixels(this.yAxisMax),pathH=[],pathV=[],crosshairOptionsX,crosshairOptionsY,temp;if(inverted){temp=xAxisMin;xAxisMin=yAxisMin;yAxisMin=temp;temp=xAxisMax;xAxisMax=yAxisMax;yAxisMax=temp}if(options.crosshairX.enabled){pathH=[["M",xAxisMin,yAxisMin+(yAxisMax-yAxisMin)/2],["L",xAxisMax,yAxisMin+(yAxisMax-yAxisMin)/2]]}if(options.crosshairY.enabled){pathV=[["M",xAxisMin+(xAxisMax-xAxisMin)/2,yAxisMin],["L",xAxisMin+(xAxisMax-xAxisMin)/2,yAxisMax]]}if(this.shapes.length>0){this.shapes[0].options.d=pathH;this.shapes[1].options.d=pathV}else{crosshairOptionsX=merge(defaultOptions,{className:"highcharts-measure-crosshair-x"},options.crosshairX);crosshairOptionsY=merge(defaultOptions,{className:"highcharts-measure-crosshair-y"},options.crosshairY);this.initShape(extend({d:pathH},crosshairOptionsX),0);this.initShape(extend({d:pathV},crosshairOptionsY),1)}};Measure.prototype.onDrag=function(e){var translation=this.mouseMoveToTranslation(e),selectType=this.options.typeOptions.selectType,x=selectType==="y"?0:translation.x,y=selectType==="x"?0:translation.y;this.translate(x,y);this.offsetX+=x;this.offsetY+=y;this.redraw(false,false,true)};Measure.prototype.resize=function(dx,dy,cpIndex,selectType){var bckShape=this.shapes[2];if(selectType==="x"){if(cpIndex===0){bckShape.translatePoint(dx,0,0);bckShape.translatePoint(dx,dy,3)}else{bckShape.translatePoint(dx,0,1);bckShape.translatePoint(dx,dy,2)}}else if(selectType==="y"){if(cpIndex===0){bckShape.translatePoint(0,dy,0);bckShape.translatePoint(0,dy,1)}else{bckShape.translatePoint(0,dy,2);bckShape.translatePoint(0,dy,3)}}else{bckShape.translatePoint(dx,0,1);bckShape.translatePoint(dx,dy,2);bckShape.translatePoint(0,dy,3)}updateStartPoints.call(this,false,true,cpIndex,dx,dy);this.options.typeOptions.background.height=Math.abs(this.startYMax-this.startYMin);this.options.typeOptions.background.width=Math.abs(this.startXMax-this.startXMin)};Measure.prototype.redraw=function(animation,resize,setStartPoints){var _a;this.linkPoints();if(!this.graphic){this.render()}if(setStartPoints){updateStartPoints.call(this,true,false)}if(this.clipRect){this.clipRect.animate(this.getClipBox())}this.addValues(resize);this.addCrosshairs();this.redrawItems(this.shapes,animation);this.redrawItems(this.labels,animation);var backgroundOptions=this.options.typeOptions.background;if((backgroundOptions===null||backgroundOptions===void 0?void 0:backgroundOptions.strokeWidth)&&((_a=this.shapes[2])===null||_a===void 0?void 0:_a.graphic)){var offset=backgroundOptions.strokeWidth/2;var background=this.shapes[2];var path=background.graphic.pathArray;var p1=path[0];var p2=path[1];var p3=path[2];var p4=path[3];p1[1]=(p1[1]||0)+offset;p2[1]=(p2[1]||0)-offset;p3[1]=(p3[1]||0)-offset;p4[1]=(p4[1]||0)+offset;p1[2]=(p1[2]||0)+offset;p2[2]=(p2[2]||0)+offset;p3[2]=(p3[2]||0)-offset;p4[2]=(p4[2]||0)-offset;background.graphic.attr({d:path})}this.controlPoints.forEach(function(controlPoint){return controlPoint.redraw()})};Measure.prototype.translate=function(dx,dy){this.shapes.forEach(function(item){return item.translate(dx,dy)})};return Measure}(Annotation);Measure.prototype.defaultOptions=merge(Annotation.prototype.defaultOptions,{typeOptions:{selectType:"xy",xAxis:0,yAxis:0,background:{fill:"rgba(130, 170, 255, 0.4)",strokeWidth:0,stroke:void 0},crosshairX:{enabled:true,zIndex:6,dashStyle:"Dash",markerEnd:"arrow"},crosshairY:{enabled:true,zIndex:6,dashStyle:"Dash",markerEnd:"arrow"},label:{enabled:true,style:{fontSize:"0.7em",color:"#666666"},formatter:void 0}},controlPointOptions:{positioner:function(target){var cpIndex=this.index,chart=target.chart,options=target.options,typeOptions=options.typeOptions,selectType=typeOptions.selectType,controlPointOptions=options.controlPointOptions,inverted=chart.inverted,xAxis=chart.xAxis[typeOptions.xAxis],yAxis=chart.yAxis[typeOptions.yAxis],ext=getExtremes(target.xAxisMin,target.xAxisMax,target.yAxisMin,target.yAxisMax);var targetX=target.xAxisMax,targetY=target.yAxisMax,x,y;if(selectType==="x"){targetY=(ext.yAxisMax+ext.yAxisMin)/2;if(cpIndex===0){targetX=target.xAxisMin}}if(selectType==="y"){targetX=ext.xAxisMin+(ext.xAxisMax-ext.xAxisMin)/2;if(cpIndex===0){targetY=target.yAxisMin}}if(inverted){x=yAxis.toPixels(targetY);y=xAxis.toPixels(targetX)}else{x=xAxis.toPixels(targetX);y=yAxis.toPixels(targetY)}return{x:x-controlPointOptions.width/2,y:y-controlPointOptions.height/2}},events:{drag:function(e,target){var translation=this.mouseMoveToTranslation(e),selectType=target.options.typeOptions.selectType,index=this.index,x=selectType==="y"?0:translation.x,y=selectType==="x"?0:translation.y;target.resize(x,y,index,selectType);target.resizeX+=x;target.resizeY+=y;target.redraw(false,true)}}}});Annotation.types.measure=Measure;export default Measure;