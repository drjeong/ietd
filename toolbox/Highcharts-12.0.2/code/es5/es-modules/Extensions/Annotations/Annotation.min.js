"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();import A from"../../Core/Animation/AnimationUtilities.js";var getDeferredAnimation=A.getDeferredAnimation;import AnnotationChart from"./AnnotationChart.js";import AnnotationDefaults from"./AnnotationDefaults.js";import ControllableRect from"./Controllables/ControllableRect.js";import ControllableCircle from"./Controllables/ControllableCircle.js";import ControllableEllipse from"./Controllables/ControllableEllipse.js";import ControllablePath from"./Controllables/ControllablePath.js";import ControllableImage from"./Controllables/ControllableImage.js";import ControllableLabel from"./Controllables/ControllableLabel.js";import ControlPoint from"./ControlPoint.js";import ControlTarget from"./ControlTarget.js";import EventEmitter from"./EventEmitter.js";import MockPoint from"./MockPoint.js";import PopupComposition from"./Popup/PopupComposition.js";import U from"../../Core/Utilities.js";var destroyObjectProperties=U.destroyObjectProperties,erase=U.erase,fireEvent=U.fireEvent,merge=U.merge,pick=U.pick,splat=U.splat;function adjustVisibility(item){var label=item.graphic,hasVisiblePoints=item.points.some(function(point){return point.series.visible!==false&&point.visible!==false});if(label){if(!hasVisiblePoints){label.hide()}else if(label.visibility==="hidden"){label.show()}}}function getLabelsAndShapesOptions(baseOptions,newOptions){var mergedOptions={};["labels","shapes"].forEach(function(name){var someBaseOptions=baseOptions[name],newOptionsValue=newOptions[name];if(someBaseOptions){if(newOptionsValue){mergedOptions[name]=splat(newOptionsValue).map(function(basicOptions,i){return merge(someBaseOptions[i],basicOptions)})}else{mergedOptions[name]=baseOptions[name]}}});return mergedOptions}var Annotation=function(_super){__extends(Annotation,_super);function Annotation(chart,userOptions){var _this=_super.call(this)||this;_this.coll="annotations";_this.chart=chart;_this.points=[];_this.controlPoints=[];_this.coll="annotations";_this.index=-1;_this.labels=[];_this.shapes=[];_this.options=merge(_this.defaultOptions,userOptions);_this.userOptions=userOptions;var labelsAndShapes=getLabelsAndShapesOptions(_this.options,userOptions);_this.options.labels=labelsAndShapes.labels;_this.options.shapes=labelsAndShapes.shapes;_this.init(chart,_this.options);return _this}Annotation.compose=function(ChartClass,NavigationBindingsClass,PointerClass,SVGRendererClass){AnnotationChart.compose(Annotation,ChartClass,PointerClass);ControllableLabel.compose(SVGRendererClass);ControllablePath.compose(ChartClass,SVGRendererClass);NavigationBindingsClass.compose(Annotation,ChartClass);PopupComposition.compose(NavigationBindingsClass,PointerClass)};Annotation.prototype.addClipPaths=function(){this.setClipAxes();if(this.clipXAxis&&this.clipYAxis&&this.options.crop){this.clipRect=this.chart.renderer.clipRect(this.getClipBox())}};Annotation.prototype.addLabels=function(){var _this=this;var labelsOptions=this.options.labels||[];labelsOptions.forEach(function(labelOptions,i){var label=_this.initLabel(labelOptions,i);merge(true,labelsOptions[i],label.options)})};Annotation.prototype.addShapes=function(){var _this=this;var shapes=this.options.shapes||[];shapes.forEach(function(shapeOptions,i){var shape=_this.initShape(shapeOptions,i);merge(true,shapes[i],shape.options)})};Annotation.prototype.destroy=function(){var chart=this.chart,destroyItem=function(item){item.destroy()};this.labels.forEach(destroyItem);this.shapes.forEach(destroyItem);this.clipXAxis=null;this.clipYAxis=null;erase(chart.labelCollectors,this.labelCollector);_super.prototype.destroy.call(this);this.destroyControlTarget();destroyObjectProperties(this,chart)};Annotation.prototype.destroyItem=function(item){erase(this[item.itemType+"s"],item);item.destroy()};Annotation.prototype.getClipBox=function(){if(this.clipXAxis&&this.clipYAxis){return{x:this.clipXAxis.left,y:this.clipYAxis.top,width:this.clipXAxis.width,height:this.clipYAxis.height}}};Annotation.prototype.initProperties=function(chart,userOptions){this.setOptions(userOptions);var labelsAndShapes=getLabelsAndShapesOptions(this.options,userOptions);this.options.labels=labelsAndShapes.labels;this.options.shapes=labelsAndShapes.shapes;this.chart=chart;this.points=[];this.controlPoints=[];this.coll="annotations";this.userOptions=userOptions;this.labels=[];this.shapes=[]};Annotation.prototype.init=function(_annotationOrChart,_userOptions,index){if(index===void 0){index=this.index}var chart=this.chart,animOptions=this.options.animation;this.index=index;this.linkPoints();this.addControlPoints();this.addShapes();this.addLabels();this.setLabelCollector();this.animationConfig=getDeferredAnimation(chart,animOptions)};Annotation.prototype.initLabel=function(labelOptions,index){var options=merge(this.options.labelOptions,{controlPointOptions:this.options.controlPointOptions},labelOptions),label=new ControllableLabel(this,options,index);label.itemType="label";this.labels.push(label);return label};Annotation.prototype.initShape=function(shapeOptions,index){var options=merge(this.options.shapeOptions,{controlPointOptions:this.options.controlPointOptions},shapeOptions),shape=new Annotation.shapesMap[options.type](this,options,index);shape.itemType="shape";this.shapes.push(shape);return shape};Annotation.prototype.redraw=function(animation){this.linkPoints();if(!this.graphic){this.render()}if(this.clipRect){this.clipRect.animate(this.getClipBox())}this.redrawItems(this.shapes,animation);this.redrawItems(this.labels,animation);this.redrawControlPoints(animation)};Annotation.prototype.redrawItem=function(item,animation){item.linkPoints();if(!item.shouldBeDrawn()){this.destroyItem(item)}else{if(!item.graphic){this.renderItem(item)}item.redraw(pick(animation,true)&&item.graphic.placed);if(item.points.length){adjustVisibility(item)}}};Annotation.prototype.redrawItems=function(items,animation){var i=items.length;while(i--){this.redrawItem(items[i],animation)}};Annotation.prototype.remove=function(){return this.chart.removeAnnotation(this)};Annotation.prototype.render=function(){var renderer=this.chart.renderer;this.graphic=renderer.g("annotation").attr({opacity:0,zIndex:this.options.zIndex,visibility:this.options.visible?"inherit":"hidden"}).add();this.shapesGroup=renderer.g("annotation-shapes").add(this.graphic);if(this.options.crop){this.shapesGroup.clip(this.chart.plotBoxClip)}this.labelsGroup=renderer.g("annotation-labels").attr({translateX:0,translateY:0}).add(this.graphic);this.addClipPaths();if(this.clipRect){this.graphic.clip(this.clipRect)}this.renderItems(this.shapes);this.renderItems(this.labels);this.addEvents();this.renderControlPoints()};Annotation.prototype.renderItem=function(item){item.render(item.itemType==="label"?this.labelsGroup:this.shapesGroup)};Annotation.prototype.renderItems=function(items){var i=items.length;while(i--){this.renderItem(items[i])}};Annotation.prototype.setClipAxes=function(){var xAxes=this.chart.xAxis,yAxes=this.chart.yAxis,linkedAxes=(this.options.labels||[]).concat(this.options.shapes||[]).reduce(function(axes,labelOrShape){var point=labelOrShape&&(labelOrShape.point||labelOrShape.points&&labelOrShape.points[0]);return[xAxes[point&&point.xAxis]||axes[0],yAxes[point&&point.yAxis]||axes[1]]},[]);this.clipXAxis=linkedAxes[0];this.clipYAxis=linkedAxes[1]};Annotation.prototype.setControlPointsVisibility=function(visible){var setItemControlPointsVisibility=function(item){item.setControlPointsVisibility(visible)};this.controlPoints.forEach(function(controlPoint){controlPoint.setVisibility(visible)});this.shapes.forEach(setItemControlPointsVisibility);this.labels.forEach(setItemControlPointsVisibility)};Annotation.prototype.setLabelCollector=function(){var annotation=this;annotation.labelCollector=function(){return annotation.labels.reduce(function(labels,label){if(!label.options.allowOverlap){labels.push(label.graphic)}return labels},[])};annotation.chart.labelCollectors.push(annotation.labelCollector)};Annotation.prototype.setOptions=function(userOptions){this.options=merge(this.defaultOptions,userOptions)};Annotation.prototype.setVisibility=function(visible){var options=this.options,navigation=this.chart.navigationBindings,visibility=pick(visible,!options.visible);this.graphic.attr("visibility",visibility?"inherit":"hidden");if(!visibility){var setItemControlPointsVisibility=function(item){item.setControlPointsVisibility(visibility)};this.shapes.forEach(setItemControlPointsVisibility);this.labels.forEach(setItemControlPointsVisibility);if(navigation.activeAnnotation===this&&navigation.popup&&navigation.popup.type==="annotation-toolbar"){fireEvent(navigation,"closePopup")}}options.visible=visibility};Annotation.prototype.update=function(userOptions,redraw){var chart=this.chart,labelsAndShapes=getLabelsAndShapesOptions(this.userOptions,userOptions),userOptionsIndex=chart.annotations.indexOf(this),options=merge(true,this.userOptions,userOptions);options.labels=labelsAndShapes.labels;options.shapes=labelsAndShapes.shapes;this.destroy();this.initProperties(chart,options);this.init(chart,options);chart.options.annotations[userOptionsIndex]=this.options;this.isUpdating=true;if(pick(redraw,true)){chart.drawAnnotations()}fireEvent(this,"afterUpdate");this.isUpdating=false};Annotation.ControlPoint=ControlPoint;Annotation.MockPoint=MockPoint;Annotation.shapesMap={rect:ControllableRect,circle:ControllableCircle,ellipse:ControllableEllipse,path:ControllablePath,image:ControllableImage};Annotation.types={};return Annotation}(EventEmitter);Annotation.prototype.defaultOptions=AnnotationDefaults;Annotation.prototype.nonDOMEvents=["add","afterUpdate","drag","remove"];ControlTarget.compose(Annotation);export default Annotation;"";