"use strict";import D from"../../Core/Defaults.js";var defaultOptions=D.defaultOptions,getOptions=D.getOptions;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,extend=U.extend,fireEvent=U.fireEvent,merge=U.merge,pick=U.pick;import H from"../../Core/Globals.js";var doc=H.doc,win=H.win;import defaultSonificationOptions from"./Options.js";import SonificationInstrument from"./SonificationInstrument.js";import SonificationSpeaker from"./SonificationSpeaker.js";import SynthPatch from"./SynthPatch.js";import InstrumentPresets from"./InstrumentPresets.js";import timelineFromChart from"./TimelineFromChart.js";var Sonification=function(){function Sonification(chart){this.chart=chart;this.retryContextCounter=0;this.lastUpdate=0;this.unbindKeydown=addEvent(doc,"keydown",function(e){if(chart&&chart.sonification&&(e.key==="Esc"||e.key==="Escape")){chart.sonification.cancel()}});try{this.audioContext=new win.AudioContext;this.audioContext.suspend();this.audioDestination=this.audioContext.destination}catch(e){}}Sonification.prototype.setAudioDestination=function(audioDestination){this.audioDestination=audioDestination;this.update()};Sonification.prototype.isPlaying=function(){return!!this.timeline&&this.timeline.isPlaying};Sonification.prototype.playSegment=function(segment,onEnd){if(!this.ready(this.playSegment.bind(this,segment,onEnd))){return}if(this.timeline){this.timeline.playSegment(segment,onEnd)}};Sonification.prototype.playAdjacent=function(next,onEnd,eventFilter){var _this=this;if(!this.ready(this.playAdjacent.bind(this,next,onEnd,eventFilter))){return}if(this.timeline){var opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playAdjacent(next,onEnd,onHit||function(){_this.defaultBoundaryHit()},eventFilter)}};Sonification.prototype.playAdjacentSeries=function(next,prop,onEnd){if(prop===void 0){prop="x"}var lastPlayed=this.getLastPlayedPoint();if(lastPlayed){var targetSeriesIx_1=lastPlayed.series.index+(next?1:-1);this.playClosestToProp(prop,lastPlayed[prop],function(e){return!!e.relatedPoint&&e.relatedPoint.series.index===targetSeriesIx_1},onEnd);return this.chart.series[targetSeriesIx_1]||null}return null};Sonification.prototype.playClosestToProp=function(prop,targetValue,targetFilter,onEnd){var _this=this;if(!this.ready(this.playClosestToProp.bind(this,prop,targetValue,targetFilter,onEnd))){return}if(this.timeline){var opts=this.chart.options.sonification,onHit=opts&&opts.events&&opts.events.onBoundaryHit;if(!onHit){this.initBoundaryInstrument()}this.timeline.playClosestToPropValue(prop,targetValue,onEnd,onHit||function(){return _this.defaultBoundaryHit()},targetFilter)}};Sonification.prototype.getLastPlayedPoint=function(){if(this.timeline){return this.timeline.getLastPlayedPoint()}return null};Sonification.prototype.playNote=function(instrument,options,delayMs){if(delayMs===void 0){delayMs=0}if(!this.ready(this.playNote.bind(this,instrument,options))){return}var duration=options.noteDuration=options.noteDuration||500;var instr=new SonificationInstrument(this.audioContext,this.audioDestination,{synthPatch:instrument,capabilities:{filters:true,tremolo:true,pan:true}});instr.scheduleEventAtTime(delayMs/1e3,options);setTimeout(function(){return instr&&instr.destroy()},delayMs+duration+500)};Sonification.prototype.speak=function(text,speakerOptions,delayMs){if(delayMs===void 0){delayMs=0}var speaker=new SonificationSpeaker(merge({language:"en-US",rate:1.5,volume:.4},speakerOptions||{}));speaker.sayAtTime(delayMs,text)};Sonification.prototype.cancel=function(){if(this.timeline){this.timeline.cancel()}fireEvent(this,"cancel")};Sonification.prototype.downloadMIDI=function(){if(!this.ready(this.downloadMIDI.bind(this))){return}if(this.timeline){this.timeline.reset();this.timeline.downloadMIDI()}};Sonification.prototype.sonifyChart=function(resetAfter,onEnd){if(!this.ready(this.sonifyChart.bind(this,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(void 0,void 0,resetAfter,onEnd)}};Sonification.prototype.sonifySeries=function(series,resetAfter,onEnd){if(!this.ready(this.sonifySeries.bind(this,series,resetAfter,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.play(function(e){return!!e.relatedPoint&&e.relatedPoint.series===series},void 0,resetAfter,onEnd)}};Sonification.prototype.sonifyPoint=function(point,onEnd){if(!this.ready(this.sonifyPoint.bind(this,point,onEnd))){return}if(this.timeline){this.timeline.reset();this.beforePlay();this.timeline.anchorPlayMoment(function(e){return e.relatedPoint===point},onEnd)}};Sonification.prototype.setMasterVolume=function(vol){if(this.timeline){this.timeline.setMasterVolume(vol)}};Sonification.prototype.destroy=function(){this.unbindKeydown();if(this.timeline){this.timeline.destroy();delete this.timeline}if(this.boundaryInstrument){this.boundaryInstrument.stop()}if(this.audioContext){this.audioContext.close();delete this.audioContext}};Sonification.prototype.update=function(){var sOpts=this.chart.options&&this.chart.options.sonification;if(!this.ready(this.update.bind(this))||!sOpts){return}var now=Date.now(),updateInterval=sOpts.updateInterval;if(now-this.lastUpdate<updateInterval&&!this.forceReady){clearTimeout(this.scheduledUpdate);this.scheduledUpdate=setTimeout(this.update.bind(this),updateInterval/2);return}var events=sOpts.events||{};if(events.beforeUpdate){events.beforeUpdate({chart:this.chart,timeline:this.timeline})}this.lastUpdate=now;if(this.timeline){this.timeline.destroy()}if(this.audioContext&&this.audioDestination){this.timeline=timelineFromChart(this.audioContext,this.audioDestination,this.chart);var sOpts_1=this.chart.options.sonification;this.timeline.setMasterVolume(pick(sOpts_1&&sOpts_1.masterVolume,1))}if(events.afterUpdate){events.afterUpdate({chart:this.chart,timeline:this.timeline})}};Sonification.prototype.ready=function(whenReady){var _this=this;if(!this.audioContext||!this.audioDestination||!this.chart.options||this.chart.options.sonification&&this.chart.options.sonification.enabled===false){return false}if(this.audioContext.state==="suspended"&&!this.forceReady){if(this.retryContextCounter++<20){setTimeout(function(){if(_this.audioContext&&_this.audioContext.state==="suspended"){_this.audioContext.resume().then(whenReady)}else{whenReady()}},5)}return false}this.retryContextCounter=0;return true};Sonification.prototype.beforePlay=function(){var opts=this.chart.options.sonification,beforePlay=opts&&opts.events&&opts.events.beforePlay;if(beforePlay){beforePlay({chart:this.chart,timeline:this.timeline})}};Sonification.prototype.initBoundaryInstrument=function(){if(!this.boundaryInstrument){this.boundaryInstrument=new SynthPatch(this.audioContext,merge(InstrumentPresets.chop,{masterVolume:.3}));this.boundaryInstrument.startSilently();this.boundaryInstrument.connect(this.audioDestination)}};Sonification.prototype.defaultBoundaryHit=function(){if(this.boundaryInstrument){this.boundaryInstrument.playFreqAtTime(.1,1,200);this.boundaryInstrument.playFreqAtTime(.2,1,200)}};return Sonification}();(function(Sonification){var composedClasses=[];function updateSonificationEnabled(){var sonification=this.sonification,sOptions=this.options&&this.options.sonification;if(sOptions&&sOptions.enabled){if(sonification){sonification.update()}else{this.sonification=new Sonification(this);this.sonification.update()}}else if(sonification){sonification.destroy();delete this.sonification}}function chartOnDestroy(){if(this&&this.sonification){this.sonification.destroy()}}function chartOnRender(){if(this.updateSonificationEnabled){this.updateSonificationEnabled()}}function chartOnUpdate(e){var newOptions=e.options.sonification;if(newOptions){merge(true,this.options.sonification,newOptions);chartOnRender.call(this)}}function compose(ChartClass,SeriesClass,PointClass){if(composedClasses.indexOf(ChartClass)===-1){composedClasses.push(ChartClass);extend(ChartClass.prototype,{updateSonificationEnabled:updateSonificationEnabled,sonify:function(onEnd){if(this.sonification){this.sonification.sonifyChart(false,onEnd)}},toggleSonify:function(reset,onEnd){if(reset===void 0){reset=true}if(!this.sonification){return}var timeline=this.sonification.timeline;if(win.speechSynthesis){win.speechSynthesis.cancel()}if(timeline&&this.sonification.isPlaying()){if(reset){this.sonification.cancel()}else{timeline.pause()}}else if(timeline&&timeline.isPaused){timeline.resume()}else{this.sonification.sonifyChart(reset,onEnd)}}});addEvent(ChartClass,"destroy",chartOnDestroy);addEvent(ChartClass,"render",chartOnRender);addEvent(ChartClass,"update",chartOnUpdate)}if(composedClasses.indexOf(SeriesClass)===-1){composedClasses.push(SeriesClass);SeriesClass.prototype.sonify=function(onEnd){if(this.chart.sonification){this.chart.sonification.sonifySeries(this,false,onEnd)}}}if(composedClasses.indexOf(PointClass)===-1){composedClasses.push(PointClass);PointClass.prototype.sonify=function(onEnd){if(this.series.chart.sonification){this.series.chart.sonification.sonifyPoint(this,onEnd)}}}var exportingOptions=getOptions().exporting;if(exportingOptions&&exportingOptions.buttons&&exportingOptions.buttons.contextButton.menuItems){exportingOptions.buttons.contextButton.menuItems.push("separator","downloadMIDI","playAsSound")}}Sonification.compose=compose})(Sonification||(Sonification={}));merge(true,defaultOptions,defaultSonificationOptions);export default Sonification;"";