"use strict";import A from"../../Core/Animation/AnimationUtilities.js";var animObject=A.animObject;import DDU from"./DragDropUtilities.js";var addEvents=DDU.addEvents,countProps=DDU.countProps,getFirstProp=DDU.getFirstProp,getNormalizedEvent=DDU.getNormalizedEvent;import DragDropDefaults from"./DragDropDefaults.js";import H from"../../Core/Globals.js";var doc=H.doc;import U from"../../Core/Utilities.js";var addEvent=U.addEvent,isArray=U.isArray,merge=U.merge,pick=U.pick;function addDragDropEvents(chart){var container=chart.container;if(isChartDraggable(chart)){addEvents(container,["mousedown","touchstart"],function(e){mouseDown(getNormalizedEvent(e,chart),chart)});addEvents(container,["mousemove","touchmove"],function(e){mouseMove(getNormalizedEvent(e,chart),chart)},{passive:false});addEvent(container,"mouseleave",function(e){mouseUp(getNormalizedEvent(e,chart),chart)});chart.unbindDragDropMouseUp=addEvents(doc,["mouseup","touchend"],function(e){mouseUp(getNormalizedEvent(e,chart),chart)},{passive:false});chart.hasAddedDragDropEvents=true;addEvent(chart,"destroy",function(){if(chart.unbindDragDropMouseUp){chart.unbindDragDropMouseUp()}})}}function chartHideDragHandles(){var chart=this,dragHandles=chart.dragHandles||{};if(dragHandles){for(var _i=0,_a=Object.keys(dragHandles);_i<_a.length;_i++){var key=_a[_i];if(dragHandles[key].destroy){dragHandles[key].destroy()}}delete chart.dragHandles}}function chartSetGuideBoxState(state,options){var guideBox=this.dragGuideBox,guideBoxOptions=merge(DragDropDefaults.guideBox,options),stateOptions=merge(guideBoxOptions["default"],guideBoxOptions[state]);return guideBox.attr({class:stateOptions.className,stroke:stateOptions.lineColor,strokeWidth:stateOptions.lineWidth,fill:stateOptions.color,cursor:stateOptions.cursor,zIndex:stateOptions.zIndex}).css({pointerEvents:"none"})}function chartZoomOrPanKeyPressed(e){var chart=this,chartOptions=chart.options.chart||{},panKey=chartOptions.panKey&&chartOptions.panKey+"Key",zoomKey=chart.zooming.key&&chart.zooming.key+"Key";return e[zoomKey]||e[panKey]}function compose(ChartClass){var chartProto=ChartClass.prototype;if(!chartProto.hideDragHandles){chartProto.hideDragHandles=chartHideDragHandles;chartProto.setGuideBoxState=chartSetGuideBoxState;chartProto.zoomOrPanKeyPressed=chartZoomOrPanKeyPressed;addEvent(ChartClass,"render",onChartRender)}}function dragMove(e,point){var series=point.series,chart=series.chart,data=chart.dragDropData,options=merge(series.options.dragDrop,point.options.dragDrop),draggableX=options.draggableX,draggableY=options.draggableY,origin=data.origin,updateProp=data.updateProp;var dX=e.chartX-origin.chartX,dY=e.chartY-origin.chartY;var oldDx=dX;if(chart.inverted){dX=-dY;dY=-oldDx}if(pick(options.liveRedraw,true)){updatePoints(chart,false);point.showDragHandles()}else{if(updateProp){resizeGuideBox(point,dX,dY)}else{chart.dragGuideBox.translate(draggableX?dX:0,draggableY?dY:0)}}origin.prevdX=dX;origin.prevdY=dY}function flipResizeSide(side){return{left:"right",right:"left",top:"bottom",bottom:"top"}[side]}function getGroupedPoints(point){var series=point.series,data=series.options.data||[],groupKey=series.options.dragDrop.groupBy;var points=[];if(series.boosted&&isArray(data)){for(var i=0,iEnd=data.length;i<iEnd;++i){points.push(new series.pointClass(series,data[i]));points[points.length-1].index=i}}else{points=series.points}return point.options[groupKey]?points.filter(function(comparePoint){return comparePoint.options[groupKey]===point.options[groupKey]}):[point]}function getNewPoints(dragDropData,newPos){var point=dragDropData.point,series=point.series,chart=series.chart,options=merge(series.options.dragDrop,point.options.dragDrop),updateProps={},resizeProp=dragDropData.updateProp,hashmap={},dragDropProps=point.series.dragDropProps;for(var key in dragDropProps){var val=dragDropProps[key];if(resizeProp&&(resizeProp!==key||!val.resize||val.optionName&&options[val.optionName]===false)){continue}if(resizeProp||val.move&&(val.axis==="x"&&options.draggableX||val.axis==="y"&&options.draggableY)){if(chart.mapView){updateProps[key==="x"?"lon":"lat"]=val}else{updateProps[key]=val}}}for(var _i=0,_a=resizeProp?[point]:dragDropData.groupedPoints;_i<_a.length;_i++){var p=_a[_i];hashmap[p.id]={point:p,newValues:p.getDropValues(dragDropData.origin,newPos,updateProps)}}return hashmap}function getPositionSnapshot(e,points,guideBox){var res={chartX:e.chartX,chartY:e.chartY,guideBox:guideBox&&{x:guideBox.attr("x"),y:guideBox.attr("y"),width:guideBox.attr("width"),height:guideBox.attr("height")},points:{}};for(var _i=0,points_1=points;_i<points_1.length;_i++){var point=points_1[_i];var dragDropProps=point.series.dragDropProps||{},pointProps={};for(var _a=0,_b=Object.keys(dragDropProps);_a<_b.length;_a++){var key=_b[_a];var val=dragDropProps[key],axis=point.series[val.axis+"Axis"];pointProps[key]=point[key];if(point.series.chart.mapView&&point.plotX&&point.plotY){pointProps[key+"Offset"]=key==="x"?point.plotX:point.plotY}else{pointProps[key+"Offset"]=axis.toPixels(point[key])-(axis.horiz?e.chartX:e.chartY)}}pointProps.point=point;res.points[point.id]=pointProps}return res}function hasDraggedPastSensitivity(e,chart,sensitivity){var orig=chart.dragDropData.origin,oldX=orig.chartX,oldY=orig.chartY,newX=e.chartX,newY=e.chartY,distance=Math.sqrt((newX-oldX)*(newX-oldX)+(newY-oldY)*(newY-oldY));return distance>sensitivity}function initDragDrop(e,point){var groupedPoints=getGroupedPoints(point),series=point.series,chart=series.chart;var guideBox;if(!pick(series.options.dragDrop&&series.options.dragDrop.liveRedraw,true)){chart.dragGuideBox=guideBox=series.getGuideBox(groupedPoints);chart.setGuideBoxState("default",series.options.dragDrop.guideBox).add(series.group)}chart.dragDropData={origin:getPositionSnapshot(e,groupedPoints,guideBox),point:point,groupedPoints:groupedPoints,isDragging:true}}function isChartDraggable(chart){var i=chart.series?chart.series.length:0;if(chart.hasCartesianSeries&&!chart.polar||chart.mapView){while(i--){if(chart.series[i].options.dragDrop&&isSeriesDraggable(chart.series[i])){return true}}}return false}function isPointMovable(point){var series=point.series,chart=series.chart,seriesDragDropOptions=series.options.dragDrop||{},pointDragDropOptions=point.options&&point.options.dragDrop,updateProps=series.dragDropProps;var p,hasMovableX,hasMovableY;for(var key in updateProps){p=updateProps[key];if(p.axis==="x"&&p.move){hasMovableX=true}else if(p.axis==="y"&&p.move){hasMovableY=true}}return(seriesDragDropOptions.draggableX&&hasMovableX||seriesDragDropOptions.draggableY&&hasMovableY)&&!(pointDragDropOptions&&pointDragDropOptions.draggableX===false&&pointDragDropOptions.draggableY===false)&&(!!(series.yAxis&&series.xAxis)||chart.mapView)}function isSeriesDraggable(series){var props=["draggableX","draggableY"],dragDropProps=series.dragDropProps||{};var val;for(var _i=0,_a=Object.keys(dragDropProps);_i<_a.length;_i++){var key=_a[_i];val=dragDropProps[key];if(val.optionName){props.push(val.optionName)}}var i=props.length;while(i--){if(series.options.dragDrop[props[i]]){return true}}}function mouseDown(e,chart){var dragPoint=chart.hoverPoint,dragDropOptions=merge(dragPoint&&dragPoint.series.options.dragDrop,dragPoint&&dragPoint.options.dragDrop),draggableX=dragDropOptions.draggableX||false,draggableY=dragDropOptions.draggableY||false;chart.cancelClick=false;if(!(draggableX||draggableY)||chart.zoomOrPanKeyPressed(e)||chart.hasDraggedAnnotation){return}if(chart.dragDropData&&chart.dragDropData.isDragging){mouseUp(e,chart);return}if(dragPoint&&isPointMovable(dragPoint)){chart.mouseIsDown=false;initDragDrop(e,dragPoint);dragPoint.firePointEvent("dragStart",e)}}function mouseMove(e,chart){if(chart.zoomOrPanKeyPressed(e)){return}var dragDropData=chart.dragDropData;var point,seriesDragDropOpts,newPoints,numNewPoints=0,newPoint;if(dragDropData&&dragDropData.isDragging&&dragDropData.point.series){point=dragDropData.point;seriesDragDropOpts=point.series.options.dragDrop;e.preventDefault();if(!dragDropData.draggedPastSensitivity){dragDropData.draggedPastSensitivity=hasDraggedPastSensitivity(e,chart,pick(point.options.dragDrop&&point.options.dragDrop.dragSensitivity,seriesDragDropOpts&&seriesDragDropOpts.dragSensitivity,DragDropDefaults.dragSensitivity))}if(dragDropData.draggedPastSensitivity){dragDropData.newPoints=getNewPoints(dragDropData,e);newPoints=dragDropData.newPoints;numNewPoints=countProps(newPoints);newPoint=numNewPoints===1?getFirstProp(newPoints):null;point.firePointEvent("drag",{origin:dragDropData.origin,newPoints:dragDropData.newPoints,newPoint:newPoint&&newPoint.newValues,newPointId:newPoint&&newPoint.point.id,numNewPoints:numNewPoints,chartX:e.chartX,chartY:e.chartY},function(){dragMove(e,point)})}}}function mouseUp(e,chart){var dragDropData=chart.dragDropData;if(dragDropData&&dragDropData.isDragging&&dragDropData.draggedPastSensitivity&&dragDropData.point.series){var point=dragDropData.point,newPoints=dragDropData.newPoints,numNewPoints=countProps(newPoints),newPoint=numNewPoints===1?getFirstProp(newPoints):null;if(chart.dragHandles){chart.hideDragHandles()}e.preventDefault();chart.cancelClick=true;point.firePointEvent("drop",{origin:dragDropData.origin,chartX:e.chartX,chartY:e.chartY,newPoints:newPoints,numNewPoints:numNewPoints,newPoint:newPoint&&newPoint.newValues,newPointId:newPoint&&newPoint.point.id},function(){updatePoints(chart)})}delete chart.dragDropData;if(chart.dragGuideBox){chart.dragGuideBox.destroy();delete chart.dragGuideBox}}function onChartRender(){if(!this.hasAddedDragDropEvents){addDragDropEvents(this)}}function resizeGuideBox(point,dX,dY){var series=point.series,chart=series.chart,dragDropData=chart.dragDropData,resizeProp=series.dragDropProps[dragDropData.updateProp],newPoint=dragDropData.newPoints[point.id].newValues,resizeSide=typeof resizeProp.resizeSide==="function"?resizeProp.resizeSide(newPoint,point):resizeProp.resizeSide;if(resizeProp.beforeResize){resizeProp.beforeResize(chart.dragGuideBox,newPoint,point)}resizeRect(chart.dragGuideBox,resizeProp.axis==="x"&&series.xAxis.reversed||resizeProp.axis==="y"&&series.yAxis.reversed?flipResizeSide(resizeSide):resizeSide,{x:resizeProp.axis==="x"?dX-(dragDropData.origin.prevdX||0):0,y:resizeProp.axis==="y"?dY-(dragDropData.origin.prevdY||0):0})}function resizeRect(rect,updateSide,update){var resizeAttrs;switch(updateSide){case"left":resizeAttrs={x:rect.attr("x")+update.x,width:Math.max(1,rect.attr("width")-update.x)};break;case"right":resizeAttrs={width:Math.max(1,rect.attr("width")+update.x)};break;case"top":resizeAttrs={y:rect.attr("y")+update.y,height:Math.max(1,rect.attr("height")-update.y)};break;case"bottom":resizeAttrs={height:Math.max(1,rect.attr("height")+update.y)};break;default:}rect.attr(resizeAttrs)}function updatePoints(chart,animation){var newPoints=chart.dragDropData.newPoints,animOptions=animObject(animation);chart.isDragDropAnimating=true;var newPoint;for(var _i=0,_a=Object.keys(newPoints);_i<_a.length;_i++){var key=_a[_i];newPoint=newPoints[key];newPoint.point.update(newPoint.newValues,false)}chart.redraw(animOptions);setTimeout(function(){delete chart.isDragDropAnimating;if(chart.hoverPoint&&!chart.dragHandles){chart.hoverPoint.showDragHandles()}},animOptions.duration)}var DraggableChart={compose:compose,flipResizeSide:flipResizeSide,initDragDrop:initDragDrop};export default DraggableChart;