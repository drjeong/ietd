class AnomalyPlot extends ChartCommons{constructor(containerId,IETDhour,IETDData,zScoreThreshold=2){super(containerId);this.containerId=containerId;this.IETDhour=IETDhour;this.IETDData=IETDData;this.zScoreThreshold=zScoreThreshold;this.margin={top:20,right:20,bottom:50,left:60};this.title="Significant Precipitation Anomalies";this.probabilityThreshold=.05;this.distributionType="gamma";this.positiveColor="#e41a1c";this.negativeColor="#e41a1c";this.meanLineColor="#666666";this.resize=this.resize.bind(this);this.processData=this.processData.bind(this);this.timeFormat=this.timeFormat.bind(this);this.processData();this.initialize()}initialize(){const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.height=parseInt(container.style("height"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.innerHeight=this.height-this.margin.top-this.margin.bottom;this.createThresholdSelector();this.createDistributionSelector();this.createSvg();this.createScales();this.createAxes();this.createVisualization();window.addEventListener("resize",this.resize)}timeFormat(date){if(!date)return"";try{const d=new Date(date);const month=(d.getMonth()+1).toString().padStart(2,"0");const day=d.getDate().toString().padStart(2,"0");const year=d.getFullYear();const hour=d.getHours().toString().padStart(2,"0");return`${month}/${day}/${year} ${hour}h`}catch(e){return""}}processData(){if(!Array.isArray(this.IETDData)||this.IETDData.length===0){console.error("Invalid or empty IETDData");return}try{const baseData=this.IETDData.map(data=>{const[datefrom,dateto,volume]=data;return{date:new Date(datefrom),volume:volume,from:datefrom,to:dateto,period:`${this.timeFormat(datefrom)} ~ ${this.timeFormat(dateto)}`}}).sort((a,b)=>a.date-b.date);const volumes=baseData.map(d=>d.volume);switch(this.distributionType){case"normal":this.meanValue=d3.mean(volumes);this.stdDev=d3.deviation(volumes);this.formattedData=baseData.map(d=>{const anomaly=d.volume-this.meanValue;const zScore=anomaly/this.stdDev;return{...d,anomaly:anomaly,zScore:zScore,isSignificant:Math.abs(zScore)>=this.zScoreThreshold}});break;case"gamma":try{const mean=d3.mean(volumes);const variance=d3.variance(volumes);const alpha=Math.pow(mean,2)/variance;const beta=variance/mean;this.meanValue=alpha*beta;this.formattedData=baseData.map(d=>{const anomaly=d.volume-this.meanValue;const prob=jStat.gamma.cdf(d.volume,alpha,beta);const isSignificant=prob<this.probabilityThreshold/2||prob>1-this.probabilityThreshold/2;return{...d,anomaly:anomaly,probability:prob,isSignificant:isSignificant}})}catch(error){console.error("Error in Gamma processing:",error)}break;case"weibull":try{this.k=this.estimateWeibullShape(volumes);this.lambda=d3.mean(volumes.map(v=>Math.pow(v,this.k)))**(1/this.k);this.meanValue=this.lambda*jStat.gammafn(1+1/this.k);this.formattedData=baseData.map(d=>{const anomaly=d.volume-this.meanValue;const prob=1-jStat.weibull.cdf(d.volume,this.k,this.lambda);const isSignificant=prob<this.probabilityThreshold;return{...d,anomaly:anomaly,probability:prob,isSignificant:isSignificant}})}catch(error){console.error("Error in Weibull processing:",error)}break}this.significantAnomalies=this.formattedData.filter(d=>d.isSignificant);this.anomalyPercentage=(this.significantAnomalies.length/this.formattedData.length*100).toFixed(1)}catch(error){console.error("Error processing anomaly data:",error);return null}}estimateWeibullShape(data){let k=1;const n=data.length;if(data.some(v=>v<=0)){console.error("Data contains non-positive values, which are invalid for Weibull estimation.");return NaN}const sumLnX=d3.sum(data.map(v=>Math.log(v)));const meanLnX=sumLnX/n;for(let i=0;i<100;i++){const sumXk=d3.sum(data.map(v=>Math.pow(v,k)));const sumXkLnX=d3.sum(data.map(v=>Math.pow(v,k)*Math.log(v)));const f=sumXkLnX/sumXk-1/k-meanLnX;const sumXkLnX2=d3.sum(data.map(v=>Math.pow(v,k)*Math.pow(Math.log(v),2)));const fprime=sumXkLnX2/sumXk-Math.pow(sumXkLnX/sumXk,2)+1/(k*k);const knew=k-f/fprime;if(Math.abs(knew-k)<1e-6)break;k=knew}return k}createDistributionSelector(){const selectContainer=d3.select(`#${this.containerId}`).insert("div","svg").style("position","absolute").style("left","15px").style("top","-8px").style("z-index","1");const distSelect=selectContainer.append("select").style("padding","1px").style("margin-right","10px").style("border-radius","4px").style("font-family","Arial").style("font-size","10px");distSelect.selectAll("option").data(["normal","gamma","weibull"]).enter().append("option").attr("value",d=>d).text(d=>d.charAt(0).toUpperCase()+d.slice(1));distSelect.property("value",this.distributionType);distSelect.on("change",event=>{this.distributionType=event.target.value;this.updateThresholdSelectText();this.updateData(this.IETDData,this.IETDhour,this.zScoreThreshold)})}createThresholdSelector(){const selectContainer=d3.select(`#${this.containerId}`).insert("div","svg").style("position","absolute").style("right","30px").style("top","-8px").style("z-index","1");const select=selectContainer.append("select").style("padding","1px").style("border-radius","4px").style("font-family","Arial").style("font-size","10px");select.selectAll("option").data([{value:2,prob:.05,conf:95},{value:3,prob:.01,conf:99}]).enter().append("option").attr("value",d=>d.value).text(d=>this.distributionType==="normal"?`${d.value}Ïƒ (${d.conf}%)`:`p < ${d.prob} (${d.conf}%)`);select.property("value",this.zScoreThreshold);select.on("change",event=>{const newThreshold=+event.target.value;this.updateData(this.IETDData,this.IETDhour,newThreshold)})}createSvg(){d3.select(`#${this.containerId}`).select("svg").remove();this.svg=d3.select(`#${this.containerId}`).append("svg").attr("width",this.width).attr("height",this.height);this.tooltip=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").attr("font-family","Arial").style("font-size","11px").style("color","black")}createScales(){this.xScale=d3.scaleTime().domain(d3.extent(this.formattedData,d=>d.date)).range([0,this.innerWidth]);const maxValue=d3.max(this.formattedData,d=>Math.max(d.volume,d.anomaly));const minValue=d3.min(this.formattedData,d=>Math.min(d.volume,d.anomaly));this.yScale=d3.scaleSymlog().domain([Math.min(0,minValue),maxValue]).range([this.innerHeight,0]).nice()}dedupeLabels(labels){const rects=[];labels.each(function(d,i){const bbox=this.getBoundingClientRect();rects.push({index:i,x:bbox.x,y:bbox.y,width:bbox.width,height:bbox.height,element:this,visible:true})});rects.sort((a,b)=>a.x-b.x);let lastVisibleIndex=0;for(let i=1;i<rects.length;i++){const curr=rects[i];const lastVisible=rects[lastVisibleIndex];if(lastVisible.x+lastVisible.width+5>curr.x){d3.select(curr.element).style("opacity",0);curr.visible=false}else{d3.select(curr.element).style("opacity",1);curr.visible=true;lastVisibleIndex=i}}}createAxes(){const xAxis=d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"));this.xAxis=this.svg.append("g").attr("class","x axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top+this.innerHeight})`).call(xAxis);this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"));this.yAxis=this.svg.append("g").attr("class","y axis").attr("color","black").attr("transform",`translate(${this.margin.left}, ${this.margin.top})`).call(d3.axisLeft(this.yScale).ticks(5).tickFormat(d=>d.toFixed(2)));this.yAxis.select(".domain").attr("stroke","black");this.yAxis.selectAll(".tick line").attr("stroke","black").attr("stroke-width",1);this.yAxis.selectAll(".tick text").attr("fill","black");this.svg.append("line").attr("class","zero-line").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(0)).attr("y2",this.margin.top+this.yScale(0)).attr("stroke",this.meanLineColor).attr("stroke-width",1).attr("stroke-dasharray","4,4")}createVisualization(){if(this.distributionType==="normal"){const upperBand=this.meanValue+this.stdDev*this.zScoreThreshold;const lowerBand=this.meanValue-this.stdDev*this.zScoreThreshold;this.svg.append("line").attr("class","confidence-band upper").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(upperBand)).attr("y2",this.margin.top+this.yScale(upperBand)).attr("stroke","#999").attr("stroke-dasharray","2,2");this.svg.append("line").attr("class","confidence-band lower").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(lowerBand)).attr("y2",this.margin.top+this.yScale(lowerBand)).attr("stroke","#999").attr("stroke-dasharray","2,2")}else if(this.distributionType==="weibull"){const criticalValue=jStat.weibull.inv(1-this.probabilityThreshold,this.k,this.lambda);this.svg.append("line").attr("class","confidence-band").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(criticalValue)).attr("y2",this.margin.top+this.yScale(criticalValue)).attr("stroke","#999").attr("stroke-dasharray","2,2")}this.svg.append("line").attr("class","mean-line").attr("x1",this.margin.left).attr("x2",this.margin.left+this.innerWidth).attr("y1",this.margin.top+this.yScale(this.meanValue)).attr("y2",this.margin.top+this.yScale(this.meanValue)).attr("stroke",this.meanLineColor).attr("stroke-width",1).attr("stroke-dasharray","4,4");this.points=this.svg.selectAll(".anomaly-point").data(this.significantAnomalies).enter().append("circle").attr("class","anomaly-point").attr("data-indicator",d=>d.period).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly)).attr("r",4).attr("fill",d=>d.volume>this.meanValue?this.positiveColor:this.negativeColor).attr("stroke","white").attr("stroke-width",1).on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.append("path").datum(this.significantAnomalies).attr("class","anomaly-line").attr("fill","none").attr("stroke","#999999").attr("stroke-width",1).attr("stroke-dasharray","4,4").attr("d",lineGenerator);this.createTitles()}createTitles(){let titleText;switch(this.distributionType){case"normal":const confLevel=this.zScoreThreshold===2?95:99;titleText=`${this.title} (${this.zScoreThreshold}Ïƒ, ${confLevel}%)`;break;case"gamma":case"weibull":const prob=this.probabilityThreshold;const conf=(1-prob)*100;titleText=`${this.title} (p < ${prob}, ${conf}%)`;break}this.chartTitle=this.svg.append("text").attr("class","title anomaly").attr("x",this.margin.left+this.innerWidth/2).attr("y",15).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","12px").attr("font-weight","bold").text(`${titleText}`);this.svg.append("text").attr("class","anomaly-percentage").attr("x",this.innerWidth/2).attr("y",35).attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","10px").text(`${this.anomalyPercentage}% of events (${this.significantAnomalies.length} of ${this.formattedData.length})`);this.svg.append("g").attr("transform",`translate(${this.margin.left*1/5}, ${this.innerHeight/2})`).append("text").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("font-size","12px").text("HPCP (inch)").attr("font-family","Arial")}handleMouseOver(event,d){this.svg.selectAll(".anomaly-point").attr("r",4).attr("stroke-width",1).attr("fill",d=>d.volume>this.meanValue?this.positiveColor:this.negativeColor);if(typeof addHighlights_in_Highcharts==="function"){addHighlights_in_Highcharts(d.from,d.to)}if(typeof addHighlightD3Glyphs==="function"){addHighlightD3Glyphs(d.period,"brown")}let statsText;switch(this.distributionType){case"normal":statsText=`Z-Score: ${d.zScore.toFixed(2)}Ïƒ`;break;case"gamma":case"weibull":statsText=`Probability: ${d.probability.toExponential(2)}`;break}const mouseX=event.clientX-this.svg.node().getBoundingClientRect().left;const isRightHalf=mouseX>this.innerWidth/2;const tooltipNode=this.tooltip.node();const tooltipWidth=tooltipNode?tooltipNode.getBoundingClientRect().width:150;this.tooltip.html(this.createTooltipFormat(d,`<div style="padding: 3px;">
                <span style="color:blue">${d.period}</span><br/>
                Value: ${d.volume.toFixed(2)} inches<br/>
                Mean: ${this.meanValue.toFixed(2)} inches<br/>
                Anomaly: ${d.anomaly>=0?"+":""}${d.anomaly.toFixed(2)} inches<br/>
                ${statsText}
            </div>`)).style("visibility","visible").style("top",event.pageY-30+"px").style("left",isRightHalf?event.pageX-tooltipWidth-10+"px":event.pageX+10+"px");d3.select(event.target).raise().attr("r",7).attr("stroke-width",2).attr("fill","brown")}handleMouseOut(event,d){if(typeof removeHighlights_in_allHighcharts==="function"){removeHighlights_in_allHighcharts()}if(typeof removeHighlightD3Glyphs==="function"){removeHighlightD3Glyphs(d.period)}this.tooltip.style("visibility","hidden");d3.select(event.target).attr("r",4).attr("stroke-width",1).attr("fill",d=>d.volume>this.meanValue?this.positiveColor:this.negativeColor)}resize(){if(!this.isVisible())return;const container=d3.select(`#${this.containerId}`);this.width=parseInt(container.style("width"));this.innerWidth=this.width-this.margin.left-this.margin.right;this.svg.attr("width",this.width);this.xScale.range([0,this.innerWidth]);this.svg.select(".x.axis").transition().duration(500).call(d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"))).on("end",()=>{this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"))});this.svg.selectAll(".threshold-line, .zero-line").transition().duration(500).attr("x2",this.margin.left+this.innerWidth);this.points.transition().duration(500).attr("cx",d=>this.margin.left+this.xScale(d.date));const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.select(".anomaly-line").transition().duration(500).attr("d",lineGenerator);this.chartTitle.attr("x",this.margin.left+this.innerWidth/2);this.svg.select(".anomaly-percentage").attr("x",this.innerWidth/2)}updateThresholdSelectText(){const select=d3.select(`#${this.containerId}`).select("select");const thresholdData=[{value:2,prob:.05,conf:95},{value:3,prob:.01,conf:99}];if(this.distributionType==="normal"){select.selectAll("option").data(thresholdData).text(d=>`${d.value}Ïƒ (${d.conf}%)`)}else{select.selectAll("option").data(thresholdData).text(d=>`p < ${d.prob} (${d.conf}%)`)}}async updateData(newIETDData,newIETDHour,newZScoreThreshold=null){this.IETDData=newIETDData;this.IETDhour=newIETDHour;if(newZScoreThreshold!==null){this.zScoreThreshold=newZScoreThreshold;this.probabilityThreshold=newZScoreThreshold===2?.05:.01}this.processData();this.updateThresholdSelectText();this.createScales();this.svg.select(".no-data-message").remove();if(this.formattedData.length<50){this.svg.selectAll(".zero-line").remove();this.svg.selectAll(".anomaly-point").on("mouseover",null).on("mouseout",null).remove();this.svg.selectAll(".anomaly-line").remove();this.svg.append("text").attr("class","no-data-message").attr("x",this.innerWidth/2).attr("y",this.innerHeight/2).attr("text-anchor","middle").attr("alignment-baseline","middle").style("font-size","14px").style("fill","#666").text("Not enough data!");return}this.svg.select(".mean-line").transition().duration(750).attr("y1",this.margin.top+this.yScale(this.meanValue)).attr("y2",this.margin.top+this.yScale(this.meanValue));this.svg.select(".x.axis").transition().duration(750).call(d3.axisBottom(this.xScale).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y"))).on("end",()=>{this.dedupeLabels(this.svg.select(".x.axis").selectAll(".tick text"))});this.svg.select(".y.axis").transition().duration(750).call(d3.axisLeft(this.yScale).ticks(5).tickFormat(d=>d3.format("+.1f")(d)));this.svg.selectAll(".threshold-line").transition().duration(750).attr("y1",(d,i)=>this.margin.top+this.yScale((i===0?1:-1)*this.stdDev*this.zScoreThreshold)).attr("y2",(d,i)=>this.margin.top+this.yScale((i===0?1:-1)*this.stdDev*this.zScoreThreshold));this.svg.select(".zero-line").transition().duration(750).attr("y1",this.margin.top+this.yScale(0)).attr("y2",this.margin.top+this.yScale(0));this.svg.selectAll(".anomaly-point").on("mouseover",null).on("mouseout",null).remove();const points=this.svg.selectAll(".anomaly-point").data(this.significantAnomalies);points.exit().on("mouseover",null).on("mouseout",null).remove();points.transition().duration(750).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly)).attr("fill",d=>d.volume>this.meanValue?this.positiveColor:this.negativeColor);const enterPoints=points.enter().append("circle").attr("class","anomaly-point").attr("data-indicator",d=>d.period).attr("r",4).attr("fill",d=>d.volume>this.meanValue?this.positiveColor:this.negativeColor).attr("stroke","white").attr("stroke-width",1).attr("cx",d=>this.margin.left+this.xScale(d.date)).attr("cy",d=>this.margin.top+this.yScale(d.anomaly));enterPoints.on("mouseover",(event,d)=>this.handleMouseOver(event,d)).on("mouseout",(event,d)=>this.handleMouseOut(event,d));this.points=points.merge(enterPoints);const lineGenerator=d3.line().x(d=>this.margin.left+this.xScale(d.date)).y(d=>this.margin.top+this.yScale(d.anomaly)).curve(d3.curveMonotoneX);this.svg.select(".anomaly-line").datum(this.significantAnomalies).transition().duration(750).attr("d",lineGenerator);let titleText;switch(this.distributionType){case"normal":titleText=`${this.title} (|z| â‰¥ ${this.zScoreThreshold}Ïƒ)`;break;case"gamma":case"weibull":titleText=`${this.title} (p < ${this.probabilityThreshold})`;break}this.chartTitle.text(titleText);this.svg.select(".anomaly-percentage").text(`${this.anomalyPercentage}% of events (${this.significantAnomalies.length} of ${this.formattedData.length})`)}highlightPoints(indicator){this.points.filter(d=>d.period===indicator).attr("r",5).attr("stroke-width",1).attr("stroke","#FFD700").raise()}resetHighlights(){this.points.attr("r",4).attr("stroke","white").attr("stroke-width",1)}addHighlights(indicator){this.highlightPoints(indicator)}removeHighlights(indicator){this.resetHighlights()}destroy(){try{window.removeEventListener("resize",this.resize);const container=d3.select(`#${this.containerId}`);container.selectAll("select").each(function(){d3.select(this).on("change",null)});container.selectAll("div").remove();container.select("svg").remove();if(this.tooltip){this.tooltip.on("mouseover",null).on("mouseout",null).remove()}container.selectAll(".anomaly-point").remove();container.selectAll(".anomaly-line").remove();container.selectAll(".threshold-line").remove();container.selectAll(".zero-line").remove();container.selectAll(".mean-line").remove();container.selectAll(".x.axis").remove();container.selectAll(".y.axis").remove();container.selectAll(".title").remove();container.selectAll(".anomaly-percentage").remove();container.selectAll(".no-data-message").remove();container.selectAll(".anomaly-point").on("mouseover",null).on("mouseout",null);this.formattedData=null;this.significantAnomalies=null;this.IETDData=null;this.IETDhour=null;this.svg=null;this.tooltip=null;this.xScale=null;this.yScale=null;this.xAxis=null;this.yAxis=null;this.points=null;this.chartTitle=null;this.meanValue=null;this.stdDev=null;this.zScoreThreshold=null;this.width=null;this.height=null;this.innerWidth=null;this.innerHeight=null;this.margin=null;this.positiveColor=null;this.negativeColor=null;this.meanLineColor=null;this.distributionType=null;this.probabilityThreshold=null;this.k=null;this.lambda=null;super.destroy()}catch(error){console.error("Error in destroy:",error)}}}